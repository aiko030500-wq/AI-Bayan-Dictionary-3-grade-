<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ENGLISH WITH AI BAYAN ‚Äì Grade 3 Unit 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --main-green:#1b5e20;
      --menu-bg:#004d40;
      --card:#ffffff;
      --text:#0d1b2a;
      --border:#ffd54f;
      --wrong:#ffcccc;
      --right:#c8e6c9;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{
      margin:0;
      background:#e0f2f1;
      color:var(--text);
    }
    .app{
      max-width:900px;
      margin:0 auto;
      min-height:100vh;
      background:#e0f2f1;
    }
    header.app-header{
      background:var(--menu-bg);
      color:#fff;
      padding:12px 16px;
      text-align:center;
      position:sticky;
      top:0;
      z-index:10;
    }
    header.app-header h1{
      margin:4px 0;
      font-size:20px;
    }
    header.app-header small{
      opacity:0.8;
      font-size:13px;
    }
    main{
      padding:16px;
      padding-bottom:40px;
    }
    .card{
      background:var(--card);
      border-radius:16px;
      border:3px solid var(--border);
      padding:16px;
      margin-bottom:16px;
      box-shadow:0 4px 8px rgba(0,0,0,0.08);
    }
    .hidden{display:none;}
    h2{margin-top:0;font-size:19px;}
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 18px;
      border-radius:999px;
      border:none;
      background:var(--main-green);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      font-size:15px;
      margin:4px 2px;
    }
    .btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    .btn-secondary{
      background:#004d40;
    }
    .btn-outline{
      background:#fff;
      color:var(--main-green);
      border:2px solid var(--main-green);
    }
    .input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:2px solid #cfd8dc;
      font-size:16px;
      margin-bottom:10px;
    }
    .lesson-list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .lesson-btn{
      border-radius:16px;
      border:none;
      padding:12px 14px;
      text-align:left;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      background:#ffffff;
      box-shadow:0 2px 4px rgba(0,0,0,0.12);
      font-size:15px;
    }
    .lesson-btn-title{
      font-weight:600;
    }
    .pill{
      padding:2px 10px;
      border-radius:999px;
      background:rgba(0,0,0,0.08);
      font-size:12px;
    }
    .vocab-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:10px;
      margin-top:10px;
    }
    .vocab-card{
      background:#f1f8e9;
      border-radius:14px;
      padding:8px;
      text-align:center;
      border:2px solid rgba(0,0,0,0.05);
    }
    .vocab-emoji{font-size:28px;margin-bottom:4px;}
    .vocab-word{font-weight:600;}
    .vocab-ru{font-size:13px;opacity:0.8;}
    .say-btn{
      margin-top:6px;
      font-size:13px;
      padding:4px 10px;
    }
    .grammar-box{
      background:#e3f2fd;
      border-radius:14px;
      padding:10px 12px;
    }
    .grammar-rule{margin-bottom:4px;}
    .grammar-formula{
      font-weight:600;
      margin-bottom:4px;
    }
    .examples-list{
      padding-left:18px;
      margin:4px 0;
    }
    .examples-list li{margin-bottom:2px;}
    .reading-dialogue{
      background:#fffde7;
      border-radius:14px;
      padding:10px 12px;
      margin-bottom:10px;
    }
    .q-item{margin-bottom:8px;}
    select.ws-select, input.ws-input{
      width:100%;
      padding:6px 8px;
      border-radius:10px;
      border:2px solid #cfd8dc;
      font-size:15px;
      margin-top:4px;
    }
    .ws-row{
      margin-bottom:10px;
    }
    .ws-label{
      display:block;
      margin-bottom:2px;
    }
    .match-row{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .match-emoji{
      font-size:22px;
      width:32px;
      text-align:center;
    }
    .status-text{
      font-size:14px;
      margin-top:4px;
    }
    .correct{
      background:var(--right)!important;
      animation:bounce 0.3s;
    }
    .wrong{
      background:var(--wrong)!important;
      animation:shake 0.3s;
    }
    @keyframes shake{
      0%{transform:translateX(0);}
      25%{transform:translateX(-3px);}
      50%{transform:translateX(3px);}
      75%{transform:translateX(-3px);}
      100%{transform:translateX(0);}
    }
    @keyframes bounce{
      0%{transform:scale(1);}
      50%{transform:scale(1.03);}
      100%{transform:scale(1);}
    }
    .karaoke-box{
      margin-top:16px;
      padding:16px;
      border-radius:16px;
      background:#ffffff;
    }
    .karaoke-lines{margin-top:8px;}
    .karaoke-line{
      padding:6px 10px;
      border-radius:8px;
      margin-bottom:4px;
      transition:background 0.3s;
    }
    .karaoke-line.active{
      background:rgba(255,235,59,0.6);
      font-weight:bold;
    }
    .lesson-header-band{
      border-radius:16px;
      padding:10px 12px;
      color:#fff;
      margin-bottom:12px;
    }
    .lesson-header-band h2{
      margin:0;
      font-size:18px;
    }
    .lesson-sub{
      font-size:13px;
      opacity:0.9;
    }
    .top-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:12px;
    }
    .stars-text{
      font-weight:600;
      margin-top:4px;
    }
    .journal-table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    .journal-table th,.journal-table td{
      border:1px solid #cfd8dc;
      padding:4px 6px;
      text-align:center;
    }
    .small-note{
      font-size:12px;
      opacity:0.8;
    }
  </style>
</head>
<body>
<div class="app">
  <header class="app-header">
    <h1>ENGLISH WITH AI BAYAN</h1>
    <small>Grade 3 ‚Äì Unit 1 &nbsp;|&nbsp; Picture Vocabulary, Grammar & Worksheets</small>
  </header>
  <main>

    <!-- LOGIN -->
    <section id="loginScreen" class="card">
      <h2>Login</h2>
      <p>Enter your name and PIN.</p>
      <input id="loginName" class="input" placeholder="Example: 3E S1" />
      <input id="loginPin" class="input" placeholder="PIN" type="password" />
      <button class="btn" onclick="handleLogin()">Enter</button>
      <p class="small-note" style="margin-top:8px;">
        Students: PIN <strong>2844</strong> ‚Ä¢ Teacher: PIN <strong>3244</strong>
      </p>
    </section>

    <!-- MENU -->
    <section id="menuScreen" class="hidden">
      <div class="card" style="background:#a5d6a7;">
        <h2 id="helloUser">Hello!</h2>
        <p id="totalStarsText">Total stars in all lessons: 0 ‚≠ê</p>
      </div>

      <div class="card" style="background:#c8e6c9;">
        <h2>üìö Unit 1 ‚Äì Hello English!</h2>
        <p>Choose a lesson. You have only <strong>one try</strong> in each lesson.</p>
        <div class="lesson-list" id="lessonList"></div>
      </div>

      <div class="card">
        <h2>ü§ñ AI Bayan Chat</h2>
        <p class="small-note">
          One question per lesson. This is an offline demo ‚Äì you can later connect your own AI endpoint.
        </p>
        <textarea id="aiQuestion" class="input" style="height:70px;" placeholder="Ask one question about Unit 1..."></textarea>
        <button class="btn" onclick="askAI()">Ask AI Bayan</button>
        <p id="aiAnswer" class="small-note" style="margin-top:6px;"></p>
      </div>

      <div id="teacherMenuBlock" class="card hidden">
        <h2>üè´ Teacher‚Äôs Journal</h2>
        <button class="btn btn-secondary" onclick="openTeacherJournal()">Open journal</button>
        <p class="small-note">Shows stars per lesson for each student (from this device).</p>
      </div>
    </section>

    <!-- LESSON -->
    <section id="lessonScreen" class="hidden">
      <div id="lessonHeaderBox" class="lesson-header-band">
        <h2 id="lessonTitle">Lesson</h2>
        <div class="lesson-sub" id="lessonSubtitle"></div>
        <div class="stars-text" id="lessonStarsText"></div>
      </div>

      <div class="top-buttons">
        <button class="btn btn-outline" onclick="backToMenu()">‚Üê Back</button>
        <button class="btn btn-secondary" onclick="printLesson()">üñ® Print this lesson</button>
      </div>

      <div id="lessonContent"></div>

      <div class="card" id="bottomCard">
        <h2>üéØ Lesson Complete</h2>
        <p id="lessonCompleteText">Do the tasks and then save your result.</p>
        <button class="btn" id="saveResultBtn" onclick="saveLessonResult()">Save Result ‚úî</button>
      </div>
    </section>

    <!-- TEACHER JOURNAL -->
    <section id="teacherScreen" class="hidden">
      <div class="card">
        <h2>üè´ Teacher‚Äôs Journal</h2>
        <p class="small-note">Results are stored only on this device (localStorage).</p>
        <div id="journalTableWrap"></div>
        <button class="btn btn-outline" onclick="closeTeacherJournal()">‚Üê Back to menu</button>
      </div>
    </section>

  </main>
</div>

<script>
  const STUDENT_PIN = "2844";
  const TEACHER_PIN = "3244";
  const allowedStudents = [
    "3E S1","3E S2","3E S3","3E S4","3E S5",
    "3E S6","3E S7","3E S8","3E S9","3E S10",
    "3E S11","3E S12","3E S13","3E S14","3E S15"
  ];

  let currentUser = { name:null, role:null }; // role: "student" or "teacher"
  let currentLessonId = null;
  let karaokeTimer = null;
  let karaokeIndex = 0;

  // === LESSON DATA (Unit 1: 8 lessons) ===
  const lessons = [
    {
      id:"L1",
      title:"Lesson 1 ‚Äì Greetings & names",
      subtitle:"Hello English!",
      color:"#00796b",
      vocab:[
        {word:"hello", ru:"–ø—Ä–∏–≤–µ—Ç", emoji:"üëã", tts:"Hello"},
        {word:"goodbye", ru:"–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è", emoji:"üëã", tts:"Goodbye"},
        {word:"name", ru:"–∏–º—è", emoji:"üè∑Ô∏è", tts:"name"},
        {word:"friend", ru:"–¥—Ä—É–≥", emoji:"üßë‚Äçü§ù‚Äçüßë", tts:"friend"},
        {word:"teacher", ru:"—É—á–∏—Ç–µ–ª—å", emoji:"üë©‚Äçüè´", tts:"teacher"},
        {word:"class", ru:"–∫–ª–∞—Å—Å", emoji:"üè´", tts:"class"}
      ],
      grammar:{
        rule:"Use <strong>Hello</strong> to greet people and <strong>Goodbye</strong> to say bye. Ask <strong>What's your name?</strong> and answer <strong>My name's...</strong>",
        formula:"‚Äì Hello! What's your name?<br>‚Äì My name's Rosy.<br>‚Äì Goodbye, Rosy!",
        examples:[
          "Hello, my name's Tim.",
          "Goodbye, class!"
        ]
      },
      reading:{
        dialogue:`Hello! My name's Tim. I'm eight.<br>
This is my cousin, Billy. He's seven.<br>
This is our teacher, Miss Jones.`,
        questions:[
          {q:"1) Tim is __ years old.", options:["seven","eight","nine"], answer:"eight"},
          {q:"2) Billy is Tim's __.", options:["teacher","cousin","friend"], answer:"cousin"},
          {q:"3) Miss Jones is their __.", options:["friend","teacher","cousin"], answer:"teacher"},
          {q:"4) There are __ children in the story.", options:["two","three","four"], answer:"two"},
          {q:"5) They say __ when they meet.", options:["Goodbye","Hello","Thanks"], answer:"Hello"}
        ]
      },
      worksheets:{
        ws1:[
          {sentence:"1) ‚Äì __! What's your name?", options:["Goodbye","Hello"], answer:"Hello"},
          {sentence:"2) ‚Äì __ name's Billy.", options:["My","I'm"], answer:"My"},
          {sentence:"3) ‚Äì Goodbye, class! ‚Äì __, Miss Jones.", options:["Hello","Goodbye"], answer:"Goodbye"}
        ],
        ws2:[
          {emoji:"üëã", options:["hello","goodbye","teacher","friend"], answer:"hello"},
          {emoji:"üö™", options:["hello","goodbye","teacher","friend"], answer:"goodbye"},
          {emoji:"üë©‚Äçüè´", options:["hello","goodbye","teacher","friend"], answer:"teacher"},
          {emoji:"üßë‚Äçü§ù‚Äçüßë", options:["hello","goodbye","teacher","friend"], answer:"friend"}
        ],
        ws3:[
          {sentence:"You say this when you meet.", options:["goodbye","hello","teacher"], answer:"hello"},
          {sentence:"This person teaches you.", options:["friend","teacher","cousin"], answer:"teacher"},
          {sentence:"You write your __ on the board.", options:["board","name","class"], answer:"name"}
        ],
        ws4:[
          {sentence:"1) Tim is Billy's cousin.", options:["True","False"], answer:"True"},
          {sentence:"2) Miss Jones is a student.", options:["True","False"], answer:"False"},
          {sentence:"3) They say 'Hello' at the beginning.", options:["True","False"], answer:"True"}
        ]
      }
    },

    // Lesson 2 ‚Äì Alphabet
    {
      id:"L2",
      title:"Lesson 2 ‚Äì Alphabet",
      subtitle:"Letters A‚ÄìZ and spelling names",
      color:"#1976d2",
      vocab:(()=>{
        const letters = [
          ["A a","—ç–π","üÖ∞Ô∏è"],["B b","–±–∏","üÖ±Ô∏è"],["C c","—Å–∏","üåä"],["D d","–¥–∏","üê∂"],
          ["E e","–∏","ü¶Ö"],["F f","—ç—Ñ","üêü"],["G g","–¥–∂–∏","ü¶í"],["H h","—ç–π—á","üè†"],
          ["I i","–∞–π","üç¶"],["J j","–¥–∂–µ–π","ü§π"],["K k","–∫–µ–π","ü™Å"],["L l","—ç–ª","ü¶Å"],
          ["M m","—ç–º","üçà"],["N n","—ç–Ω","ü•ú"],["O o","–æ—É","ü¶â"],["P p","–ø–∏","üÖøÔ∏è"],
          ["Q q","–∫—å—é","‚ùì"],["R r","–∞—Ä","üöó"],["S s","—ç—Å","üêç"],["T t","—Ç–∏","üå¥"],
          ["U u","—é","‚òÇÔ∏è"],["V v","–≤–∏","üéª"],["W w","–¥–∞–±–ª-—é","üåä"],["X x","—ç–∫—Å","‚ùå"],
          ["Y y","—É–∞–π","ü™Ä"],["Z z","–∑–µ–¥","ü¶ì"]
        ];
        return letters.map(([w,ru,em])=>({word:w, ru, emoji:em, tts:w}));
      })(),
      grammar:{
        rule:"We use the alphabet to spell our names.",
        formula:"‚Äì What's your name?<br>‚Äì My name's Ayan. A‚ÄìY‚ÄìA‚ÄìN.",
        examples:[
          "A is for apple.",
          "B is for bag.",
          "Spell 'Tim': T‚ÄìI‚ÄìM."
        ]
      },
      reading:{
        dialogue:`Hello! My name's Ayan. I'm eight.<br>
I can spell my name: A‚ÄìY‚ÄìA‚ÄìN.<br>
This is my friend Dana. She can spell her name too.`,
        questions:[
          {q:"1) The boy's name is __.", options:["Tim","Ayan","Billy"], answer:"Ayan"},
          {q:"2) Ayan is __ years old.", options:["seven","eight","nine"], answer:"eight"},
          {q:"3) He can __ his name.", options:["count","spell","read"], answer:"spell"},
          {q:"4) His friend's name is __.", options:["Dana","Rosy","Katie"], answer:"Dana"},
          {q:"5) A‚ÄìY‚ÄìA‚ÄìN is the spelling of __.", options:["Dana","Ayan","Tim"], answer:"Ayan"}
        ]
      },
      worksheets:{
        ws1:[
          {sentence:"1) Which letter comes after C?", options:["B","D","F"], answer:"D"},
          {sentence:"2) Which letter comes before M?", options:["N","L","O"], answer:"L"},
          {sentence:"3) What is the first letter of 'bag'?", options:["b","g","a"], answer:"b"}
        ],
        ws2:[
          {emoji:"üçé", options:["A","B","C","D"], answer:"A"},
          {emoji:"üéí", options:["A","B","C","D"], answer:"B"},
          {emoji:"üê±", options:["A","C","F","Z"], answer:"C"},
          {emoji:"üê∂", options:["D","A","B","C"], answer:"D"}
        ],
        ws3:[
          {sentence:"This letter is in the word 'bag'.", options:["X","B","Q"], answer:"B"},
          {sentence:"This letter is in the word 'pen'.", options:["P","Z","Y"], answer:"P"},
          {sentence:"This letter is in the word 'cat'.", options:["T","C","M"], answer:"C"}
        ],
        ws4:[
          {sentence:"1) A, B, C are letters of the alphabet.", options:["True","False"], answer:"True"},
          {sentence:"2) We use numbers to spell names.", options:["True","False"], answer:"False"},
          {sentence:"3) Ayan can spell his name.", options:["True","False"], answer:"True"}
        ]
      }
    },

    // Lesson 3 ‚Äì Song (karaoke)
    {
      id:"L3",
      title:"Lesson 3 ‚Äì Hello song",
      subtitle:"Sing about introductions",
      color:"#c2185b",
      song:{
        title:"Hello, hello!",
        lines:[
          "Hello, hello, how are you?",
          "I'm fine, thank you. I'm fine, thank you.",
          "Hello, hello, what's your name?",
          "My name's ____. That's my name.",
          "Goodbye, goodbye, goodbye to you..."
        ]
      },
      vocab:[
        {word:"how are you?", ru:"–∫–∞–∫ —Ç—ã?", emoji:"üôÇ", tts:"How are you?"},
        {word:"I'm fine, thank you.", ru:"—É –º–µ–Ω—è –≤—Å–µ —Ö–æ—Ä–æ—à–æ, —Å–ø–∞—Å–∏–±–æ", emoji:"üòä", tts:"I'm fine, thank you."},
        {word:"Goodbye to you.", ru:"–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è —Ç–µ–±–µ", emoji:"üëã", tts:"Goodbye to you."},
        {word:"What's your name?", ru:"–∫–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?", emoji:"‚ùì", tts:"What's your name?"},
        {word:"My name's ...", ru:"–º–µ–Ω—è –∑–æ–≤—É—Ç ...", emoji:"üßí", tts:"My name's"}
      ],
      grammar:{
        rule:"In the song we use questions and answers.",
        formula:"‚Äì How are you?<br>‚Äì I'm fine, thank you.<br>‚Äì What's your name?<br>‚Äì My name's Arman.",
        examples:[
          "Hello, how are you?",
          "I'm fine, thank you.",
          "Goodbye, see you!"
        ]
      },
      reading:{
        dialogue:`Hello! My name‚Äôs Arman. How are you?<br>
‚Äì I'm fine, thank you. My name‚Äôs Aruzhan.<br>
‚Äì Goodbye, Arman. Goodbye, Aruzhan.`,
        questions:[
          {q:"1) The boy's name is __.", options:["Tim","Billy","Arman"], answer:"Arman"},
          {q:"2) The girl's name is __.", options:["Rosy","Katie","Aruzhan"], answer:"Aruzhan"},
          {q:"3) They say __ when they meet.", options:["Goodbye","Hello","Thanks"], answer:"Hello"},
          {q:"4) They say __ when they go.", options:["Goodbye","Hello","Sorry"], answer:"Goodbye"},
          {q:"5) ‚ÄúI'm fine, thank you‚Äù is the answer to __.", options:["What's your name?","How are you?","Where are you from?"], answer:"How are you?"}
        ]
      },
      worksheets:{
        ws1:[
          {sentence:"1) You meet a friend. You say __.", options:["Goodbye","Hello"], answer:"Hello"},
          {sentence:"2) You go home. You say __.", options:["Hello","Goodbye"], answer:"Goodbye"},
          {sentence:"3) You answer 'How are you?' ‚Äì __.", options:["I'm fine, thank you.","My name's Tim."], answer:"I'm fine, thank you."}
        ],
        ws2:[
          {emoji:"üôÇ", options:["How are you?","Goodbye!","What's your name?"], answer:"How are you?"},
          {emoji:"üëã", options:["Goodbye!","Hello!","Fine, thanks."], answer:"Goodbye!"},
          {emoji:"üßí", options:["My name's...","How old are you?","Where are you from?"], answer:"My name's..."}
        ],
        ws3:[
          {sentence:"You ask this to know the name.", options:["How are you?","What's your name?","Goodbye!"], answer:"What's your name?"},
          {sentence:"You say this when you feel good.", options:["I'm fine, thank you.","Goodbye!","Hello!"], answer:"I'm fine, thank you."},
          {sentence:"You say this at the end of the song.", options:["Hello","Goodbye","Thanks"], answer:"Goodbye"}
        ],
        ws4:[
          {sentence:"1) In the song children are happy.", options:["True","False"], answer:"True"},
          {sentence:"2) They never say 'Goodbye'.", options:["True","False"], answer:"False"},
          {sentence:"3) The song is about introductions.", options:["True","False"], answer:"True"}
        ]
      }
    },

    // Lesson 4 ‚Äì Numbers 1‚Äì20
    {
      id:"L4",
      title:"Lesson 4 ‚Äì Numbers 1‚Äì20",
      subtitle:"How old are you?",
      color:"#388e3c",
      vocab:[
        {word:"one", ru:"–æ–¥–∏–Ω", emoji:"1Ô∏è‚É£", tts:"one"},
        {word:"two", ru:"–¥–≤–∞", emoji:"2Ô∏è‚É£", tts:"two"},
        {word:"three", ru:"—Ç—Ä–∏", emoji:"3Ô∏è‚É£", tts:"three"},
        {word:"four", ru:"—á–µ—Ç—ã—Ä–µ", emoji:"4Ô∏è‚É£", tts:"four"},
        {word:"five", ru:"–ø—è—Ç—å", emoji:"5Ô∏è‚É£", tts:"five"},
        {word:"six", ru:"—à–µ—Å—Ç—å", emoji:"6Ô∏è‚É£", tts:"six"},
        {word:"seven", ru:"—Å–µ–º—å", emoji:"7Ô∏è‚É£", tts:"seven"},
        {word:"eight", ru:"–≤–æ—Å–µ–º—å", emoji:"8Ô∏è‚É£", tts:"eight"},
        {word:"nine", ru:"–¥–µ–≤—è—Ç—å", emoji:"9Ô∏è‚É£", tts:"nine"},
        {word:"ten", ru:"–¥–µ—Å—è—Ç—å", emoji:"üîü", tts:"ten"},
        {word:"eleven", ru:"–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å", emoji:"1Ô∏è‚É£1Ô∏è‚É£", tts:"eleven"},
        {word:"twelve", ru:"–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å", emoji:"1Ô∏è‚É£2Ô∏è‚É£", tts:"twelve"},
        {word:"thirteen", ru:"—Ç—Ä–∏–Ω–∞–¥—Ü–∞—Ç—å", emoji:"1Ô∏è‚É£3Ô∏è‚É£", tts:"thirteen"},
        {word:"fourteen", ru:"—á–µ—Ç—ã—Ä–Ω–∞–¥—Ü–∞—Ç—å", emoji:"1Ô∏è‚É£4Ô∏è‚É£", tts:"fourteen"},
        {word:"fifteen", ru:"–ø—è—Ç–Ω–∞–¥—Ü–∞—Ç—å", emoji:"1Ô∏è‚É£5Ô∏è‚É£", tts:"fifteen"},
        {word:"sixteen", ru:"—à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—å", emoji:"1Ô∏è‚É£6Ô∏è‚É£", tts:"sixteen"},
        {word:"seventeen", ru:"—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å", emoji:"1Ô∏è‚É£7Ô∏è‚É£", tts:"seventeen"},
        {word:"eighteen", ru:"–≤–æ—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å", emoji:"1Ô∏è‚É£8Ô∏è‚É£", tts:"eighteen"},
        {word:"nineteen", ru:"–¥–µ–≤—è—Ç–Ω–∞–¥—Ü–∞—Ç—å", emoji:"1Ô∏è‚É£9Ô∏è‚É£", tts:"nineteen"},
        {word:"twenty", ru:"–¥–≤–∞–¥—Ü–∞—Ç—å", emoji:"2Ô∏è‚É£0Ô∏è‚É£", tts:"twenty"}
      ],
      grammar:{
        rule:"We use numbers to talk about age.",
        formula:"‚Äì How old are you?<br>‚Äì I'm ten.",
        examples:[
          "I'm nine.",
          "She's seven.",
          "He's eight."
        ]
      },
      reading:{
        dialogue:`Hello! I'm Billy. I'm seven.<br>
This is Rosy. She's eight.<br>
Tim is nine.`,
        questions:[
          {q:"1) Billy is __ years old.", options:["seven","eight","nine"], answer:"seven"},
          {q:"2) Rosy is __ years old.", options:["seven","eight","nine"], answer:"eight"},
          {q:"3) Tim is __ years old.", options:["nine","ten","eight"], answer:"nine"},
          {q:"4) The youngest child is __.", options:["Billy","Rosy","Tim"], answer:"Billy"},
          {q:"5) The oldest child is __.", options:["Billy","Rosy","Tim"], answer:"Tim"}
        ]
      },
      worksheets:{
        ws1:[
          {sentence:"1) ‚Äì How old are you? ‚Äì I __ ten.", options:["am","is"], answer:"am"},
          {sentence:"2) She __ eight.", options:["am","is"], answer:"is"},
          {sentence:"3) He __ seven.", options:["am","is"], answer:"is"}
        ],
        ws2:[
          {emoji:"7Ô∏è‚É£", options:["seven","eight","nine","ten"], answer:"seven"},
          {emoji:"8Ô∏è‚É£", options:["six","seven","eight","nine"], answer:"eight"},
          {emoji:"9Ô∏è‚É£", options:["nine","ten","seven","eight"], answer:"nine"}
        ],
        ws3:[
          {sentence:"1 = __.", options:["one","ten","five"], answer:"one"},
          {sentence:"5 = __.", options:["four","five","six"], answer:"five"},
          {sentence:"9 = __.", options:["nine","nineteen","ten"], answer:"nine"}
        ],
        ws4:[
          {sentence:"1) Billy is seven years old.", options:["True","False"], answer:"True"},
          {sentence:"2) Tim is eight years old.", options:["True","False"], answer:"False"},
          {sentence:"3) Rosy is eight years old.", options:["True","False"], answer:"True"}
        ]
      }
    },

    // Lesson 5 ‚Äì Colours
    {
      id:"L5",
      title:"Lesson 5 ‚Äì Colours",
      subtitle:"What colour is it?",
      color:"#f57c00",
      vocab:[
        {word:"red", ru:"–∫—Ä–∞—Å–Ω—ã–π", emoji:"üî¥", tts:"red"},
        {word:"yellow", ru:"–∂—ë–ª—Ç—ã–π", emoji:"üü°", tts:"yellow"},
        {word:"blue", ru:"—Å–∏–Ω–∏–π", emoji:"üîµ", tts:"blue"},
        {word:"green", ru:"–∑–µ–ª—ë–Ω—ã–π", emoji:"üü¢", tts:"green"},
        {word:"black", ru:"—á—ë—Ä–Ω—ã–π", emoji:"‚ö´", tts:"black"},
        {word:"white", ru:"–±–µ–ª—ã–π", emoji:"‚ö™", tts:"white"},
        {word:"brown", ru:"–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π", emoji:"üü§", tts:"brown"},
        {word:"pink", ru:"—Ä–æ–∑–æ–≤—ã–π", emoji:"üå∏", tts:"pink"},
        {word:"grey", ru:"—Å–µ—Ä—ã–π", emoji:"‚ö™", tts:"grey"},
        {word:"orange", ru:"–æ—Ä–∞–Ω–∂–µ–≤—ã–π", emoji:"üü†", tts:"orange"}
      ],
      grammar:{
        rule:"We use colours with 'is' or 'are'.",
        formula:"The flag is blue and yellow.<br>The bag is green.",
        examples:[
          "The car is red.",
          "The horse is brown."
        ]
      },
      reading:{
        dialogue:`The flag of Kazakhstan is blue and yellow.<br>
My bag is green.<br>
My favourite colour is red.`,
        questions:[
          {q:"1) The flag is blue and __.", options:["red","yellow","green"], answer:"yellow"},
          {q:"2) The bag is __.", options:["brown","green","grey"], answer:"green"},
          {q:"3) My favourite colour is __.", options:["red","blue","pink"], answer:"red"},
          {q:"4) There are __ colours on the flag.", options:["two","three","four"], answer:"two"},
          {q:"5) The horse in the picture is __.", options:["brown","pink","blue"], answer:"brown"}
        ]
      },
      worksheets:{
        ws1:[
          {sentence:"1) The bag __ green.", options:["is","are"], answer:"is"},
          {sentence:"2) The cars __ red.", options:["is","are"], answer:"are"},
          {sentence:"3) The flag __ blue and yellow.", options:["is","are"], answer:"is"}
        ],
        ws2:[
          {emoji:"üá∞üáø", options:["blue and red","blue and yellow","green and white"], answer:"blue and yellow"},
          {emoji:"üéí", options:["green","pink","grey"], answer:"green"},
          {emoji:"üåπ", options:["red","blue","black"], answer:"red"}
        ],
        ws3:[
          {sentence:"Grass is usually __.", options:["green","pink","black"], answer:"green"},
          {sentence:"The sky is __.", options:["brown","blue","orange"], answer:"blue"},
          {sentence:"Coal is __.", options:["white","black","yellow"], answer:"black"}
        ],
        ws4:[
          {sentence:"1) The flag of Kazakhstan is blue and yellow.", options:["True","False"], answer:"True"},
          {sentence:"2) My bag is red.", options:["True","False"], answer:"False"},
          {sentence:"3) My favourite colour is red.", options:["True","False"], answer:"True"}
        ]
      }
    },

    // Lesson 6 ‚Äì How old / Where from
    {
      id:"L6",
      title:"Lesson 6 ‚Äì How old? Where from?",
      subtitle:"Talking about age and country",
      color:"#6a1b9a",
      vocab:[
        {word:"How old are you?", ru:"–°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç?", emoji:"üéÇ", tts:"How old are you?"},
        {word:"Where are you from?", ru:"–û—Ç–∫—É–¥–∞ —Ç—ã?", emoji:"üåç", tts:"Where are you from?"},
        {word:"I'm from Kazakhstan.", ru:"–Ø –∏–∑ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞.", emoji:"üá∞üáø", tts:"I'm from Kazakhstan."},
        {word:"I'm nine.", ru:"–ú–Ω–µ –¥–µ–≤—è—Ç—å –ª–µ—Ç.", emoji:"9Ô∏è‚É£", tts:"I'm nine."}
      ],
      grammar:{
        rule:"We use <strong>How old are you?</strong> and <strong>Where are you from?</strong> to ask about age and country.",
        formula:"‚Äì How old are you?<br>‚Äì I'm nine.<br>‚Äì Where are you from?<br>‚Äì I'm from Kazakhstan.",
        examples:[
          "She's from Japan.",
          "He's from Brazil."
        ]
      },
      reading:{
        dialogue:`This is Katie. She's nine.<br>
She's from the UK.<br>
Aizere is from Kazakhstan. She's nine too.`,
        questions:[
          {q:"1) Katie is __ years old.", options:["eight","nine","ten"], answer:"nine"},
          {q:"2) Katie is from the __.", options:["USA","UK","Brazil"], answer:"UK"},
          {q:"3) Aizere is from __.", options:["Japan","Kazakhstan","Russia"], answer:"Kazakhstan"},
          {q:"4) Aizere is __ years old.", options:["nine","ten","eight"], answer:"nine"},
          {q:"5) The girls are the __ age.", options:["same","different"], answer:"same"}
        ]
      },
      worksheets:{
        ws1:[
          {sentence:"1) ‚Äì __ are you? ‚Äì I'm nine.", options:["How","How old"], answer:"How old"},
          {sentence:"2) ‚Äì Where __ you from? ‚Äì I'm from Kazakhstan.", options:["is","are"], answer:"are"},
          {sentence:"3) I __ from Brazil.", options:["am","are"], answer:"am"}
        ],
        ws2:[
          {emoji:"üá∞üáø", options:["Kazakhstan","Japan","Brazil"], answer:"Kazakhstan"},
          {emoji:"üá¨üáß", options:["USA","UK","Russia"], answer:"UK"},
          {emoji:"üáØüáµ", options:["Kazakhstan","Japan","Brazil"], answer:"Japan"}
        ],
        ws3:[
          {sentence:"He is from Kazakhstan. He is __.", options:["Japanese","Kazakh","Brazilian"], answer:"Kazakh"},
          {sentence:"She is from Japan. She is __.", options:["Japanese","English","Kazakh"], answer:"Japanese"},
          {sentence:"He is from Brazil. He is __.", options:["Brazilian","English","Russian"], answer:"Brazilian"}
        ],
        ws4:[
          {sentence:"1) Katie is from the UK.", options:["True","False"], answer:"True"},
          {sentence:"2) Aizere is from the USA.", options:["True","False"], answer:"False"},
          {sentence:"3) Both girls are nine.", options:["True","False"], answer:"True"}
        ]
      }
    },

    // Lesson 7 ‚Äì Project: About me
    {
      id:"L7",
      title:"Lesson 7 ‚Äì Project: About me",
      subtitle:"Poster about yourself",
      color:"#8bc34a",
      vocab:[
        {word:"poster", ru:"–ø–ª–∞–∫–∞—Ç", emoji:"üñºÔ∏è", tts:"poster"},
        {word:"favourite colour", ru:"–ª—é–±–∏–º—ã–π —Ü–≤–µ—Ç", emoji:"üé®", tts:"favourite colour"},
        {word:"I'm ten.", ru:"–ú–Ω–µ –¥–µ—Å—è—Ç—å –ª–µ—Ç.", emoji:"üîü", tts:"I'm ten."}
      ],
      grammar:{
        rule:"We talk about name, age, country and favourite colour.",
        formula:"My name's Birzhan.<br>I'm ten.<br>I'm from Kazakhstan.<br>My favourite colour is red.",
        examples:[
          "My favourite colour is blue.",
          "I'm nine.",
          "I'm from Aktau."
        ]
      },
      reading:{
        dialogue:`My name's Birzhan. I'm ten.<br>
I'm from Kazakhstan. My favourite colour is red.`,
        questions:[
          {q:"1) The boy's name is __.", options:["Tim","Birzhan","Billy"], answer:"Birzhan"},
          {q:"2) He is __ years old.", options:["nine","ten","eight"], answer:"ten"},
          {q:"3) He is from __.", options:["Japan","Kazakhstan","Brazil"], answer:"Kazakhstan"},
          {q:"4) His favourite colour is __.", options:["red","blue","green"], answer:"red"},
          {q:"5) He is making a __.", options:["poster","book","song"], answer:"poster"}
        ]
      },
      worksheets:{
        ws1:[
          {sentence:"1) My __'s Aigerim.", options:["name","old"], answer:"name"},
          {sentence:"2) I __ ten.", options:["am","is"], answer:"am"},
          {sentence:"3) My favourite colour __ blue.", options:["am","is"], answer:"is"}
        ],
        ws2:[
          {emoji:"üßí", options:["My name's Arman.","I'm ten.","I'm from Kazakhstan."], answer:"My name's Arman."},
          {emoji:"üéÇ", options:["My name's Arman.","I'm ten.","I'm from Kazakhstan."], answer:"I'm ten."},
          {emoji:"üá∞üáø", options:["My name's Arman.","I'm ten.","I'm from Kazakhstan."], answer:"I'm from Kazakhstan."}
        ],
        ws3:[
          {sentence:"You talk about your __ when you say 'My name's Ayan'.", options:["age","name","colour"], answer:"name"},
          {sentence:"'I'm nine' ‚Äì you talk about your __.", options:["name","age","colour"], answer:"age"},
          {sentence:"'My favourite colour is blue' ‚Äì you talk about your __.", options:["poster","age","favourite colour"], answer:"favourite colour"}
        ],
        ws4:[
          {sentence:"1) Birzhan is from Kazakhstan.", options:["True","False"], answer:"True"},
          {sentence:"2) His favourite colour is green.", options:["True","False"], answer:"False"},
          {sentence:"3) He is ten.", options:["True","False"], answer:"True"}
        ]
      }
    },

    // Lesson 8 ‚Äì Culture: At my school
    {
      id:"L8",
      title:"Lesson 8 ‚Äì At my school",
      subtitle:"Classroom instructions & positions",
      color:"#5d4037",
      vocab:[
        {word:"Sit down, please.", ru:"–°–∞–¥–∏—Ç–µ—Å—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.", emoji:"ü™ë", tts:"Sit down, please."},
        {word:"Stand up!", ru:"–í—Å—Ç–∞–Ω—å—Ç–µ!", emoji:"üßç", tts:"Stand up!"},
        {word:"Don't talk.", ru:"–ù–µ —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–π—Ç–µ.", emoji:"ü§ê", tts:"Don't talk."},
        {word:"next to", ru:"—Ä—è–¥–æ–º —Å", emoji:"‚û°Ô∏è", tts:"next to"},
        {word:"in front of", ru:"–ø–µ—Ä–µ–¥", emoji:"‚¨ÜÔ∏è", tts:"in front of"},
        {word:"on", ru:"–Ω–∞", emoji:"üìç", tts:"on"}
      ],
      grammar:{
        rule:"Teachers give classroom instructions. We also talk about where things are.",
        formula:"Sit down. Don't talk.<br>The rubber is next to the pencil case.",
        examples:[
          "Stand up, please.",
          "The book is on the desk."
        ]
      },
      reading:{
        dialogue:`Teacher: Sit down, class. Don't talk.<br>
The rubber is next to the pencil case.<br>
The book is on the desk.`,
        questions:[
          {q:"1) The teacher says 'Sit __, class.'", options:["up","down","in"], answer:"down"},
          {q:"2) The teacher says 'Don't __.'", options:["run","talk","read"], answer:"talk"},
          {q:"3) The rubber is __ the pencil case.", options:["next to","on","in"], answer:"next to"},
          {q:"4) The book is __ the desk.", options:["next to","under","on"], answer:"on"},
          {q:"5) These sentences are about the __.", options:["playground","classroom","street"], answer:"classroom"}
        ]
      },
      worksheets:{
        ws1:[
          {sentence:"1) The teacher says '__ down, class.'", options:["Sit","Stand"], answer:"Sit"},
          {sentence:"2) The teacher says '__ up!'", options:["Sit","Stand"], answer:"Stand"},
          {sentence:"3) '__ talk.'", options:["Don't","Please"], answer:"Don't"}
        ],
        ws2:[
          {emoji:"üßç", options:["Stand up!","Sit down, please.","Don't talk."], answer:"Stand up!"},
          {emoji:"ü™ë", options:["Stand up!","Sit down, please.","Don't talk."], answer:"Sit down, please."},
          {emoji:"ü§ê", options:["Stand up!","Sit down, please.","Don't talk."], answer:"Don't talk."}
        ],
        ws3:[
          {sentence:"The book is __ the desk.", options:["on","next to","in front of"], answer:"on"},
          {sentence:"The rubber is __ the pencil case.", options:["in front of","next to","on"], answer:"next to"},
          {sentence:"The chair is __ the table.", options:["under","next to","in"], answer:"next to"}
        ],
        ws4:[
          {sentence:"1) The teacher says 'Don't talk.'", options:["True","False"], answer:"True"},
          {sentence:"2) The rubber is on the desk.", options:["True","False"], answer:"False"},
          {sentence:"3) The classroom is in the story.", options:["True","False"], answer:"True"}
        ]
      }
    }
  ];

  // ====== LOGIN & MENU ======
  function show(id){
    ["loginScreen","menuScreen","lessonScreen","teacherScreen"].forEach(sec=>{
      document.getElementById(sec).classList.add("hidden");
    });
    document.getElementById(id).classList.remove("hidden");
  }

  function handleLogin(){
    const name = document.getElementById("loginName").value.trim();
    const pin = document.getElementById("loginPin").value.trim();

    if(pin === TEACHER_PIN){
      currentUser = {name: name || "Teacher", role:"teacher"};
      document.getElementById("teacherMenuBlock").classList.remove("hidden");
      renderMenu();
      show("menuScreen");
      return;
    }

    if(pin === STUDENT_PIN){
      if(!allowedStudents.includes(name)){
        alert("This name is not in the student list. Use format like '3E S1'.");
        return;
      }
      currentUser = {name, role:"student"};
      document.getElementById("teacherMenuBlock").classList.add("hidden");
      renderMenu();
      show("menuScreen");
      return;
    }

    alert("Wrong PIN.");
  }

  function renderMenu(){
    document.getElementById("helloUser").textContent =
      currentUser.role==="teacher"
        ? "Hello, Teacher!"
        : `Hello, ${currentUser.name}!`;

    const totalStars = getTotalStars();
    document.getElementById("totalStarsText").textContent =
      `Total stars in all lessons: ${totalStars} ‚≠ê`;

    const list = document.getElementById("lessonList");
    list.innerHTML = "";
    lessons.forEach(lesson=>{
      const stars = getLessonStar(lesson.id);
      const btn = document.createElement("button");
      btn.className = "lesson-btn";
      btn.style.borderLeft = `8px solid ${lesson.color}`;
      btn.onclick = ()=>openLesson(lesson.id);
      btn.innerHTML = `
        <div>
          <div class="lesson-btn-title">${lesson.title}</div>
          <div class="small-note">${lesson.subtitle}</div>
        </div>
        <div>
          <span class="pill">${stars} ‚≠ê</span>
        </div>
      `;
      list.appendChild(btn);
    });
  }

  function askAI(){
    const q = document.getElementById("aiQuestion").value.trim();
    const ans = document.getElementById("aiAnswer");
    if(!q){
      ans.textContent = "Write your question first.";
      return;
    }
    ans.textContent = "AI Bayan: Think about Unit 1 ‚Äì use greetings, numbers, colours and simple sentences. (Here you can later connect a real AI endpoint.)";
  }

  // ====== LESSON RENDERING ======
  function openLesson(id){
    currentLessonId = id;
    const lesson = lessons.find(l=>l.id===id);
    if(!lesson) return;

    const headerBox = document.getElementById("lessonHeaderBox");
    headerBox.style.background = lesson.color;

    document.getElementById("lessonTitle").textContent = lesson.title;
    document.getElementById("lessonSubtitle").textContent = lesson.subtitle;

    const stars = getLessonStar(id);
    document.getElementById("lessonStarsText").textContent =
      `You have ${stars} ‚≠ê in this lesson.`;

    const content = document.getElementById("lessonContent");
    content.innerHTML = "";

    // VOCABULARY
    if(lesson.vocab && lesson.vocab.length){
      const card = document.createElement("section");
      card.className = "card";
      card.innerHTML = `<h2>üß† VOCABULARY ‚Äì Picture words</h2>
        <p>Tap the speaker to hear AI Bayan say the word in English.</p>`;
      const grid = document.createElement("div");
      grid.className = "vocab-grid";
      lesson.vocab.forEach((v,i)=>{
        const vcard = document.createElement("div");
        vcard.className = "vocab-card";
        vcard.innerHTML = `
          <div class="vocab-emoji">${v.emoji||"üìñ"}</div>
          <div class="vocab-word">${v.word}</div>
          <div class="vocab-ru">${v.ru||""}</div>
          <button class="btn say-btn" onclick="sayWord('${id}',${i})">üîä Say it</button>
        `;
        grid.appendChild(vcard);
      });
      card.appendChild(grid);
      content.appendChild(card);
    }

    // GRAMMAR
    if(lesson.grammar){
      const card = document.createElement("section");
      card.className = "card";
      card.innerHTML = `
        <h2>üìò GRAMMAR ‚Äì Key rule</h2>
        <div class="grammar-box">
          <div class="grammar-rule">${lesson.grammar.rule}</div>
          <div class="grammar-formula">${lesson.grammar.formula}</div>
          <ul class="examples-list">
            ${lesson.grammar.examples.map(e=>`<li>${e}</li>`).join("")}
          </ul>
        </div>
      `;
      content.appendChild(card);
    }

    // SONG (karaoke)
    if(lesson.song){
      const card = document.createElement("section");
      card.className = "card karaoke-box";
      card.innerHTML = `
        <h2>üéµ SONG ‚Äì ${lesson.song.title}</h2>
        <p>Tap <strong>Play song</strong> and sing with AI Bayan like karaoke.</p>
        <div class="karaoke-lines">
          ${lesson.song.lines.map((line,i)=>`
            <div class="karaoke-line" data-line="${i}">${line}</div>
          `).join("")}
        </div>
        <div style="margin-top:10px;">
          <button class="btn" onclick="playSongKaraoke('${id}')">‚ñ∂ Play song</button>
          <button class="btn btn-outline" onclick="stopSongKaraoke()">‚èπ Stop</button>
        </div>
      `;
      content.appendChild(card);
    }

    // READING
    if(lesson.reading){
      const card = document.createElement("section");
      card.className = "card";
      card.innerHTML = `<h2>üìñ READING ‚Äì Mini dialogue</h2>`;
      const dialog = document.createElement("div");
      dialog.className = "reading-dialogue";
      dialog.innerHTML = lesson.reading.dialogue;
      card.appendChild(dialog);

      const qWrap = document.createElement("div");
      lesson.reading.questions.forEach((qObj,idx)=>{
        const row = document.createElement("div");
        row.className = "q-item";
        row.innerHTML = `
          <div>${qObj.q}</div>
          <select class="ws-select" data-section="reading" data-index="${idx}">
            <option value="">-- choose --</option>
            ${qObj.options.map(opt=>`<option value="${opt}">${opt}</option>`).join("")}
          </select>
        `;
        qWrap.appendChild(row);
      });
      card.appendChild(qWrap);
      content.appendChild(card);
    }

    // WORKSHEETS
    buildWorksheets(content, lesson);

    // Update bottom text and button
    const attemptsKey = getAttemptsKey(id);
    const already = localStorage.getItem(attemptsKey);
    const saveBtn = document.getElementById("saveResultBtn");
    if(already){
      document.getElementById("lessonCompleteText").textContent =
        "You have already saved your result for this lesson. One try only.";
      saveBtn.disabled = true;
    }else{
      document.getElementById("lessonCompleteText").textContent =
        "Do all worksheets, then press 'Save Result'.";
      saveBtn.disabled = false;
    }

    show("lessonScreen");
  }

  function buildWorksheets(container, lesson){
    const ws = lesson.worksheets || {};
    const card = document.createElement("section");
    card.className = "card";
    card.innerHTML = `<h2>üìÑ WORKSHEETS (4 tasks)</h2>`;
    const inner = document.createElement("div");
    card.appendChild(inner);

    // WS1 ‚Äì Grammar choose
    if(ws.ws1 && ws.ws1.length){
      const sec = document.createElement("div");
      sec.innerHTML = `<h3>Worksheet 1 ‚Äì Grammar (choose)</h3>`;
      ws.ws1.forEach((item,idx)=>{
        const row = document.createElement("div");
        row.className = "ws-row";
        row.innerHTML = `
          <label class="ws-label">${item.sentence}</label>
          <select class="ws-select" data-ws="ws1" data-index="${idx}">
            <option value="">-- choose --</option>
            ${item.options.map(opt=>`<option value="${opt}">${opt}</option>`).join("")}
          </select>
        `;
        sec.appendChild(row);
      });
      sec.innerHTML += `<button class="btn" onclick="checkWorksheet('ws1')">Check ‚úî</button>
                        <div class="status-text" id="status-ws1"></div>`;
      inner.appendChild(sec);
    }

    // WS2 ‚Äì Matching picture and word
    if(ws.ws2 && ws.ws2.length){
      const sec = document.createElement("div");
      sec.style.marginTop = "16px";
      sec.innerHTML = `<h3>Worksheet 2 ‚Äì Matching picture and word</h3>
        <p>Choose the correct word for each picture.</p>`;
      ws.ws2.forEach((item,idx)=>{
        const row = document.createElement("div");
        row.className = "match-row";
        row.innerHTML = `
          <div class="match-emoji">${item.emoji||"üìò"}</div>
          <select class="ws-select" data-ws="ws2" data-index="${idx}">
            <option value="">-- choose --</option>
            ${item.options.map(opt=>`<option value="${opt}">${opt}</option>`).join("")}
          </select>
        `;
        sec.appendChild(row);
      });
      sec.innerHTML += `<button class="btn" onclick="checkWorksheet('ws2')">Check ‚úî</button>
                        <div class="status-text" id="status-ws2"></div>`;
      inner.appendChild(sec);
    }

    // WS3 ‚Äì Vocabulary quiz
    if(ws.ws3 && ws.ws3.length){
      const sec = document.createElement("div");
      sec.style.marginTop = "16px";
      sec.innerHTML = `<h3>Worksheet 3 ‚Äì Mini vocabulary quiz</h3>`;
      ws.ws3.forEach((item,idx)=>{
        const row = document.createElement("div");
        row.className = "ws-row";
        row.innerHTML = `
          <label class="ws-label">${item.sentence}</label>
          <select class="ws-select" data-ws="ws3" data-index="${idx}">
            <option value="">-- choose --</option>
            ${item.options.map(opt=>`<option value="${opt}">${opt}</option>`).join("")}
          </select>
        `;
        sec.appendChild(row);
      });
      sec.innerHTML += `<button class="btn" onclick="checkWorksheet('ws3')">Check ‚úî</button>
                        <div class="status-text" id="status-ws3"></div>`;
      inner.appendChild(sec);
    }

    // WS4 ‚Äì Reading check
    if(ws.ws4 && ws.ws4.length){
      const sec = document.createElement("div");
      sec.style.marginTop = "16px";
      sec.innerHTML = `<h3>Worksheet 4 ‚Äì Reading check</h3>`;
      ws.ws4.forEach((item,idx)=>{
        const row = document.createElement("div");
        row.className = "ws-row";
        row.innerHTML = `
          <label class="ws-label">${item.sentence}</label>
          <select class="ws-select" data-ws="ws4" data-index="${idx}">
            <option value="">-- choose --</option>
            ${item.options.map(opt=>`<option value="${opt}">${opt}</option>`).join("")}
          </select>
        `;
        sec.appendChild(row);
      });
      sec.innerHTML += `<button class="btn" onclick="checkWorksheet('ws4')">Check ‚úî</button>
                        <div class="status-text" id="status-ws4"></div>`;
      inner.appendChild(sec);
    }

    container.appendChild(card);
  }

  // ==== TTS for vocabulary ====
  function sayWord(lessonId, index){
    const lesson = lessons.find(l=>l.id===lessonId);
    if(!lesson) return;
    const item = lesson.vocab[index];
    if(!item) return;
    if(!("speechSynthesis" in window)) return;
    const u = new SpeechSynthesisUtterance(item.tts || item.word);
    u.lang = "en-US";
    window.speechSynthesis.speak(u);
  }

  // ==== Karaoke ====
  function playSongKaraoke(lessonId){
    const lesson = lessons.find(l=>l.id===lessonId);
    if(!lesson || !lesson.song) return;
    stopSongKaraoke();
    karaokeIndex = 0;
    const linesEls = document.querySelectorAll("#lessonScreen .karaoke-line");
    const lines = lesson.song.lines;

    function step(){
      if(karaokeIndex >= lines.length){
        stopSongKaraoke();
        return;
      }
      linesEls.forEach(el=>el.classList.remove("active"));
      const current = linesEls[karaokeIndex];
      if(current) current.classList.add("active");
      if("speechSynthesis" in window){
        const u = new SpeechSynthesisUtterance(lines[karaokeIndex]);
        u.lang = "en-US";
        speechSynthesis.speak(u);
      }
      karaokeIndex++;
      karaokeTimer = setTimeout(step, 2500);
    }
    step();
  }

  function stopSongKaraoke(){
    if(karaokeTimer){ clearTimeout(karaokeTimer); karaokeTimer = null; }
    if("speechSynthesis" in window) speechSynthesis.cancel();
    document.querySelectorAll(".karaoke-line.active")
      .forEach(el=>el.classList.remove("active"));
  }

  // ==== Checking worksheets & reading ====
  function checkWorksheet(wsKey){
    const lesson = lessons.find(l=>l.id===currentLessonId);
    if(!lesson || !lesson.worksheets) return;
    const ws = lesson.worksheets[wsKey] || [];
    let correct = 0;
    let total = ws.length;

    ws.forEach((item,idx)=>{
      const el = document.querySelector(`.ws-select[data-ws="${wsKey}"][data-index="${idx}"]`);
      if(!el) return;
      const val = el.value;
      el.classList.remove("correct","wrong");
      if(!val) return;
      if(val === item.answer){
        correct++;
        el.classList.add("correct");
      }else{
        el.classList.add("wrong");
      }
    });

    const status = document.getElementById(`status-${wsKey}`);
    if(status){
      status.textContent = `Correct: ${correct} / ${total}`;
    }
  }

  function getLessonStar(lessonId){
    if(!currentUser.name) return 0;
    const key = `star_${currentUser.name}_${lessonId}`;
    return parseInt(localStorage.getItem(key) || "0",10);
  }

  function getTotalStars(){
    if(!currentUser.name) return 0;
    let sum = 0;
    lessons.forEach(lesson=>{
      sum += getLessonStar(lesson.id);
    });
    return sum;
  }

  function getAttemptsKey(lessonId){
    if(!currentUser.name) return "";
    return `attempt_${currentUser.name}_${lessonId}`;
  }

  function saveLessonResult(){
    if(!currentUser || currentUser.role!=="student"){
      alert("Only students can save stars.");
      return;
    }
    const attemptsKey = getAttemptsKey(currentLessonId);
    if(localStorage.getItem(attemptsKey)){
      alert("You already saved your result. One try only.");
      return;
    }

    // simple scoring: if student answered something in each worksheet -> 1 star
    const selects = document.querySelectorAll("#lessonScreen .ws-select");
    if(!selects.length){
      alert("No tasks.");
      return;
    }
    let allAnswered = true;
    selects.forEach(sel=>{
      if(!sel.value) allAnswered = false;
    });
    if(!allAnswered){
      alert("Answer all tasks before saving.");
      return;
    }

    // Give 1 star
    const starKey = `star_${currentUser.name}_${currentLessonId}`;
    localStorage.setItem(starKey, "1");
    localStorage.setItem(attemptsKey, "1");

    alert("Result saved! You earned 1 ‚≠ê in this lesson.");
    renderMenu();
    openLesson(currentLessonId); // re-open to update header & button
  }

  function backToMenu(){
    stopSongKaraoke();
    show("menuScreen");
    renderMenu();
  }

  function printLesson(){
    window.print();
  }

  // ===== Teacher Journal =====
  function openTeacherJournal(){
    const wrap = document.getElementById("journalTableWrap");
    const students = allowedStudents.slice();
    let html = `<table class="journal-table"><tr><th>Student</th>`;
    lessons.forEach(l=>{ html += `<th>${l.id}</th>`; });
    html += `<th>Total</th></tr>`;
    students.forEach(name=>{
      let total = 0;
      html += `<tr><td>${name}</td>`;
      lessons.forEach(l=>{
        const val = parseInt(localStorage.getItem(`star_${name}_${l.id}`) || "0",10);
        total += val;
        html += `<td>${val}</td>`;
      });
      html += `<td>${total}</td></tr>`;
    });
    html += `</table>`;
    wrap.innerHTML = html;
    show("teacherScreen");
  }

  function closeTeacherJournal(){
    show("menuScreen");
  }

  // Start on login screen
  show("loginScreen");
</script>
</body>
</html>

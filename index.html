<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Bayan Vocabulary 3 Grade ‚Äî Unit 1</title>
  <style>
    :root{
      --bg:#0b5b4b;
      --bg2:#0a4d40;
      --card:#ffffff;
      --soft:#e9fff7;
      --soft2:#f3fffb;
      --accent:#ffd34d;
      --accent2:#1a7a64;
      --btn:#0e6b58;
      --btn2:#0b5b4b;
      --danger:#b91c1c;
      --ok:#166534;
      --muted:#6b7280;
      --line:#d1d5db;
      --shadow:0 10px 30px rgba(0,0,0,.18);
      --radius:22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 50% -20%, #0f7d66 0%, var(--bg) 50%, #063a31 100%);
      color:#0b1a16;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 12px 34px;
    }

    /* Header */
    .hero{
      background: linear-gradient(180deg, #0b6a58 0%, #084a3e 100%);
      border-radius: 26px;
      padding: 18px 14px 16px;
      box-shadow: var(--shadow);
      border: 2px solid rgba(255,255,255,.12);
      position: relative;
      overflow: hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-60px -80px auto auto;
      width: 260px; height: 260px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,211,77,.9), rgba(255,211,77,.0) 70%);
      filter: blur(0px);
      opacity:.55;
      transform: rotate(10deg);
    }
    .brand{
      display:flex; gap:14px; align-items:center;
    }
    .logo{
      width:92px; height:92px; border-radius: 50%;
      background: #fff;
      border: 6px solid var(--accent);
      box-shadow: 0 12px 24px rgba(0,0,0,.22);
      display:grid; place-items:center;
      font-weight: 800;
      color:#0b5b4b;
      position: relative;
      flex: 0 0 auto;
    }
    .logo span{font-size: 28px; line-height:1;}
    .titleBlock{
      color:#fff;
      padding-top: 2px;
    }
    .titleBlock h1{
      margin:0;
      font-size: 22px;
      letter-spacing:.3px;
      text-transform: uppercase;
    }
    .titleBlock .sub{
      margin-top:6px;
      font-size: 14px;
      opacity:.95;
      font-weight: 600;
    }

    .panel{
      margin-top: 14px;
      background: rgba(255,255,255,.9);
      border-radius: 18px;
      border: 2px solid rgba(255,211,77,.65);
      padding: 14px;
    }

    /* Cards / Buttons */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (min-width: 760px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }
    .btnCard{
      background: var(--card);
      border-radius: 18px;
      padding: 14px 14px;
      border: 2px solid rgba(11,91,75,.18);
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, box-shadow .12s ease;
    }
    .btnCard:active{ transform: scale(.99); }
    .btnCard .left{
      display:flex; gap:10px; align-items:center;
      min-width: 0;
    }
    .pillIcon{
      width:46px; height:46px; border-radius: 14px;
      background: linear-gradient(180deg, #eafff7, #dffef2);
      border: 2px solid rgba(11,91,75,.18);
      display:grid; place-items:center;
      font-size: 22px;
      flex: 0 0 auto;
    }
    .btnCard .txt{
      min-width:0;
    }
    .btnCard .txt .t{
      font-weight: 800;
      font-size: 18px;
      margin:0;
      color:#07352d;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .btnCard .txt .s{
      margin:3px 0 0;
      font-size: 13px;
      color: var(--muted);
      font-weight: 650;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .chip{
      background: linear-gradient(180deg, var(--btn), var(--btn2));
      color:#fff;
      border:none;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 800;
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      cursor:pointer;
    }
    .chip.secondary{
      background: #0f766e;
    }
    .chip.gray{
      background: #1f2937;
    }
    .chip.red{
      background: #b91c1c;
    }

    /* Login */
    .loginRow{
      display:flex;
      flex-wrap: wrap;
      gap:10px;
      align-items:center;
      justify-content: space-between;
    }
    .loginRow .inputs{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
      flex: 1 1 auto;
    }
    input{
      padding: 12px 12px;
      border-radius: 14px;
      border: 2px solid rgba(11,91,75,.18);
      background: #fff;
      font-weight: 700;
      outline: none;
      min-width: 170px;
    }
    input:focus{ border-color: rgba(11,91,75,.55); }

    .statusBar{
      margin-top: 10px;
      display:flex; gap:10px; align-items:center; justify-content: space-between;
      flex-wrap: wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius: 14px;
      padding: 10px 12px;
      background: var(--soft2);
      border: 2px solid rgba(11,91,75,.18);
      font-weight: 850;
      color:#07352d;
    }
    .badge small{font-weight:800; color:var(--muted)}
    .star{
      color: #f59e0b;
      font-size: 18px;
      margin-left: 2px;
    }

    /* Views */
    .view{ display:none; }
    .view.active{ display:block; }

    /* Lesson Page */
    .lessonHead{
      margin-top: 14px;
      background: rgba(255,255,255,.92);
      border-radius: 18px;
      border: 2px solid rgba(255,211,77,.65);
      padding: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,.12);
    }
    .lessonHead h2{
      margin: 0;
      font-size: 22px;
      font-weight: 900;
      color:#07352d;
      text-align:center;
    }
    .lessonHead .sub{
      margin-top: 4px;
      text-align:center;
      color:#0b5b4b;
      font-weight: 850;
    }
    .section{
      margin-top: 12px;
      background: rgba(255,255,255,.92);
      border-radius: 18px;
      border: 2px solid rgba(11,91,75,.16);
      padding: 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,.08);
    }
    .sectionTitle{
      display:flex; align-items:center; gap:10px;
      background: linear-gradient(180deg, #0c6b58, #075446);
      color:#fff;
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 900;
      letter-spacing:.2px;
      width: fit-content;
      margin: 2px 0 10px;
      box-shadow: 0 10px 18px rgba(0,0,0,.16);
    }
    .sectionTitle .mini{opacity:.95; font-weight:900;}
    .cards{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media(min-width: 760px){
      .cards{ grid-template-columns: 1fr 1fr 1fr 1fr; }
    }
    .vcard{
      background: #eafff7;
      border: 2px solid rgba(11,91,75,.14);
      border-radius: 18px;
      padding: 10px;
      text-align:center;
    }
    .pic{
      height:62px;
      border-radius: 14px;
      background:#ffffff;
      border: 2px solid rgba(11,91,75,.10);
      display:grid; place-items:center;
      font-size: 34px;
      margin-bottom: 8px;
      overflow:hidden;
    }
    .vcard h3{
      margin:0;
      font-size: 18px;
      font-weight: 950;
      color:#07352d;
      line-height:1.05;
      text-transform: lowercase;
    }
    .vcard .ru{
      margin-top: 4px;
      color:#1f2937;
      font-weight: 850;
      opacity:.9;
    }
    .say{
      margin-top: 8px;
      width: 100%;
      border:none;
      border-radius: 999px;
      padding: 10px 10px;
      font-weight: 950;
      background: linear-gradient(180deg, #0f766e, #0b5b4b);
      color:#fff;
      cursor:pointer;
      box-shadow: 0 10px 16px rgba(0,0,0,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }

    .grammarBox{
      background: #e7f4ff;
      border: 2px solid rgba(2,132,199,.25);
      border-radius: 18px;
      padding: 12px;
    }
    .grammarBox h3{
      margin: 0 0 6px;
      font-size: 20px;
      font-weight: 950;
      color:#0b4a6b;
    }
    .grammarBox .f{
      margin-top: 8px;
      font-weight: 900;
      color:#0b4a6b;
    }
    .grammarBox ul{
      margin: 8px 0 0 18px;
      font-weight: 800;
    }

    /* Worksheets */
    .wsCard{
      border-radius: 18px;
      border: 2px dashed rgba(11,91,75,.35);
      padding: 12px;
      background: #fff;
      margin-top: 12px;
    }
    .wsCard h4{
      margin:0 0 4px;
      font-size: 20px;
      font-weight: 950;
      color:#07352d;
    }
    .wsCard p{
      margin: 0 0 10px;
      color: #374151;
      font-weight: 750;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
      margin: 7px 0;
    }
    .row label{
      font-weight: 900;
      color:#07352d;
      min-width: 34px;
    }
    .ans{
      flex: 1 1 auto;
      min-width: 180px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 2px solid rgba(11,91,75,.20);
      font-weight: 900;
      text-transform: none;
    }
    .ans.good{ border-color: rgba(22,101,52,.70); background: #ecfdf5; }
    .ans.bad{ border-color: rgba(185,28,28,.70); background: #fef2f2; }

    select{
      flex: 1 1 auto;
      min-width: 180px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 2px solid rgba(11,91,75,.20);
      font-weight: 900;
      background:#fff;
    }
    select.good{ border-color: rgba(22,101,52,.70); background:#ecfdf5; }
    select.bad{ border-color: rgba(185,28,28,.70); background:#fef2f2; }

    .checkRow{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .smallInfo{
      font-weight: 900;
      color:#1f2937;
    }

    .navRow{
      margin-top: 14px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
    }
    .footerBar{
      margin-top: 14px;
      text-align:center;
      color: rgba(255,255,255,.85);
      font-weight: 800;
      font-size: 12px;
      padding: 8px 0 0;
    }

    /* Chat */
    .chatBox{
      background: #0b1f1a;
      border: 2px solid rgba(255,255,255,.12);
      color:#e5fff8;
      border-radius: 18px;
      padding: 12px;
      margin-top: 10px;
    }
    .chatLog{
      height: 220px;
      overflow:auto;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .msg{
      margin: 8px 0;
      display:flex;
      gap:8px;
      align-items:flex-start;
    }
    .bubble{
      padding: 9px 10px;
      border-radius: 14px;
      max-width: 85%;
      font-weight: 750;
      line-height: 1.25;
    }
    .me .bubble{
      background: rgba(255,211,77,.18);
      border: 1px solid rgba(255,211,77,.35);
      margin-left:auto;
    }
    .bot .bubble{
      background: rgba(34,197,94,.14);
      border: 1px solid rgba(34,197,94,.28);
    }
    .chatSend{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
    }
    .chatSend input{
      flex: 1 1 auto;
      min-width: 220px;
    }

    /* Teacher */
    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 2px solid rgba(11,91,75,.18);
      background:#fff;
    }
    th, td{
      padding: 10px 8px;
      border-bottom: 1px solid rgba(17,24,39,.08);
      text-align:left;
      font-weight: 800;
    }
    th{ background: #eafff7; color:#07352d; }
    td small{ color: var(--muted); font-weight: 800; }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- HERO -->
    <div class="hero">
      <div class="brand">
        <div class="logo" id="logoBtn" title="AI Bayan">
          <span>AI</span>
        </div>
        <div class="titleBlock">
          <h1>AI Bayan Vocabulary 3 Grade</h1>
          <div class="sub">Unit 1 ‚Äî Hello English! (8 lessons) ‚Ä¢ Student PIN 2844 ‚Ä¢ Teacher PIN 3244</div>
        </div>
      </div>

      <div class="panel">
        <div class="loginRow">
          <div class="inputs">
            <input id="loginInput" type="text" inputmode="text" autocomplete="off" placeholder="Login" />
            <input id="pinInput" type="password" inputmode="numeric" autocomplete="off" placeholder="PIN" />
          </div>
          <button class="chip" id="btnLogin">Enter</button>
        </div>

        <div class="statusBar">
          <div class="badge" id="whoBadge">Not logged in</div>
          <div class="badge" id="starsBadge">Total stars: 0 <span class="star">‚òÖ</span></div>
        </div>

        <!-- MAIN MENU buttons -->
        <div class="grid" style="margin-top:12px;">
          <div class="btnCard" id="goUnit1">
            <div class="left">
              <div class="pillIcon">üìò</div>
              <div class="txt">
                <p class="t">Unit 1 ‚Äî Hello English!</p>
                <p class="s">Open 8 lessons</p>
              </div>
            </div>
            <button class="chip secondary">Open</button>
          </div>

          <div class="btnCard" id="goChat">
            <div class="left">
              <div class="pillIcon">ü§ñ</div>
              <div class="txt">
                <p class="t">AI Bayan Chat</p>
                <p class="s">Only in Main Menu</p>
              </div>
            </div>
            <button class="chip secondary">Chat</button>
          </div>

          <div class="btnCard" id="goTeacher">
            <div class="left">
              <div class="pillIcon">üìã</div>
              <div class="txt">
                <p class="t">Teacher Journal</p>
                <p class="s">Students progress & stars</p>
              </div>
            </div>
            <button class="chip gray">Open</button>
          </div>

          <div class="btnCard" id="btnLogout">
            <div class="left">
              <div class="pillIcon">üö™</div>
              <div class="txt">
                <p class="t">Log out</p>
                <p class="s">Clear current session</p>
              </div>
            </div>
            <button class="chip red">Exit</button>
          </div>
        </div>

        <div class="footerBar" id="footerInfo">Students: 3EL1‚Äì3EL15</div>
      </div>
    </div>

    <!-- VIEW: UNIT 1 LESSON LIST -->
    <div class="view" id="viewUnit">
      <div class="lessonHead">
        <h2>Unit 1 ‚Äî Hello English!</h2>
        <div class="sub" id="unitSub">Choose a lesson</div>
      </div>

      <div class="grid" id="lessonList"></div>

      <div class="navRow">
        <button class="chip" id="backToMenu1">‚Üê Back to Main Menu</button>
        <button class="chip secondary" id="printUnit">Print Unit 1</button>
      </div>
    </div>

    <!-- VIEW: LESSON PAGE -->
    <div class="view" id="viewLesson">
      <div class="lessonHead">
        <h2 id="lessonTitle">Lesson</h2>
        <div class="sub" id="lessonTopic">Topic</div>
        <div class="sub" id="lessonStars">You have 0 ‚òÖ in this lesson.</div>
      </div>

      <div class="section">
        <div class="sectionTitle">üß† <span class="mini">VOCABULARY ‚Äî Picture Dictionary</span></div>
        <div class="cards" id="vocabCards"></div>
      </div>

      <div class="section">
        <div class="sectionTitle">üìò <span class="mini">GRAMMAR ‚Äî Key Rule</span></div>
        <div class="grammarBox" id="grammarBox"></div>
      </div>

      <div class="section">
        <div class="sectionTitle">üìù <span class="mini">WORKSHEETS (4 tasks)</span></div>
        <div id="worksheets"></div>
      </div>

      <div class="navRow">
        <button class="chip" id="backToUnit">‚Üê Back</button>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="chip secondary" id="btnPrintLesson">Print</button>
          <button class="chip" id="btnSaveLesson">Save Result ‚úì</button>
        </div>
      </div>
    </div>

    <!-- VIEW: CHAT (MAIN MENU ONLY) -->
    <div class="view" id="viewChat">
      <div class="lessonHead">
        <h2>AI Bayan Chat</h2>
        <div class="sub">Ask about Unit 1: greetings, alphabet, numbers, colours, classroom instructions</div>
      </div>

      <div class="chatBox">
        <div class="chatLog" id="chatLog"></div>
        <div class="chatSend">
          <input id="chatInput" type="text" autocomplete="off" placeholder="Type your question..." />
          <button class="chip secondary" id="chatSendBtn">Send</button>
          <button class="chip gray" id="chatClearBtn">Clear</button>
        </div>
      </div>

      <div class="navRow">
        <button class="chip" id="backToMenuChat">‚Üê Back to Main Menu</button>
      </div>
    </div>

    <!-- VIEW: TEACHER -->
    <div class="view" id="viewTeacher">
      <div class="lessonHead">
        <h2>Teacher Journal</h2>
        <div class="sub">Unit 1 ‚Äî stars & last login</div>
      </div>

      <div class="section">
        <div class="sectionTitle">üìä <span class="mini">Students</span></div>
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Student</th>
                <th>Total ‚òÖ</th>
                <th>Unit 1 ‚òÖ</th>
                <th>Last login</th>
              </tr>
            </thead>
            <tbody id="teacherRows"></tbody>
          </table>
        </div>
      </div>

      <div class="navRow">
        <button class="chip" id="backToMenuTeacher">‚Üê Back to Main Menu</button>
        <button class="chip secondary" id="refreshTeacher">Refresh</button>
      </div>
    </div>

  </div>

<script>
/* =========================
   DATA ‚Äî UNIT 1 (8 lessons)
   Based exactly on your photos
========================= */

const STUDENT_PIN = "2844";
const TEACHER_PIN = "3244";
const CLASS_PREFIX = "3EL";
const STUDENTS = Array.from({length:15}, (_,i)=> `${CLASS_PREFIX}${i+1}`); // 3EL1..3EL15

function colorDot(hex){
  return `<div style="width:48px;height:48px;border-radius:14px;background:${hex};border:2px solid rgba(0,0,0,.08)"></div>`;
}

const UNIT1 = {
  id: 1,
  title: "Unit 1 ‚Äî Hello English!",
  lessons: [
    {
      id: 1,
      title: "Lesson 1 ‚Äî Hello!",
      topic: "Greetings and names",
      vocab: [
        { en:"hello", ru:"–ø—Ä–∏–≤–µ—Ç", icon:"üëã" },
        { en:"goodbye", ru:"–ø–æ–∫–∞", icon:"üëã" },
        { en:"how are you?", ru:"–∫–∞–∫ –¥–µ–ª–∞?", icon:"‚ùì" },
        { en:"i'm fine, thank you", ru:"—è –≤ –ø–æ—Ä—è–¥–∫–µ, —Å–ø–∞—Å–∏–±–æ", icon:"üòä" },
        { en:"what's your name?", ru:"–∫–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?", icon:"ü™™" },
        { en:"my name's ‚Ä¶", ru:"–º–µ–Ω—è –∑–æ–≤—É—Ç ‚Ä¶", icon:"üó£Ô∏è" },
      ],
      grammar: {
        title: "Hello, hello!",
        explain: 'We can greet and say our name.',
        formula: 'Hello. ‚Üí What‚Äôs your name? ‚Üí My name‚Äôs ‚Ä¶ ‚Üí Goodbye.',
        examples: [
          "Hello! What's your name?",
          "My name's Rosy.",
          "How are you? I'm fine, thank you.",
          "Goodbye!"
        ]
      }
    },

    {
      id: 2,
      title: "Lesson 2 ‚Äî Alphabet",
      topic: "The alphabet & spelling your name",
      vocab: [
        { en:"a b c", ru:"–∞–ª—Ñ–∞–≤–∏—Ç", icon:"üî§" },
        { en:"spell", ru:"–ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç—å –ø–æ –±—É–∫–≤–∞–º", icon:"üìù" },
        { en:"my name's ‚Ä¶", ru:"–º–µ–Ω—è –∑–æ–≤—É—Ç ‚Ä¶", icon:"üó£Ô∏è" },
        { en:"what's your name?", ru:"–∫–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?", icon:"‚ùì" },
      ],
      grammar: {
        title: "Spell your name",
        explain: 'We can spell our name with letters.',
        formula: 'My name‚Äôs ‚Ä¶ ‚Üí (S-A-M).',
        examples: [
          "My name‚Äôs Saken. S-A-K-E-N.",
          "My name‚Äôs Galikhan. G-A-L-I-K-H-A-N."
        ]
      }
    },

    {
      id: 3,
      title: "Lesson 3 ‚Äî Numbers 1‚Äì10",
      topic: "one to ten",
      vocab: [
        { en:"one", ru:"1", icon:"1Ô∏è‚É£" },
        { en:"two", ru:"2", icon:"2Ô∏è‚É£" },
        { en:"three", ru:"3", icon:"3Ô∏è‚É£" },
        { en:"four", ru:"4", icon:"4Ô∏è‚É£" },
        { en:"five", ru:"5", icon:"5Ô∏è‚É£" },
        { en:"six", ru:"6", icon:"6Ô∏è‚É£" },
        { en:"seven", ru:"7", icon:"7Ô∏è‚É£" },
        { en:"eight", ru:"8", icon:"8Ô∏è‚É£" },
        { en:"nine", ru:"9", icon:"9Ô∏è‚É£" },
        { en:"ten", ru:"10", icon:"üîü" },
      ],
      grammar: {
        title: "How old are you?",
        explain: 'We ask and answer about age.',
        formula: 'How old are you? ‚Üí I‚Äôm + number.',
        examples: [
          "How old are you?",
          "I'm ten."
        ]
      }
    },

    {
      id: 4,
      title: "Lesson 4 ‚Äî Numbers 11‚Äì20",
      topic: "eleven to twenty",
      vocab: [
        { en:"eleven", ru:"11", icon:"1Ô∏è‚É£1Ô∏è‚É£" },
        { en:"twelve", ru:"12", icon:"1Ô∏è‚É£2Ô∏è‚É£" },
        { en:"thirteen", ru:"13", icon:"1Ô∏è‚É£3Ô∏è‚É£" },
        { en:"fourteen", ru:"14", icon:"1Ô∏è‚É£4Ô∏è‚É£" },
        { en:"fifteen", ru:"15", icon:"1Ô∏è‚É£5Ô∏è‚É£" },
        { en:"sixteen", ru:"16", icon:"1Ô∏è‚É£6Ô∏è‚É£" },
        { en:"seventeen", ru:"17", icon:"1Ô∏è‚É£7Ô∏è‚É£" },
        { en:"eighteen", ru:"18", icon:"1Ô∏è‚É£8Ô∏è‚É£" },
        { en:"nineteen", ru:"19", icon:"1Ô∏è‚É£9Ô∏è‚É£" },
        { en:"twenty", ru:"20", icon:"2Ô∏è‚É£0Ô∏è‚É£" },
      ],
      grammar: {
        title: "I‚Äôm ‚Ä¶",
        explain: 'We say our age with numbers.',
        formula: 'I‚Äôm + number.',
        examples: [
          "I'm fifteen.",
          "I'm twenty."
        ]
      }
    },

    {
      id: 5,
      title: "Lesson 5 ‚Äî Colours",
      topic: "identify colours",
      vocab: [
        { en:"red", ru:"–∫—Ä–∞—Å–Ω—ã–π", html: colorDot("#ef4444") },
        { en:"yellow", ru:"–∂—ë–ª—Ç—ã–π", html: colorDot("#facc15") },
        { en:"pink", ru:"—Ä–æ–∑–æ–≤—ã–π", html: colorDot("#fb7185") },
        { en:"purple", ru:"—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π", html: colorDot("#a855f7") },
        { en:"blue", ru:"—Å–∏–Ω–∏–π", html: colorDot("#3b82f6") },
        { en:"green", ru:"–∑–µ–ª—ë–Ω—ã–π", html: colorDot("#22c55e") },
        { en:"orange", ru:"–æ—Ä–∞–Ω–∂–µ–≤—ã–π", html: colorDot("#f97316") },
        { en:"brown", ru:"–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π", html: colorDot("#8b5a2b") },
        { en:"white", ru:"–±–µ–ª—ã–π", html: colorDot("#ffffff") },
        { en:"grey", ru:"—Å–µ—Ä—ã–π", html: colorDot("#9ca3af") },
        { en:"black", ru:"—á—ë—Ä–Ω—ã–π", html: colorDot("#111827") },
      ],
      grammar: {
        title: "It‚Äôs ‚Ä¶ (colour)",
        explain: 'We name a colour.',
        formula: 'It‚Äôs + colour.',
        examples: [
          "Twelve is red.",
          "Twenty is grey."
        ]
      }
    },

    {
      id: 6,
      title: "Lesson 6 ‚Äî Classroom instructions",
      topic: "listen and do",
      vocab: [
        { en:"sit down", ru:"—Å—è–¥—å", icon:"ü™ë" },
        { en:"stand up", ru:"–≤—Å—Ç–∞–Ω—å", icon:"üßç" },
        { en:"listen", ru:"—Å–ª—É—à–∞–π", icon:"üëÇ" },
        { en:"don't talk", ru:"–Ω–µ —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–π", icon:"ü§´" },
        { en:"walk", ru:"–∏–¥–∏", icon:"üö∂" },
        { en:"don't run", ru:"–Ω–µ –±–µ–≥–∏", icon:"‚úã" },
      ],
      grammar: {
        title: "Classroom commands",
        explain: 'We use short commands in class.',
        formula: 'Verb! / Don‚Äôt + verb!',
        examples: [
          "Sit down!",
          "Stand up!",
          "Don‚Äôt talk!",
          "Don‚Äôt run!"
        ]
      }
    },

    {
      id: 7,
      title: "Lesson 7 ‚Äî About you (Project lesson)",
      topic: "name ‚Ä¢ age ‚Ä¢ country",
      vocab: [
        { en:"what's your name?", ru:"–∫–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?", icon:"‚ùì" },
        { en:"how old are you?", ru:"—Å–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç?", icon:"üéÇ" },
        { en:"where are you from?", ru:"–æ—Ç–∫—É–¥–∞ —Ç—ã?", icon:"üåç" },
        { en:"i'm from Kazakhstan", ru:"—è –∏–∑ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞", icon:"üá∞üáø" },
      ],
      grammar: {
        title: "Questions about you",
        explain: 'We ask and answer personal questions.',
        formula: "What‚Äôs your name? / How old are you? / Where are you from?",
        examples: [
          "My name‚Äôs Azere.",
          "I‚Äôm nine.",
          "I‚Äôm from Kazakhstan."
        ]
      }
    },

    {
      id: 8,
      title: "Lesson 8 ‚Äî Project (poster) & review",
      topic: "make a poster about you",
      vocab: [
        { en:"my name's ‚Ä¶", ru:"–º–µ–Ω—è –∑–æ–≤—É—Ç ‚Ä¶", icon:"üó£Ô∏è" },
        { en:"i'm ‚Ä¶", ru:"–º–Ω–µ ‚Ä¶", icon:"üéÇ" },
        { en:"i'm from ‚Ä¶", ru:"—è –∏–∑ ‚Ä¶", icon:"üåç" },
        { en:"my favourite colour is ‚Ä¶", ru:"–º–æ–π –ª—é–±–∏–º—ã–π —Ü–≤–µ—Ç ‚Ä¶", icon:"üé®" },
      ],
      grammar: {
        title: "Poster sentences",
        explain: "Use these sentences for your poster.",
        formula: "My name‚Äôs ‚Ä¶ | I‚Äôm ‚Ä¶ | I‚Äôm from ‚Ä¶ | My favourite colour is ‚Ä¶",
        examples: [
          "My name‚Äôs Birzhan.",
          "I‚Äôm ten.",
          "I‚Äôm from Kazakhstan.",
          "My favourite colour is red."
        ]
      }
    },
  ]
};

/* =========================
   STORAGE KEYS
========================= */
const KEY = {
  session: "aib3_session",
  students: "aib3_students_db",
  chat: "aib3_chat_log"
};

function nowStr(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function loadDB(){
  const raw = localStorage.getItem(KEY.students);
  if(raw) return JSON.parse(raw);
  const db = {};
  for(const s of STUDENTS){
    db[s] = { totalStars:0, unitStars:{1:0}, lessonStars:{}, lastLogin:"‚Äî" };
  }
  localStorage.setItem(KEY.students, JSON.stringify(db));
  return db;
}
function saveDB(db){ localStorage.setItem(KEY.students, JSON.stringify(db)); }
function getSession(){
  const raw = localStorage.getItem(KEY.session);
  return raw ? JSON.parse(raw) : null;
}
function setSession(s){ localStorage.setItem(KEY.session, JSON.stringify(s)); }
function clearSession(){ localStorage.removeItem(KEY.session); }

/* =========================
   SIMPLE TTS
========================= */
function speak(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = 0.95;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch(e){}
}

/* =========================
   HELPERS: worksheets generator
========================= */
function pickWords(lesson){
  // choose up to 6 "real" words (skip very long phrases sometimes)
  const words = lesson.vocab
    .map(v => v.en.toLowerCase().trim())
    .filter(w => w.length >= 3)
    .filter(w => !w.includes("‚Ä¶"));
  // unique
  const uniq = [...new Set(words)];
  return uniq.slice(0, 6);
}
function makeMissing(word){
  // remove 1-2 letters (not first)
  const w = word.replace(/[^a-z]/g,"");
  if(w.length < 4) return {q: word, a: word};
  const i = Math.min( Math.max(1, Math.floor(w.length/2)-1), w.length-2 );
  const j = Math.min(w.length-2, i+1);
  const chars = w.split("");
  chars[i] = "_";
  if(w.length >= 6) chars[j] = "_";
  return { q: chars.join(""), a: w };
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function norm(s){
  return (s||"").toLowerCase().trim().replace(/\s+/g," ");
}

/* =========================
   UI STATE
========================= */
const el = id => document.getElementById(id);
const views = {
  menu: null,
  unit: el("viewUnit"),
  lesson: el("viewLesson"),
  chat: el("viewChat"),
  teacher: el("viewTeacher"),
};
let currentLesson = null;
let db = loadDB();

function showView(v){
  [views.unit, views.lesson, views.chat, views.teacher].forEach(x => x.classList.remove("active"));
  if(v) v.classList.add("active");
  window.scrollTo({top:0, behavior:"smooth"});
}

/* =========================
   LOGIN LOGIC
========================= */
function updateTopBadges(){
  db = loadDB();
  const sess = getSession();
  if(!sess){
    el("whoBadge").textContent = "Not logged in";
    el("starsBadge").innerHTML = `Total stars: 0 <span class="star">‚òÖ</span>`;
    return;
  }
  if(sess.role === "teacher"){
    el("whoBadge").textContent = "Teacher";
    el("starsBadge").innerHTML = `Total stars: ‚Äî <span class="star">‚òÖ</span>`;
    return;
  }
  const s = sess.login;
  const st = db[s] || {totalStars:0};
  el("whoBadge").textContent = `Hello, ${s}!`;
  el("starsBadge").innerHTML = `Total stars: ${st.totalStars||0} <span class="star">‚òÖ</span>`;
}

function doLogin(){
  const login = el("loginInput").value.trim();
  const pin = el("pinInput").value.trim();

  // teacher
  if(pin === TEACHER_PIN){
    setSession({role:"teacher", login:"teacher", at: nowStr()});
    updateTopBadges();
    alert("Teacher mode ‚úì");
    return;
  }

  // student
  if(pin !== STUDENT_PIN){
    alert("Wrong PIN");
    return;
  }
  if(!STUDENTS.includes(login)){
    alert("Wrong login");
    return;
  }

  const sdb = loadDB();
  sdb[login] = sdb[login] || { totalStars:0, unitStars:{1:0}, lessonStars:{}, lastLogin:"‚Äî" };
  sdb[login].lastLogin = nowStr();
  saveDB(sdb);

  setSession({role:"student", login, at: nowStr()});
  updateTopBadges();
  alert("Welcome ‚úì");
}

function doLogout(){
  clearSession();
  el("loginInput").value="";
  el("pinInput").value="";
  updateTopBadges();
  showView(null);
}

/* =========================
   MAIN MENU ACTIONS
========================= */
el("btnLogin").addEventListener("click", doLogin);
el("btnLogout").addEventListener("click", doLogout);

el("goUnit1").addEventListener("click", ()=>{
  const sess = getSession();
  if(!sess || sess.role!=="student"){
    alert("Student login first");
    return;
  }
  renderUnitList();
  showView(views.unit);
});

el("goChat").addEventListener("click", ()=>{
  const sess = getSession();
  if(!sess || sess.role!=="student"){
    alert("Student login first");
    return;
  }
  renderChat();
  showView(views.chat);
});

el("goTeacher").addEventListener("click", ()=>{
  const sess = getSession();
  if(!sess || sess.role!=="teacher"){
    alert("Teacher PIN first");
    return;
  }
  renderTeacher();
  showView(views.teacher);
});

/* =========================
   UNIT LIST
========================= */
function lessonStarsFor(login, lessonId){
  const sdb = loadDB();
  const st = sdb[login];
  if(!st) return 0;
  return (st.lessonStars && st.lessonStars[`1-${lessonId}`]) ? st.lessonStars[`1-${lessonId}`] : 0;
}

function renderUnitList(){
  const sess = getSession();
  if(!sess || sess.role!=="student") return;

  el("unitSub").textContent = `Student: ${sess.login}`;
  const wrap = el("lessonList");
  wrap.innerHTML = "";

  UNIT1.lessons.forEach(ls=>{
    const stars = lessonStarsFor(sess.login, ls.id);
    const card = document.createElement("div");
    card.className = "btnCard";
    card.innerHTML = `
      <div class="left">
        <div class="pillIcon">üìó</div>
        <div class="txt">
          <p class="t">${ls.title}</p>
          <p class="s">${ls.topic} ‚Ä¢ ${stars} ‚òÖ</p>
        </div>
      </div>
      <button class="chip secondary">Open</button>
    `;
    card.addEventListener("click", ()=>{
      openLesson(ls.id);
    });
    wrap.appendChild(card);
  });
}

el("backToMenu1").addEventListener("click", ()=> showView(null));
el("printUnit").addEventListener("click", ()=>{
  window.print();
});

/* =========================
   LESSON PAGE
========================= */
function openLesson(id){
  const sess = getSession();
  if(!sess || sess.role!=="student"){
    alert("Student login first");
    return;
  }
  currentLesson = UNIT1.lessons.find(x=>x.id===id);
  if(!currentLesson) return;

  el("lessonTitle").textContent = `${currentLesson.title}`;
  el("lessonTopic").textContent = currentLesson.topic;

  const s = sess.login;
  const stars = lessonStarsFor(s, currentLesson.id);
  el("lessonStars").innerHTML = `You have ${stars} <span class="star">‚òÖ</span> in this lesson.`;

  renderVocab(currentLesson);
  renderGrammar(currentLesson);
  renderWorksheets(currentLesson);

  showView(views.lesson);
}

function renderVocab(lesson){
  const box = el("vocabCards");
  box.innerHTML = "";
  lesson.vocab.forEach(v=>{
    const card = document.createElement("div");
    card.className = "vcard";
    const pic = v.html ? v.html : `<div class="pic">${v.icon || "üü©"}</div>`;
    card.innerHTML = `
      ${v.html ? `<div class="pic" style="background:#fff">${v.html}</div>` : `<div class="pic">${v.icon||"üü©"}</div>`}
      <h3>${v.en}</h3>
      <div class="ru">${v.ru || ""}</div>
      <button class="say" type="button">üîä Say it</button>
    `;
    card.querySelector(".say").addEventListener("click", ()=> speak(v.en));
    box.appendChild(card);
  });
}

function renderGrammar(lesson){
  const g = lesson.grammar;
  el("grammarBox").innerHTML = `
    <h3>${g.title}</h3>
    <div style="font-weight:850;color:#0b4a6b">${g.explain}</div>
    <div class="f">Formula: ${g.formula}</div>
    <div class="f" style="margin-top:10px">Examples:</div>
    <ul>
      ${g.examples.map(e=> `<li>${e}</li>`).join("")}
    </ul>
  `;
}

function renderWorksheets(lesson){
  const host = el("worksheets");
  host.innerHTML = "";

  // DATA
  const words = pickWords(lesson);
  const baseWords = words.slice(0,4);

  /* Worksheet 1 ‚Äî Missing letters */
  const missItems = baseWords.map(w => makeMissing(w));
  const ws1 = document.createElement("div");
  ws1.className = "wsCard";
  ws1.innerHTML = `
    <h4>Worksheet 1 ‚Äî Missing letters</h4>
    <p>Write the missing letters. (Use small letters.)</p>
    ${missItems.map((it,i)=>`
      <div class="row">
        <label>${i+1})</label>
        <div style="font-weight:950; min-width:110px">${it.q}</div>
        <input class="ans" data-key="ws1-${i}" placeholder="answer" />
      </div>
    `).join("")}
    <div class="checkRow">
      <button class="chip secondary" data-act="check-ws1">Check ‚úì</button>
      <div class="smallInfo" id="ws1score">Correct: 0 / ${missItems.length}</div>
    </div>
  `;
  host.appendChild(ws1);

  /* Worksheet 2 ‚Äî Matching picture and word (dropdown) */
  const matchPool = shuffle(baseWords);
  const ws2 = document.createElement("div");
  ws2.className = "wsCard";

  // pick 3 vocab items that have icon/html
  const pics = lesson.vocab.filter(v => v.icon || v.html).slice(0,3);
  const words2 = shuffle(pics.map(v => v.en.toLowerCase()));

  ws2.innerHTML = `
    <h4>Worksheet 2 ‚Äî Matching picture and word</h4>
    <p>Choose the correct word for each picture.</p>
    ${pics.map((v,i)=>{
      const options = shuffle(words2).map(w=> `<option value="${w}">${w}</option>`).join("");
      const picHtml = v.html ? v.html : (v.icon || "üü©");
      return `
        <div class="row">
          <label>${i+1})</label>
          <div class="pillIcon" style="width:44px;height:44px;border-radius:14px;background:#fff">
            ${v.html ? v.html : v.icon}
          </div>
          <select data-key="ws2-${i}">
            <option value="">--choose--</option>
            ${options}
          </select>
        </div>
      `;
    }).join("")}
    <div class="checkRow">
      <button class="chip secondary" data-act="check-ws2">Check ‚úì</button>
      <div class="smallInfo" id="ws2score">Correct: 0 / ${pics.length}</div>
    </div>
  `;
  host.appendChild(ws2);

  /* Worksheet 3 ‚Äî Mini crossword (write the word) */
  // for different lessons, make simple clues
  const clues = makeCluesForLesson(lesson);
  const ws3 = document.createElement("div");
  ws3.className = "wsCard";
  ws3.innerHTML = `
    <h4>Worksheet 3 ‚Äî Mini crossword (write the word)</h4>
    <p>Read the clue. Write one word.</p>
    ${clues.map((c,i)=>`
      <div class="row">
        <label>${i+1})</label>
        <div style="font-weight:900; min-width:260px">${c.q}</div>
        <input class="ans" data-key="ws3-${i}" placeholder="answer" />
      </div>
    `).join("")}
    <div class="checkRow">
      <button class="chip secondary" data-act="check-ws3">Check ‚úì</button>
      <div class="smallInfo" id="ws3score">Correct: 0 / ${clues.length}</div>
    </div>
  `;
  host.appendChild(ws3);

  /* Worksheet 4 ‚Äî Choose the correct word (dropdown) */
  const ws4Items = makeChooseItems(lesson);
  const ws4 = document.createElement("div");
  ws4.className = "wsCard";
  ws4.innerHTML = `
    <h4>Worksheet 4 ‚Äî Choose the correct word</h4>
    <p>Choose the correct word to complete each sentence.</p>
    ${ws4Items.map((it,i)=>{
      const opts = it.options.map(o=> `<option value="${o}">${o}</option>`).join("");
      return `
        <div class="row">
          <label>${i+1})</label>
          <div style="font-weight:900; min-width:260px">${it.sentence}</div>
          <select data-key="ws4-${i}">
            <option value="">--choose--</option>
            ${opts}
          </select>
        </div>
      `;
    }).join("")}
    <div class="checkRow">
      <button class="chip secondary" data-act="check-ws4">Check ‚úì</button>
      <div class="smallInfo" id="ws4score">Correct: 0 / ${ws4Items.length}</div>
    </div>
  `;
  host.appendChild(ws4);

  // Attach check handlers
  host.querySelectorAll("[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act = btn.getAttribute("data-act");
      if(act==="check-ws1") checkWS1(missItems);
      if(act==="check-ws2") checkWS2(pics);
      if(act==="check-ws3") checkWS3(clues);
      if(act==="check-ws4") checkWS4(ws4Items);
      updateLessonStarsPreview();
    });
  });
}

function makeCluesForLesson(lesson){
  const id = lesson.id;

  if(id===1){
    return [
      {q:"You say it when you meet a friend.", a:"hello"},
      {q:"You say it when you leave.", a:"goodbye"},
      {q:"A question: ____ are you?", a:"how"},
    ];
  }
  if(id===2){
    return [
      {q:"The first letter.", a:"a"},
      {q:"The last letter.", a:"z"},
      {q:"Write your name with letters: ____ your name.", a:"spell"},
    ];
  }
  if(id===3){
    return [
      {q:"1", a:"one"},
      {q:"5", a:"five"},
      {q:"10", a:"ten"},
    ];
  }
  if(id===4){
    return [
      {q:"11", a:"eleven"},
      {q:"15", a:"fifteen"},
      {q:"20", a:"twenty"},
    ];
  }
  if(id===5){
    return [
      {q:"The colour of the sun.", a:"yellow"},
      {q:"The colour of the sky.", a:"blue"},
      {q:"The colour of snow.", a:"white"},
    ];
  }
  if(id===6){
    return [
      {q:"In class: ____ down.", a:"sit"},
      {q:"In class: ____ up.", a:"stand"},
      {q:"Don‚Äôt ____.", a:"talk"},
    ];
  }
  if(id===7){
    return [
      {q:"Question: What‚Äôs your ____?", a:"name"},
      {q:"Answer: I‚Äôm ____ Kazakhstan.", a:"from"},
      {q:"Question: How ____ are you?", a:"old"},
    ];
  }
  // lesson 8
  return [
    {q:"My name‚Äôs ____.", a:"birzhan"},
    {q:"I‚Äôm ____.", a:"ten"},
    {q:"My favourite colour is ____.", a:"red"},
  ];
}

function makeChooseItems(lesson){
  const id = lesson.id;

  if(id===1){
    return [
      {sentence:"Hello! What's your ____?", options:["name","blue","ten"], correct:"name"},
      {sentence:"How are you? I'm ____.", options:["fine","purple","from"], correct:"fine"},
      {sentence:"____!", options:["Goodbye","Yellow","Two"], correct:"Goodbye"},
    ];
  }
  if(id===2){
    return [
      {sentence:"My name's Saken. S-A-K-E-N. I ____ my name.", options:["spell","run","paint"], correct:"spell"},
      {sentence:"A, B, C ‚Äî the ____.", options:["alphabet","colour","number"], correct:"alphabet"},
      {sentence:"What's your ____?", options:["name","green","twenty"], correct:"name"},
    ];
  }
  if(id===3){
    return [
      {sentence:"How old are you? I'm ____.", options:["ten","red","from"], correct:"ten"},
      {sentence:"____ is 2.", options:["Two","Blue","Hello"], correct:"Two"},
      {sentence:"____ is 7.", options:["Seven","Green","Goodbye"], correct:"Seven"},
    ];
  }
  if(id===4){
    return [
      {sentence:"____ is 11.", options:["Eleven","Five","Purple"], correct:"Eleven"},
      {sentence:"I'm ____.", options:["fifteen","yellow","spell"], correct:"fifteen"},
      {sentence:"____ is 20.", options:["Twenty","Two","Red"], correct:"Twenty"},
    ];
  }
  if(id===5){
    return [
      {sentence:"It‚Äôs ____.", options:["red","ten","from"], correct:"red"},
      {sentence:"Twenty is ____.", options:["grey","blue","name"], correct:"grey"},
      {sentence:"It‚Äôs ____.", options:["yellow","spell","sit down"], correct:"yellow"},
    ];
  }
  if(id===6){
    return [
      {sentence:"____ down!", options:["Sit","Red","Two"], correct:"Sit"},
      {sentence:"Don't ____!", options:["talk","yellow","spell"], correct:"talk"},
      {sentence:"____ up!", options:["Stand","Seven","From"], correct:"Stand"},
    ];
  }
  if(id===7){
    return [
      {sentence:"Where are you ____?", options:["from","blue","ten"], correct:"from"},
      {sentence:"I'm ____ Kazakhstan.", options:["from","fine","red"], correct:"from"},
      {sentence:"How ____ are you?", options:["old","purple","spell"], correct:"old"},
    ];
  }
  // lesson 8 project/review
  return [
    {sentence:"My name's ____.", options:["Birzhan","Yellow","Fifteen"], correct:"Birzhan"},
    {sentence:"I'm ____.", options:["ten","blue","spell"], correct:"ten"},
    {sentence:"My favourite colour is ____.", options:["red","sit down","from"], correct:"red"},
  ];
}

/* CHECKERS */
function checkWS1(items){
  const host = el("worksheets");
  let ok=0;
  items.forEach((it,i)=>{
    const inp = host.querySelector(`[data-key="ws1-${i}"]`);
    const val = norm(inp.value).replace(/[^a-z]/g,"");
    const ans = norm(it.a).replace(/[^a-z]/g,"");
    inp.classList.remove("good","bad");
    if(val === ans){
      ok++; inp.classList.add("good");
    }else{
      inp.classList.add("bad");
    }
  });
  el("ws1score").textContent = `Correct: ${ok} / ${items.length}`;
}

function checkWS2(pics){
  const host = el("worksheets");
  let ok=0;
  pics.forEach((v,i)=>{
    const sel = host.querySelector(`[data-key="ws2-${i}"]`);
    const val = norm(sel.value);
    const ans = norm(v.en);
    sel.classList.remove("good","bad");
    if(val && val === ans){
      ok++; sel.classList.add("good");
    }else{
      sel.classList.add("bad");
    }
  });
  el("ws2score").textContent = `Correct: ${ok} / ${pics.length}`;
}

function checkWS3(clues){
  const host = el("worksheets");
  let ok=0;
  clues.forEach((c,i)=>{
    const inp = host.querySelector(`[data-key="ws3-${i}"]`);
    const val = norm(inp.value).replace(/[^a-z]/g,"");
    const ans = norm(c.a).replace(/[^a-z]/g,"");
    inp.classList.remove("good","bad");
    if(val === ans){
      ok++; inp.classList.add("good");
    }else{
      inp.classList.add("bad");
    }
  });
  el("ws3score").textContent = `Correct: ${ok} / ${clues.length}`;
}

function checkWS4(items){
  const host = el("worksheets");
  let ok=0;
  items.forEach((it,i)=>{
    const sel = host.querySelector(`[data-key="ws4-${i}"]`);
    const val = norm(sel.value);
    const ans = norm(it.correct);
    sel.classList.remove("good","bad");
    if(val && val === ans){
      ok++; sel.classList.add("good");
    }else{
      sel.classList.add("bad");
    }
  });
  el("ws4score").textContent = `Correct: ${ok} / ${items.length}`;
}

/* STARS: each worksheet correct count -> stars
   ws1 max 4, ws2 max 3, ws3 max 3, ws4 max 3  => max 13 stars
*/
function computeStarsFromUI(){
  const getScore = (id) => {
    const t = el(id)?.textContent || "";
    const m = t.match(/Correct:\s*(\d+)\s*\/\s*(\d+)/i);
    return m ? {ok:+m[1], total:+m[2]} : {ok:0,total:0};
  };
  const s1 = getScore("ws1score").ok;
  const s2 = getScore("ws2score").ok;
  const s3 = getScore("ws3score").ok;
  const s4 = getScore("ws4score").ok;
  return s1+s2+s3+s4;
}

function updateLessonStarsPreview(){
  const sess = getSession();
  if(!sess || sess.role!=="student" || !currentLesson) return;
  const tempStars = computeStarsFromUI();
  el("lessonStars").innerHTML = `You have ${tempStars} <span class="star">‚òÖ</span> in this lesson (not saved).`;
}

/* SAVE RESULT */
function saveLessonResult(){
  const sess = getSession();
  if(!sess || sess.role!=="student"){
    alert("Student login first");
    return;
  }
  if(!currentLesson) return;

  const stars = computeStarsFromUI();

  const sdb = loadDB();
  const login = sess.login;
  sdb[login] = sdb[login] || { totalStars:0, unitStars:{1:0}, lessonStars:{}, lastLogin:"‚Äî" };

  const key = `1-${currentLesson.id}`;
  const prev = sdb[login].lessonStars[key] || 0;

  // Replace stars for this lesson (not add) ‚Äî like your app
  sdb[login].lessonStars[key] = stars;

  // Recompute unit1 stars sum
  let unitSum = 0;
  UNIT1.lessons.forEach(ls=>{
    unitSum += (sdb[login].lessonStars[`1-${ls.id}`] || 0);
  });
  sdb[login].unitStars[1] = unitSum;

  // Total stars = sum of all lessons (currently only unit1)
  sdb[login].totalStars = unitSum;

  saveDB(sdb);
  updateTopBadges();

  el("lessonStars").innerHTML = `You have ${stars} <span class="star">‚òÖ</span> in this lesson.`;
  alert("Saved ‚úì");
}

el("btnSaveLesson").addEventListener("click", saveLessonResult);

el("btnPrintLesson").addEventListener("click", ()=> window.print());
el("backToUnit").addEventListener("click", ()=>{
  renderUnitList();
  showView(views.unit);
});

/* =========================
   CHAT (OFFLINE SIMPLE BOT)
========================= */
function loadChat(){
  const raw = localStorage.getItem(KEY.chat);
  return raw ? JSON.parse(raw) : [];
}
function saveChat(log){
  localStorage.setItem(KEY.chat, JSON.stringify(log));
}
function renderChat(){
  const log = loadChat();
  const box = el("chatLog");
  box.innerHTML = "";
  if(log.length===0){
    addChat("bot", "Hello! I‚Äôm AI Bayan ü§ñ Ask me about Unit 1.");
  }else{
    log.forEach(m=>{
      const d = document.createElement("div");
      d.className = `msg ${m.role}`;
      d.innerHTML = `<div class="bubble">${escapeHtml(m.text)}</div>`;
      box.appendChild(d);
    });
    box.scrollTop = box.scrollHeight;
  }
}
function addChat(role, text){
  const log = loadChat();
  log.push({role, text, at: Date.now()});
  saveChat(log);
  renderChat();
}
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function botReply(q){
  const t = norm(q);

  // simple rule-based
  if(t.includes("name")){
    return `Use: "What‚Äôs your name?" ‚Üí "My name‚Äôs ‚Ä¶"`;
  }
  if(t.includes("how old") || t.includes("age")){
    return `Use: "How old are you?" ‚Üí "I‚Äôm ten."`;
  }
  if(t.includes("from") || t.includes("country")){
    return `Use: "Where are you from?" ‚Üí "I‚Äôm from Kazakhstan."`;
  }
  if(t.includes("colour") || t.includes("color") || t.includes("red") || t.includes("blue")){
    return `Use: "It‚Äôs red / blue / green ‚Ä¶" Example: "Twenty is grey."`;
  }
  if(t.includes("alphabet") || t.includes("spell")){
    return `Spell your name: "My name‚Äôs ‚Ä¶" ‚Üí "S-A-K-E-N."`;
  }
  if(t.includes("sit") || t.includes("stand") || t.includes("listen")){
    return `Classroom commands: "Sit down!", "Stand up!", "Listen!", "Don‚Äôt talk!", "Don‚Äôt run!"`;
  }
  if(t.includes("hello") || t.includes("goodbye")){
    return `Greeting: "Hello! How are you?" ‚Üí "I‚Äôm fine, thank you." ‚Üí "Goodbye!"`;
  }
  return `Try one question: name / age / from / colours / alphabet / classroom instructions.`;
}

function sendChat(){
  const sess = getSession();
  if(!sess || sess.role!=="student"){
    alert("Student login first");
    return;
  }
  const msg = el("chatInput").value.trim();
  if(!msg) return;
  el("chatInput").value = "";
  addChat("me", msg);
  setTimeout(()=> addChat("bot", botReply(msg)), 200);
}

el("chatSendBtn").addEventListener("click", sendChat);
el("chatInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendChat(); });
el("chatClearBtn").addEventListener("click", ()=>{
  localStorage.removeItem(KEY.chat);
  renderChat();
});
el("backToMenuChat").addEventListener("click", ()=> showView(null));

/* =========================
   TEACHER JOURNAL
========================= */
function renderTeacher(){
  const sdb = loadDB();
  const body = el("teacherRows");
  body.innerHTML = "";
  for(const s of STUDENTS){
    const st = sdb[s] || {totalStars:0, unitStars:{1:0}, lastLogin:"‚Äî"};
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${s}</td>
      <td>${st.totalStars||0} ‚òÖ</td>
      <td>${(st.unitStars && st.unitStars[1]) ? st.unitStars[1] : 0} ‚òÖ</td>
      <td><small>${st.lastLogin || "‚Äî"}</small></td>
    `;
    body.appendChild(tr);
  }
}
el("refreshTeacher").addEventListener("click", renderTeacher);
el("backToMenuTeacher").addEventListener("click", ()=> showView(null));

/* =========================
   INIT
========================= */
updateTopBadges();

// Lesson list render only when opened
// Print: browser print

// Logo click = back to menu
el("logoBtn").addEventListener("click", ()=> showView(null));
</script>
</body>
</html>

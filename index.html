<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ENGLISH WITH AI BAYAN ‚Äì Grade 3 FF3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ‚Äì –∑–µ–ª—ë–Ω–æ–µ */
      --menu-bg-dark:#1b5e20;
      --menu-bg:#2e7d32;
      --menu-soft:#a5d6a7;
      --accent-gold:#ffd54f;
      --text-main:#05313a;

      /* –¶–≤–µ—Ç–∞ —é–Ω–∏—Ç–æ–≤ (–¥–ª—è —Ä–∞–º–æ–∫ –∫–Ω–æ–ø–æ–∫ —é–Ω–∏—Ç–æ–≤) */
      --u1:#1565c0;
      --u2:#ef6c00;
      --u3:#d81b60;
      --u4:#039be5;
      --u5:#8e24aa;
      --u6:#c62828;
      --u7:#6d4c41;
      --u8:#9e9d24;
    }

    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#004d40;
      color:var(--text-main);
    }
    .app{
      max-width:900px;
      margin:0 auto;
      min-height:100vh;
      background:linear-gradient(180deg,var(--menu-bg-dark),var(--menu-bg));
      padding-bottom:2.5rem;
    }

    header.app-header{
      text-align:center;
      color:#e8f5e9;
      padding:1.1rem 0 0.7rem;
    }
    .logo-circle{
      width:140px;height:140px;border-radius:50%;
      border:6px solid var(--accent-gold);
      margin:0 auto 0.6rem;
      background:#fff;
      background-size:cover;
      background-position:center;
      background-image:url("img/ai-bayan-logo.png"); /* —Ç–≤–æ–π –ª–æ–≥–æ—Ç–∏–ø */
    }
    header h1{
      font-size:1.4rem;
      font-weight:800;
      letter-spacing:.08em;
    }
    header h2{font-size:.9rem;margin-top:.15rem;opacity:.9;}

    .card{
      background:#fff;
      border-radius:18px;
      margin:.8rem 1rem;
      padding:1rem 1.1rem;
      border:3px solid var(--accent-gold);
      box-shadow:0 6px 14px rgba(0,0,0,.25);
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:.5rem 1.2rem;
      background:#00695c;
      color:#fff;
      font-weight:600;
      font-size:.95rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:.25rem;
      box-shadow:0 4px 8px rgba(0,0,0,.3);
      transition:transform .08s,box-shadow .08s,opacity .12s;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 5px 12px rgba(0,0,0,.35);}
    .btn:active{transform:translateY(1px);box-shadow:0 2px 6px rgba(0,0,0,.25);opacity:.9;}
    .btn-secondary{background:#01579b;}
    .btn-danger{background:#c62828;}

    .input{
      width:100%;
      padding:.55rem .75rem;
      border-radius:10px;
      border:2px solid #b0bec5;
      font-size:1rem;
      margin-top:.25rem;
    }

    .center{text-align:center;}
    .hidden{display:none;}

    .section-title{
      font-weight:800;
      font-size:.98rem;
      display:flex;
      align-items:center;
      gap:.4rem;
      margin-bottom:.3rem;
    }

    .menu-greeting{font-size:1.05rem;text-align:center;margin-bottom:.1rem;}
    .menu-stars{font-size:.95rem;text-align:center;font-weight:700;color:#fdd835;}

    /* –Æ–Ω–∏—Ç—ã –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é */
    .unit-list{display:flex;flex-direction:column;gap:.6rem;margin-top:.7rem;}
    .unit-row{
      border-radius:16px;
      padding:.6rem .8rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:#e8f5e9;
      border:2px solid var(--accent-gold);
      flex-wrap:wrap;
      gap:.4rem;
    }
    .unit-left{display:flex;align-items:center;gap:.45rem;}
    .unit-icon{font-size:1.4rem;}
    .unit-text small{font-size:.8rem;color:#004d40;display:block;}
    .unit-actions{display:flex;gap:.3rem;align-items:center;}
    .unit-stars-mini{font-size:.85rem;font-weight:700;color:#f57f17;}

    /* –õ–∏—Å—Ç —É—Ä–æ–∫–æ–≤ –≤–Ω—É—Ç—Ä–∏ —é–Ω–∏—Ç–∞ */
    .lesson-list{display:flex;flex-direction:column;gap:.55rem;margin-top:.6rem;}
    .lesson-btn{
      border-radius:16px;
      padding:.55rem .75rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      color:#fff;
      cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,.25);
    }
    .lesson-btn-title{font-size:.9rem;font-weight:700;}
    .lesson-btn-sub{font-size:.78rem;opacity:.9;}
    .lesson-btn-stars{font-size:.85rem;font-weight:700;}

    /* –≠–∫—Ä–∞–Ω —É—Ä–æ–∫–∞ */
    .vocab-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
      gap:.6rem;
      margin-top:.25rem;
    }
    .vocab-card{
      border-radius:16px;
      padding:.45rem .5rem .6rem;
      text-align:center;
      background:#e8f5e9;
      border:2px solid #c8e6c9;
    }
    .vocab-img{
      width:70px;height:70px;
      background:#fff;
      border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-size:2rem;
      margin:0 auto .25rem;
      border:1px solid #cfd8dc;
    }
    .vocab-word{font-weight:700;}
    .vocab-ru{font-size:.8rem;color:#455a64;}
    .vocab-sound-btn{margin-top:.2rem;font-size:.8rem;padding:.2rem .7rem;}

    .grammar-box{
      border-radius:16px;
      padding:.7rem .8rem;
      background:#e3f2fd;
      border:2px solid #90caf9;
      font-size:.9rem;
      line-height:1.4;
    }
    .grammar-box em{font-style:italic;}
    .grammar-examples{margin-top:.35rem;font-size:.88rem;}
    .grammar-examples li{margin-left:1.1rem;}

    .reading-box{
      border-radius:16px;
      padding:.7rem .8rem;
      background:#fff3e0;
      border:2px solid #ffcc80;
      font-size:.9rem;
      line-height:1.4;
    }
    .reading-dialogue{margin-bottom:.4rem;}
    .reading-question{margin-top:.3rem;font-size:.86rem;}

    textarea{
      width:100%;
      min-height:80px;
      padding:.55rem .7rem;
      border-radius:10px;
      border:1px solid #b0bec5;
      resize:vertical;
      font-size:.9rem;
    }

    .worksheet-block{
      border-radius:16px;
      border:1px dashed #b0bec5;
      padding:.6rem .7rem .8rem;
      margin-top:.5rem;
      background:#fafafa;
      font-size:.9rem;
    }
    .worksheet-block h4{font-size:.95rem;margin-bottom:.3rem;}
    .task-item{margin-bottom:.4rem;}
    .task-item input[type=text],
    .task-item select{
      border-radius:8px;
      border:1px solid #90a4ae;
      padding:.25rem .4rem;
      min-width:120px;
      margin-top:.12rem;
      font-size:.9rem;
    }

    .check-row{
      margin-top:.4rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.6rem;
      flex-wrap:wrap;
    }
    .result-msg{font-size:.83rem;}

    .nav-row{
      margin-top:.8rem;
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:.4rem;
    }

    .small-note{
      text-align:center;
      color:#e0f2f1;
      font-size:.78rem;
      margin:.4rem 0;
    }

    .correct-icon{color:#2e7d32;font-weight:700;margin-left:.2rem;}
    .wrong-icon{color:#c62828;font-weight:700;margin-left:.2rem;}

    /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–≤–µ–∑–¥—ã */
    .star-burst{
      position:fixed;
      left:50%;
      bottom:12%;
      transform:translateX(-50%);
      font-size:2.4rem;
      animation:starBurst 1s ease-out forwards;
      pointer-events:none;
      z-index:9999;
    }
    @keyframes starBurst{
      0%{opacity:0;transform:translate(-50%,20px) scale(.5);}
      20%{opacity:1;transform:translate(-50%,0) scale(1);}
      80%{opacity:1;transform:translate(-50%,-40px) scale(1.2);}
      100%{opacity:0;transform:translate(-50%,-60px) scale(.4);}
    }

    @media(max-width:600px){
      .card{margin:.7rem .6rem;}
      header h1{font-size:1.15rem;}
      .logo-circle{width:120px;height:120px;}
    }

    /* –ü–µ—á–∞—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ lessonScreen */
    @media print{
      body{background:#fff;}
      .app-header,#loginScreen,#menuScreen,#unitScreen,#teacherScreen,.small-note{display:none!important;}
      #lessonScreen{margin:0;border:none;box-shadow:none;}
      .nav-row{display:none!important;}
    }
  </style>
</head>
<body>
<div class="app">
  <header class="app-header">
    <div class="logo-circle"></div>
    <h1>ENGLISH WITH AI BAYAN</h1>
    <h2>Grade 3 ‚Äì Family and Friends 3</h2>
  </header>

  <!-- LOGIN -->
  <section id="loginScreen" class="card">
    <h3 class="center" style="margin-bottom:.4rem;">English with AI Bayan</h3>
    <p class="center" style="font-size:.9rem;margin-bottom:.5rem;">
      Enter your name and PIN:
    </p>
    <label>Student name or Teacher:</label>
    <input id="loginName" class="input" placeholder="3E S1, 3E S2... or Teacher" />
    <label style="margin-top:.5rem;display:block;">PIN:</label>
    <input id="loginPin" type="password" class="input" placeholder="****" />
    <div class="center" style="margin-top:.7rem;">
      <button class="btn" onclick="handleLogin()">Enter</button>
    </div>
    <p class="center" style="font-size:.8rem;margin-top:.45rem;">
      Students PIN: <strong>2844</strong> ¬∑ Teacher PIN: <strong>3244</strong>
    </p>
  </section>

  <!-- MAIN MENU: UNITS + CHAT -->
  <section id="menuScreen" class="card hidden">
    <div id="menuGreeting" class="menu-greeting"></div>
    <div id="menuStars" class="menu-stars"></div>

    <div id="unitList" class="unit-list"></div>

    <!-- AI CHAT –í –ì–õ–ê–í–ù–û–ú –ú–ï–ù–Æ -->
    <div class="card" style="margin:0.8rem 0 0;padding:.7rem .75rem;">
      <div class="section-title">üí¨ AI Bayan Chat (1 question per unit)</div>
      <p style="font-size:.84rem;margin-bottom:.3rem;">
        –í—ã–±–µ—Ä–∏ —é–Ω–∏—Ç, –Ω–∞–ø–∏—à–∏ –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –ø–æ —Ç–µ–º–µ –∏ –æ—Ç–ø—Ä–∞–≤—å. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —é–Ω–∏—Ç–∞ ‚Äì —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å.
      </p>
      <div style="display:flex;gap:.4rem;flex-wrap:wrap;margin-bottom:.35rem;">
        <select id="chatUnitSelect" class="input" style="max-width:220px;padding:.3rem .5rem;">
          <option value="">Choose unit...</option>
        </select>
      </div>
      <textarea id="chatQuestion" placeholder="Ask AI Bayan about this unit..."></textarea>
      <div style="margin-top:.4rem;display:flex;justify-content:space-between;gap:.4rem;flex-wrap:wrap;">
        <button class="btn-secondary btn" onclick="sendChatQuestion()">Send question</button>
      </div>
      <div id="chatInfo" style="font-size:.8rem;margin-top:.3rem;color:#455a64;"></div>
    </div>

    <div style="display:flex;justify-content:center;gap:.5rem;margin-top:.7rem;flex-wrap:wrap;">
      <button class="btn-secondary btn" onclick="openTeacherJournal()">üè´ Teacher's Journal</button>
    </div>
  </section>

  <!-- UNIT SCREEN: LIST OF 8 LESSONS -->
  <section id="unitScreen" class="card hidden">
    <div class="section-title">
      <span id="unitIcon">üìò</span>
      <span id="unitTitle">Unit 1 ‚Äì Hello English!</span>
    </div>
    <div id="unitSubtitle" style="font-size:.88rem;margin-bottom:.3rem;">Overview</div>
    <div id="unitStars" style="font-size:.9rem;font-weight:700;margin-bottom:.4rem;">You have 0 ‚≠ê in this unit.</div>

    <div id="lessonList" class="lesson-list"></div>

    <div class="nav-row" style="margin-top:.9rem;">
      <button class="btn-secondary btn" onclick="goBackToMenu()">‚¨Ö Back to main menu</button>
    </div>
  </section>

  <!-- LESSON SCREEN -->
  <section id="lessonScreen" class="card hidden" style="padding:0;">
    <div id="lessonHeader" style="padding:.8rem .9rem;border-radius:15px 15px 0 0;color:#fff;background:#1565c0;">
      <div class="section-title" style="margin-bottom:.15rem;">
        <span id="lessonIcon">üìö</span>
        <span id="lessonTitle">Unit 1 ‚Äì Lesson 1</span>
      </div>
      <div id="lessonSubtitle" style="font-size:.86rem;opacity:.9;">Greetings and names</div>
      <div id="lessonStars" style="font-size:.9rem;font-weight:700;margin-top:.2rem;">
        You have 0 ‚≠ê in this lesson.
      </div>
    </div>

    <div style="padding:.7rem .9rem 1rem;">
      <!-- VOCAB -->
      <section>
        <div class="section-title">üß† VOCABULARY ‚Äì Picture words</div>
        <p style="font-size:.86rem;margin-bottom:.25rem;">
          Tap the speaker to hear AI Bayan say the word in English.
        </p>
        <div id="vocabGrid" class="vocab-grid"></div>
      </section>

      <!-- GRAMMAR -->
      <section style="margin-top:.7rem;">
        <div class="section-title">üìò GRAMMAR ‚Äì Key rule</div>
        <div id="grammarBox" class="grammar-box"></div>
      </section>

      <!-- READING / MINI DIALOGUE -->
      <section style="margin-top:.7rem;">
        <div class="section-title">üìñ READING ‚Äì Mini dialogue</div>
        <div id="readingBox" class="reading-box"></div>
      </section>

      <!-- WORKSHEETS -->
      <section style="margin-top:.7rem;">
        <div class="section-title">üìÑ WORKSHEETS (4 tasks)</div>

        <div class="worksheet-block" id="ws1Block">
          <h4>Worksheet 1 ‚Äì Vocabulary (write the word)</h4>
          <p style="font-size:.82rem;margin-bottom:.25rem;">Write the missing word.</p>
          <div id="ws1Tasks"></div>
          <div class="check-row">
            <button class="btn" onclick="checkWorksheet('ws1')">Check ‚úÖ</button>
            <div id="ws1Result" class="result-msg"></div>
          </div>
        </div>

        <div class="worksheet-block" id="ws2Block">
          <h4>Worksheet 2 ‚Äì Grammar (choose)</h4>
          <p style="font-size:.82rem;margin-bottom:.25rem;">Choose the correct answer.</p>
          <div id="ws2Tasks"></div>
          <div class="check-row">
            <button class="btn" onclick="checkWorksheet('ws2')">Check ‚úÖ</button>
            <div id="ws2Result" class="result-msg"></div>
          </div>
        </div>

        <div class="worksheet-block" id="ws3Block">
          <h4>Worksheet 3 ‚Äì Phonics / letters</h4>
          <p style="font-size:.82rem;margin-bottom:.25rem;">Write the first letter.</p>
          <div id="ws3Tasks"></div>
          <div class="check-row">
            <button class="btn" onclick="checkWorksheet('ws3')">Check ‚úÖ</button>
            <div id="ws3Result" class="result-msg"></div>
          </div>
        </div>

        <div class="worksheet-block" id="ws4Block">
          <h4>Worksheet 4 ‚Äì Reading check</h4>
          <p style="font-size:.82rem;margin-bottom:.25rem;">Choose True or False.</p>
          <div id="ws4Tasks"></div>
          <div class="check-row">
            <button class="btn" onclick="checkWorksheet('ws4')">Check ‚úÖ</button>
            <div id="ws4Result" class="result-msg"></div>
          </div>
        </div>
      </section>

      <!-- NAV + PRINT + SAVE -->
      <div class="nav-row">
        <button class="btn-secondary btn" onclick="goBackToUnit()">‚¨Ö Back to unit</button>
        <div style="display:flex;gap:.4rem;flex-wrap:wrap;">
          <button class="btn" onclick="window.print()">üñ® Print this lesson</button>
          <button id="saveBtn" class="btn" onclick="saveLessonResult()">Save result ‚úî</button>
        </div>
      </div>
    </div>
  </section>

  <!-- TEACHER -->
  <section id="teacherScreen" class="card hidden">
    <h3 class="center" style="margin-bottom:.4rem;">Teacher's Journal ‚Äì Grade 3</h3>
    <p style="font-size:.84rem;margin-bottom:.4rem;">Total stars saved on this device.</p>
    <div id="teacherTable" style="font-size:.86rem;"></div>
    <div class="center" style="margin-top:.6rem;">
      <button class="btn-secondary btn" onclick="goBackToMenu()">‚¨Ö Back</button>
      <button class="btn-danger btn" style="margin-left:.4rem;" onclick="clearAllData()">Clear all data</button>
    </div>
  </section>

  <p class="small-note">
    Students: 3E S1‚Äì3E S15 ¬∑ Student PIN 2844 ¬∑ Teacher PIN 3244 ¬∑ Main menu ‚Äì green, each unit and lesson has its own colour.
  </p>
</div>

<script>
  const STUDENT_PIN="2844";
  const TEACHER_PIN="3244";
  const STORAGE_KEY="ai_bayan_grade3_units_lessons";

  let currentUser=null;          // {name,isTeacher}
  let currentUnitId=null;        // "u1"..."u8"
  let currentLessonId=null;      // "u1l1", "u1l2" etc

  /* ---------- DATA: Units + Lessons ---------- */
  const units=[
    {
      id:"u1",
      icon:"üëã",
      title:"Unit 1 ‚Äì Hello English!",
      subtitle:"Greetings, alphabet, numbers, colours",
      color:"var(--u1)",
      lessons:[
        {
          id:"u1l1",
          title:"Lesson 1 ‚Äì Greetings & Names",
          subtitle:"Hello, what's your name?",
          color:"#1565c0",   // —Å–∏–Ω–∏–π
          icon:"üòä",
          vocab:[
            {word:"hello",ru:"–ø—Ä–∏–≤–µ—Ç",emoji:"üëã",tts:"hello"},
            {word:"goodbye",ru:"–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è",emoji:"üëã",tts:"goodbye"},
            {word:"name",ru:"–∏–º—è",emoji:"üßí",tts:"name"},
            {word:"teacher",ru:"—É—á–∏—Ç–µ–ª—å",emoji:"üë©‚Äçüè´",tts:"teacher"},
            {word:"friend",ru:"–¥—Ä—É–≥",emoji:"üë´",tts:"friend"}
          ],
          grammar:{
            rule:`We ask about name with <strong>What's your name?</strong> and answer <strong>My name's...</strong>`,
            formula:`Question: What's your name?<br>
Answer: My name's Ayan.`,
            examples:[
              "‚Äì What's your name? ‚Äì My name's Ali.",
              "‚Äì What's her name? ‚Äì Her name's Rosy."
            ]
          },
          reading:{
            dialogue:`‚Äì Hello! What's your name?<br>
‚Äì My name's Tim. What's your name?<br>
‚Äì I'm Rosy. This is our teacher, Miss Jones.<br>
‚Äì Hello, Miss Jones!`,
            questions:[
              {q:"The boy's name is __.",options:["Billy","Tim","Ali"],answer:"Tim"},
              {q:"The teacher's name is __.",options:["Miss Jones","Rosy","Mr Brown"],answer:"Miss Jones"}
            ]
          },
          worksheets:{
            ws1:[
              {prompt:"1) You say this when you meet a friend: __________",answer:"hello"},
              {prompt:"2) You say this when you go home: __________",answer:"goodbye"},
              {prompt:"3) Rosy is Tim's __________.",answer:"friend"}
            ],
            ws2:[
              {
                sentence:"1) ‚Äì __________ your name? ‚Äì My name's Ayan.",
                options:["Where's","What's","How's"],
                answer:"What's"
              },
              {
                sentence:"2) ‚Äì What's her name? ‚Äì __________ Rosy.",
                options:["She's","Her","It's"],
                answer:"She's"
              }
            ],
            ws3:[
              {prompt:"1) ___ for hello",answer:"H"},
              {prompt:"2) ___ for name",answer:"N"}
            ],
            ws4:[
              {
                sentence:"1) Tim and Rosy are in the classroom.",
                options:["True","False"],
                answer:"True"
              },
              {
                sentence:"2) The teacher's name is Mr Brown.",
                options:["True","False"],
                answer:"False"
              }
            ]
          }
        },

        /* –ü—Ä–∏–º–µ—Ä –∑–∞–≥–æ—Ç–æ–≤–æ–∫ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —É—Ä–æ–∫–æ–≤ Unit 1
           (–ø–æ–∫–∞ –±–µ–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ‚Äì –ø–æ—Ç–æ–º –∑–∞–ø–æ–ª–Ω–∏—à—å –ø–æ –∫–Ω–∏–≥–µ) */
        {
          id:"u1l2",
          title:"Lesson 2 ‚Äì Alphabet & Spelling",
          subtitle:"A‚ÄìZ, spell your name",
          color:"#1e88e5",
          icon:"üî§",
          vocab:[],
          grammar:{rule:"",formula:"",examples:[]},
          reading:{dialogue:"(–ø–æ –∫–Ω–∏–≥–µ)",questions:[]},
          worksheets:{ws1:[],ws2:[],ws3:[],ws4:[]}
        },
        {
          id:"u1l3",
          title:"Lesson 3 ‚Äì Song: Hello, hello!",
          subtitle:"Song & actions",
          color:"#5e35b1",
          icon:"üéµ",
          vocab:[],grammar:{rule:"",formula:"",examples:[]},
          reading:{dialogue:"Song text (adapted)",questions:[]},
          worksheets:{ws1:[],ws2:[],ws3:[],ws4:[]}
        },
        {
          id:"u1l4",
          title:"Lesson 4 ‚Äì Numbers 1‚Äì20",
          subtitle:"How old are you?",
          color:"#00897b",
          icon:"üî¢",
          vocab:[],grammar:{rule:"",formula:"",examples:[]},
          reading:{dialogue:"Mini text with ages",questions:[]},
          worksheets:{ws1:[],ws2:[],ws3:[],ws4:[]}
        },
        {
          id:"u1l5",
          title:"Lesson 5 ‚Äì Colours",
          subtitle:"red, blue, green...",
          color:"#8e24aa",
          icon:"üé®",
          vocab:[],grammar:{rule:"",formula:"",examples:[]},
          reading:{dialogue:"Colour dialogue",questions:[]},
          worksheets:{ws1:[],ws2:[],ws3:[],ws4:[]}
        },
        {
          id:"u1l6",
          title:"Lesson 6 ‚Äì Age & Country",
          subtitle:"How old / Where from",
          color:"#c62828",
          icon:"üåç",
          vocab:[],grammar:{rule:"",formula:"",examples:[]},
          reading:{dialogue:"Mini dialogue",questions:[]},
          worksheets:{ws1:[],ws2:[],ws3:[],ws4:[]}
        },
        {
          id:"u1l7",
          title:"Lesson 7 ‚Äì Project: About me",
          subtitle:"My name, age, country",
          color:"#6d4c41",
          icon:"üìú",
          vocab:[],grammar:{rule:"",formula:"",examples:[]},
          reading:{dialogue:"Poster example",questions:[]},
          worksheets:{ws1:[],ws2:[],ws3:[],ws4:[]}
        },
        {
          id:"u1l8",
          title:"Lesson 8 ‚Äì Culture: At my school",
          subtitle:"Classroom rules & prepositions",
          color:"#9e9d24",
          icon:"üè´",
          vocab:[],grammar:{rule:"",formula:"",examples:[]},
          reading:{dialogue:"Culture dialogue",questions:[]},
          worksheets:{ws1:[],ws2:[],ws3:[],ws4:[]}
        }
      ]
    },

    /* Unit 2‚Äì8 ‚Äì –ø–æ–∫–∞ —à–∞–±–ª–æ–Ω—ã, –ø–æ—Ç–æ–º –∑–∞–ø–æ–ª–Ω–∏—à—å –ø–æ –∫–Ω–∏–≥–µ */
    { id:"u2",icon:"üè´",title:"Unit 2 ‚Äì My School",subtitle:"...",color:"var(--u2)",lessons:[] },
    { id:"u3",icon:"üë®‚Äçüë©‚Äçüëß",title:"Unit 3 ‚Äì People I Love",subtitle:"...",color:"var(--u3)",lessons:[] },
    { id:"u4",icon:"üå¶",title:"Unit 4 ‚Äì Weather",subtitle:"...",color:"var(--u4)",lessons:[] },
    { id:"u5",icon:"‚öΩ",title:"Unit 5 ‚Äì My Free Time",subtitle:"...",color:"var(--u5)",lessons:[] },
    { id:"u6",icon:"‚ù§Ô∏è",title:"Unit 6 ‚Äì Health",subtitle:"...",color:"var(--u6)",lessons:[] },
    { id:"u7",icon:"üèô",title:"Unit 7 ‚Äì Buildings",subtitle:"...",color:"var(--u7)",lessons:[] },
    { id:"u8",icon:"‚úàÔ∏è",title:"Unit 8 ‚Äì My Holidays",subtitle:"...",color:"var(--u8)",lessons:[] }
  ];

  /* ---------- helpers ---------- */
  function $(id){return document.getElementById(id);}
  function speak(text){
    if(!("speechSynthesis" in window))return;
    const u=new SpeechSynthesisUtterance(text);
    u.lang="en-US";
    window.speechSynthesis.speak(u);
  }
  function loadData(){
    try{
      const raw=localStorage.getItem(STORAGE_KEY);
      return raw?JSON.parse(raw):{};
    }catch(e){return {};}
  }
  function saveData(data){
    localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
  }
  function getUserRecord(name){
    const data=loadData();
    if(!data[name]){
      data[name]={totalStars:0,lessons:{},chats:{}}; // lessons[lessonId], chats[unitId]
      saveData(data);
    }
    return data[name];
  }

  /* ---------- LOGIN ---------- */
  function handleLogin(){
    const name=$("loginName").value.trim();
    const pin=$("loginPin").value.trim();
    if(!name||!pin){alert("Please enter name and PIN.");return;}

    if(pin===TEACHER_PIN){
      currentUser={name:"Teacher",isTeacher:true};
      $("loginScreen").classList.add("hidden");
      buildTeacherJournal();
      $("teacherScreen").classList.remove("hidden");
      return;
    }
    if(pin!==STUDENT_PIN){alert("Wrong PIN.");return;}

    currentUser={name,isTeacher:false};
    $("loginScreen").classList.add("hidden");
    showMenu();
  }

  /* ---------- MAIN MENU (UNITS) ---------- */
  function showMenu(){
    const ul=$("unitList");
    const sel=$("chatUnitSelect");
    ul.innerHTML="";
    sel.innerHTML='<option value="">Choose unit...</option>';

    const rec=currentUser?getUserRecord(currentUser.name):null;
    if(rec){
      $("menuGreeting").textContent=`Hello, ${currentUser.name}!`;
      $("menuStars").textContent=`Total stars: ${rec.totalStars} ‚≠ê`;
    }

    units.forEach(u=>{
      const unitLessonsIds=(u.lessons||[]).map(l=>l.id);
      let unitStars=0;
      if(rec){
        unitLessonsIds.forEach(id=>{
          const lrec=rec.lessons[id];
          if(lrec)unitStars+=lrec.stars||0;
        });
      }

      const row=document.createElement("div");
      row.className="unit-row";
      row.innerHTML=`
        <div class="unit-left">
          <div class="unit-icon">${u.icon}</div>
          <div class="unit-text">
            <strong>${u.title}</strong>
            <small>${u.subtitle||""}</small>
          </div>
        </div>
        <div class="unit-actions">
          <span class="unit-stars-mini">‚≠ê ${unitStars}</span>
          <button class="btn-secondary btn" onclick="openUnit('${u.id}')">Open</button>
        </div>
      `;
      ul.appendChild(row);

      const opt=document.createElement("option");
      opt.value=u.id;
      const used=rec && rec.chats && rec.chats[u.id];
      opt.textContent=u.title+(used?" (used)":"");
      sel.appendChild(opt);
    });

    $("chatInfo").textContent="";
    $("teacherScreen").classList.add("hidden");
    $("unitScreen").classList.add("hidden");
    $("lessonScreen").classList.add("hidden");
    $("menuScreen").classList.remove("hidden");
  }

  /* ---------- UNIT SCREEN (LIST OF LESSONS) ---------- */
  function openUnit(unitId){
    currentUnitId=unitId;
    const u=units.find(x=>x.id===unitId);
    const rec=getUserRecord(currentUser.name);

    $("unitIcon").textContent=u.icon;
    $("unitTitle").textContent=u.title;
    $("unitSubtitle").textContent=u.subtitle||"";
    // —Å—á–∏—Ç–∞–µ–º –∑–≤–µ–∑–¥–æ—á–∫–∏ –ø–æ —é–Ω–∏—Ç—É
    let unitStars=0;
    (u.lessons||[]).forEach(l=>{
      const lrec=rec.lessons[l.id];
      if(lrec)unitStars+=(lrec.stars||0);
    });
    $("unitStars").textContent=`You have ${unitStars} ‚≠ê in this unit.`;

    const list=$("lessonList");
    list.innerHTML="";
    (u.lessons||[]).forEach((lesson,idx)=>{
      const lrec=rec.lessons[lesson.id]||{stars:0};
      const div=document.createElement("div");
      div.className="lesson-btn";
      div.style.background=lesson.color||u.color;
      div.innerHTML=`
        <div>
          <div class="lesson-btn-title">${lesson.title}</div>
          <div class="lesson-btn-sub">${lesson.subtitle||""}</div>
        </div>
        <div class="lesson-btn-stars">‚≠ê ${lrec.stars||0}</div>
      `;
      div.onclick=()=>openLesson(unitId,lesson.id);
      list.appendChild(div);
    });

    $("menuScreen").classList.add("hidden");
    $("teacherScreen").classList.add("hidden");
    $("lessonScreen").classList.add("hidden");
    $("unitScreen").classList.remove("hidden");
  }

  /* ---------- LESSON SCREEN ---------- */
  function openLesson(unitId,lessonId){
    currentUnitId=unitId;
    currentLessonId=lessonId;
    const u=units.find(x=>x.id===unitId);
    const lesson=(u.lessons||[]).find(l=>l.id===lessonId);
    const rec=getUserRecord(currentUser.name);
    const lrec=rec.lessons[lessonId]||{stars:0,locked:false};

    const header=$("lessonHeader");
    header.style.background=lesson.color||u.color;
    $("lessonIcon").textContent=lesson.icon||u.icon;
    $("lessonTitle").textContent=lesson.title;
    $("lessonSubtitle").textContent=lesson.subtitle||"";
    $("lessonStars").textContent=`You have ${lrec.stars||0} ‚≠ê in this lesson.`;
    $("saveBtn").disabled=!!lrec.locked;
    $("saveBtn").textContent=lrec.locked?"Result saved ‚úî":"Save result ‚úî";

    // VOCAB
    const vg=$("vocabGrid");
    vg.innerHTML="";
    (lesson.vocab||[]).forEach(v=>{
      const card=document.createElement("div");
      card.className="vocab-card";
      card.innerHTML=`
        <div class="vocab-img">${v.emoji||"üìò"}</div>
        <div class="vocab-word">${v.word}</div>
        <div class="vocab-ru">${v.ru}</div>
        <button class="btn vocab-sound-btn"
          onclick="speak('${(v.tts||v.word).replace(/'/g,"\\'")}')">üîä Say it</button>
      `;
      vg.appendChild(card);
    });

    // GRAMMAR
    $("grammarBox").innerHTML=`
      ${lesson.grammar.rule||""}<br>
      <div style="margin-top:.3rem;font-size:.85rem;">${lesson.grammar.formula||""}</div>
      <div class="grammar-examples">
        <strong>${(lesson.grammar.examples||[]).length?"Examples:":""}</strong>
        <ul>${(lesson.grammar.examples||[]).map(e=>`<li>${e}</li>`).join("")}</ul>
      </div>
    `;

    // READING
    const rb=$("readingBox");
    if(lesson.reading && lesson.reading.dialogue){
      const qHTML=(lesson.reading.questions||[]).map((q,i)=>`
        <div class="reading-question">
          ${i+1}) ${q.q}<br>
          <select data-rq="${i}">
            <option value="">--choose--</option>
            ${q.options.map(o=>`<option value="${o}">${o}</option>`).join("")}
          </select>
        </div>`).join("");
      rb.innerHTML=`
        <div class="reading-dialogue">${lesson.reading.dialogue}</div>
        ${qHTML?'<div style="margin-top:.3rem;font-size:.85rem;">Answer the questions:</div>':''}
        ${qHTML}
      `;
    }else{
      rb.innerHTML="(Reading will be here)";
    }

    // WORKSHEETS
    buildWorksheet("ws1");
    buildWorksheet("ws2");
    buildWorksheet("ws3");
    buildWorksheet("ws4");

    $("menuScreen").classList.add("hidden");
    $("unitScreen").classList.add("hidden");
    $("teacherScreen").classList.add("hidden");
    $("lessonScreen").classList.remove("hidden");
  }

  function buildWorksheet(wsKey){
    const lesson=getCurrentLesson();
    const tasks=lesson.worksheets[wsKey]||[];
    const container=$(wsKey+"Tasks");
    container.innerHTML="";
    $(wsKey+"Result").textContent="";
    $(wsKey+"Block").dataset.locked="false";

    tasks.forEach((t,i)=>{
      const div=document.createElement("div");
      div.className="task-item";
      if(wsKey==="ws1"||wsKey==="ws3"){
        div.innerHTML=`
          ${t.prompt}<br>
          <input type="text" data-ws="${wsKey}" data-idx="${i}">
        `;
      }else{
        div.innerHTML=`
          ${t.sentence}<br>
          <select data-ws="${wsKey}" data-idx="${i}">
            <option value="">--choose--</option>
            ${t.options.map(o=>`<option value="${o}">${o}</option>`).join("")}
          </select>
        `;
      }
      container.appendChild(div);
    });
  }

  function getCurrentLesson(){
    const u=units.find(x=>x.id===currentUnitId);
    return (u.lessons||[]).find(l=>l.id===currentLessonId);
  }

  function checkWorksheet(wsKey){
    const block=$(wsKey+"Block");
    if(block.dataset.locked==="true"){
      alert("You already checked this worksheet. Only one try.");
      return;
    }
    const lesson=getCurrentLesson();
    const tasks=lesson.worksheets[wsKey]||[];
    let correct=0;

    tasks.forEach((t,i)=>{
      const el=document.querySelector(`[data-ws="${wsKey}"][data-idx="${i}"]`);
      if(!el)return;
      const val=el.value.trim();
      const ans=(t.answer||"").trim();
      const ok=(wsKey==="ws1"||wsKey==="ws3")
        ? val.toLowerCase()===ans.toLowerCase()
        : val===ans;
      if(ok){
        correct++;
        el.style.borderColor="#2e7d32";
      }else{
        el.style.borderColor="#c62828";
      }
      el.disabled=true;
    });

    const res=$(wsKey+"Result");
    res.innerHTML=`Correct: ${correct}/${tasks.length} ${
      correct===tasks.length && tasks.length>0
        ? '<span class="correct-icon">‚úî +1‚≠ê</span>'
        : correct>0
          ? '<span class="correct-icon">‚úî</span>'
          : '<span class="wrong-icon">‚úñ</span>'
    }`;

    if(correct===tasks.length && tasks.length>0){
      showStar();
    }
    block.dataset.locked="true";
  }

  function showStar(){
    const el=document.createElement("div");
    el.className="star-burst";
    el.textContent="‚≠ê";
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),1000);
  }

  function saveLessonResult(){
    if(!currentUser||currentUser.isTeacher)return;
    const data=loadData();
    const rec=getUserRecord(currentUser.name);
    const lesson=getCurrentLesson();
    let lrec=rec.lessons[currentLessonId]||{stars:0,locked:false};

    if(lrec.locked){
      alert("Result already saved.");
      return;
    }

    let gained=0;
    ["ws1","ws2","ws3","ws4"].forEach(wsKey=>{
      const tasks=lesson.worksheets[wsKey]||[];
      if(!tasks.length)return;
      let allCorrect=true;
      tasks.forEach((t,i)=>{
        const el=document.querySelector(`[data-ws="${wsKey}"][data-idx="${i}"]`);
        if(!el)return;
        const val=el.value.trim();
        const ans=(t.answer||"").trim();
        const ok=(wsKey==="ws1"||wsKey==="ws3")
          ? val.toLowerCase()===ans.toLowerCase()
          : val===ans;
        if(!ok)allCorrect=false;
      });
      if(allCorrect)gained++;
    });

    lrec.stars+=gained;
    lrec.locked=true;
    rec.totalStars+=gained;
    rec.lessons[currentLessonId]=lrec;
    data[currentUser.name]=rec;
    saveData(data);

    $("lessonStars").textContent=`You have ${lrec.stars} ‚≠ê in this lesson.`;
    $("saveBtn").disabled=true;
    $("saveBtn").textContent="Result saved ‚úî";
    alert(`Saved! You earned ${gained} ‚≠ê in this lesson.`);
  }

  function goBackToUnit(){
    if(currentUnitId)openUnit(currentUnitId);
  }
  function goBackToMenu(){showMenu();}

  /* ---------- TEACHER JOURNAL ---------- */
  function buildTeacherJournal(){
    const data=loadData();
    const container=$("teacherTable");
    const names=Object.keys(data);
    if(!names.length){
      container.textContent="No data yet.";
      return;
    }
    // —Å–ª–æ–≤–∞—Ä—å: lessonId -> title
    const lessonTitles={};
    units.forEach(u=>{
      (u.lessons||[]).forEach(l=>{
        lessonTitles[l.id]=`${u.title.replace("Unit ","U")} ${l.title.replace("Lesson ","L")}`;
      });
    });

    let html=`<table style="width:100%;border-collapse:collapse;">
      <tr>
        <th style="border-bottom:1px solid #b0bec5;text-align:left;">Student</th>
        <th style="border-bottom:1px solid #b0bec5;">Total ‚≠ê</th>
        <th style="border-bottom:1px solid #b0bec5;font-size:.8rem;">By lessons</th>
      </tr>`;
    names.forEach(name=>{
      const r=data[name];
      const perLessons=Object.entries(r.lessons||{})
        .map(([id,info])=>{
          const t=lessonTitles[id]||id;
          return `${t}: ${info.stars||0}‚≠ê`;
        }).join("<br>");
      html+=`<tr>
        <td style="border-bottom:1px solid #eceff1;padding:.25rem 0;">${name}</td>
        <td style="border-bottom:1px solid #eceff1;text-align:center;">${r.totalStars}</td>
        <td style="border-bottom:1px solid #eceff1;font-size:.78rem;">${perLessons}</td>
      </tr>`;
    });
    html+="</table>";
    container.innerHTML=html;
  }

  function openTeacherJournal(){
    if(!currentUser||!currentUser.isTeacher){
      alert("Teacher PIN needed.");
      return;
    }
    $("menuScreen").classList.add("hidden");
    $("unitScreen").classList.add("hidden");
    buildTeacherJournal();
    $("teacherScreen").classList.remove("hidden");
  }

  function clearAllData(){
    if(!confirm("Delete all saved stars on this device?"))return;
    localStorage.removeItem(STORAGE_KEY);
    buildTeacherJournal();
  }

  /* ---------- CHAT (main menu, 1 question per unit) ---------- */
  function sendChatQuestion(){
    if(!currentUser||currentUser.isTeacher){
      alert("Login as student.");
      return;
    }
    const unitId=$("chatUnitSelect").value;
    const question=$("chatQuestion").value.trim();
    if(!unitId){alert("Choose unit.");return;}
    if(!question){alert("Write your question.");return;}

    const data=loadData();
    const rec=getUserRecord(currentUser.name);
    rec.chats=rec.chats||{};
    if(rec.chats[unitId]){
      $("chatInfo").textContent="You already used your question for this unit.";
      return;
    }
    rec.chats[unitId]=true;
    data[currentUser.name]=rec;
    saveData(data);

    $("chatQuestion").value="";
    $("chatInfo").textContent="Question sent to AI Bayan (demo). Only one question per unit.";
    showMenu(); // –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å (used)

    // —Å—é–¥–∞ –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Ç–≤–æ–π Cloudflare Worker
    // fetch('https://your-worker-url', {method:'POST', body:JSON.stringify({student:currentUser.name, unit:unitId, question})})
  }
</script>
</body>
</html>

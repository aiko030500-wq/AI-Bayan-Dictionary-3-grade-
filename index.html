<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ENGLISH WITH AI BAYAN ‚Äì Grade 3 Vocabulary & Grammar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --green-main: #1b5e20;
      --green-soft: #c8e6c9;
      --teal-bg: #006064;
      --card: #ffffff;
      --accent: #ffd54f;
      --text: #063b3b;
      --danger: #c62828;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--teal-bg);
      color: var(--text);
    }

    .app-wrapper {
      max-width: 900px;
      margin: 0 auto;
      min-height: 100vh;
      background: linear-gradient(180deg, #004d40, #0097a7);
      padding-bottom: 3rem;
    }

    header.app-header {
      text-align: center;
      padding: 1.2rem 0 0.8rem;
      color: #fffde7;
    }
    header.app-header h1 {
      font-size: 1.4rem;
      font-weight: 800;
      letter-spacing: 0.05em;
    }
    header.app-header h2 {
      font-size: 0.9rem;
      margin-top: 0.1rem;
      opacity: 0.9;
    }

    .logo-circle {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      border: 6px solid var(--accent);
      margin: 0.5rem auto 0.6rem;
      background: #fff;
      background-size: cover;
      background-position: center;
      /* –ø–æ—Å—Ç–∞–≤—å —Å–≤–æ—é –∫–∞—Ä—Ç–∏–Ω–∫—É –ª–æ–≥–æ—Ç–∏–ø–∞ —Å—é–¥–∞ */
      background-image: url("img/ai-bayan-logo.png");
    }

    .card {
      background: var(--card);
      border-radius: 18px;
      margin: 0.8rem 1rem;
      padding: 1rem 1.1rem;
      box-shadow: 0 6px 14px rgba(0,0,0,0.25);
      border: 3px solid var(--accent);
    }

    .btn {
      display: inline-block;
      border: none;
      border-radius: 999px;
      padding: 0.5rem 1.2rem;
      font-size: 0.95rem;
      font-weight: 600;
      background: var(--green-main);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: transform 0.08s, box-shadow 0.08s, opacity 0.12s;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 5px 12px rgba(0,0,0,0.35); }
    .btn:active { transform: translateY(1px); box-shadow: 0 2px 6px rgba(0,0,0,0.25); opacity: 0.85; }

    .btn-secondary {
      background: #01579b;
    }
    .btn-danger {
      background: var(--danger);
    }

    .input {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border-radius: 10px;
      border: 2px solid #b0bec5;
      font-size: 1rem;
      margin-top: 0.2rem;
    }

    .center { text-align: center; }

    .menu-greeting {
      font-size: 1.05rem;
      text-align: center;
      margin-bottom: 0.2rem;
    }
    .menu-stars {
      font-size: 0.95rem;
      text-align: center;
      color: #f57f17;
      font-weight: 700;
    }

    .lesson-list {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      margin-top: 0.7rem;
    }
    .lesson-btn {
      border-radius: 20px;
      border: 3px solid var(--accent);
      background: #e0f2f1;
      padding: 0.7rem 0.9rem;
      font-size: 0.98rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .lesson-btn span.topic {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .lesson-btn small {
      font-size: 0.78rem;
      color: #004d40;
    }

    .chip {
      display:inline-block;
      padding:0.2rem 0.55rem;
      border-radius:999px;
      background:var(--green-soft);
      font-size:0.75rem;
      margin-left:0.3rem;
    }

    .lesson-header {
      text-align: center;
      margin-bottom: 0.4rem;
    }
    .lesson-header h3 {
      font-size: 1.15rem;
      margin-bottom: 0.15rem;
    }
    .lesson-header p {
      font-size: 0.9rem;
      color: #004d40;
    }
    .lesson-stars {
      margin-top: 0.3rem;
      font-size: 0.9rem;
      font-weight: 700;
      color: #f57f17;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 800;
      margin: 0.6rem 0 0.4rem;
      padding: 0.35rem 0.7rem;
      border-radius: 14px;
      background: #004d40;
      color: #fffde7;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .vocab-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 0.55rem;
      margin-top: 0.3rem;
    }
    .vocab-card {
      background: #e8f5e9;
      border-radius: 14px;
      padding: 0.4rem 0.4rem 0.5rem;
      text-align: center;
      border: 2px solid #a5d6a7;
    }
    .vocab-img {
      width: 70px;
      height: 70px;
      margin: 0 auto 0.2rem;
      border-radius: 12px;
      background: #fff;
      background-size: cover;
      background-position: center;
      border: 2px solid #cfd8dc;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 2rem;
    }
    .vocab-word {
      font-weight: 700;
      margin-bottom: 0.05rem;
    }
    .vocab-ru {
      font-size: 0.78rem;
      color: #37474f;
    }
    .vocab-sound-btn {
      margin-top: 0.25rem;
      font-size: 0.8rem;
      padding: 0.2rem 0.7rem;
    }

    .grammar-box {
      background: #e1f5fe;
      border-radius: 14px;
      padding: 0.6rem 0.8rem;
      border: 2px solid #81d4fa;
      font-size: 0.92rem;
      line-height: 1.35;
    }
    .grammar-box strong {
      color: #01579b;
    }
    .grammar-examples {
      margin-top: 0.4rem;
      padding-left: 1rem;
    }

    .worksheet-block {
      margin-top: 0.5rem;
      padding: 0.6rem 0.6rem 0.8rem;
      border-radius: 14px;
      background: #fafafa;
      border: 1px dashed #b0bec5;
      font-size: 0.9rem;
    }
    .worksheet-block h4 {
      font-size: 0.96rem;
      margin-bottom: 0.35rem;
      color: #004d40;
    }
    .task-item {
      margin-bottom: 0.35rem;
    }
    .task-item input[type="text"] {
      padding: 0.25rem 0.4rem;
      border-radius: 8px;
      border: 1px solid #90a4ae;
      min-width: 120px;
    }
    .task-item select {
      padding: 0.25rem 0.4rem;
      border-radius: 8px;
      border: 1px solid #90a4ae;
      min-width: 120px;
    }

    .check-row {
      margin-top: 0.4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
    }
    .result-msg {
      font-size: 0.86rem;
    }

    .nav-row {
      margin-top: 0.8rem;
      display: flex;
      justify-content: space-between;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .footer-nav {
      margin-top: 0.6rem;
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .small-note {
      font-size: 0.78rem;
      color: #eceff1;
      text-align:center;
      margin-top:0.3rem;
    }

    .hidden { display: none; }

    @media (max-width: 600px) {
      .card { margin: 0.7rem 0.6rem; }
      header.app-header h1 { font-size: 1.1rem; }
      .logo-circle { width: 120px; height: 120px; }
    }
  </style>
</head>
<body>
<div class="app-wrapper">

  <header class="app-header">
    <div class="logo-circle"></div>
    <h1>ENGLISH WITH AI BAYAN</h1>
    <h2>Grade 3 ‚Äì Picture Vocabulary & Grammar</h2>
  </header>

  <!-- LOGIN SCREEN -->
  <section id="loginScreen" class="card">
    <h3 class="center" style="font-size:1.1rem;margin-bottom:0.4rem;">
      English with AI Bayan
    </h3>
    <p class="center" style="font-size:0.9rem;margin-bottom:0.6rem;">
      Enter your name and PIN:
    </p>
    <label>Student name or Teacher code:</label>
    <input id="loginName" class="input" placeholder="3E S1, 3E S2, ... or Teacher" />
    <label style="margin-top:0.5rem;display:block;">PIN:</label>
    <input id="loginPin" type="password" class="input" placeholder="****" />

    <div class="center" style="margin-top:0.7rem;">
      <button class="btn" onclick="handleLogin()">Enter</button>
    </div>
    <p class="center" style="font-size:0.8rem;margin-top:0.45rem;color:#37474f;">
      Students: PIN <strong>2844</strong> ‚Ä¢ Teacher: PIN <strong>3244</strong>
    </p>
  </section>

  <!-- MAIN MENU -->
  <section id="menuScreen" class="card hidden">
    <div class="menu-greeting" id="menuGreeting"></div>
    <div class="menu-stars" id="menuStars"></div>

    <div class="lesson-list" id="lessonList"></div>

    <div class="footer-nav">
      <button class="btn-secondary btn" onclick="openChat()">üí¨ AI Bayan Chat</button>
      <button class="btn-secondary btn" onclick="openTeacherJournal()">üè´ Teacher's Journal</button>
    </div>
  </section>

  <!-- LESSON SCREEN -->
  <section id="lessonScreen" class="card hidden">
    <div class="lesson-header">
      <h3 id="lessonTitle"></h3>
      <p id="lessonSubtitle"></p>
      <div class="lesson-stars" id="lessonStars"></div>
    </div>

    <!-- VOCABULARY -->
    <div>
      <div class="section-title">üß† VOCABULARY ‚Äî Picture Dictionary</div>
      <p style="font-size:0.85rem;margin-top:0.25rem;">
        Tap the speaker to hear AI Bayan say the word in English.
      </p>
      <div id="vocabGrid" class="vocab-grid"></div>
    </div>

    <!-- GRAMMAR -->
    <div style="margin-top:0.8rem;">
      <div class="section-title">üìò GRAMMAR ‚Äî Key Rule</div>
      <div id="grammarBox" class="grammar-box"></div>
    </div>

    <!-- WORKSHEETS -->
    <div style="margin-top:0.8rem;">
      <div class="section-title">üìÑ WORKSHEETS (4 tasks)</div>

      <!-- WS1 Missing letters -->
      <div class="worksheet-block" id="ws1Block">
        <h4>Worksheet 1 ‚Äì Missing letters</h4>
        <p style="font-size:0.82rem;margin-bottom:0.3rem;">
          Write the missing letters. (Use small letters.)
        </p>
        <div id="ws1Tasks"></div>
        <div class="check-row">
          <button class="btn" onclick="checkWorksheet('ws1')">Check ‚úÖ</button>
          <div class="result-msg" id="ws1Result"></div>
        </div>
      </div>

      <!-- WS2 Matching -->
      <div class="worksheet-block" id="ws2Block">
        <h4>Worksheet 2 ‚Äì Matching picture and word</h4>
        <p style="font-size:0.82rem;margin-bottom:0.3rem;">
          Choose the correct word for each picture.
        </p>
        <div id="ws2Tasks"></div>
        <div class="check-row">
          <button class="btn" onclick="checkWorksheet('ws2')">Check ‚úÖ</button>
          <div class="result-msg" id="ws2Result"></div>
        </div>
      </div>

      <!-- WS3 Crossword-style -->
      <div class="worksheet-block" id="ws3Block">
        <h4>Worksheet 3 ‚Äì Mini crossword (write the word)</h4>
        <p style="font-size:0.82rem;margin-bottom:0.3rem;">
          Read the clue. Write one word.
        </p>
        <div id="ws3Tasks"></div>
        <div class="check-row">
          <button class="btn" onclick="checkWorksheet('ws3')">Check ‚úÖ</button>
          <div class="result-msg" id="ws3Result"></div>
        </div>
      </div>

      <!-- WS4 Choose the word -->
      <div class="worksheet-block" id="ws4Block">
        <h4>Worksheet 4 ‚Äì Choose the correct word</h4>
        <p style="font-size:0.82rem;margin-bottom:0.3rem;">
          Choose the correct word to complete each sentence.
        </p>
        <div id="ws4Tasks"></div>
        <div class="check-row">
          <button class="btn" onclick="checkWorksheet('ws4')">Check ‚úÖ</button>
          <div class="result-msg" id="ws4Result"></div>
        </div>
      </div>

    </div>

    <div class="nav-row">
      <button class="btn-secondary btn" onclick="goBackToMenu()">‚¨Ö Back</button>
      <button class="btn" onclick="saveLessonResult()">Save Result ‚úî</button>
    </div>
  </section>

  <!-- TEACHER JOURNAL -->
  <section id="teacherScreen" class="card hidden">
    <h3 class="center" style="margin-bottom:0.4rem;">Teacher's Journal ‚Äì Grade 3</h3>
    <p style="font-size:0.85rem;margin-bottom:0.4rem;">
      Shows total stars saved on this device.
    </p>
    <div id="teacherTable" style="font-size:0.88rem;"></div>
    <div class="center" style="margin-top:0.6rem;">
      <button class="btn-secondary btn" onclick="goBackToMenu()">‚¨Ö Back to Menu</button>
      <button class="btn-danger btn" style="margin-left:0.4rem;" onclick="clearAllData()">
        Clear all data
      </button>
    </div>
  </section>

  <!-- SIMPLE CHAT PLACEHOLDER -->
  <section id="chatScreen" class="card hidden">
    <h3 class="center" style="margin-bottom:0.4rem;">AI Bayan Chat (demo)</h3>
    <p style="font-size:0.85rem;margin-bottom:0.3rem;">
      Here you can write one question in English. (–≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –º–µ—Å—Ç–æ –¥–ª—è —Ç–µ–∫—Å—Ç–∞. –ú–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —á–∞—Ç –ò–ò —á–µ—Ä–µ–∑ Cloudflare Worker.)
    </p>
    <textarea id="chatInput"
              class="input"
              style="min-height:90px;"></textarea>
    <div class="center" style="margin-top:0.6rem;">
      <button class="btn-secondary btn" onclick="goBackToMenu()">‚¨Ö Back</button>
    </div>
  </section>

  <p class="small-note">
    Students: 3E S1‚Äì3E S15 &nbsp; | &nbsp; Student PIN 2844 &nbsp; | &nbsp; Teacher PIN 3244
  </p>
</div>

<script>
  /* ----------- DATA ----------- */

  const STUDENT_PIN = "2844";
  const TEACHER_PIN = "3244";

  // –¢–µ–º—ã ‚Äì –ø—Ä–∏–º–µ—Ä—ã –ø–æ FF3. –¢—ã –º–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë —é–Ω–∏—Ç—ã.
  const lessons = [
    {
      id: "u1",
      title: "Unit 1 ‚Äì My Classroom",
      subtitle: "Things in our classroom",
      icon: "üßë‚Äçüè´",
      vocabulary: [
        {
          word: "book",
          ru: "–∫–Ω–∏–≥–∞",
          emoji: "üìñ",
          tts: "a book",
          example: "This is my English book."
        },
        {
          word: "pen",
          ru: "—Ä—É—á–∫–∞",
          emoji: "üñäÔ∏è",
          tts: "a pen",
          example: "I have a blue pen."
        },
        {
          word: "pencil",
          ru: "–∫–∞—Ä–∞–Ω–¥–∞—à",
          emoji: "‚úèÔ∏è",
          tts: "a pencil",
          example: "Sharpen your pencil, please."
        },
        {
          word: "bag",
          ru: "–ø–æ—Ä—Ç—Ñ–µ–ª—å",
          emoji: "üéí",
          tts: "a school bag",
          example: "My bag is green."
        },
        {
          word: "desk",
          ru: "–ø–∞—Ä—Ç–∞",
          emoji: "ü™ë",
          tts: "a desk",
          example: "We sit at the desk."
        },
        {
          word: "board",
          ru: "–¥–æ—Å–∫–∞",
          emoji: "üñºÔ∏è",
          tts: "a board",
          example: "Look at the board."
        }
      ],
      grammar: {
        title: "There is / There are",
        rule: "We use \"There is\" for one thing and \"There are\" for many things.",
        formula: "There is + a / an + singular noun.  |  There are + plural noun.",
        examples: [
          "There is a book on the desk.",
          "There are three pens in my pencil case."
        ]
      },
      worksheets: {
        ws1: [ // missing letters
          { prompt: "b__k", answer: "book" },
          { prompt: "p__cil", answer: "pencil" },
          { prompt: "scho__ bag", answer: "school bag" },
          { prompt: "d__sk", answer: "desk" }
        ],
        ws2: [ // matching ‚Äì select
          {
            picture: "üéí",
            options: ["board", "bag", "pen"],
            answer: "bag"
          },
          {
            picture: "üìñ",
            options: ["book", "desk", "pencil"],
            answer: "book"
          },
          {
            picture: "‚úèÔ∏è",
            options: ["pencil", "bag", "board"],
            answer: "pencil"
          }
        ],
        ws3: [ // mini crossword clues
          { clue: "1. You write with it. (not a pencil)", answer: "pen" },
          { clue: "2. You read it in class.", answer: "book" },
          { clue: "3. It is on the wall. The teacher writes on it.", answer: "board" }
        ],
        ws4: [ // choose the word in a sentence
          {
            sentence: "There __ a book on my desk.",
            options: ["is", "are"],
            answer: "is"
          },
          {
            sentence: "There __ three pens in my bag.",
            options: ["is", "are"],
            answer: "are"
          },
          {
            sentence: "__ is a big board in our classroom.",
            options: ["There", "They"],
            answer: "There"
          }
        ]
      }
    },

    {
      id: "u2",
      title: "Unit 2 ‚Äì My Family",
      subtitle: "People in my family",
      icon: "üë®‚Äçüë©‚Äçüëß",
      vocabulary: [
        { word: "mother", ru: "–º–∞–º–∞", emoji: "üë©", tts: "my mother", example: "My mother is kind." },
        { word: "father", ru: "–ø–∞–ø–∞", emoji: "üë®", tts: "my father", example: "My father is tall." },
        { word: "sister", ru: "—Å–µ—Å—Ç—Ä–∞", emoji: "üëß", tts: "my sister", example: "I play with my sister." },
        { word: "brother", ru: "–±—Ä–∞—Ç", emoji: "üë¶", tts: "my brother", example: "My brother likes football." },
        { word: "grandmother", ru: "–±–∞–±—É—à–∫–∞", emoji: "üëµ", tts: "my grandmother", example: "My grandmother makes cakes." },
        { word: "grandfather", ru: "–¥–µ–¥—É—à–∫–∞", emoji: "üë¥", tts: "my grandfather", example: "My grandfather tells stories." }
      ],
      grammar: {
        title: "Possessive 's",
        rule: "We use 's to show that something belongs to someone.",
        formula: "Name + 's + noun",
        examples: [
          "This is Ali's mother.",
          "That is my sister's bag."
        ]
      },
      worksheets: {
        ws1: [
          { prompt: "m__her", answer: "mother" },
          { prompt: "br__her", answer: "brother" },
          { prompt: "gran__father", answer: "grandfather" },
          { prompt: "si__er", answer: "sister" }
        ],
        ws2: [
          {
            picture: "üëµ",
            options: ["grandfather", "grandmother", "father"],
            answer: "grandmother"
          },
          {
            picture: "üë¶",
            options: ["brother", "mother", "sister"],
            answer: "brother"
          },
          {
            picture: "üë®",
            options: ["father", "grandfather", "sister"],
            answer: "father"
          }
        ],
        ws3: [
          { clue: "1. Your father's father.", answer: "grandfather" },
          { clue: "2. Your mother's mother.", answer: "grandmother" },
          { clue: "3. Your parents' girl.", answer: "daughter" } // —á—É—Ç—å —Å–ª–æ–∂–Ω–µ–µ
        ],
        ws4: [
          {
            sentence: "This is my __ bag.",
            options: ["sister's", "sisters"],
            answer: "sister's"
          },
          {
            sentence: "That is my __ bike.",
            options: ["brother's", "brother"],
            answer: "brother's"
          },
          {
            sentence: "This is my __ house.",
            options: ["family's", "family"],
            answer: "family's"
          }
        ]
      }
    }

    // –∑–¥–µ—Å—å –º–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å Unit 3, Unit 4 –∏ —Ç.–¥.
  ];

  /* ----------- STATE ----------- */
  let currentUser = null;   // { name, isTeacher }
  let currentLessonId = null;
  const STORAGE_KEY = "ai_bayan_grade3";

  /* ----------- HELPERS ----------- */

  function $(id) { return document.getElementById(id); }

  function speak(text) {
    if (!("speechSynthesis" in window)) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "en-US";
    window.speechSynthesis.speak(utter);
  }

  function loadData() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : {};
    } catch (e) {
      return {};
    }
  }

  function saveData(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function getUserRecord(name) {
    const data = loadData();
    if (!data[name]) {
      data[name] = { totalStars: 0, lessons: {} };
      saveData(data);
    }
    return data[name];
  }

  /* ----------- LOGIN ----------- */

  function handleLogin() {
    const name = $("loginName").value.trim();
    const pin = $("loginPin").value.trim();

    if (!name || !pin) {
      alert("Please enter name and PIN.");
      return;
    }

    if (pin === TEACHER_PIN) {
      currentUser = { name: "Teacher", isTeacher: true };
      $("loginScreen").classList.add("hidden");
      buildTeacherJournal();
      $("teacherScreen").classList.remove("hidden");
      return;
    }

    if (pin !== STUDENT_PIN) {
      alert("Wrong PIN.");
      return;
    }

    currentUser = { name, isTeacher: false };
    $("loginScreen").classList.add("hidden");
    showMenu();
  }

  /* ----------- MENU ----------- */

  function showMenu() {
    if (!currentUser) return;
    const rec = getUserRecord(currentUser.name);
    $("menuGreeting").textContent = `Hello, ${currentUser.name}!`;
    $("menuStars").textContent = `Total stars in all lessons: ${rec.totalStars} ‚≠ê`;

    const list = $("lessonList");
    list.innerHTML = "";

    lessons.forEach(lesson => {
      const userLessonRecord = rec.lessons[lesson.id] || { stars: 0 };
      const div = document.createElement("div");
      div.className = "lesson-btn";
      div.onclick = () => openLesson(lesson.id);

      div.innerHTML = `
        <span class="topic">
          <span>${lesson.icon}</span>
          <span>${lesson.title}<br><small>${lesson.subtitle}</small></span>
        </span>
        <span>‚≠ê ${userLessonRecord.stars || 0}</span>
      `;
      list.appendChild(div);
    });

    $("teacherScreen").classList.add("hidden");
    $("chatScreen").classList.add("hidden");
    $("lessonScreen").classList.add("hidden");
    $("menuScreen").classList.remove("hidden");
  }

  /* ----------- LESSON ----------- */

  function openLesson(id) {
    currentLessonId = id;
    const lesson = lessons.find(l => l.id === id);
    if (!lesson) return;

    const rec = getUserRecord(currentUser.name);
    const lessonRec = rec.lessons[id] || { stars: 0 };

    $("lessonTitle").textContent = lesson.title;
    $("lessonSubtitle").textContent = lesson.subtitle;
    $("lessonStars").textContent = `You have ${lessonRec.stars || 0} ‚≠ê in this lesson.`;

    // vocabulary
    const vg = $("vocabGrid");
    vg.innerHTML = "";
    lesson.vocabulary.forEach(v => {
      const card = document.createElement("div");
      card.className = "vocab-card";
      const imgStyle = v.image ? `background-image:url('${v.image}')` : "";
      card.innerHTML = `
        <div class="vocab-img" style="${imgStyle}">
          ${v.image ? "" : (v.emoji || "üìò")}
        </div>
        <div class="vocab-word">${v.word}</div>
        <div class="vocab-ru">${v.ru}</div>
        <button class="btn vocab-sound-btn"
                onclick="speak('${(v.tts || v.word).replace(/'/g, "\\'")}')">
          üîä Say it
        </button>
      `;
      vg.appendChild(card);
    });

    // grammar
    const g = lesson.grammar;
    $("grammarBox").innerHTML = `
      <strong>${g.title}</strong><br/>
      <em>${g.rule}</em><br/>
      <span style="font-size:0.85rem;display:inline-block;margin-top:0.3rem;">
        Formula: ${g.formula}
      </span>
      <div class="grammar-examples">
        <strong>Examples:</strong>
        <ul style="margin-top:0.15rem;">
          ${g.examples.map(e => `<li>${e}</li>`).join("")}
        </ul>
      </div>
    `;

    // worksheets
    buildWorksheet("ws1");
    buildWorksheet("ws2");
    buildWorksheet("ws3");
    buildWorksheet("ws4");

    $("menuScreen").classList.add("hidden");
    $("lessonScreen").classList.remove("hidden");
  }

  function buildWorksheet(wsKey) {
    const lesson = lessons.find(l => l.id === currentLessonId);
    if (!lesson) return;
    const data = lesson.worksheets[wsKey] || [];
    const container = $(wsKey + "Tasks");
    container.innerHTML = "";

    data.forEach((task, index) => {
      const div = document.createElement("div");
      div.className = "task-item";
      const number = index + 1;

      if (wsKey === "ws1") {
        div.innerHTML = `
          ${number}) ${task.prompt} ‚Üí
          <input type="text" data-ws="${wsKey}" data-index="${index}" />
        `;
      } else if (wsKey === "ws2") {
        div.innerHTML = `
          ${number}) <span style="font-size:1.2rem;">${task.picture}</span>
          <select data-ws="${wsKey}" data-index="${index}">
            <option value="">--choose--</option>
            ${task.options.map(opt => `<option value="${opt}">${opt}</option>`).join("")}
          </select>
        `;
      } else if (wsKey === "ws3") {
        div.innerHTML = `
          ${number}) ${task.clue}<br/>
          <input style="margin-top:0.2rem;" type="text" data-ws="${wsKey}" data-index="${index}" />
        `;
      } else if (wsKey === "ws4") {
        div.innerHTML = `
          ${number}) ${task.sentence}<br/>
          <select style="margin-top:0.2rem;" data-ws="${wsKey}" data-index="${index}">
            <option value="">--choose--</option>
            ${task.options.map(opt => `<option value="${opt}">${opt}</option>`).join("")}
          </select>
        `;
      }

      container.appendChild(div);
    });

    $(wsKey + "Result").textContent = "";
  }

  function checkWorksheet(wsKey) {
    const lesson = lessons.find(l => l.id === currentLessonId);
    const tasks = lesson.worksheets[wsKey] || [];
    let correct = 0;

    tasks.forEach((task, index) => {
      const selector = `[data-ws="${wsKey}"][data-index="${index}"]`;
      const el = document.querySelector(selector);
      if (!el) return;

      const value = el.value.trim().toLowerCase();
      const answer = (task.answer || "").toLowerCase();

      if (value === answer) {
        correct++;
        el.style.borderColor = "#388e3c";
      } else {
        el.style.borderColor = "#d32f2f";
      }
    });

    const msgEl = $(wsKey + "Result");
    msgEl.textContent = `Correct: ${correct} / ${tasks.length}`;
    if (correct === tasks.length && tasks.length > 0) {
      msgEl.textContent += " ‚≠ê +1";
    }
  }

  function saveLessonResult() {
    if (!currentUser || !currentLessonId) return;
    const lesson = lessons.find(l => l.id === currentLessonId);
    const rec = getUserRecord(currentUser.name);
    const lessonRec = rec.lessons[currentLessonId] || { stars: 0 };

    // —Å—á–∏—Ç–∞–µ–º –∑–≤—ë–∑–¥—ã –∑–∞ Worksheets (–ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–µ—Ä–Ω—ã–µ)
    let gained = 0;
    ["ws1", "ws2", "ws3", "ws4"].forEach(wsKey => {
      const lessonTasks = lesson.worksheets[wsKey] || [];
      if (lessonTasks.length === 0) return;

      let allCorrect = true;
      lessonTasks.forEach((task, index) => {
        const el = document.querySelector(`[data-ws="${wsKey}"][data-index="${index}"]`);
        if (!el) return;
        const value = el.value.trim().toLowerCase();
        if (value !== (task.answer || "").toLowerCase()) {
          allCorrect = false;
        }
      });
      if (allCorrect) gained++;
    });

    lessonRec.stars += gained;
    rec.totalStars += gained;
    rec.lessons[currentLessonId] = lessonRec;

    const data = loadData();
    data[currentUser.name] = rec;
    saveData(data);

    alert(`Saved! You earned ${gained} ‚≠ê in this lesson.`);
    $("lessonStars").textContent = `You have ${lessonRec.stars} ‚≠ê in this lesson.`;
  }

  function goBackToMenu() {
    if (!currentUser || currentUser.isTeacher) {
      showMenu();
    } else {
      showMenu();
    }
  }

  /* ----------- TEACHER ----------- */

  function buildTeacherJournal() {
    const data = loadData();
    const container = $("teacherTable");
    const names = Object.keys(data);
    if (names.length === 0) {
      container.textContent = "No data yet.";
      return;
    }
    let html = `<table style="width:100%;border-collapse:collapse;">
      <tr>
        <th style="border-bottom:1px solid #90a4ae;text-align:left;">Student</th>
        <th style="border-bottom:1px solid #90a4ae;">Total ‚≠ê</th>
        <th style="border-bottom:1px solid #90a4ae;">By lessons</th>
      </tr>`;
    names.forEach(name => {
      const r = data[name];
      const lessonsStars = Object.entries(r.lessons || {})
        .map(([id, lr]) => {
          const lesson = lessons.find(l => l.id === id);
          const shortTitle = lesson ? lesson.title.replace("Unit ","U") : id;
          return `${shortTitle}: ${lr.stars}‚≠ê`;
        }).join("<br/>");
      html += `
        <tr>
          <td style="border-bottom:1px solid #eceff1;padding:0.25rem 0;">${name}</td>
          <td style="border-bottom:1px solid #eceff1;text-align:center;">${r.totalStars}</td>
          <td style="border-bottom:1px solid #eceff1;font-size:0.78rem;">${lessonsStars}</td>
        </tr>
      `;
    });
    html += "</table>";
    container.innerHTML = html;
  }

  function openTeacherJournal() {
    if (!currentUser || !currentUser.isTeacher) {
      alert("Teacher PIN needed.");
      return;
    }
    $("menuScreen").classList.add("hidden");
    buildTeacherJournal();
    $("teacherScreen").classList.remove("hidden");
  }

  function clearAllData() {
    if (!confirm("Delete all saved results on this device?")) return;
    localStorage.removeItem(STORAGE_KEY);
    buildTeacherJournal();
  }

  /* ----------- CHAT ----------- */

  function openChat() {
    $("menuScreen").classList.add("hidden");
    $("chatScreen").classList.remove("hidden");
  }

</script>

</body>
</html>

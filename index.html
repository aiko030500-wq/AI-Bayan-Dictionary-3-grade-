<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Bayan Dictionary 3 gr</title>

  <style>
    :root{
      --bg:#f3fff5;
      --card:#ffffff;
      --text:#16301c;
      --muted:#5a7a62;
      --green:#2b9348;
      --green2:#6ede8a;
      --gold:#ffd54f;
      --red:#d62828;
      --shadow: 0 10px 24px rgba(0,0,0,.08);
      --radius:18px;
      --btnRadius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 20% 0%, #eaffef 0%, var(--bg) 45%, #f7fff8 100%);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 14px;border-radius:var(--radius);
      background: linear-gradient(135deg, #ffffff 0%, #f1fff4 70%);
      box-shadow: var(--shadow);
      position:sticky;top:0;z-index:10;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:46px;height:46px;border-radius:50%;
      border:4px solid var(--gold);
      background:#fff;
      object-fit:cover;
    }
    .brand h1{margin:0;font-size:16px;line-height:1.15}
    .brand p{margin:2px 0 0 0;font-size:12px;color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 12px;border-radius:999px;
      background:#ffffff;border:1px solid rgba(43,147,72,.18);
      font-size:12px;color:var(--muted);
    }
    .grid{display:grid;gap:14px;margin-top:14px;grid-template-columns:1fr;}
    @media (min-width:900px){ .grid{grid-template-columns: 1.15fr .85fr;} }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      border:1px solid rgba(0,0,0,.05);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:none;cursor:pointer;
      padding:12px 14px;border-radius:var(--btnRadius);
      font-weight:800;
      background: linear-gradient(180deg, var(--green2), var(--green));
      color:#0b1a0f;
      box-shadow: 0 8px 16px rgba(43,147,72,.22);
      transition: transform .05s ease;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      background: linear-gradient(180deg, #fff4c9, var(--gold));
      box-shadow: 0 8px 16px rgba(255,213,79,.25);
    }
    .btn.ghost{
      background:#ffffff;
      border:1px solid rgba(0,0,0,.12);
      box-shadow:none;
      color:var(--text);
    }
    .btn.danger{
      background: linear-gradient(180deg, #ffb3b3, #ff6b6b);
      box-shadow: 0 8px 16px rgba(255,107,107,.22);
    }
    .btn.small{padding:9px 10px;border-radius:12px;font-weight:800;font-size:12px}
    .btn.unit{
      min-width:140px;justify-content:center;
      display:inline-flex;align-items:center;gap:8px;
    }

    .muted{color:var(--muted)}
    .title{margin:0 0 10px 0;font-size:16px}
    .sub{margin:0 0 10px 0;color:var(--muted);font-size:13px}
    .input{
      padding:12px 12px;border-radius:14px;
      border:1px solid rgba(0,0,0,.14);
      outline:none;font-size:14px;min-width:220px;background:#fff;
    }
    .input:focus{border-color: rgba(43,147,72,.45); box-shadow: 0 0 0 4px rgba(43,147,72,.12);}
    .hr{height:1px;background:rgba(0,0,0,.07);margin:12px 0}

    .lessonTabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{
      padding:10px 12px;border-radius:14px;
      background:#fff;border:1px solid rgba(0,0,0,.12);
      cursor:pointer;font-weight:900;font-size:13px;
    }
    .tab.active{
      border-color: rgba(43,147,72,.55);
      box-shadow: 0 0 0 4px rgba(43,147,72,.10);
      background:#f4fff7;
    }

    .section{
      padding:12px;border-radius:18px;
      background: linear-gradient(135deg, #ffffff 0%, #f6fff8 70%);
      border:1px solid rgba(0,0,0,.06);
      margin-top:12px;
    }
    .section h3{margin:0 0 10px 0;font-size:15px}
    .section .hint{margin:-6px 0 10px 0;font-size:12px;color:var(--muted)}

    .vGrid{display:grid;gap:10px;grid-template-columns: repeat(4, minmax(0,1fr));}
    @media (max-width:900px){ .vGrid{grid-template-columns: repeat(2, minmax(0,1fr));} }
    .vItem{
      border-radius:16px;border:1px solid rgba(0,0,0,.10);
      background:#fff;padding:10px;display:flex;flex-direction:column;gap:8px;min-height:150px;
    }
    .vPic{
      width:100%;height:70px;border-radius:14px;
      background: linear-gradient(135deg, #eaffef, #fff9d6);
      display:flex;align-items:center;justify-content:center;
      font-size:28px;
    }
    .vWord{font-weight:950}
    .vRu{font-size:12px;color:var(--muted)}
    .vSpeakRow{display:flex;justify-content:space-between;align-items:center;gap:8px}

    .qa{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      padding:10px;border-radius:14px;background:#fff;border:1px solid rgba(0,0,0,.10);
      margin-bottom:10px;
    }
    .mark{
      font-weight:950;font-size:18px;
      width:28px;height:28px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(0,0,0,.10);
      background:#f8f8f8;
    }
    .mark.ok{background:#eaffef}
    .mark.bad{background:#ffecec}
    .stars{
      display:inline-flex;gap:6px;align-items:center;
      padding:8px 10px;border-radius:14px;background:#fff;border:1px solid rgba(0,0,0,.10);
      font-weight:950;
    }
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(43,147,72,.20);
      background:#f4fff7;
      font-size:12px;color:var(--muted);
    }

    .matchWrap{display:grid;gap:10px;grid-template-columns: 1fr 1fr;}
    @media(max-width:900px){.matchWrap{grid-template-columns:1fr}}
    .matchCol{padding:10px;border-radius:14px;background:#fff;border:1px solid rgba(0,0,0,.10)}
    .matchItem{
      padding:10px;border-radius:14px;margin-bottom:8px;
      background:#f7fff9;border:1px solid rgba(43,147,72,.18);
      cursor:pointer;font-weight:900;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .matchItem.selected{outline: 3px solid rgba(255,213,79,.65)}
    .matchItem.done{opacity:.65;cursor:default}
    .tiny{font-size:12px;color:var(--muted)}

    .karaokeBox{
      padding:10px;border-radius:16px;background:#fff;border:1px solid rgba(0,0,0,.10)
    }
    .lyricLine{
      padding:8px 10px;border-radius:12px;
      border:1px solid rgba(0,0,0,.08);
      margin:8px 0;background:#fafafa;font-weight:900;
    }
    .lyricLine.active{
      background: linear-gradient(180deg, #fff4c9, #ffeaa1);
      border-color: rgba(255,213,79,.55);
    }

    .screen{display:none}
    .screen.active{display:block}

    @media print{
      body{background:#fff}
      .topbar, .noPrint{display:none !important}
      .wrap{max-width:none;padding:0}
      .card{box-shadow:none;border:none}
      .section{border:1px solid #ddd;background:#fff}
      .vPic{border:1px solid #ddd}
      .qa, .matchCol, .karaokeBox{border:1px solid #ddd}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar noPrint">
      <div class="brand">
        <!-- –ü–æ–ª–æ–∂–∏ —Ñ–∞–π–ª logo.png —Ä—è–¥–æ–º —Å HTML -->
        <img class="logo" src="logo.png" alt="AI Bayan logo" />
        <div>
          <h1>AI Bayan Dictionary 3 gr</h1>
          <p class="muted">8 units ‚Ä¢ 1 chat question/day ‚Ä¢ stars saved</p>
        </div>
      </div>
      <div class="row">
        <div class="pill" id="whoPill">–ù–µ –≤–æ—à–ª–∏</div>
        <button class="btn ghost small" id="logoutBtn" style="display:none">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <!-- LOGIN (–±–µ–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ª–æ–≥–∏–Ω–∞/–ø–∏–Ω–∞) -->
    <section class="screen active" id="screenLogin">
      <div class="grid">
        <div class="card">
          <h2 class="title">–í—Ö–æ–¥</h2>
          <p class="sub">–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.</p>
          <div class="row">
            <input class="input" id="loginName" placeholder="–õ–æ–≥–∏–Ω" autocomplete="off" />
            <input class="input" id="loginPin" placeholder="–ü–∞—Ä–æ–ª—å" type="password" inputmode="numeric" autocomplete="off" />
            <button class="btn" id="loginBtn">–í–æ–π—Ç–∏</button>
          </div>
          <p class="muted" id="loginMsg" style="margin-top:10px"></p>

          <div class="hr"></div>
          <div class="row">
            <button class="btn secondary" id="openTeacherBtn">üë©‚Äçüè´ –ñ—É—Ä–Ω–∞–ª —É—á–∏—Ç–µ–ª—è</button>
          </div>
        </div>

        <div class="card">
          <h2 class="title">–ß—Ç–æ –≤–Ω—É—Ç—Ä–∏</h2>
          <p class="sub">Units ‚Ä¢ Visual Vocabulary (üîä) ‚Ä¢ Grammar Key ‚Ä¢ Worksheets ‚Ä¢ Reading ‚Ä¢ Karaoke ‚Ä¢ Print</p>
          <div class="row">
            <span class="stars">‚≠ê –ó–≤—ë–∑–¥—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</span>
            <span class="stars">‚úÖ/‚ùå —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</span>
            <span class="stars">üñ® Print –∫–∞–∂–¥–æ–≥–æ lesson</span>
          </div>
        </div>
      </div>
    </section>

    <!-- MAIN MENU -->
    <section class="screen" id="screenMain">
      <div class="grid">
        <div class="card">
          <h2 class="title">AI Bayan Dictionary 3 gr</h2>
          <p class="sub">–í—ã–±–µ—Ä–∏ Unit.</p>

          <div class="row noPrint" style="justify-content:space-between">
            <div class="row">
              <span class="stars" id="totalStarsBadge">‚≠ê 0</span>
              <span class="tag" id="todayChatTag">ü§ñ</span>
            </div>
          </div>

          <div class="hr noPrint"></div>
          <div class="row noPrint" id="unitsRow"></div>

          <!-- –í–ù–ò–ó–£: —á–∞—Ç + –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è + –∂—É—Ä–Ω–∞–ª —É—á–∏—Ç–µ–ª—è -->
          <div class="section noPrint">
            <h3>ü§ñ AI Bayan Chat</h3>
            <p class="hint">1 –≤–æ–ø—Ä–æ—Å –≤ –¥–µ–Ω—å.</p>
            <div class="row">
              <input class="input" id="chatQ" placeholder="–í–æ–ø—Ä–æ—Å..." />
              <button class="btn" id="chatAskBtn">–°–ø—Ä–æ—Å–∏—Ç—å</button>
            </div>
            <div class="hr"></div>
            <div id="chatA" class="muted"></div>

            <div class="hr"></div>

            <div class="row" style="justify-content:space-between">
              <div class="row">
                <span class="stars" id="achTotal">‚≠ê 0</span>
                <span class="tag" id="achUnits">Units: 0/8</span>
              </div>
              <button class="btn ghost" id="teacherBtn">üë©‚Äçüè´ –ñ—É—Ä–Ω–∞–ª —É—á–∏—Ç–µ–ª—è</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 class="title">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
          <p class="sub">–°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ –ª–æ–≥–∏–Ω—É.</p>
          <div id="progressBox"></div>
        </div>
      </div>
    </section>

    <!-- UNIT -->
    <section class="screen" id="screenUnit">
      <div class="card">
        <div class="row noPrint" style="justify-content:space-between">
          <div>
            <h2 class="title" id="unitTitle">Unit</h2>
            <p class="sub" id="unitSub">8 lessons –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ —é–Ω–∏—Ç–∞</p>
          </div>
          <div class="row">
            <span class="stars" id="unitStarsBadge">‚≠ê 0</span>
            <button class="btn ghost" id="backToMainBtn">‚¨Ö –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
            <button class="btn secondary" id="printLessonBtn">üñ® Print lesson</button>
          </div>
        </div>

        <div class="hr noPrint"></div>
        <div class="lessonTabs noPrint" id="lessonTabs"></div>

        <div id="lessonContent"></div>
      </div>
    </section>

    <!-- TEACHER -->
    <section class="screen" id="screenTeacher">
      <div class="card">
        <div class="row noPrint" style="justify-content:space-between">
          <div>
            <h2 class="title">üë©‚Äçüè´ Teacher Journal</h2>
            <p class="sub">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å.</p>
          </div>
          <div class="row">
            <button class="btn ghost" id="backTeacherBtn">‚¨Ö –ù–∞–∑–∞–¥</button>
            <button class="btn danger" id="teacherResetBtn">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
          </div>
        </div>

        <div class="section noPrint">
          <h3>–í—Ö–æ–¥</h3>
          <div class="row">
            <input class="input" id="teacherPin" placeholder="–ü–∞—Ä–æ–ª—å" type="password" inputmode="numeric" />
            <button class="btn" id="teacherLoginBtn">–û—Ç–∫—Ä—ã—Ç—å</button>
          </div>
          <p class="muted" id="teacherMsg" style="margin:10px 0 0 0"></p>
        </div>

        <div id="teacherTableWrap" style="display:none">
          <div class="hr"></div>
          <div class="section">
            <h3>–¢–∞–±–ª–∏—Ü–∞ —É—á–µ–Ω–∏–∫–æ–≤</h3>
            <div class="muted tiny">Last login –∏ ‚≠ê –ø–æ —é–Ω–∏—Ç–∞–º.</div>
            <div style="overflow:auto;margin-top:10px">
              <table style="width:100%;border-collapse:collapse;font-size:13px">
                <thead>
                  <tr style="text-align:left">
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">–õ–æ–≥–∏–Ω</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">‚≠ê –í—Å–µ–≥–æ</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">U1</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">U2</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">U3</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">U4</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">U5</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">U6</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">U7</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">U8</th>
                  </tr>
                </thead>
                <tbody id="teacherTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </section>
  </div>

  <script>
    /***********************
     * CONFIG (—Å–∫—Ä—ã—Ç–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ)
     ***********************/
    const STUDENT_PIN = "2844";
    const TEACHER_PIN = "3244";
    const CHAT_ENDPOINT = ""; // –µ—Å–ª–∏ –±—É–¥–µ—Ç Cloudflare Worker ‚Äî –≤—Å—Ç–∞–≤—å URL

    // –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –ª–æ–≥–∏–Ω—ã: 3E L1..L15
    const ALLOWED_LOGINS = Array.from({length:15}, (_,i)=>`3E L${i+1}`);

    /***********************
     * DATA (Units 1‚Äì8)
     * Unit 1: –¥–æ–±–∞–≤–ª–µ–Ω POSTER (Lesson 7)
     ***********************/
    const APP_DATA = Array.from({length:8}, (_,u)=>({
      unitId: u+1,
      title: `Unit ${u+1}`,
      lessons: Array.from({length:8}, (_,l)=>({
        lessonId: l+1,
        title: `Lesson ${l+1}`,
        vocab: (u===0 ? [
          {emoji:"üëã", en:"hello", ru:"–ø—Ä–∏–≤–µ—Ç"},
          {emoji:"üôã", en:"name", ru:"–∏–º—è"},
          {emoji:"üòä", en:"fine", ru:"—Ö–æ—Ä–æ—à–æ"},
          {emoji:"üåç", en:"from", ru:"–∏–∑ / –æ—Ç–∫—É–¥–∞"},
          {emoji:"üéÇ", en:"ten", ru:"–¥–µ—Å—è—Ç—å"},
          {emoji:"üî¥", en:"red", ru:"–∫—Ä–∞—Å–Ω—ã–π"},
          {emoji:"üîµ", en:"blue", ru:"—Å–∏–Ω–∏–π"},
          {emoji:"üü¢", en:"green", ru:"–∑–µ–ª—ë–Ω—ã–π"},
        ] : [
          {emoji:"üìò", en:"book", ru:"–∫–Ω–∏–≥–∞"},
          {emoji:"‚úèÔ∏è", en:"pen", ru:"—Ä—É—á–∫–∞"},
          {emoji:"üßë‚Äçüè´", en:"teacher", ru:"—É—á–∏—Ç–µ–ª—å"},
          {emoji:"üè´", en:"school", ru:"—à–∫–æ–ª–∞"},
          {emoji:"üéí", en:"bag", ru:"—Å—É–º–∫–∞"},
          {emoji:"üìé", en:"folder", ru:"–ø–∞–ø–∫–∞"},
          {emoji:"ü™ë", en:"desk", ru:"–ø–∞—Ä—Ç–∞"},
          {emoji:"üßë", en:"friend", ru:"–¥—Ä—É–≥"},
        ]),
        grammar: (u===0 ? {
          enTitle:"Grammar Key",
          enRule:"What‚Äôs your name? / My name‚Äôs ‚Ä¶ / I‚Äôm ‚Ä¶<br>How are you? / I‚Äôm fine. I‚Äôm OK.<br>Where are you from? / I‚Äôm from ‚Ä¶<br>How old are you? / I‚Äôm ten.",
          ruRule:"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç? / –ú–µ–Ω—è –∑–æ–≤—É—Ç ‚Ä¶ / –Ø ‚Ä¶<br>–ö–∞–∫ –¥–µ–ª–∞? / –Ø –≤ –ø–æ—Ä—è–¥–∫–µ.<br>–û—Ç–∫—É–¥–∞ —Ç—ã? / –Ø –∏–∑ ‚Ä¶<br>–°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç? / –ú–Ω–µ –¥–µ—Å—è—Ç—å."
        } : {
          enTitle:"Grammar Key",
          enRule:"This is ‚Ä¶ / These are ‚Ä¶<br>There is ‚Ä¶ / There are ‚Ä¶",
          ruRule:"–≠—Ç–æ ‚Ä¶ (–µ–¥.—á.) / –≠—Ç–æ ‚Ä¶ (–º–Ω.—á.)<br>–ï—Å—Ç—å ‚Ä¶ (–µ–¥.—á.) / –ï—Å—Ç—å ‚Ä¶ (–º–Ω.—á.)"
        }),
        ws1_missing: [
          {prompt:"h _ l l o", answer:"hello"},
          {prompt:"n a _ e", answer:"name"},
          {prompt:"f _ n e", answer:"fine"},
          {prompt:"r e _", answer:"red"},
        ],
        ws3_choose: [
          {q:"What‚Äôs your ___?", options:["name","blue","ten"], correct:0},
          {q:"How ___ you?", options:["are","from","red"], correct:0},
          {q:"I‚Äôm ___ Kazakhstan.", options:["from","fine","name"], correct:0},
        ],
        reading: {
          dialog: [
            "A: Hello!",
            "B: Hello! What‚Äôs your name?",
            "A: My name‚Äôs Tim.",
            "B: Nice to meet you. Bye!"
          ],
          tf: [
            {q:"Tim says: ‚ÄúMy name‚Äôs Tim.‚Äù", a:true},
            {q:"They say: ‚ÄúGood morning.‚Äù", a:false}
          ]
        },
        poster: (u===0 && l===6) ? { // Unit 1 Lesson 7
          hasPoster:true,
          title:"Project ‚Äî I can make a poster (About me)",
          blocks:[
            {h:"Greetings", en:["Hello!","Hi!","Goodbye!","Bye!"], ru:["–ü—Ä–∏–≤–µ—Ç!","–ü—Ä–∏–≤–µ—Ç!","–î–æ —Å–≤–∏–¥–∞–Ω–∏—è!","–ü–æ–∫–∞!"]},
            {h:"My name", en:["What‚Äôs your name?","My name‚Äôs _____.","I‚Äôm _____."], ru:["–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?","–ú–µ–Ω—è –∑–æ–≤—É—Ç _____.","–Ø _____."]},
            {h:"How are you?", en:["How are you?","I‚Äôm fine.","I‚Äôm OK."], ru:["–ö–∞–∫ –¥–µ–ª–∞?","–Ø –≤ –ø–æ—Ä—è–¥–∫–µ.","–£ –º–µ–Ω—è –≤—Å—ë —Ö–æ—Ä–æ—à–æ."]},
            {h:"Where are you from?", en:["Where are you from?","I‚Äôm from _____."], ru:["–û—Ç–∫—É–¥–∞ —Ç—ã?","–Ø –∏–∑ _____."]},
            {h:"How old are you?", en:["How old are you?","I‚Äôm _____ (years old)."], ru:["–°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç?","–ú–Ω–µ _____ –ª–µ—Ç."]},
            {h:"Colours", en:["red, blue, green, yellow, black, white"], ru:["–∫—Ä–∞—Å–Ω—ã–π, —Å–∏–Ω–∏–π, –∑–µ–ª—ë–Ω—ã–π, –∂—ë–ª—Ç—ã–π, —á—ë—Ä–Ω—ã–π, –±–µ–ª—ã–π"]},
          ]
        } : {hasPoster:false},
        song: {
          hasSong: (u===0 && l===0), // Unit 1 Lesson 1: karaoke (–µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—à—å mp3)
          audioSrc: "",              // –Ω–∞–ø—Ä–∏–º–µ—Ä: "u1l1.mp3"
          lines: [
            {t:0,  text:"Hello, hello, hello!"},
            {t:3,  text:"How are you?"},
            {t:6,  text:"I‚Äôm fine, thank you!"},
            {t:9,  text:"Goodbye, bye!"}
          ]
        }
      }))
    }));

    /***********************
     * HELPERS
     ***********************/
    const $ = (id)=>document.getElementById(id);

    let state = { student:null, currentUnit:null, currentLesson:1 };

    function keyBase(student){ return `AIB3_${student.replaceAll(" ","_")}`; }
    function loadJSON(k, fallback){
      try{ const v = localStorage.getItem(k); return v? JSON.parse(v): fallback; }catch(e){ return fallback; }
    }
    function saveJSON(k, obj){ localStorage.setItem(k, JSON.stringify(obj)); }

    function getProgress(){
      const base = keyBase(state.student);
      return loadJSON(`${base}_progress`, { stars:{}, marks:{}, lastLogin:null, chatDaily:{} });
    }
    function setProgress(p){
      const base = keyBase(state.student);
      saveJSON(`${base}_progress`, p);
    }
    function markLastLogin(){
      const p = getProgress();
      p.lastLogin = new Date().toISOString();
      setProgress(p);
    }

    function getStars(unitId, lessonId){
      const p = getProgress();
      return (p.stars?.[`${unitId}_${lessonId}`] ?? 0);
    }
    function addStar(unitId, lessonId, delta=1){
      const p = getProgress();
      const k = `${unitId}_${lessonId}`;
      p.stars = p.stars || {};
      p.stars[k] = (p.stars[k] ?? 0) + delta;
      setProgress(p);
      refreshBadges();
    }
    function getMark(unitId, lessonId, itemKey){
      const p = getProgress();
      const k = `${unitId}_${lessonId}_${itemKey}`;
      return p.marks?.[k] ?? null;
    }
    function setMark(unitId, lessonId, itemKey, value){
      const p = getProgress();
      p.marks = p.marks || {};
      const k = `${unitId}_${lessonId}_${itemKey}`;
      p.marks[k] = value;
      setProgress(p);
      refreshBadges();
    }

    function totalStars(){
      const p = getProgress();
      let s = 0; for(const k in (p.stars||{})) s += (p.stars[k]||0);
      return s;
    }
    function unitStars(unitId){
      const p = getProgress();
      let s = 0;
      for(const k in (p.stars||{})) if(k.startsWith(unitId+"_")) s += (p.stars[k]||0);
      return s;
    }
    function unitsCompleted(){
      // —Å—á–∏—Ç–∞–µ–º ‚Äú—é–Ω–∏—Ç –∑–∞–≤–µ—Ä—à—ë–Ω‚Äù, –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã 1 –∑–≤–µ–∑–¥–∞ –≤ —é–Ω–∏—Ç–µ (–ø—Ä–æ—Å—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ)
      let done = 0;
      for(let u=1; u<=8; u++){
        if(unitStars(u) > 0) done++;
      }
      return done;
    }

    /***********************
     * SCREENS
     ***********************/
    function showScreen(id){
      ["screenLogin","screenMain","screenUnit","screenTeacher"].forEach(s=>{
        $(s).classList.toggle("active", s===id);
      });
    }
    function setWho(){
      const pill = $("whoPill");
      const btn = $("logoutBtn");
      if(state.student){
        pill.textContent = `‚úÖ ${state.student}`;
        btn.style.display = "inline-flex";
      }else{
        pill.textContent = "–ù–µ –≤–æ—à–ª–∏";
        btn.style.display = "none";
      }
    }
    $("logoutBtn").addEventListener("click", ()=>{
      state.student=null; state.currentUnit=null; state.currentLesson=1;
      setWho();
      showScreen("screenLogin");
    });

    /***********************
     * LOGIN
     ***********************/
    function normalizeLogin(s){ return (s||"").trim().replace(/\s+/g," "); }

    $("loginBtn").addEventListener("click", ()=>{
      const name = normalizeLogin($("loginName").value);
      const pin = ($("loginPin").value||"").trim();

      if(!ALLOWED_LOGINS.includes(name)){
        $("loginMsg").textContent = "‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.";
        return;
      }
      if(pin !== STUDENT_PIN){
        $("loginMsg").textContent = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.";
        return;
      }
      state.student = name;
      $("loginMsg").textContent = "";
      setWho();
      markLastLogin();
      buildMain();
      showScreen("screenMain");
    });

    /***********************
     * MAIN MENU
     ***********************/
    function refreshChatTag(){
      const tag = $("todayChatTag");
      const p = getProgress();
      const d = new Date().toISOString().slice(0,10);
      const used = !!p.chatDaily?.[d];
      tag.textContent = used ? "ü§ñ –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω" : "ü§ñ 1 –≤–æ–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–µ–Ω";
      tag.style.borderColor = used ? "rgba(214,40,40,.35)" : "rgba(43,147,72,.35)";
      tag.style.background = used ? "#ffecec" : "#f4fff7";
    }

    function buildUnitsRow(){
      const row = $("unitsRow");
      row.innerHTML = "";
      APP_DATA.forEach(u=>{
        const b = document.createElement("button");
        b.className = "btn unit";
        b.innerHTML = `üìò ${u.title} <span class="tiny">‚≠ê ${unitStars(u.unitId)}</span>`;
        b.addEventListener("click", ()=>openUnit(u.unitId));
        row.appendChild(b);
      });
    }

    function buildProgressBox(){
      const box = $("progressBox");
      box.innerHTML = "";
      const p = getProgress();
      const last = p.lastLogin ? new Date(p.lastLogin).toLocaleString() : "‚Äî";
      const div = document.createElement("div");
      div.className = "section";
      div.innerHTML = `
        <h3>üë§ ${state.student}</h3>
        <p class="hint">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥: <b>${last}</b></p>
        <div class="row">
          <span class="stars">‚≠ê –í—Å–µ–≥–æ: ${totalStars()}</span>
          <span class="tag">Units: ${unitsCompleted()}/8</span>
        </div>
      `;
      box.appendChild(div);
    }

    function buildMain(){
      $("totalStarsBadge").textContent = `‚≠ê ${totalStars()}`;
      $("achTotal").textContent = `‚≠ê ${totalStars()}`;
      $("achUnits").textContent = `Units: ${unitsCompleted()}/8`;
      buildUnitsRow();
      buildProgressBox();
      refreshChatTag();
      $("chatA").textContent = "";
      $("chatQ").value = "";
    }

    /***********************
     * AI CHAT (1 per day)
     ***********************/
    async function askChat(){
      const q = ($("chatQ").value||"").trim();
      if(!q){ $("chatA").textContent = "–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å üòä"; return; }

      const p = getProgress();
      const d = new Date().toISOString().slice(0,10);
      p.chatDaily = p.chatDaily || {};
      if(p.chatDaily[d]){
        $("chatA").textContent = "‚ùå –°–µ–≥–æ–¥–Ω—è –ª–∏–º–∏—Ç —á–∞—Ç–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω (1 –≤–æ–ø—Ä–æ—Å –≤ –¥–µ–Ω—å).";
        refreshChatTag();
        return;
      }
      p.chatDaily[d] = true;
      setProgress(p);
      refreshChatTag();

      if(CHAT_ENDPOINT){
        try{
          $("chatA").textContent = "‚Ä¶";
          const res = await fetch(CHAT_ENDPOINT, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ question:q, student: state.student, dateISO: new Date().toISOString() })
          });
          const data = await res.json();
          $("chatA").textContent = data.answer ? String(data.answer) : "–û—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω.";
        }catch(e){
          $("chatA").textContent = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —á–∞—Ç—É.";
        }
      }else{
        $("chatA").textContent =
          "AI Bayan: –°–Ω–∞—á–∞–ª–∞ –ø–æ–≤—Ç–æ—Ä–∏ —Å–ª–æ–≤–∞ (Vocabulary), –ø–æ—Ç–æ–º –ø—Ä–∞–≤–∏–ª–æ (Grammar Key), –∑–∞—Ç–µ–º —Å–¥–µ–ª–∞–π Worksheets üòä";
      }
    }
    $("chatAskBtn").addEventListener("click", askChat);

    /***********************
     * UNIT + LESSONS
     ***********************/
    function openUnit(unitId){
      state.currentUnit = unitId;
      state.currentLesson = 1;
      buildUnit();
      showScreen("screenUnit");
    }

    $("backToMainBtn").addEventListener("click", ()=>{
      buildMain();
      showScreen("screenMain");
    });
    $("printLessonBtn").addEventListener("click", ()=>window.print());

    function buildLessonTabs(unit){
      const tabs = $("lessonTabs");
      tabs.innerHTML = "";
      unit.lessons.forEach(les=>{
        const t = document.createElement("button");
        t.className = "tab" + (les.lessonId===state.currentLesson ? " active":"");
        t.textContent = `Lesson ${les.lessonId}`;
        t.addEventListener("click", ()=>{
          state.currentLesson = les.lessonId;
          buildUnit();
        });
        tabs.appendChild(t);
      });
    }

    function refreshBadges(){
      if(!state.student) return;
      $("totalStarsBadge").textContent = `‚≠ê ${totalStars()}`;
      $("achTotal").textContent = `‚≠ê ${totalStars()}`;
      $("achUnits").textContent = `Units: ${unitsCompleted()}/8`;

      if(state.currentUnit){
        $("unitStarsBadge").textContent = `‚≠ê ${unitStars(state.currentUnit)}`;
      }
      const row = $("unitsRow");
      if(row && row.children){
        Array.from(row.children).forEach((btn,i)=>{
          const u = APP_DATA[i];
          if(u) btn.innerHTML = `üìò ${u.title} <span class="tiny">‚≠ê ${unitStars(u.unitId)}</span>`;
        });
      }
    }

    // "AI Bayan" voice (Web Speech API)
    function speakAI(text){
      try{
        const u = new SpeechSynthesisUtterance(text);
        const voices = speechSynthesis.getVoices ? speechSynthesis.getVoices() : [];
        const v = voices.find(v=>/en/i.test(v.lang)) || voices[0];
        if(v) u.voice = v;
        u.lang = (v && v.lang) ? v.lang : "en-US";
        u.rate = 0.9;
        u.pitch = 1.1;
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      }catch(e){
        alert("–û–∑–≤—É—á–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.");
      }
    }
    if("speechSynthesis" in window){
      window.speechSynthesis.onvoiceschanged = ()=>{};
    }

    function buildUnit(){
      const unit = APP_DATA.find(u=>u.unitId===state.currentUnit);
      const les = unit.lessons.find(l=>l.lessonId===state.currentLesson);

      $("unitTitle").textContent = unit.title;
      $("unitSub").textContent = `${les.title} ‚Ä¢ 8 lessons –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ —é–Ω–∏—Ç–∞`;
      $("unitStarsBadge").textContent = `‚≠ê ${unitStars(unit.unitId)}`;

      buildLessonTabs(unit);

      const root = $("lessonContent");
      root.innerHTML = "";

      // 1) Visual Vocabulary
      const s1 = document.createElement("div");
      s1.className = "section";
      s1.innerHTML = `
        <h3>1) Visual Vocabulary</h3>
        <p class="hint">–ù–∞–∂–º–∏ üîä ‚Äî AI Bayan –≥–æ–≤–æ—Ä–∏—Ç —Å–ª–æ–≤–æ.</p>
        <div class="vGrid" id="vGrid"></div>
      `;
      root.appendChild(s1);

      const vGrid = s1.querySelector("#vGrid");
      les.vocab.forEach((w)=>{
        const item = document.createElement("div");
        item.className = "vItem";
        item.innerHTML = `
          <div class="vPic" aria-hidden="true">${w.emoji || "üß∏"}</div>
          <div class="vSpeakRow">
            <div>
              <div class="vWord">${w.en}</div>
              <div class="vRu">${w.ru}</div>
            </div>
            <button class="btn secondary small noPrint" title="Speak">üîä</button>
          </div>
        `;
        item.querySelector("button").addEventListener("click", ()=>speakAI(w.en));
        vGrid.appendChild(item);
      });

      // 2) Grammar Key (EN+RU)
      const s2 = document.createElement("div");
      s2.className = "section";
      s2.innerHTML = `
        <h3>2) ${les.grammar.enTitle}</h3>
        <div class="qa">
          <div style="flex:1">
            <div><b>EN:</b> <span>${les.grammar.enRule}</span></div>
            <div style="margin-top:8px"><b>RU:</b> <span>${les.grammar.ruRule}</span></div>
          </div>
        </div>
      `;
      root.appendChild(s2);

      // Stars (lesson)
      const lessonStars = getStars(unit.unitId, les.lessonId);
      const starBox = document.createElement("div");
      starBox.className = "section";
      starBox.innerHTML = `
        <h3>‚≠ê Stars for this lesson</h3>
        <div class="row">
          <span class="stars">‚≠ê ${lessonStars}</span>
          <span class="tag">‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω–æ = +1 ‚≠ê</span>
        </div>
      `;
      root.appendChild(starBox);

      // 3) Worksheet 1 ‚Äî Missing letters
      const s3 = document.createElement("div");
      s3.className = "section";
      s3.innerHTML = `<h3>3) Worksheet 1 ‚Äî Missing Letters</h3><div id="ws1"></div>`;
      root.appendChild(s3);

      const ws1 = s3.querySelector("#ws1");
      les.ws1_missing.forEach((it,i)=>{
        const itemKey = `ws1_${i}`;
        const mark = getMark(unit.unitId, les.lessonId, itemKey);
        const row = document.createElement("div");
        row.className = "qa";
        row.innerHTML = `
          <div class="mark ${mark==="ok"?"ok":mark==="bad"?"bad":""}">${mark==="ok"?"‚úÖ":mark==="bad"?"‚úñ":"‚Ä¢"}</div>
          <div style="min-width:120px;font-weight:950">${it.prompt}</div>
          <input class="input" style="min-width:180px" placeholder="answer" />
          <button class="btn small">Check</button>
        `;
        const inp = row.querySelector("input");
        if(mark==="ok") inp.value = it.answer;

        row.querySelector("button").addEventListener("click", ()=>{
          const ans = (inp.value||"").trim().toLowerCase();
          if(ans === it.answer.toLowerCase()){
            if(getMark(unit.unitId, les.lessonId, itemKey)!=="ok") addStar(unit.unitId, les.lessonId, 1);
            setMark(unit.unitId, les.lessonId, itemKey, "ok");
          }else{
            setMark(unit.unitId, les.lessonId, itemKey, "bad");
          }
          buildUnit();
        });

        ws1.appendChild(row);
      });

      // 4) Worksheet 2 ‚Äî Matching
      const s4 = document.createElement("div");
      s4.className = "section";
      s4.innerHTML = `<h3>4) Worksheet 2 ‚Äî Matching (Pictures + Words)</h3><div class="matchWrap" id="matchWrap"></div>`;
      root.appendChild(s4);

      const matchWrap = s4.querySelector("#matchWrap");
      const left = document.createElement("div");
      const right = document.createElement("div");
      left.className="matchCol"; right.className="matchCol";
      left.innerHTML = `<div style="font-weight:950;margin-bottom:8px">Pictures</div>`;
      right.innerHTML = `<div style="font-weight:950;margin-bottom:8px">Words</div>`;

      const pairs = les.vocab.slice(0,6).map((w,idx)=>({id:idx,...w}));
      const pics = [...pairs].sort(()=>Math.random()-0.5);
      const words = [...pairs].sort(()=>Math.random()-0.5);

      let selPic=null, selWord=null;

      pics.forEach(p=>{
        const done = getMark(unit.unitId, les.lessonId, `ws2_done_${p.id}`)==="ok";
        const el = document.createElement("div");
        el.className = "matchItem" + (done?" done":"");
        el.innerHTML = `<span>${p.emoji}</span><span class="tiny">${done?"‚úÖ":""}</span>`;
        el.addEventListener("click", ()=>{
          if(done) return;
          Array.from(left.querySelectorAll(".matchItem")).forEach(x=>x.classList.remove("selected"));
          el.classList.add("selected");
          selPic=p;
          tryPair();
        });
        left.appendChild(el);
      });

      words.forEach(w=>{
        const done = getMark(unit.unitId, les.lessonId, `ws2_done_${w.id}`)==="ok";
        const el = document.createElement("div");
        el.className = "matchItem" + (done?" done":"");
        el.innerHTML = `<span>${w.en}</span><span class="tiny">${done?"‚úÖ":""}</span>`;
        el.addEventListener("click", ()=>{
          if(done) return;
          Array.from(right.querySelectorAll(".matchItem")).forEach(x=>x.classList.remove("selected"));
          el.classList.add("selected");
          selWord=w;
          tryPair();
        });
        right.appendChild(el);
      });

      function tryPair(){
        if(!selPic || !selWord) return;
        if(selPic.id === selWord.id){
          if(getMark(unit.unitId, les.lessonId, `ws2_done_${selPic.id}`)!=="ok") addStar(unit.unitId, les.lessonId, 1);
          setMark(unit.unitId, les.lessonId, `ws2_done_${selPic.id}`, "ok");
        }else{
          setMark(unit.unitId, les.lessonId, `ws2_try_${selPic.id}_${selWord.id}`, "bad");
        }
        selPic=null; selWord=null;
        buildUnit();
      }

      matchWrap.appendChild(left);
      matchWrap.appendChild(right);

      // 5) Worksheet 3 ‚Äî Choose correct word
      const s5 = document.createElement("div");
      s5.className = "section";
      s5.innerHTML = `<h3>5) Worksheet 3 ‚Äî Choose the Correct Word</h3><div id="ws3"></div>`;
      root.appendChild(s5);

      const ws3 = s5.querySelector("#ws3");
      les.ws3_choose.forEach((it,i)=>{
        const itemKey = `ws3_${i}`;
        const mark = getMark(unit.unitId, les.lessonId, itemKey);
        const box = document.createElement("div");
        box.className="qa";
        box.innerHTML = `
          <div class="mark ${mark==="ok"?"ok":mark==="bad"?"bad":""}">${mark==="ok"?"‚úÖ":mark==="bad"?"‚úñ":"‚Ä¢"}</div>
          <div style="flex:1">
            <div style="font-weight:950;margin-bottom:8px">${it.q}</div>
            <div class="row" id="opts"></div>
            <div class="row" style="margin-top:8px"><button class="btn small">Check</button></div>
          </div>
        `;
        const opts = box.querySelector("#opts");
        const group = `g_${unit.unitId}_${les.lessonId}_${i}`;
        it.options.forEach((op,idx)=>{
          const lab = document.createElement("label");
          lab.className="tag";
          lab.style.cursor="pointer";
          lab.innerHTML = `<input type="radio" name="${group}" value="${idx}" style="transform:scale(1.1)"> ${op}`;
          opts.appendChild(lab);
        });

        box.querySelector("button").addEventListener("click", ()=>{
          const chosen = box.querySelector(`input[name="${group}"]:checked`);
          if(!chosen){ alert("–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç üôÇ"); return; }
          const val = Number(chosen.value);
          if(val === it.correct){
            if(getMark(unit.unitId, les.lessonId, itemKey)!=="ok") addStar(unit.unitId, les.lessonId, 1);
            setMark(unit.unitId, les.lessonId, itemKey, "ok");
          }else{
            setMark(unit.unitId, les.lessonId, itemKey, "bad");
          }
          buildUnit();
        });

        ws3.appendChild(box);
      });

      // 6) Worksheet 4 ‚Äî Reading mini + 2 TF
      const s6 = document.createElement("div");
      s6.className="section";
      s6.innerHTML = `
        <h3>6) Worksheet 4 ‚Äî Reading Mini (Dialog)</h3>
        <div class="qa" style="display:block">
          <div style="font-weight:950;margin-bottom:8px">Dialog</div>
          <div style="line-height:1.55" id="dialog"></div>
        </div>
        <div id="tfBox" style="margin-top:10px"></div>
      `;
      root.appendChild(s6);

      s6.querySelector("#dialog").innerHTML = les.reading.dialog.map(x=>`<div>${x}</div>`).join("");

      const tfBox = s6.querySelector("#tfBox");
      les.reading.tf.forEach((tfi,i)=>{
        const itemKey = `ws4_tf_${i}`;
        const mark = getMark(unit.unitId, les.lessonId, itemKey);
        const row = document.createElement("div");
        row.className="qa";
        row.innerHTML = `
          <div class="mark ${mark==="ok"?"ok":mark==="bad"?"bad":""}">${mark==="ok"?"‚úÖ":mark==="bad"?"‚úñ":"‚Ä¢"}</div>
          <div style="flex:1;font-weight:950">${tfi.q}</div>
          <label class="tag" style="cursor:pointer"><input type="radio" name="tf_${i}" value="true"> True</label>
          <label class="tag" style="cursor:pointer"><input type="radio" name="tf_${i}" value="false"> False</label>
          <button class="btn small">Check</button>
        `;
        row.querySelector("button").addEventListener("click", ()=>{
          const chosen = row.querySelector(`input[name="tf_${i}"]:checked`);
          if(!chosen){ alert("–í—ã–±–µ—Ä–∏ True/False üôÇ"); return; }
          const val = (chosen.value==="true");
          if(val === tfi.a){
            if(getMark(unit.unitId, les.lessonId, itemKey)!=="ok") addStar(unit.unitId, les.lessonId, 1);
            setMark(unit.unitId, les.lessonId, itemKey, "ok");
          }else{
            setMark(unit.unitId, les.lessonId, itemKey, "bad");
          }
          buildUnit();
        });
        tfBox.appendChild(row);
      });

      // 7) Project Poster (Unit 1 Lesson 7)
      if(les.poster && les.poster.hasPoster){
        const sP = document.createElement("div");
        sP.className="section";
        sP.innerHTML = `
          <h3>7) ${les.poster.title}</h3>
          <p class="hint">–ì–æ—Ç–æ–≤–æ –¥–ª—è –ø–µ—á–∞—Ç–∏. (Print lesson)</p>
          <div id="posterBlocks"></div>
        `;
        root.appendChild(sP);
        const pb = sP.querySelector("#posterBlocks");
        les.poster.blocks.forEach(b=>{
          const block = document.createElement("div");
          block.className="qa";
          block.style.display="block";
          block.innerHTML = `
            <div style="font-weight:950;margin-bottom:6px">${b.h}</div>
            <div><b>EN:</b> ${Array.isArray(b.en)? b.en.join(" ‚Ä¢ "): b.en}</div>
            <div style="margin-top:6px"><b>RU:</b> ${Array.isArray(b.ru)? b.ru.join(" ‚Ä¢ "): b.ru}</div>
          `;
          pb.appendChild(block);
        });
      }

      // Song ‚Äî Karaoke (Unit 1 Lesson 1)
      if(les.song && les.song.hasSong){
        const s7 = document.createElement("div");
        s7.className="section";
        s7.innerHTML = `
          <h3>${les.poster && les.poster.hasPoster ? "8" : "7"}) Song ‚Äî Karaoke</h3>
          <div class="karaokeBox">
            <audio id="aud" preload="metadata"></audio>
            <div class="row noPrint" style="margin-bottom:10px">
              <button class="btn small" id="kStart">‚ñ∂ Start</button>
              <button class="btn ghost small" id="kPause">‚è∏ Pause</button>
              <button class="btn danger small" id="kStop">‚èπ Stop</button>
            </div>
            <div id="lyrics"></div>
          </div>
        `;
        root.appendChild(s7);

        const aud = s7.querySelector("#aud");
        if(les.song.audioSrc) aud.src = les.song.audioSrc;

        const lyrics = s7.querySelector("#lyrics");
        les.song.lines.forEach((ln,idx)=>{
          const div = document.createElement("div");
          div.className="lyricLine";
          div.dataset.idx=String(idx);
          div.textContent=ln.text;
          lyrics.appendChild(div);
        });

        const lines = les.song.lines;
        function highlightByTime(t){
          let active = 0;
          for(let i=0;i<lines.length;i++) if(t >= lines[i].t) active = i;
          Array.from(lyrics.children).forEach((c,i)=>c.classList.toggle("active", i===active));
        }

        let tick=null;
        function startTick(){
          stopTick();
          tick=setInterval(()=>highlightByTime(aud.currentTime||0), 150);
        }
        function stopTick(){ if(tick){ clearInterval(tick); tick=null; } }

        s7.querySelector("#kStart").addEventListener("click", async ()=>{
          if(aud.src){
            try{ await aud.play(); startTick(); }catch(e){}
          }else{
            let t=0; stopTick();
            tick=setInterval(()=>{
              t+=0.15; highlightByTime(t);
              if(t> (lines[lines.length-1].t+4)) stopTick();
            },150);
          }
        });
        s7.querySelector("#kPause").addEventListener("click", ()=>{
          if(aud.src) aud.pause();
          stopTick();
        });
        s7.querySelector("#kStop").addEventListener("click", ()=>{
          if(aud.src){ aud.pause(); aud.currentTime=0; }
          stopTick();
          Array.from(lyrics.children).forEach(c=>c.classList.remove("active"));
        });
        aud.addEventListener("ended", ()=>stopTick());
      }

      refreshBadges();
    }

    /***********************
     * TEACHER JOURNAL
     ***********************/
    function openTeacher(){
      showScreen("screenTeacher");
      $("teacherMsg").textContent = "";
      $("teacherTableWrap").style.display = "none";
      $("teacherPin").value = "";
    }
    $("openTeacherBtn").addEventListener("click", openTeacher);
    $("teacherBtn").addEventListener("click", openTeacher);
    $("backTeacherBtn").addEventListener("click", ()=>{
      if(state.student){ buildMain(); showScreen("screenMain"); }
      else showScreen("screenLogin");
    });

    $("teacherLoginBtn").addEventListener("click", ()=>{
      const pin = ($("teacherPin").value||"").trim();
      if(pin !== TEACHER_PIN){
        $("teacherMsg").textContent = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.";
        return;
      }
      $("teacherMsg").textContent = "‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω.";
      $("teacherTableWrap").style.display = "block";
      buildTeacherTable();
    });

    function teacherReadStudentProgress(login){
      const base = `AIB3_${login.replaceAll(" ","_")}`;
      return loadJSON(`${base}_progress`, { stars:{}, marks:{}, lastLogin:null, chatDaily:{} });
    }

    function buildTeacherTable(){
      const tb = $("teacherTbody");
      tb.innerHTML = "";
      ALLOWED_LOGINS.forEach(login=>{
        const p = teacherReadStudentProgress(login);
        const last = p.lastLogin ? new Date(p.lastLogin).toLocaleString() : "‚Äî";
        const total = (()=>{ let s=0; for(const k in (p.stars||{})) s += (p.stars[k]||0); return s; })();
        const perUnit = (u)=>{
          let s=0; for(const k in (p.stars||{})) if(k.startsWith(u+"_")) s += (p.stars[k]||0);
          return s;
        };
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="padding:10px;border-bottom:1px solid rgba(0,0,0,.08);font-weight:950">${login}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(0,0,0,.08)">${last}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(0,0,0,.08);font-weight:950">‚≠ê ${total}</td>
          ${Array.from({length:8},(_,i)=>`<td style="padding:10px;border-bottom:1px solid rgba(0,0,0,.08)">‚≠ê ${perUnit(i+1)}</td>`).join("")}
        `;
        tb.appendChild(tr);
      });
    }

    $("teacherResetBtn").addEventListener("click", ()=>{
      const pin = ($("teacherPin").value||"").trim();
      if(pin !== TEACHER_PIN){ alert("–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å."); return; }
      if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —É –í–°–ï–• —É—á–µ–Ω–∏–∫–æ–≤?")) return;
      ALLOWED_LOGINS.forEach(login=>{
        const base = `AIB3_${login.replaceAll(" ","_")}`;
        localStorage.removeItem(`${base}_progress`);
      });
      buildTeacherTable();
      alert("–ì–æ—Ç–æ–≤–æ ‚úÖ");
    });

    /***********************
     * INIT
     ***********************/
    setWho();

    $("loginName").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("loginPin").focus(); });
    $("loginPin").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("loginBtn").click(); });
    $("chatQ").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("chatAskBtn").click(); });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Bayan ‚Äì Grade 3 (Units 1‚Äì8)</title>

  <style>
    :root{
      --bg:#f3fff5;
      --card:#ffffff;
      --text:#16301c;
      --muted:#5a7a62;
      --green:#2b9348;
      --green2:#6ede8a;
      --gold:#ffd54f;
      --red:#d62828;
      --shadow: 0 10px 24px rgba(0,0,0,.08);
      --radius:18px;
      --btnRadius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 20% 0%, #eaffef 0%, var(--bg) 45%, #f7fff8 100%);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 14px;border-radius:var(--radius);
      background: linear-gradient(135deg, #ffffff 0%, #f1fff4 70%);
      box-shadow: var(--shadow);
      position:sticky;top:0;z-index:10;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:46px;height:46px;border-radius:50%;
      border:4px solid var(--gold);
      background:#fff;
      object-fit:cover;
    }
    .brand h1{margin:0;font-size:16px;line-height:1.15}
    .brand p{margin:2px 0 0 0;font-size:12px;color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 12px;border-radius:999px;
      background:#ffffff;border:1px solid rgba(43,147,72,.18);
      font-size:12px;color:var(--muted);
    }
    .grid{
      display:grid;gap:14px;margin-top:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width:900px){
      .grid{grid-template-columns: 1.15fr .85fr;}
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      border:1px solid rgba(0,0,0,.05);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:none;cursor:pointer;
      padding:12px 14px;
      border-radius:var(--btnRadius);
      font-weight:700;
      background: linear-gradient(180deg, var(--green2), var(--green));
      color:#0b1a0f;
      box-shadow: 0 8px 16px rgba(43,147,72,.22);
      transition: transform .05s ease;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      background: linear-gradient(180deg, #fff4c9, var(--gold));
      box-shadow: 0 8px 16px rgba(255,213,79,.25);
    }
    .btn.ghost{
      background:#ffffff;
      border:1px solid rgba(0,0,0,.12);
      box-shadow:none;
      color:var(--text);
    }
    .btn.danger{
      background: linear-gradient(180deg, #ffb3b3, #ff6b6b);
      box-shadow: 0 8px 16px rgba(255,107,107,.22);
    }
    .btn.small{padding:9px 10px;border-radius:12px;font-weight:700;font-size:12px}
    .btn.unit{
      min-width:120px;justify-content:center;
      display:inline-flex;align-items:center;gap:8px;
    }
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(43,147,72,.20);
      background:#f4fff7;
      font-size:12px;color:var(--muted);
    }
    .muted{color:var(--muted)}
    .title{margin:0 0 10px 0;font-size:16px}
    .sub{margin:0 0 10px 0;color:var(--muted);font-size:13px}
    .input{
      padding:12px 12px;border-radius:14px;
      border:1px solid rgba(0,0,0,.14);
      outline:none;
      font-size:14px;
      min-width:220px;
      background:#fff;
    }
    .input:focus{border-color: rgba(43,147,72,.45); box-shadow: 0 0 0 4px rgba(43,147,72,.12);}
    .hr{height:1px;background:rgba(0,0,0,.07);margin:12px 0}

    /* Lessons UI */
    .lessonTabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{
      padding:10px 12px;border-radius:14px;
      background:#fff;border:1px solid rgba(0,0,0,.12);
      cursor:pointer;font-weight:800;font-size:13px;
    }
    .tab.active{
      border-color: rgba(43,147,72,.55);
      box-shadow: 0 0 0 4px rgba(43,147,72,.10);
      background:#f4fff7;
    }

    .section{
      padding:12px;border-radius:18px;
      background: linear-gradient(135deg, #ffffff 0%, #f6fff8 70%);
      border:1px solid rgba(0,0,0,.06);
      margin-top:12px;
    }
    .section h3{margin:0 0 10px 0;font-size:15px}
    .section .hint{margin:-6px 0 10px 0;font-size:12px;color:var(--muted)}

    /* Vocabulary grid: 2 rows (auto wrap) */
    .vGrid{
      display:grid;gap:10px;
      grid-template-columns: repeat(4, minmax(0,1fr));
    }
    @media (max-width:900px){
      .vGrid{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
    .vItem{
      border-radius:16px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      padding:10px;
      display:flex;flex-direction:column;gap:8px;
      min-height:150px;
    }
    .vPic{
      width:100%;height:70px;border-radius:14px;
      background: linear-gradient(135deg, #eaffef, #fff9d6);
      display:flex;align-items:center;justify-content:center;
      font-size:28px;
    }
    .vWord{font-weight:900}
    .vRu{font-size:12px;color:var(--muted)}
    .vSpeakRow{display:flex;justify-content:space-between;align-items:center;gap:8px}

    /* Worksheet widgets */
    .qa{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      padding:10px;border-radius:14px;background:#fff;border:1px solid rgba(0,0,0,.10);
      margin-bottom:10px;
    }
    .mark{
      font-weight:900;font-size:18px;
      width:28px;height:28px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(0,0,0,.10);
      background:#f8f8f8;
    }
    .mark.ok{background:#eaffef}
    .mark.bad{background:#ffecec}
    .stars{
      display:inline-flex;gap:6px;align-items:center;
      padding:8px 10px;border-radius:14px;background:#fff;border:1px solid rgba(0,0,0,.10);
      font-weight:900;
    }

    /* Matching */
    .matchWrap{display:grid;gap:10px;grid-template-columns: 1fr 1fr;}
    @media(max-width:900px){.matchWrap{grid-template-columns:1fr}}
    .matchCol{padding:10px;border-radius:14px;background:#fff;border:1px solid rgba(0,0,0,.10)}
    .matchItem{
      padding:10px;border-radius:14px;margin-bottom:8px;
      background:#f7fff9;border:1px solid rgba(43,147,72,.18);
      cursor:pointer;font-weight:800;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .matchItem.selected{outline: 3px solid rgba(255,213,79,.65)}
    .matchItem.done{opacity:.65;cursor:default}
    .tiny{font-size:12px;color:var(--muted)}

    /* Karaoke */
    .karaokeBox{
      padding:10px;border-radius:16px;background:#fff;border:1px solid rgba(0,0,0,.10)
    }
    .lyricLine{
      padding:8px 10px;border-radius:12px;
      border:1px solid rgba(0,0,0,.08);
      margin:8px 0;
      background:#fafafa;
      font-weight:800;
    }
    .lyricLine.active{
      background: linear-gradient(180deg, #fff4c9, #ffeaa1);
      border-color: rgba(255,213,79,.55);
    }

    /* Screens */
    .screen{display:none}
    .screen.active{display:block}

    /* Print */
    @media print{
      body{background:#fff}
      .topbar, .noPrint{display:none !important}
      .wrap{max-width:none;padding:0}
      .card{box-shadow:none;border:none}
      .section{border:1px solid #ddd;background:#fff}
      .vPic{border:1px solid #ddd}
      .qa, .matchCol, .karaokeBox{border:1px solid #ddd}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar noPrint">
      <div class="brand">
        <!-- –í–ê–ñ–ù–û: –ø–æ–ª–æ–∂–∏ —Ñ–∞–π–ª logo.png —Ä—è–¥–æ–º —Å —ç—Ç–∏–º HTML -->
        <img class="logo" src="logo.png" alt="AI Bayan logo" />
        <div>
          <h1>AI Bayan ‚Ä¢ Grade 3</h1>
          <p class="muted">Units 1‚Äì8 ‚Ä¢ Login: 3E L1‚Äì3E L15 ‚Ä¢ PIN 2844</p>
        </div>
      </div>
      <div class="row">
        <div class="pill" id="whoPill">–ù–µ –≤–æ—à–ª–∏</div>
        <button class="btn ghost small" id="logoutBtn" style="display:none">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <!-- LOGIN -->
    <section class="screen active" id="screenLogin">
      <div class="grid">
        <div class="card">
          <h2 class="title">–í—Ö–æ–¥ —É—á–µ–Ω–∏–∫–∞</h2>
          <p class="sub">–õ–æ–≥–∏–Ω —Ç–æ–ª—å–∫–æ –∏–∑ —Å–ø–∏—Å–∫–∞: <b>3E L1</b> ‚Ä¶ <b>3E L15</b>. –ü–∞—Ä–æ–ª—å (PIN): <b>2844</b>.</p>
          <div class="row">
            <input class="input" id="loginName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 3E L7" autocomplete="off" />
            <input class="input" id="loginPin" placeholder="PIN" type="password" inputmode="numeric" autocomplete="off" />
            <button class="btn" id="loginBtn">–í–æ–π—Ç–∏</button>
          </div>
          <div class="hr"></div>
          <div class="row">
            <span class="tag">üë©‚Äçüè´ –ñ—É—Ä–Ω–∞–ª —É—á–∏—Ç–µ–ª—è: PIN 3244</span>
            <button class="btn secondary" id="openTeacherBtn">–û—Ç–∫—Ä—ã—Ç—å –∂—É—Ä–Ω–∞–ª</button>
          </div>
          <p class="muted" id="loginMsg" style="margin-top:10px"></p>
        </div>

        <div class="card">
          <h2 class="title">–ß—Ç–æ –≤–Ω—É—Ç—Ä–∏</h2>
          <p class="sub">–í –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é: 8 —é–Ω–∏—Ç–æ–≤ + AI —á–∞—Ç (–ª–∏–º–∏—Ç 1 –≤–æ–ø—Ä–æ—Å/–¥–µ–Ω—å) + –∂—É—Ä–Ω–∞–ª —É—á–∏—Ç–µ–ª—è.</p>
          <div class="row">
            <span class="stars">‚≠ê –ó–≤—ë–∑–¥—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</span>
            <span class="stars">‚úÖ/‚ùå —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</span>
            <span class="stars">üñ® Print –∫–∞–∂–¥–æ–≥–æ lesson</span>
            <span class="stars">üîä Vocabulary –≥–æ–≤–æ—Ä–∏—Ç ‚ÄúAI Bayan‚Äù</span>
            <span class="stars">üéµ Song = Karaoke (Start/Pause/Stop)</span>
          </div>
        </div>
      </div>
    </section>

    <!-- MAIN MENU -->
    <section class="screen" id="screenMain">
      <div class="grid">
        <div class="card">
          <h2 class="title">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
          <p class="sub">–í—ã–±–µ—Ä–∏ Unit. AI —á–∞—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å (1 –≤–æ–ø—Ä–æ—Å –≤ –¥–µ–Ω—å).</p>

          <div class="row noPrint" style="justify-content:space-between">
            <div class="row">
              <span class="stars" id="totalStarsBadge">‚≠ê 0</span>
              <span class="tag" id="todayChatTag">ü§ñ –ß–∞—Ç: –¥–æ—Å—Ç—É–ø–Ω–æ</span>
            </div>
            <div class="row">
              <button class="btn ghost" id="teacherBtn">üë©‚Äçüè´ Journal</button>
            </div>
          </div>

          <div class="hr noPrint"></div>
          <div class="row noPrint" id="unitsRow"></div>

          <div class="section noPrint">
            <h3>ü§ñ AI Bayan Chat (—Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)</h3>
            <p class="hint">–õ–∏–º–∏—Ç: 1 –≤–æ–ø—Ä–æ—Å –≤ –¥–µ–Ω—å –Ω–∞ —É—á–µ–Ω–∏–∫–∞. (–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å–≤–æ–π Cloudflare Worker ‚Äî –≤—Å—Ç–∞–≤—å URL –≤ –∫–æ–¥–µ.)</p>
            <div class="row">
              <input class="input" id="chatQ" placeholder="–ó–∞–¥–∞–π –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å..." />
              <button class="btn" id="chatAskBtn">–°–ø—Ä–æ—Å–∏—Ç—å</button>
            </div>
            <div class="hr"></div>
            <div id="chatA" class="muted"></div>
          </div>
        </div>

        <div class="card">
          <h2 class="title">–ü—Ä–æ–≥—Ä–µ—Å—Å</h2>
          <p class="sub">–ó–≤—ë–∑–¥—ã –∏ –æ—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ –ª–æ–≥–∏–Ω—É.</p>
          <div id="progressBox"></div>
        </div>
      </div>
    </section>

    <!-- UNIT (8 lessons inside) -->
    <section class="screen" id="screenUnit">
      <div class="card">
        <div class="row noPrint" style="justify-content:space-between">
          <div>
            <h2 class="title" id="unitTitle">Unit</h2>
            <p class="sub" id="unitSub">8 lessons –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ —é–Ω–∏—Ç–∞</p>
          </div>
          <div class="row">
            <span class="stars" id="unitStarsBadge">‚≠ê 0</span>
            <button class="btn ghost" id="backToMainBtn">‚¨Ö –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
            <button class="btn secondary" id="printLessonBtn">üñ® Print lesson</button>
          </div>
        </div>

        <div class="hr noPrint"></div>

        <div class="lessonTabs noPrint" id="lessonTabs"></div>

        <!-- LESSON CONTENT -->
        <div id="lessonContent">
          <!-- inserted -->
        </div>
      </div>
    </section>

    <!-- TEACHER -->
    <section class="screen" id="screenTeacher">
      <div class="card">
        <div class="row noPrint" style="justify-content:space-between">
          <div>
            <h2 class="title">üë©‚Äçüè´ Teacher Journal</h2>
            <p class="sub">–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –ø–æ PIN <b>3244</b>. –°–ø–∏—Å–æ–∫ –ª–æ–≥–∏–Ω–æ–≤: 3E L1‚Äì3E L15.</p>
          </div>
          <div class="row">
            <button class="btn ghost" id="backTeacherBtn">‚¨Ö –ù–∞–∑–∞–¥</button>
            <button class="btn danger" id="teacherResetBtn">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å (–≤—Å–µ)</button>
          </div>
        </div>

        <div class="section noPrint">
          <h3>–í—Ö–æ–¥ –≤ –∂—É—Ä–Ω–∞–ª</h3>
          <div class="row">
            <input class="input" id="teacherPin" placeholder="PIN 3244" type="password" inputmode="numeric" />
            <button class="btn" id="teacherLoginBtn">–û—Ç–∫—Ä—ã—Ç—å</button>
          </div>
          <p class="muted" id="teacherMsg" style="margin:10px 0 0 0"></p>
        </div>

        <div id="teacherTableWrap" style="display:none">
          <div class="hr"></div>
          <div class="section">
            <h3>–¢–∞–±–ª–∏—Ü–∞ —É—á–µ–Ω–∏–∫–æ–≤</h3>
            <div class="muted tiny">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç last login –∏ —Å—É–º–º–∞—Ä–Ω—ã–µ ‚≠ê.</div>
            <div style="overflow:auto;margin-top:10px">
              <table style="width:100%;border-collapse:collapse;font-size:13px">
                <thead>
                  <tr style="text-align:left">
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">–õ–æ–≥–∏–Ω</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">‚≠ê –í—Å–µ–≥–æ</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">Unit 1</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">Unit 2</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">Unit 3</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">Unit 4</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">Unit 5</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">Unit 6</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">Unit 7</th>
                    <th style="padding:10px;border-bottom:1px solid rgba(0,0,0,.12)">Unit 8</th>
                  </tr>
                </thead>
                <tbody id="teacherTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </section>
  </div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const STUDENT_PIN = "2844";
    const TEACHER_PIN = "3244";

    // –ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å Cloudflare Worker endpoint –¥–ª—è —á–∞—Ç–∞ ‚Äî –≤—Å—Ç–∞–≤—å —Å—é–¥–∞ URL:
    // (–æ–∂–∏–¥–∞–µ—Ç—Å—è POST {question, student, dateISO} -> {answer})
    const CHAT_ENDPOINT = ""; // –Ω–∞–ø—Ä–∏–º–µ—Ä: "https://your-worker.yourdomain.workers.dev/chat"

    // –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –ª–æ–≥–∏–Ω—ã 3E L1..L15
    const ALLOWED_LOGINS = Array.from({length:15}, (_,i)=>`3E L${i+1}`);

    /***********************
     * DATA (–®–ê–ë–õ–û–ù)
     * –ó–∞–ø–æ–ª–Ω–∏ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏/–∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏/–ø–µ—Å–Ω–µ–π –ø–æ Unit/lesson.
     ***********************/
    const APP_DATA = Array.from({length:8}, (_,u)=>({
      unitId: u+1,
      title: `Unit ${u+1}`,
      lessons: Array.from({length:8}, (_,l)=>({
        lessonId: l+1,
        title: `Lesson ${l+1}`,
        vocab: [
          {emoji:"‚òÄÔ∏è", en:"sun", ru:"—Å–æ–ª–Ω—Ü–µ"},
          {emoji:"‚òÅÔ∏è", en:"cloud", ru:"–æ–±–ª–∞–∫–æ"},
          {emoji:"üåßÔ∏è", en:"rain", ru:"–¥–æ–∂–¥—å"},
          {emoji:"‚ùÑÔ∏è", en:"snow", ru:"—Å–Ω–µ–≥"},
          {emoji:"üå¨Ô∏è", en:"wind", ru:"–≤–µ—Ç–µ—Ä"},
          {emoji:"üåà", en:"rainbow", ru:"—Ä–∞–¥—É–≥–∞"},
          {emoji:"‚ö°", en:"storm", ru:"–±—É—Ä—è"},
          {emoji:"üå°Ô∏è", en:"hot", ru:"–∂–∞—Ä–∫–æ"}
        ],
        grammar: {
          enTitle:"KM Grammar",
          enRule:"We use <b>It‚Äôs</b> + adjective to talk about weather: <b>It‚Äôs hot.</b> <b>It‚Äôs cold.</b>",
          ruRule:"–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º <b>It‚Äôs</b> + –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ –ø–æ–≥–æ–¥—É: <b>It‚Äôs hot.</b> <b>It‚Äôs cold.</b>"
        },
        ws1_missing: [
          {prompt:"s _ n", answer:"sun"},
          {prompt:"r a _ n", answer:"rain"},
          {prompt:"s n _ w", answer:"snow"},
          {prompt:"w i _ d", answer:"wind"},
        ],
        ws3_choose: [
          {q:"It‚Äôs ___ today.", options:["hot","has","are"], correct:0},
          {q:"It‚Äôs ___ . (‚ùÑÔ∏è)", options:["rain","snow","cloud"], correct:1},
          {q:"___ windy.", options:["It‚Äôs","He‚Äôs","I‚Äôm"], correct:0},
        ],
        reading: {
          dialog: [
            "A: Hi! How‚Äôs the weather?",
            "B: It‚Äôs sunny and hot.",
            "A: Great! Let‚Äôs go to the park.",
            "B: Yes! Let‚Äôs go!"
          ],
          tf: [
            {q:"It‚Äôs sunny.", a:true},
            {q:"They go to the zoo.", a:false}
          ]
        },
        song: {
          hasSong: (l===0), // –ø—Ä–∏–º–µ—Ä: –ø–µ—Å–Ω—è —Ç–æ–ª—å–∫–æ –≤ Lesson 1 (–ø–æ–º–µ–Ω—è–π –∫–∞–∫ –Ω—É–∂–Ω–æ)
          audioSrc: "",     // –ø–æ–ª–æ–∂–∏ —Ñ–∞–π–ª —Ä—è–¥–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä: "song_unit1_lesson1.mp3"
          lines: [
            {t:0,  text:"Sunny day, sunny day,"},
            {t:4,  text:"Let‚Äôs go out and play!"},
            {t:8,  text:"Windy breeze, windy breeze,"},
            {t:12, text:"Dance among the trees!"}
          ]
        }
      }))
    }));

    /***********************
     * STATE + STORAGE
     ***********************/
    const $ = (id)=>document.getElementById(id);

    let state = {
      student: null,
      currentUnit: null,
      currentLesson: 1
    };

    function keyBase(student){ return `AIB3_${student.replaceAll(" ","_")}`; }
    function loadJSON(k, fallback){
      try{ const v = localStorage.getItem(k); return v? JSON.parse(v): fallback; }catch(e){ return fallback; }
    }
    function saveJSON(k, obj){
      localStorage.setItem(k, JSON.stringify(obj));
    }

    function getProgress(){
      const base = keyBase(state.student);
      return loadJSON(`${base}_progress`, { stars:{}, marks:{}, lastLogin:null, chatDaily:{} });
    }
    function setProgress(p){
      const base = keyBase(state.student);
      saveJSON(`${base}_progress`, p);
    }

    function markLastLogin(){
      const p = getProgress();
      p.lastLogin = new Date().toISOString();
      setProgress(p);
    }

    function getStars(unitId, lessonId){
      const p = getProgress();
      return (p.stars?.[`${unitId}_${lessonId}`] ?? 0);
    }
    function addStar(unitId, lessonId, delta=1){
      const p = getProgress();
      const k = `${unitId}_${lessonId}`;
      p.stars = p.stars || {};
      p.stars[k] = (p.stars[k] ?? 0) + delta;
      setProgress(p);
      refreshBadges();
    }

    function getMark(unitId, lessonId, itemKey){
      const p = getProgress();
      const k = `${unitId}_${lessonId}_${itemKey}`;
      return p.marks?.[k] ?? null; // "ok" | "bad" | null
    }
    function setMark(unitId, lessonId, itemKey, value){
      const p = getProgress();
      p.marks = p.marks || {};
      const k = `${unitId}_${lessonId}_${itemKey}`;
      p.marks[k] = value;
      setProgress(p);
      refreshBadges();
    }

    function totalStars(){
      const p = getProgress();
      let s = 0;
      for(const k in (p.stars||{})) s += (p.stars[k]||0);
      return s;
    }
    function unitStars(unitId){
      const p = getProgress();
      let s = 0;
      for(const k in (p.stars||{})){
        if(k.startsWith(unitId+"_")) s += (p.stars[k]||0);
      }
      return s;
    }

    /***********************
     * SCREENS
     ***********************/
    function showScreen(id){
      ["screenLogin","screenMain","screenUnit","screenTeacher"].forEach(s=>{
        $(s).classList.toggle("active", s===id);
      });
    }

    function setWho(){
      const pill = $("whoPill");
      const btn = $("logoutBtn");
      if(state.student){
        pill.textContent = `‚úÖ ${state.student}`;
        btn.style.display = "inline-flex";
      }else{
        pill.textContent = "–ù–µ –≤–æ—à–ª–∏";
        btn.style.display = "none";
      }
    }

    $("logoutBtn").addEventListener("click", ()=>{
      state.student = null;
      state.currentUnit = null;
      state.currentLesson = 1;
      setWho();
      showScreen("screenLogin");
    });

    /***********************
     * LOGIN
     ***********************/
    function normalizeLogin(s){
      return (s||"").trim().replace(/\s+/g," ");
    }

    $("loginBtn").addEventListener("click", ()=>{
      const name = normalizeLogin($("loginName").value);
      const pin = ($("loginPin").value||"").trim();
      if(!ALLOWED_LOGINS.includes(name)){
        $("loginMsg").textContent = "‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 3E L1 ‚Ä¶ 3E L15.";
        return;
      }
      if(pin !== STUDENT_PIN){
        $("loginMsg").textContent = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π PIN.";
        return;
      }
      state.student = name;
      $("loginMsg").textContent = "";
      setWho();
      markLastLogin();
      buildMain();
      showScreen("screenMain");
    });

    /***********************
     * MAIN MENU
     ***********************/
    function buildUnitsRow(){
      const row = $("unitsRow");
      row.innerHTML = "";
      APP_DATA.forEach(u=>{
        const b = document.createElement("button");
        b.className = "btn unit";
        b.innerHTML = `üìò ${u.title} <span class="tiny">‚≠ê ${unitStars(u.unitId)}</span>`;
        b.addEventListener("click", ()=>openUnit(u.unitId));
        row.appendChild(b);
      });
    }

    function buildProgressBox(){
      const box = $("progressBox");
      box.innerHTML = "";
      const p = getProgress();
      const last = p.lastLogin ? new Date(p.lastLogin).toLocaleString() : "‚Äî";
      const div = document.createElement("div");
      div.className = "section";
      div.innerHTML = `
        <h3>üë§ ${state.student}</h3>
        <p class="hint">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥: <b>${last}</b></p>
        <div class="row">
          <span class="stars">‚≠ê –í—Å–µ–≥–æ: ${totalStars()}</span>
          ${APP_DATA.map(u=>`<span class="tag">${u.title}: ‚≠ê ${unitStars(u.unitId)}</span>`).join("")}
        </div>
      `;
      box.appendChild(div);
    }

    function refreshChatTag(){
      const tag = $("todayChatTag");
      const p = getProgress();
      const d = new Date().toISOString().slice(0,10); // YYYY-MM-DD
      const used = !!p.chatDaily?.[d];
      tag.textContent = used ? "ü§ñ –ß–∞—Ç: –ª–∏–º–∏—Ç —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω" : "ü§ñ –ß–∞—Ç: –¥–æ—Å—Ç—É–ø–Ω–æ 1 –≤–æ–ø—Ä–æ—Å";
      tag.style.borderColor = used ? "rgba(214,40,40,.35)" : "rgba(43,147,72,.35)";
      tag.style.background = used ? "#ffecec" : "#f4fff7";
    }

    function buildMain(){
      $("totalStarsBadge").textContent = `‚≠ê ${totalStars()}`;
      buildUnitsRow();
      buildProgressBox();
      refreshChatTag();
      $("chatA").textContent = "";
      $("chatQ").value = "";
    }

    /***********************
     * AI CHAT (1 per day)
     ***********************/
    async function askChat(){
      const q = ($("chatQ").value||"").trim();
      if(!q){ $("chatA").textContent = "–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å üòä"; return; }

      const p = getProgress();
      const d = new Date().toISOString().slice(0,10);
      p.chatDaily = p.chatDaily || {};
      if(p.chatDaily[d]){
        $("chatA").textContent = "‚ùå –°–µ–≥–æ–¥–Ω—è –ª–∏–º–∏—Ç —á–∞—Ç–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω (1 –≤–æ–ø—Ä–æ—Å –≤ –¥–µ–Ω—å).";
        refreshChatTag();
        return;
      }

      // mark used now (—á—Ç–æ–±—ã –Ω–µ –æ–±–æ–π—Ç–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ)
      p.chatDaily[d] = true;
      setProgress(p);
      refreshChatTag();

      // If endpoint set -> use it; else offline answer
      if(CHAT_ENDPOINT){
        try{
          $("chatA").textContent = "‚Ä¶";
          const res = await fetch(CHAT_ENDPOINT, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ question:q, student: state.student, dateISO: new Date().toISOString() })
          });
          const data = await res.json();
          $("chatA").textContent = data.answer ? String(data.answer) : "–û—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω.";
        }catch(e){
          $("chatA").textContent = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —á–∞—Ç—É. (–ü—Ä–æ–≤–µ—Ä—å URL CHAT_ENDPOINT.)";
        }
      }else{
        // Offline friendly reply
        $("chatA").textContent =
          "AI Bayan: –ü–æ–ø—Ä–æ–±—É–π —Ç–∞–∫ üëá\n" +
          "1) –ü—Ä–æ—á–∏—Ç–∞–π –ø—Ä–∞–≤–∏–ª–æ (Grammar KM).\n" +
          "2) –°–¥–µ–ª–∞–π Worksheet 1 (–±—É–∫–≤—ã) ‚Üí Worksheet 2 (matching) ‚Üí Worksheet 3 (choose).\n" +
          "3) –í Reading –æ—Ç–≤–µ—Ç—å True/False.\n" +
          "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –Ω–∞–ø–∏—à–∏ —Å–ª–æ–≤–æ, –∏ —è –ø–æ–º–æ–≥—É —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º –∏ –ø—Ä–∏–º–µ—Ä–æ–º.";
      }
    }
    $("chatAskBtn").addEventListener("click", askChat);

    /***********************
     * UNIT + LESSONS
     ***********************/
    function openUnit(unitId){
      state.currentUnit = unitId;
      state.currentLesson = 1;
      buildUnit();
      showScreen("screenUnit");
    }

    $("backToMainBtn").addEventListener("click", ()=>{
      buildMain();
      showScreen("screenMain");
    });

    $("printLessonBtn").addEventListener("click", ()=>{
      window.print();
    });

    function buildLessonTabs(unit){
      const tabs = $("lessonTabs");
      tabs.innerHTML = "";
      unit.lessons.forEach(les=>{
        const t = document.createElement("button");
        t.className = "tab" + (les.lessonId===state.currentLesson ? " active":"");
        t.textContent = `Lesson ${les.lessonId}`;
        t.addEventListener("click", ()=>{
          state.currentLesson = les.lessonId;
          buildUnit();
        });
        tabs.appendChild(t);
      });
    }

    function refreshBadges(){
      if(!state.student) return;
      $("totalStarsBadge").textContent = `‚≠ê ${totalStars()}`;
      if(state.currentUnit){
        $("unitStarsBadge").textContent = `‚≠ê ${unitStars(state.currentUnit)}`;
      }
      // refresh unit buttons stars
      const row = $("unitsRow");
      if(row && row.children){
        Array.from(row.children).forEach((btn,i)=>{
          const u = APP_DATA[i];
          if(u){
            btn.innerHTML = `üìò ${u.title} <span class="tiny">‚≠ê ${unitStars(u.unitId)}</span>`;
          }
        });
      }
    }

    // "AI Bayan" voice (Web Speech API)
    function speakAI(text){
      try{
        const u = new SpeechSynthesisUtterance(text);
        // Try pick English voice if available
        const voices = speechSynthesis.getVoices ? speechSynthesis.getVoices() : [];
        const v = voices.find(v=>/en/i.test(v.lang)) || voices[0];
        if(v) u.voice = v;
        u.lang = (v && v.lang) ? v.lang : "en-US";
        u.rate = 0.9;
        u.pitch = 1.1;
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      }catch(e){
        alert("–ù–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –æ–∑–≤—É—á–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.");
      }
    }
    // iOS/Android sometimes loads voices later
    if("speechSynthesis" in window){
      window.speechSynthesis.onvoiceschanged = ()=>{};
    }

    function buildUnit(){
      const unit = APP_DATA.find(u=>u.unitId===state.currentUnit);
      const les = unit.lessons.find(l=>l.lessonId===state.currentLesson);

      $("unitTitle").textContent = unit.title;
      $("unitSub").textContent = `${les.title} ‚Ä¢ 8 lessons –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ —é–Ω–∏—Ç–∞`;
      $("unitStarsBadge").textContent = `‚≠ê ${unitStars(unit.unitId)}`;

      buildLessonTabs(unit);

      const root = $("lessonContent");
      root.innerHTML = "";

      // Section 1: Visual Vocabulary
      const s1 = document.createElement("div");
      s1.className = "section";
      s1.innerHTML = `
        <h3>1) Visual Vocabulary</h3>
        <p class="hint">–°–ª–æ–≤–∞ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º. –ö–∞—Ä—Ç–∏–Ω–∫–∏ —Å–µ—Ç–∫–æ–π (2 —Ä—è–¥–∞). –ù–∞–∂–º–∏ üîä ‚Äî ‚ÄúAI Bayan‚Äù –≥–æ–≤–æ—Ä–∏—Ç —Å–ª–æ–≤–æ.</p>
        <div class="vGrid" id="vGrid"></div>
      `;
      root.appendChild(s1);

      const vGrid = s1.querySelector("#vGrid");
      les.vocab.forEach((w,idx)=>{
        const item = document.createElement("div");
        item.className = "vItem";
        item.innerHTML = `
          <div class="vPic" aria-hidden="true">${w.emoji || "üß∏"}</div>
          <div class="vSpeakRow">
            <div>
              <div class="vWord">${w.en}</div>
              <div class="vRu">${w.ru}</div>
            </div>
            <button class="btn secondary small noPrint" title="Speak">üîä</button>
          </div>
        `;
        item.querySelector("button").addEventListener("click", ()=>speakAI(w.en));
        vGrid.appendChild(item);
      });

      // Section 2: Grammar KM (EN+RU)
      const s2 = document.createElement("div");
      s2.className = "section";
      s2.innerHTML = `
        <h3>2) ${les.grammar.enTitle}</h3>
        <div class="qa">
          <div style="flex:1">
            <div><b>EN:</b> <span>${les.grammar.enRule}</span></div>
            <div style="margin-top:8px"><b>RU:</b> <span>${les.grammar.ruRule}</span></div>
          </div>
        </div>
      `;
      root.appendChild(s2);

      // Stars summary (lesson)
      const lessonStars = getStars(unit.unitId, les.lessonId);
      const starBox = document.createElement("div");
      starBox.className = "section";
      starBox.innerHTML = `
        <h3>‚≠ê Stars for this lesson</h3>
        <div class="row">
          <span class="stars">‚≠ê ${lessonStars}</span>
          <span class="tag">‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç = +1 ‚≠ê</span>
          <span class="tag">–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è</span>
        </div>
      `;
      root.appendChild(starBox);

      // Worksheet 1: Missing letters
      const s3 = document.createElement("div");
      s3.className = "section";
      s3.innerHTML = `
        <h3>3) Worksheet 1 ‚Äî Missing Letters</h3>
        <p class="hint">–í–ø–∏—à–∏ —Å–ª–æ–≤–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏ –Ω–∞–∂–º–∏ Check.</p>
        <div id="ws1"></div>
      `;
      root.appendChild(s3);
      const ws1 = s3.querySelector("#ws1");

      les.ws1_missing.forEach((it,i)=>{
        const itemKey = `ws1_${i}`;
        const mark = getMark(unit.unitId, les.lessonId, itemKey);
        const row = document.createElement("div");
        row.className = "qa";
        row.innerHTML = `
          <div class="mark ${mark==="ok"?"ok":mark==="bad"?"bad":""}">${mark==="ok"?"‚úÖ":mark==="bad"?"‚úñ":"‚Ä¢"}</div>
          <div style="min-width:110px;font-weight:900">${it.prompt}</div>
          <input class="input" style="min-width:180px" placeholder="answer" data-i="${i}" />
          <button class="btn small">Check</button>
        `;
        const inp = row.querySelector("input");
        const btn = row.querySelector("button");
        // Restore previously correct value? (optional)
        if(mark==="ok") inp.value = it.answer;

        btn.addEventListener("click", ()=>{
          const ans = (inp.value||"").trim().toLowerCase();
          if(ans === it.answer.toLowerCase()){
            if(getMark(unit.unitId, les.lessonId, itemKey)!=="ok"){
              addStar(unit.unitId, les.lessonId, 1);
            }
            setMark(unit.unitId, les.lessonId, itemKey, "ok");
          }else{
            setMark(unit.unitId, les.lessonId, itemKey, "bad");
          }
          buildUnit(); // quick rerender to show marks
        });

        ws1.appendChild(row);
      });

      // Worksheet 2: Matching (pictures + words)
      const s4 = document.createElement("div");
      s4.className = "section";
      s4.innerHTML = `
        <h3>4) Worksheet 2 ‚Äî Matching (Pictures + Words)</h3>
        <p class="hint">–ù–∞–∂–º–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É ‚Üí –ø–æ—Ç–æ–º —Å–ª–æ–≤–æ. –°–¥–µ–ª–∞–π –ø–∞—Ä—ã.</p>
        <div class="matchWrap" id="matchWrap"></div>
      `;
      root.appendChild(s4);

      const matchWrap = s4.querySelector("#matchWrap");
      const left = document.createElement("div");
      left.className = "matchCol";
      const right = document.createElement("div");
      right.className = "matchCol";
      left.innerHTML = `<div style="font-weight:900;margin-bottom:8px">Pictures</div>`;
      right.innerHTML = `<div style="font-weight:900;margin-bottom:8px">Words</div>`;

      const pairs = les.vocab.slice(0,6).map((w,idx)=>({id:idx, ...w}));
      const pics = [...pairs].sort(()=>Math.random()-0.5);
      const words = [...pairs].sort(()=>Math.random()-0.5);

      let selPic = null;
      let selWord = null;

      pics.forEach(p=>{
        const k = `ws2_pic_${p.id}`;
        const done = getMark(unit.unitId, les.lessonId, `ws2_done_${p.id}`)==="ok";
        const el = document.createElement("div");
        el.className = "matchItem" + (done?" done":"");
        el.innerHTML = `<span>${p.emoji} <span class="tiny">#${p.id+1}</span></span><span class="tiny">${done?"‚úÖ":""}</span>`;
        el.addEventListener("click", ()=>{
          if(done) return;
          Array.from(left.querySelectorAll(".matchItem")).forEach(x=>x.classList.remove("selected"));
          el.classList.add("selected");
          selPic = p;
          tryPair();
        });
        left.appendChild(el);
      });

      words.forEach(w=>{
        const done = getMark(unit.unitId, les.lessonId, `ws2_done_${w.id}`)==="ok";
        const el = document.createElement("div");
        el.className = "matchItem" + (done?" done":"");
        el.innerHTML = `<span>${w.en}</span><span class="tiny">${done?"‚úÖ":""}</span>`;
        el.addEventListener("click", ()=>{
          if(done) return;
          Array.from(right.querySelectorAll(".matchItem")).forEach(x=>x.classList.remove("selected"));
          el.classList.add("selected");
          selWord = w;
          tryPair();
        });
        right.appendChild(el);
      });

      function tryPair(){
        if(!selPic || !selWord) return;
        const itemKey = `ws2_pair_${selPic.id}_${selWord.id}`;
        const correct = (selPic.id === selWord.id);

        if(correct){
          // award only once for each id
          if(getMark(unit.unitId, les.lessonId, `ws2_done_${selPic.id}`)!=="ok"){
            addStar(unit.unitId, les.lessonId, 1);
          }
          setMark(unit.unitId, les.lessonId, `ws2_done_${selPic.id}`, "ok");
        }else{
          setMark(unit.unitId, les.lessonId, itemKey, "bad");
        }
        selPic = null; selWord = null;
        buildUnit();
      }

      matchWrap.appendChild(left);
      matchWrap.appendChild(right);

      // Worksheet 3: Choose correct word (Grammar)
      const s5 = document.createElement("div");
      s5.className = "section";
      s5.innerHTML = `
        <h3>5) Worksheet 3 ‚Äî Choose the Correct Word (Grammar)</h3>
        <p class="hint">–í—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∏ –Ω–∞–∂–º–∏ Check.</p>
        <div id="ws3"></div>
      `;
      root.appendChild(s5);
      const ws3 = s5.querySelector("#ws3");

      les.ws3_choose.forEach((it,i)=>{
        const itemKey = `ws3_${i}`;
        const mark = getMark(unit.unitId, les.lessonId, itemKey);
        const box = document.createElement("div");
        box.className = "qa";
        box.innerHTML = `
          <div class="mark ${mark==="ok"?"ok":mark==="bad"?"bad":""}">${mark==="ok"?"‚úÖ":mark==="bad"?"‚úñ":"‚Ä¢"}</div>
          <div style="flex:1">
            <div style="font-weight:900;margin-bottom:8px">${it.q}</div>
            <div class="row" id="opts"></div>
            <div class="row" style="margin-top:8px">
              <button class="btn small">Check</button>
            </div>
          </div>
        `;
        const opts = box.querySelector("#opts");
        const group = `g_${unit.unitId}_${les.lessonId}_${i}`;
        it.options.forEach((op,idx)=>{
          const lab = document.createElement("label");
          lab.className = "tag";
          lab.style.cursor = "pointer";
          lab.innerHTML = `<input type="radio" name="${group}" value="${idx}" style="transform:scale(1.1)"> ${op}`;
          opts.appendChild(lab);
        });

        const btn = box.querySelector("button");
        btn.addEventListener("click", ()=>{
          const chosen = box.querySelector(`input[name="${group}"]:checked`);
          if(!chosen){ alert("–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç üôÇ"); return; }
          const val = Number(chosen.value);
          if(val === it.correct){
            if(getMark(unit.unitId, les.lessonId, itemKey)!=="ok"){
              addStar(unit.unitId, les.lessonId, 1);
            }
            setMark(unit.unitId, les.lessonId, itemKey, "ok");
          }else{
            setMark(unit.unitId, les.lessonId, itemKey, "bad");
          }
          buildUnit();
        });

        ws3.appendChild(box);
      });

      // Worksheet 4: Reading mini dialog + 2 TF
      const s6 = document.createElement("div");
      s6.className = "section";
      s6.innerHTML = `
        <h3>6) Worksheet 4 ‚Äî Reading Mini (Dialog)</h3>
        <p class="hint">–ü—Ä–æ—á–∏—Ç–∞–π –¥–∏–∞–ª–æ–≥. –ü–æ—Ç–æ–º 2 –≤–æ–ø—Ä–æ—Å–∞ True/False.</p>
        <div class="qa" style="display:block">
          <div style="font-weight:900;margin-bottom:8px">Dialog</div>
          <div style="line-height:1.55" id="dialog"></div>
        </div>
        <div id="tfBox" style="margin-top:10px"></div>
      `;
      root.appendChild(s6);

      s6.querySelector("#dialog").innerHTML = les.reading.dialog.map(x=>`<div>${x}</div>`).join("");

      const tfBox = s6.querySelector("#tfBox");
      les.reading.tf.forEach((tfi,i)=>{
        const itemKey = `ws4_tf_${i}`;
        const mark = getMark(unit.unitId, les.lessonId, itemKey);
        const row = document.createElement("div");
        row.className = "qa";
        row.innerHTML = `
          <div class="mark ${mark==="ok"?"ok":mark==="bad"?"bad":""}">${mark==="ok"?"‚úÖ":mark==="bad"?"‚úñ":"‚Ä¢"}</div>
          <div style="flex:1;font-weight:900">${tfi.q}</div>
          <label class="tag" style="cursor:pointer"><input type="radio" name="tf_${i}" value="true"> True</label>
          <label class="tag" style="cursor:pointer"><input type="radio" name="tf_${i}" value="false"> False</label>
          <button class="btn small">Check</button>
        `;
        row.querySelector("button").addEventListener("click", ()=>{
          const chosen = row.querySelector(`input[name="tf_${i}"]:checked`);
          if(!chosen){ alert("–í—ã–±–µ—Ä–∏ True –∏–ª–∏ False üôÇ"); return; }
          const val = (chosen.value === "true");
          if(val === tfi.a){
            if(getMark(unit.unitId, les.lessonId, itemKey)!=="ok"){
              addStar(unit.unitId, les.lessonId, 1);
            }
            setMark(unit.unitId, les.lessonId, itemKey, "ok");
          }else{
            setMark(unit.unitId, les.lessonId, itemKey, "bad");
          }
          buildUnit();
        });
        tfBox.appendChild(row);
      });

      // Song Karaoke (if exists)
      if(les.song && les.song.hasSong){
        const s7 = document.createElement("div");
        s7.className = "section";
        s7.innerHTML = `
          <h3>7) Song ‚Äî Karaoke</h3>
          <p class="hint">–ö–Ω–æ–ø–∫–∏: Start / Pause / Stop. –¢–µ–∫—Å—Ç –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏.</p>
          <div class="karaokeBox">
            <audio id="aud" preload="metadata"></audio>
            <div class="row noPrint" style="margin-bottom:10px">
              <button class="btn small" id="kStart">‚ñ∂ Start</button>
              <button class="btn ghost small" id="kPause">‚è∏ Pause</button>
              <button class="btn danger small" id="kStop">‚èπ Stop</button>
              <span class="tiny muted">–ï—Å–ª–∏ –Ω–µ—Ç mp3 ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç.</span>
            </div>
            <div id="lyrics"></div>
          </div>
        `;
        root.appendChild(s7);

        const aud = s7.querySelector("#aud");
        // If audioSrc empty -> no audio, only text highlight won't run
        if(les.song.audioSrc){
          aud.src = les.song.audioSrc;
        }

        const lyrics = s7.querySelector("#lyrics");
        les.song.lines.forEach((ln,idx)=>{
          const div = document.createElement("div");
          div.className = "lyricLine";
          div.dataset.idx = String(idx);
          div.textContent = ln.text;
          lyrics.appendChild(div);
        });

        const lines = les.song.lines;
        function highlightByTime(t){
          let active = 0;
          for(let i=0;i<lines.length;i++){
            if(t >= lines[i].t) active = i;
          }
          Array.from(lyrics.children).forEach((c,i)=>c.classList.toggle("active", i===active));
        }

        let tick = null;
        function startTick(){
          stopTick();
          tick = setInterval(()=>highlightByTime(aud.currentTime||0), 150);
        }
        function stopTick(){
          if(tick){ clearInterval(tick); tick=null; }
        }

        s7.querySelector("#kStart").addEventListener("click", async ()=>{
          if(aud.src){
            try{ await aud.play(); startTick(); }catch(e){ /* autoplay block */ }
          }else{
            // No audio -> just simulate
            let t=0;
            stopTick();
            tick=setInterval(()=>{
              t+=0.15; highlightByTime(t);
              if(t> (lines[lines.length-1].t+4)) stopTick();
            },150);
          }
        });
        s7.querySelector("#kPause").addEventListener("click", ()=>{
          if(aud.src) aud.pause();
          stopTick();
        });
        s7.querySelector("#kStop").addEventListener("click", ()=>{
          if(aud.src){ aud.pause(); aud.currentTime=0; }
          stopTick();
          Array.from(lyrics.children).forEach(c=>c.classList.remove("active"));
        });

        aud.addEventListener("ended", ()=>{ stopTick(); });
      }

      refreshBadges();
    }

    /***********************
     * TEACHER JOURNAL
     ***********************/
    function openTeacher(){
      showScreen("screenTeacher");
      $("teacherMsg").textContent = "";
      $("teacherTableWrap").style.display = "none";
      $("teacherPin").value = "";
    }
    $("openTeacherBtn").addEventListener("click", openTeacher);
    $("teacherBtn").addEventListener("click", openTeacher);
    $("backTeacherBtn").addEventListener("click", ()=>{
      if(state.student){ buildMain(); showScreen("screenMain"); }
      else showScreen("screenLogin");
    });

    $("teacherLoginBtn").addEventListener("click", ()=>{
      const pin = ($("teacherPin").value||"").trim();
      if(pin !== TEACHER_PIN){
        $("teacherMsg").textContent = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π PIN.";
        return;
      }
      $("teacherMsg").textContent = "‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω.";
      $("teacherTableWrap").style.display = "block";
      buildTeacherTable();
    });

    function teacherReadStudentProgress(login){
      const base = `AIB3_${login.replaceAll(" ","_")}`;
      return loadJSON(`${base}_progress`, { stars:{}, marks:{}, lastLogin:null, chatDaily:{} });
    }

    function buildTeacherTable(){
      const tb = $("teacherTbody");
      tb.innerHTML = "";
      ALLOWED_LOGINS.forEach(login=>{
        const p = teacherReadStudentProgress(login);
        const last = p.lastLogin ? new Date(p.lastLogin).toLocaleString() : "‚Äî";
        const total = (()=>{ let s=0; for(const k in (p.stars||{})) s += (p.stars[k]||0); return s; })();
        const perUnit = (u)=>{
          let s=0;
          for(const k in (p.stars||{})) if(k.startsWith(u+"_")) s += (p.stars[k]||0);
          return s;
        };
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="padding:10px;border-bottom:1px solid rgba(0,0,0,.08);font-weight:900">${login}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(0,0,0,.08)">${last}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(0,0,0,.08);font-weight:900">‚≠ê ${total}</td>
          ${Array.from({length:8},(_,i)=>`<td style="padding:10px;border-bottom:1px solid rgba(0,0,0,.08)">‚≠ê ${perUnit(i+1)}</td>`).join("")}
        `;
        tb.appendChild(tr);
      });
    }

    $("teacherResetBtn").addEventListener("click", ()=>{
      const pin = ($("teacherPin").value||"").trim();
      if(pin !== TEACHER_PIN){
        alert("–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏ PIN 3244.");
        return;
      }
      if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —É –í–°–ï–• —É—á–µ–Ω–∏–∫–æ–≤?")) return;
      ALLOWED_LOGINS.forEach(login=>{
        const base = `AIB3_${login.replaceAll(" ","_")}`;
        localStorage.removeItem(`${base}_progress`);
      });
      buildTeacherTable();
      alert("–ì–æ—Ç–æ–≤–æ ‚úÖ");
    });

    /***********************
     * INIT
     ***********************/
    setWho();
    // Enter key shortcuts
    $("loginName").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("loginPin").focus(); });
    $("loginPin").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("loginBtn").click(); });
    $("chatQ").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("chatAskBtn").click(); });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Bayan Vocabulary 3 Grade</title>
  <style>
    :root{
      --bg:#0b6f78;
      --bg2:#0a5f67;
      --gold:#f3c84b;
      --card:#ffffff;
      --ink:#0c2a2f;
      --muted:#5b6b70;
      --btn:#ffffff;
      --btnBorder:#0c6a73;
      --shadow:0 10px 25px rgba(0,0,0,.12);
      --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg,var(--bg),var(--bg2));
      color:#fff;
    }
    a{color:inherit;text-decoration:none}
    .app{
      max-width: 760px;
      margin: 0 auto;
      min-height: 100vh;
      padding-bottom: 34px;
    }

    /* TOP HERO */
    .hero{
      padding: 28px 18px 16px;
      text-align:center;
    }
    .logoWrap{
      width:170px;height:170px;
      margin:0 auto 14px;
      border-radius:999px;
      background: radial-gradient(circle at 50% 40%, #fff 0 62%, rgba(255,255,255,.15) 63% 100%);
      border: 6px solid rgba(243,200,75,.95);
      box-shadow: 0 12px 25px rgba(0,0,0,.25);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .logoWrap img{width:100%;height:100%;object-fit:cover;display:block}
    .brandTitle{
      font-weight: 900;
      letter-spacing: .8px;
      font-size: 34px;
      line-height: 1.1;
      color: var(--gold);
      text-transform: uppercase;
      text-shadow: 0 4px 10px rgba(0,0,0,.25);
    }
    .brandSub{
      margin-top:6px;
      font-weight: 800;
      opacity:.95;
      font-size: 16px;
      letter-spacing:.6px;
    }

    /* WHITE PANEL */
    .panel{
      margin: 14px 14px 28px;
      background: #fff;
      border-radius: 26px;
      padding: 14px 14px 18px;
      box-shadow: var(--shadow);
      color: var(--ink);
      border: 3px solid rgba(243,200,75,.65);
    }
    .helloCard{
      background: linear-gradient(180deg,#ffffff,#f4fbfc);
      border-radius: 18px;
      padding: 14px 14px;
      text-align:center;
      border: 2px solid rgba(12,106,115,.20);
      margin-bottom: 12px;
    }
    .helloCard .big{
      font-size: 22px;
      font-weight: 900;
      margin-bottom: 4px;
      color:#0b4f56;
    }
    .helloCard .starsLine{
      font-weight: 800;
      color:#134a50;
    }

    /* MENU BUTTONS */
    .menuList{display:flex;flex-direction:column;gap:14px;margin-top:10px}
    .menuBtn{
      background: var(--btn);
      border-radius: 22px;
      padding: 18px 16px;
      font-size: 20px;
      font-weight: 900;
      text-align:center;
      border: 3px solid rgba(12,106,115,.55);
      color:#0a4a52;
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      user-select:none;
    }
    .menuBtn:active{transform: scale(.99)}
    .menuBtn small{display:block;font-weight:700;color:#30666d;margin-top:2px;font-size:13px}

    /* BOTTOM MINI BUTTONS */
    .bottomRow{
      margin-top: 16px;
      display:flex;
      gap: 12px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .miniBtn{
      background:#fff;
      border-radius: 16px;
      padding: 12px 14px;
      font-weight: 900;
      border: 3px solid rgba(12,106,115,.55);
      color:#0a4a52;
      min-width: 170px;
      text-align:center;
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
    }

    /* AUTH SCREEN */
    .auth{
      max-width: 520px;
      margin: 0 auto;
      padding: 16px 0 0;
    }
    .authBox{
      background:#fff;
      border-radius: 22px;
      padding: 16px;
      border: 3px solid rgba(243,200,75,.55);
      box-shadow: var(--shadow);
      color: var(--ink);
    }
    .field{margin:10px 0}
    .label{font-weight:900;color:#0a4a52;margin-bottom:6px}
    .input{
      width:100%;
      padding: 13px 12px;
      border-radius: 14px;
      border: 2px solid rgba(12,106,115,.25);
      outline:none;
      font-size: 16px;
    }
    .row{
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .row .btn{
      flex:1;
      min-width: 180px;
    }
    .btn{
      border:none;
      border-radius: 16px;
      padding: 14px 14px;
      font-weight: 900;
      font-size: 16px;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
    }
    .btnPrimary{
      background: linear-gradient(180deg,#0d7a83,#0b6168);
      color:#fff;
    }
    .btnGhost{
      background:#fff;
      border: 3px solid rgba(12,106,115,.55);
      color:#0a4a52;
    }
    .note{
      margin-top:10px;
      color:#567277;
      font-size: 13px;
      font-weight: 700;
      text-align:center;
    }

    /* LESSON PAGE */
    .lessonHero{
      padding: 16px 14px 0;
      color:#fff;
    }
    .lessonBanner{
      border-radius: 26px;
      padding: 18px 16px;
      background: linear-gradient(90deg,#1a8d97,#0b6f78);
      border: 3px solid rgba(243,200,75,.65);
      box-shadow: 0 12px 25px rgba(0,0,0,.16);
      display:flex;
      gap: 14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .lessonBanner .title{
      font-size: 22px;
      font-weight: 1000;
      letter-spacing:.2px;
    }
    .lessonBanner .sub{
      font-size: 14px;
      font-weight: 800;
      opacity:.95;
      margin-top:4px;
    }
    .badge{
      background: rgba(255,255,255,.18);
      border: 2px solid rgba(255,255,255,.22);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      white-space:nowrap;
    }
    .lessonPanel{
      margin: 12px 14px 28px;
      background:#fff;
      color:var(--ink);
      border-radius: 26px;
      padding: 14px;
      border: 3px solid rgba(243,200,75,.65);
      box-shadow: var(--shadow);
    }
    .sectionTitle{
      display:flex;align-items:center;gap:10px;
      padding: 12px 12px;
      background: linear-gradient(90deg,#0b6f78,#15909b);
      color:#fff;
      border-radius: 18px;
      font-weight: 1000;
      font-size: 16px;
      margin: 10px 0 12px;
      border: 2px solid rgba(0,0,0,.06);
    }
    .vocabGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .vCard{
      background: #eef9fb;
      border-radius: 18px;
      padding: 12px;
      border: 2px solid rgba(12,106,115,.18);
      text-align:center;
    }
    .vIcon{
      width:72px;height:72px;border-radius:16px;
      background:#fff;
      margin: 0 auto 8px;
      display:flex;align-items:center;justify-content:center;
      border: 2px solid rgba(0,0,0,.06);
      font-size: 36px;
    }
    .vWord{font-weight:1000;font-size:20px;color:#0a4a52;text-transform:lowercase}
    .vRu{font-weight:900;color:#3d6167;margin-top:2px}
    .sayBtn{
      margin-top:10px;
      border:none;
      background: linear-gradient(180deg,#0b6f78,#0a5b62);
      color:#fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 1000;
      cursor:pointer;
      width: 100%;
    }
    .ruleBox{
      background:#eaf6ff;
      border: 2px solid rgba(40,120,190,.20);
      border-radius: 18px;
      padding: 14px;
      color:#103a4a;
    }
    .ruleBox h3{margin:0 0 8px;font-size:18px}
    .ruleBox p{margin:6px 0;font-weight:700;color:#285463}
    .ruleBox ul{margin:8px 0 0 18px}
    .ruleBox li{margin:6px 0;font-weight:800}

    .wsBox{
      border-radius: 18px;
      border: 2px dashed rgba(0,0,0,.25);
      padding: 12px;
      margin: 12px 0;
      background:#fff;
    }
    .wsBox h4{margin:0 0 6px;font-size:18px;color:#0a4a52}
    .wsBox p{margin:0 0 10px;color:#4b666c;font-weight:700}
    .qRow{display:flex;gap:10px;align-items:center;margin:8px 0;flex-wrap:wrap}
    .qRow .q{font-weight:900}
    .qRow input[type="text"]{
      flex:1;min-width: 160px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 2px solid rgba(12,106,115,.22);
      outline:none;
    }
    .select{
      flex:1;min-width: 200px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 2px solid rgba(12,106,115,.22);
      outline:none;
      background:#fff;
      font-weight:800;
    }
    .checkRow{
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      margin-top: 10px;
    }
    .checkBtn{
      border:none;
      background: linear-gradient(180deg,#0b6f78,#0a5b62);
      color:#fff;
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 1000;
      cursor:pointer;
      min-width: 140px;
    }
    .scoreTxt{font-weight:1000;color:#0a4a52}

    .navRow{
      display:flex;gap:12px;justify-content:space-between;flex-wrap:wrap;margin-top: 14px;
    }
    .navRow .btn{flex:1;min-width: 160px}
    .btnBlue{
      background: linear-gradient(180deg,#1f7bd0,#195a9e);
      color:#fff;
    }
    .btnGreen{
      background: linear-gradient(180deg,#1aa06c,#137e53);
      color:#fff;
    }

    .footerLine{
      margin-top: 12px;
      text-align:center;
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,.90);
      padding: 12px 10px 0;
    }
    .footerBar{
      margin-top: 12px;
      padding: 10px 8px;
      background: rgba(0,0,0,.12);
      border-radius: 14px;
      text-align:center;
      font-weight:900;
      color:#fff;
      font-size: 12px;
    }

    @media (max-width:520px){
      .brandTitle{font-size:28px}
      .menuBtn{font-size:18px}
      .vocabGrid{grid-template-columns:1fr 1fr}
    }
  </style>
</head>
<body>
  <div class="app" id="app"></div>

<script>
/* ===============================
   CONFIG
================================ */
const APP_TITLE = "AI Bayan Vocabulary 3 Grade";
const STUDENT_PIN = "2844";
const TEACHER_PIN = "3244";
const CLASS_CODE = "3E";
const MAX_L = 15;

// Unit 1 ‚Äì 8 lessons (–ø–æ —Ñ–æ—Ç–æ)
const UNIT1_LESSONS = [
  { id:"u1l1", title:"Lesson 1", subtitle:"Hello, hello!", vocabTopic:"Greetings", vocab:[
    {en:"hello", ru:"–ø—Ä–∏–≤–µ—Ç", emoji:"üëã"},
    {en:"goodbye", ru:"–ø–æ–∫–∞", emoji:"üëã"},
    {en:"how are you?", ru:"–∫–∞–∫ –¥–µ–ª–∞?", emoji:"üòä"},
    {en:"fine, thank you", ru:"—Ö–æ—Ä–æ—à–æ, —Å–ø–∞—Å–∏–±–æ", emoji:"üëç"},
  ],
  grammar:{
    title:"Hello / Goodbye",
    rule:"We say hello when we meet. We say goodbye when we leave.",
    formula:"Hello, I‚Äôm ‚Ä¶ | Goodbye.",
    examples:["Hello! I‚Äôm Rosy.","Goodbye! See you!"]
  }},
  { id:"u1l2", title:"Lesson 2", subtitle:"My name is‚Ä¶", vocabTopic:"Names", vocab:[
    {en:"my name is‚Ä¶", ru:"–º–µ–Ω—è –∑–æ–≤—É—Ç‚Ä¶", emoji:"üßí"},
    {en:"what‚Äôs your name?", ru:"–∫–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?", emoji:"‚ùì"},
    {en:"I‚Äôm‚Ä¶", ru:"—è‚Ä¶", emoji:"üôã‚Äç‚ôÄÔ∏è"},
    {en:"this is‚Ä¶", ru:"—ç—Ç–æ‚Ä¶", emoji:"üëâ"},
  ],
  grammar:{
    title:"What‚Äôs your name?",
    rule:'We ask: "What‚Äôs your name?" We answer: "My name‚Äôs ‚Ä¶ / I‚Äôm ‚Ä¶".',
    formula:"What‚Äôs your name? ‚Üí I‚Äôm ‚Ä¶ / My name‚Äôs ‚Ä¶",
    examples:["What‚Äôs your name? ‚Äî I‚Äôm Tim.","My name‚Äôs Rosy."]
  }},
  { id:"u1l3", title:"Lesson 3", subtitle:"The alphabet", vocabTopic:"Alphabet", vocab:[
    {en:"A", ru:"—ç–π", emoji:"üÖ∞Ô∏è"},
    {en:"B", ru:"–±–∏", emoji:"üÖ±Ô∏è"},
    {en:"C", ru:"—Å–∏", emoji:"üåä"},
    {en:"D", ru:"–¥–∏", emoji:"üî§"},
  ],
  grammar:{
    title:"Spell your name",
    rule:"We can spell names using letters.",
    formula:"It‚Äôs ‚Ä¶ ‚Üí A - B - C",
    examples:["My name‚Äôs Aisha. A - I - S - H - A.","It‚Äôs Tim. T - I - M."]
  }},
  { id:"u1l4", title:"Lesson 4", subtitle:"Numbers 1‚Äì10", vocabTopic:"Numbers 1‚Äì10", vocab:[
    {en:"one", ru:"–æ–¥–∏–Ω", emoji:"1Ô∏è‚É£"},
    {en:"two", ru:"–¥–≤–∞", emoji:"2Ô∏è‚É£"},
    {en:"three", ru:"—Ç—Ä–∏", emoji:"3Ô∏è‚É£"},
    {en:"ten", ru:"–¥–µ—Å—è—Ç—å", emoji:"üîü"},
  ],
  grammar:{
    title:"How old are you?",
    rule:'We ask: "How old are you?" We answer: "I‚Äôm ‚Ä¶".',
    formula:"How old are you? ‚Üí I‚Äôm (ten).",
    examples:["How old are you? ‚Äî I‚Äôm ten.","I‚Äôm eight."]
  }},
  { id:"u1l5", title:"Lesson 5", subtitle:"Numbers 11‚Äì20", vocabTopic:"Numbers 11‚Äì20", vocab:[
    {en:"eleven", ru:"–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å", emoji:"1Ô∏è‚É£1Ô∏è‚É£"},
    {en:"twelve", ru:"–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å", emoji:"1Ô∏è‚É£2Ô∏è‚É£"},
    {en:"fifteen", ru:"–ø—è—Ç–Ω–∞–¥—Ü–∞—Ç—å", emoji:"1Ô∏è‚É£5Ô∏è‚É£"},
    {en:"twenty", ru:"–¥–≤–∞–¥—Ü–∞—Ç—å", emoji:"2Ô∏è‚É£0Ô∏è‚É£"},
  ],
  grammar:{
    title:"I‚Äôm ‚Ä¶ (age)",
    rule:"Use numbers to say your age.",
    formula:"I‚Äôm + number.",
    examples:["I‚Äôm twelve.","I‚Äôm fifteen."]
  }},
  { id:"u1l6", title:"Lesson 6", subtitle:"Colours", vocabTopic:"Colours", vocab:[
    {en:"red", ru:"–∫—Ä–∞—Å–Ω—ã–π", emoji:"üü•"},
    {en:"blue", ru:"—Å–∏–Ω–∏–π", emoji:"üü¶"},
    {en:"green", ru:"–∑–µ–ª—ë–Ω—ã–π", emoji:"üü©"},
    {en:"yellow", ru:"–∂—ë–ª—Ç—ã–π", emoji:"üü®"},
  ],
  grammar:{
    title:"This is ‚Ä¶ (colour)",
    rule:'We say: "This is red." / "It is blue."',
    formula:"This is + colour. | It is + colour.",
    examples:["This is red.","It is blue."]
  }},
  { id:"u1l7", title:"Lesson 7", subtitle:"Where are you from?", vocabTopic:"Countries", vocab:[
    {en:"I‚Äôm from Kazakhstan", ru:"—è –∏–∑ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞", emoji:"üá∞üáø"},
    {en:"I‚Äôm from the UK", ru:"—è –∏–∑ –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏–∏", emoji:"üá¨üáß"},
    {en:"I‚Äôm from Russia", ru:"—è –∏–∑ –†–æ—Å—Å–∏–∏", emoji:"üá∑üá∫"},
    {en:"I‚Äôm from the USA", ru:"—è –∏–∑ –°–®–ê", emoji:"üá∫üá∏"},
  ],
  grammar:{
    title:"Where are you from?",
    rule:'We ask: "Where are you from?" We answer: "I‚Äôm from ‚Ä¶".',
    formula:"Where are you from? ‚Üí I‚Äôm from ‚Ä¶",
    examples:["Where are you from? ‚Äî I‚Äôm from Kazakhstan.","I‚Äôm from the UK."]
  }},
  { id:"u1l8", title:"Project", subtitle:"I can make a poster", vocabTopic:"Poster words", vocab:[
    {en:"name", ru:"–∏–º—è", emoji:"üè∑Ô∏è"},
    {en:"age", ru:"–≤–æ–∑—Ä–∞—Å—Ç", emoji:"üéÇ"},
    {en:"country", ru:"—Å—Ç—Ä–∞–Ω–∞", emoji:"üåç"},
    {en:"favourite colour", ru:"–ª—é–±–∏–º—ã–π —Ü–≤–µ—Ç", emoji:"üé®"},
  ],
  grammar:{
    title:"My poster",
    rule:"We can write simple sentences about us.",
    formula:"My name‚Äôs ‚Ä¶ . I‚Äôm ‚Ä¶ . I‚Äôm from ‚Ä¶ . My favourite colour is ‚Ä¶ .",
    examples:["My name‚Äôs Aigerim. I‚Äôm ten. I‚Äôm from Kazakhstan. My favourite colour is blue."]
  }},
];

// Units 2‚Äì8 –ø–æ–∫–∞ –∫–∞–∫ –∑–∞–≥–æ—Ç–æ–≤–∫–∏
const UNITS = [
  {unit:1, title:"Unit 1 ‚Äî Hello English!", lessons: UNIT1_LESSONS},
  {unit:2, title:"Unit 2 ‚Äî My school", lessons: []},
  {unit:3, title:"Unit 3 ‚Äî People I love", lessons: []},
  {unit:4, title:"Unit 4 ‚Äî Weather", lessons: []},
  {unit:5, title:"Unit 5 ‚Äî My free time", lessons: []},
  {unit:6, title:"Unit 6 ‚Äî Health", lessons: []},
  {unit:7, title:"Unit 7 ‚Äî Buildings", lessons: []},
  {unit:8, title:"Unit 8 ‚Äî My holidays", lessons: []},
];

const STORAGE_KEY = "aib_voc_3g_state_v1";

/* ===============================
   STATE
================================ */
let state = loadState();
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) return JSON.parse(raw);
  }catch(e){}
  return {
    user: null, // {type:'student'|'teacher', login:'3EL1'}
    starsByLesson: {}, // lessonId -> number
    teacherLog: [] // {ts, login, action, lessonId, stars}
  };
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

function nowStr(){
  const d = new Date();
  return d.toLocaleString();
}
function sumStars(){
  return Object.values(state.starsByLesson || {}).reduce((a,b)=>a+(+b||0),0);
}

/* ===============================
   ROUTER
================================ */
const app = document.getElementById("app");
let route = {page:"auth"}; // auth, menu, unit, lesson, chat, journal

function go(page, params={}){
  route = {page, ...params};
  render();
}

/* ===============================
   AUTH HELPERS
================================ */
function validStudentLogin(login){
  // 3EL1 ... 3EL15
  if(!login) return false;
  const m = login.trim().match(/^3EL(\d{1,2})$/i);
  if(!m) return false;
  const n = parseInt(m[1],10);
  return n>=1 && n<=MAX_L;
}

/* ===============================
   SPEAK
================================ */
function speak(text){
  try{
    if(!("speechSynthesis" in window)) return alert("Speech is not supported on this device.");
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = 0.95;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }catch(e){}
}

/* ===============================
   RENDER
================================ */
function render(){
  if(route.page==="auth") return renderAuth();
  if(!state.user) return renderAuth();
  if(route.page==="menu") return renderMenu();
  if(route.page==="unit") return renderUnit(route.unit);
  if(route.page==="lesson") return renderLesson(route.unit, route.lessonId);
  if(route.page==="chat") return renderChat();
  if(route.page==="journal") return renderJournal();
  renderMenu();
}

/* ===============================
   AUTH UI
================================ */
function renderAuth(){
  app.innerHTML = `
    <div class="hero">
      <div class="logoWrap">
        <!-- –∑–∞–º–µ–Ω–∏—à—å –Ω–∞ —Å–≤–æ—é –∫–∞—Ä—Ç–∏–Ω–∫—É: ai-bayan.png -->
        <img src="ai-bayan.png" alt="AI Bayan" onerror="this.style.display='none'; this.parentElement.innerHTML='üëß'; this.parentElement.style.fontSize='70px'; this.parentElement.style.color='#0b6f78'">
      </div>
      <div class="brandTitle">AI Bayan</div>
      <div class="brandSub">Vocabulary ‚Ä¢ Grade 3</div>
    </div>

    <div class="panel auth">
      <div class="authBox">
        <div class="field">
          <div class="label">Login</div>
          <input class="input" id="login" placeholder=""/>
        </div>
        <div class="field">
          <div class="label">PIN</div>
          <input class="input" id="pin" placeholder="" type="password"/>
        </div>

        <div class="row">
          <button class="btn btnPrimary" onclick="handleLogin()">Enter</button>
          <button class="btn btnGhost" onclick="demoFill()">Quick fill</button>
        </div>

        <div class="note">No hints on screen (as you asked).<br/>Teacher and student access are separated.</div>
      </div>
    </div>
  `;
}

function demoFill(){
  document.getElementById("login").value = "3EL1";
  document.getElementById("pin").value = STUDENT_PIN;
}

function handleLogin(){
  const login = (document.getElementById("login").value || "").trim();
  const pin = (document.getElementById("pin").value || "").trim();

  if(pin === TEACHER_PIN){
    state.user = {type:"teacher", login:"TEACHER"};
    state.teacherLog.push({ts: nowStr(), login:"TEACHER", action:"login"});
    saveState();
    go("menu");
    return;
  }

  if(pin === STUDENT_PIN && validStudentLogin(login)){
    state.user = {type:"student", login: login.toUpperCase()};
    state.teacherLog.push({ts: nowStr(), login: state.user.login, action:"student_login"});
    saveState();
    go("menu");
    return;
  }

  alert("Wrong login or PIN.");
}

/* ===============================
   MENU UI
================================ */
function renderMenu(){
  const who = state.user.type==="teacher" ? "Teacher" : state.user.login;
  app.innerHTML = `
    <div class="hero">
      <div class="logoWrap">
        <img src="ai-bayan.png" alt="AI Bayan" onerror="this.style.display='none'; this.parentElement.innerHTML='üëß'; this.parentElement.style.fontSize='70px'; this.parentElement.style.color='#0b6f78'">
      </div>
      <div class="brandTitle">ENGLISH WITH AI BAYAN</div>
      <div class="brandSub">AI Bayan Vocabulary ‚Äî Grade 3</div>
    </div>

    <div class="panel">
      <div class="helloCard">
        <div class="big">Hello, ${escapeHtml(who)}!</div>
        <div class="starsLine">Total stars in all lessons: ${sumStars()} ‚≠ê</div>
      </div>

      <div class="menuList">
        ${UNITS.map(u=>`
          <div class="menuBtn" onclick="go('unit',{unit:${u.unit}})">
            üìò ${escapeHtml(u.title)}
            <small>Open Unit ${u.unit}</small>
          </div>
        `).join("")}
      </div>

      <div class="bottomRow">
        <div class="miniBtn" onclick="go('chat')">üí¨ AI Bayan Chat</div>
        <div class="miniBtn" onclick="go('journal')">üè´ Teacher‚Äôs Journal</div>
        <div class="miniBtn" onclick="logout()">üö™ Exit</div>
      </div>
    </div>

    <div class="footerLine">Students: 3EL1‚Äì3EL15 | Student PIN 2844 | Teacher PIN 3244</div>
  `;
}

function logout(){
  state.teacherLog.push({ts: nowStr(), login: state.user?.login || "-", action:"logout"});
  state.user = null;
  saveState();
  go("auth");
}

/* ===============================
   UNIT UI
================================ */
function renderUnit(unitNum){
  const u = UNITS.find(x=>x.unit===unitNum);
  if(!u) return go("menu");

  // –µ—Å–ª–∏ –ø–æ–∫–∞ –ø—É—Å—Ç–æ ‚Äî –ø–æ–∫–∞–∂–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
  if(!u.lessons || u.lessons.length===0){
    app.innerHTML = `
      <div class="lessonHero">
        <div class="lessonBanner">
          <div>
            <div class="title">${escapeHtml(u.title)}</div>
            <div class="sub">Lessons will be added</div>
          </div>
          <div class="badge">‚≠ê Total: ${sumStars()}</div>
        </div>
      </div>

      <div class="lessonPanel">
        <div class="sectionTitle">‚ÑπÔ∏è Unit is empty now</div>
        <p style="margin:0;font-weight:800;color:#3d6167">
          Send photos of Unit ${unitNum} (8 lessons) and I will fill it exactly like Unit 1.
        </p>

        <div class="navRow">
          <button class="btn btnBlue" onclick="go('menu')">‚Üê Back</button>
          <button class="btn btnGhost" onclick="go('chat')">üí¨ AI Bayan Chat</button>
        </div>
      </div>

      <div class="footerLine">Students: 3EL1‚Äì3EL15 | Student PIN 2844 | Teacher PIN 3244</div>
    `;
    return;
  }

  app.innerHTML = `
    <div class="lessonHero">
      <div class="lessonBanner">
        <div>
          <div class="title">${escapeHtml(u.title)}</div>
          <div class="sub">Choose a lesson</div>
        </div>
        <div class="badge">‚≠ê Total: ${sumStars()}</div>
      </div>
    </div>

    <div class="lessonPanel">
      <div class="menuList" style="margin-top:0">
        ${u.lessons.map((L,idx)=>`
          <div class="menuBtn" onclick="go('lesson',{unit:${u.unit}, lessonId:'${L.id}'})">
            üìó Lesson ${idx+1} ‚Äî ${escapeHtml(L.subtitle)}
            <small>${escapeHtml(L.vocabTopic)}</small>
          </div>
        `).join("")}
      </div>

      <div class="bottomRow">
        <div class="miniBtn" onclick="go('menu')">‚Üê Main menu</div>
        <div class="miniBtn" onclick="go('chat')">üí¨ AI Bayan Chat</div>
        <div class="miniBtn" onclick="go('journal')">üè´ Teacher‚Äôs Journal</div>
      </div>
    </div>

    <div class="footerLine">Students: 3EL1‚Äì3EL15 | Student PIN 2844 | Teacher PIN 3244</div>
  `;
}

/* ===============================
   LESSON UI (Unit 1)
================================ */
function renderLesson(unitNum, lessonId){
  const u = UNITS.find(x=>x.unit===unitNum);
  if(!u) return go("menu");
  const L = (u.lessons||[]).find(x=>x.id===lessonId);
  if(!L) return go("unit",{unit:unitNum});

  const stars = state.starsByLesson[lessonId] || 0;

  app.innerHTML = `
    <div class="lessonHero">
      <div class="lessonBanner">
        <div>
          <div class="title">${escapeHtml(u.title)} ‚Äî ${escapeHtml(L.title)}</div>
          <div class="sub">${escapeHtml(L.subtitle)}</div>
        </div>
        <div class="badge">‚≠ê You have ${stars} in this lesson</div>
      </div>
    </div>

    <div class="lessonPanel">
      <div style="text-align:center;font-weight:1000;color:#0a4a52;margin-top:6px">
        ${escapeHtml(L.vocabTopic)}
      </div>

      <div class="sectionTitle">üß† VOCABULARY ‚Äî Picture Dictionary</div>
      <div style="margin:-2px 0 10px;color:#4b666c;font-weight:800">
        Tap ‚ÄúSay it‚Äù to hear AI Bayan say the word in English.
      </div>

      <div class="vocabGrid">
        ${L.vocab.map((w,i)=>`
          <div class="vCard">
            <div class="vIcon">${w.emoji || "‚≠ê"}</div>
            <div class="vWord">${escapeHtml(w.en)}</div>
            <div class="vRu">${escapeHtml(w.ru)}</div>
            <button class="sayBtn" onclick="speak('${jsStr(w.en)}')">üîä Say it</button>
          </div>
        `).join("")}
      </div>

      <div class="sectionTitle">üìò GRAMMAR ‚Äî Key Rule</div>
      <div class="ruleBox">
        <h3>${escapeHtml(L.grammar.title)}</h3>
        <p>${escapeHtml(L.grammar.rule)}</p>
        <p><b>Formula:</b> ${escapeHtml(L.grammar.formula)}</p>
        <p><b>Examples:</b></p>
        <ul>
          ${L.grammar.examples.map(e=>`<li>${escapeHtml(e)}</li>`).join("")}
        </ul>
      </div>

      <div class="sectionTitle">üìù WORKSHEETS (4 tasks)</div>

      ${renderWorksheetsHTML(L)}

      <div class="navRow">
        <button class="btn btnBlue" onclick="go('unit',{unit:${unitNum}})">‚Üê Back</button>
        <button class="btn btnGreen" onclick="saveResult('${lessonId}')">Save Result ‚úì</button>
        <button class="btn btnGhost" onclick="printLesson()">üñ® Print</button>
      </div>
    </div>

    <div class="footerLine">Students: 3EL1‚Äì3EL15 | Student PIN 2844 | Teacher PIN 3244</div>
  `;
}

function renderWorksheetsHTML(L){
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 4 –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ 4 —Å–ª–æ–≤ (–∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ)
  const words = L.vocab.map(v=>v.en.replace(/\?$/,"").toLowerCase());
  const w0 = words[0] || "hello";
  const w1 = words[1] || "goodbye";
  const w2 = words[2] || "fine";
  const w3 = words[3] || "name";

  // missing letters
  const miss = [w0,w1,w2,w3].map(w=>{
    if(w.length<3) return w;
    const idx = Math.max(1, Math.floor(w.length/2));
    return w.slice(0,idx) + "_" + w.slice(idx+1);
  });

  // matching selects
  const opts = shuffle([w0,w1,w2,w3]);

  // mini crossword clues (simple)
  const clues = [
    {clue:`Say it when you meet.`, ans:w0},
    {clue:`Say it when you leave.`, ans:w1},
    {clue:`How are you? ‚Äî I‚Äôm ‚Ä¶`, ans:w2.includes("fine")?w2:"fine"},
  ];

  // choose correct word (fill)
  const sent = [
    {text:`I say ____ when I meet you.`, ans:w0, options: shuffle([w0,w1,w2])},
    {text:`I say ____ when I leave.`, ans:w1, options: shuffle([w1,w0,w3])},
    {text:`How are you? ‚Äî I‚Äôm ____.`, ans:w2.includes("fine")?w2:"fine", options: shuffle([w2,w0,w1])},
  ];

  return `
    <div class="wsBox" id="ws1">
      <h4>Worksheet 1 ‚Äî Missing letters</h4>
      <p>Write the missing letters. (Use small letters.)</p>
      ${miss.map((m,i)=>`
        <div class="qRow">
          <div class="q">${i+1}) ${escapeHtml(m)} ‚Üí</div>
          <input type="text" data-ans="${escapeHtml(words[i]||'')}" class="ws1in"/>
        </div>
      `).join("")}
      <div class="checkRow">
        <button class="checkBtn" onclick="checkWS1()">Check ‚úì</button>
        <div class="scoreTxt" id="ws1score">Correct: 0 / ${miss.length}</div>
      </div>
    </div>

    <div class="wsBox" id="ws2">
      <h4>Worksheet 2 ‚Äî Matching word</h4>
      <p>Choose the correct word.</p>
      ${[0,1,2].map(i=>`
        <div class="qRow">
          <div class="q">${i+1})</div>
          <select class="select ws2sel" data-ans="${escapeHtml(words[i]||'')}">
            <option value="">--choose--</option>
            ${opts.map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("")}
          </select>
        </div>
      `).join("")}
      <div class="checkRow">
        <button class="checkBtn" onclick="checkWS2()">Check ‚úì</button>
        <div class="scoreTxt" id="ws2score">Correct: 0 / 3</div>
      </div>
    </div>

    <div class="wsBox" id="ws3">
      <h4>Worksheet 3 ‚Äî Mini crossword (write the word)</h4>
      <p>Read the clue. Write one word.</p>
      ${clues.map((c,i)=>`
        <div class="qRow">
          <div class="q">${i+1}) ${escapeHtml(c.clue)}</div>
          <input type="text" class="ws3in" data-ans="${escapeHtml(c.ans)}"/>
        </div>
      `).join("")}
      <div class="checkRow">
        <button class="checkBtn" onclick="checkWS3()">Check ‚úì</button>
        <div class="scoreTxt" id="ws3score">Correct: 0 / ${clues.length}</div>
      </div>
    </div>

    <div class="wsBox" id="ws4">
      <h4>Worksheet 4 ‚Äî Choose the correct word</h4>
      <p>Choose the correct word to complete each sentence.</p>
      ${sent.map((s,i)=>`
        <div class="qRow">
          <div class="q">${i+1}) ${escapeHtml(s.text)}</div>
          <select class="select ws4sel" data-ans="${escapeHtml(s.ans)}">
            <option value="">--choose--</option>
            ${s.options.map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("")}
          </select>
        </div>
      `).join("")}
      <div class="checkRow">
        <button class="checkBtn" onclick="checkWS4()">Check ‚úì</button>
        <div class="scoreTxt" id="ws4score">Correct: 0 / ${sent.length}</div>
      </div>
    </div>
  `;
}

/* ===============================
   CHECKERS + STARS
================================ */
function markInput(el, ok){
  el.style.borderColor = ok ? "rgba(26,160,108,.7)" : "rgba(214,40,40,.7)";
  el.style.background = ok ? "#f1fff7" : "#fff3f3";
}
function checkWS1(){
  const inputs = document.querySelectorAll(".ws1in");
  let c=0;
  inputs.forEach(inp=>{
    const ans = (inp.dataset.ans||"").trim().toLowerCase();
    const v = (inp.value||"").trim().toLowerCase();
    const ok = v===ans;
    if(ok) c++;
    markInput(inp, ok);
  });
  document.getElementById("ws1score").textContent = `Correct: ${c} / ${inputs.length}`;
}
function checkWS2(){
  const sels = document.querySelectorAll(".ws2sel");
  let c=0;
  sels.forEach(sel=>{
    const ans=(sel.dataset.ans||"").trim().toLowerCase();
    const v=(sel.value||"").trim().toLowerCase();
    const ok = v===ans;
    if(ok) c++;
    markInput(sel, ok);
  });
  document.getElementById("ws2score").textContent = `Correct: ${c} / ${sels.length}`;
}
function checkWS3(){
  const inputs = document.querySelectorAll(".ws3in");
  let c=0;
  inputs.forEach(inp=>{
    const ans=(inp.dataset.ans||"").trim().toLowerCase();
    const v=(inp.value||"").trim().toLowerCase();
    const ok=v===ans;
    if(ok) c++;
    markInput(inp, ok);
  });
  document.getElementById("ws3score").textContent = `Correct: ${c} / ${inputs.length}`;
}
function checkWS4(){
  const sels = document.querySelectorAll(".ws4sel");
  let c=0;
  sels.forEach(sel=>{
    const ans=(sel.dataset.ans||"").trim().toLowerCase();
    const v=(sel.value||"").trim().toLowerCase();
    const ok=v===ans;
    if(ok) c++;
    markInput(sel, ok);
  });
  document.getElementById("ws4score").textContent = `Correct: ${c} / ${sels.length}`;
}

function calcLessonStars(){
  // –°—á–∏—Ç–∞–µ–º "–∑–≤—ë–∑–¥—ã" –∫–∞–∫ —Å—É–º–º—É –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ 4 worksheets (–º–∞–∫—Å ~ 4+3+3+3=13)
  let total=0;

  const ws1 = document.querySelectorAll(".ws1in");
  ws1.forEach(inp=>{
    const ans=(inp.dataset.ans||"").trim().toLowerCase();
    const v=(inp.value||"").trim().toLowerCase();
    if(v && v===ans) total++;
  });

  const ws2 = document.querySelectorAll(".ws2sel");
  ws2.forEach(sel=>{
    const ans=(sel.dataset.ans||"").trim().toLowerCase();
    const v=(sel.value||"").trim().toLowerCase();
    if(v && v===ans) total++;
  });

  const ws3 = document.querySelectorAll(".ws3in");
  ws3.forEach(inp=>{
    const ans=(inp.dataset.ans||"").trim().toLowerCase();
    const v=(inp.value||"").trim().toLowerCase();
    if(v && v===ans) total++;
  });

  const ws4 = document.querySelectorAll(".ws4sel");
  ws4.forEach(sel=>{
    const ans=(sel.dataset.ans||"").trim().toLowerCase();
    const v=(sel.value||"").trim().toLowerCase();
    if(v && v===ans) total++;
  });

  return total;
}

function saveResult(lessonId){
  const stars = calcLessonStars();
  state.starsByLesson[lessonId] = stars;

  // teacher log
  state.teacherLog.push({
    ts: nowStr(),
    login: state.user?.login || "-",
    action: "save_result",
    lessonId,
    stars
  });

  saveState();
  alert(`Saved! Stars in this lesson: ${stars} ‚≠ê`);
  render(); // –æ–±–Ω–æ–≤–∏—Ç—å badge
}

/* ===============================
   PRINT
================================ */
function printLesson(){
  window.print();
}

/* ===============================
   CHAT
================================ */
function renderChat(){
  // –ø—Ä–æ—Å—Ç–æ–π —á–∞—Ç-–∑–∞–≥–ª—É—à–∫–∞ (–º–æ–∂–Ω–æ –ø–æ—Ç–æ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å Cloudflare Worker)
  app.innerHTML = `
    <div class="lessonHero">
      <div class="lessonBanner">
        <div>
          <div class="title">AI Bayan Chat</div>
          <div class="sub">Ask simple questions</div>
        </div>
        <div class="badge">‚≠ê Total: ${sumStars()}</div>
      </div>
    </div>

    <div class="lessonPanel">
      <div class="sectionTitle">üí¨ Chat</div>

      <div id="chatBox" style="background:#f6fbfc;border:2px solid rgba(12,106,115,.18);border-radius:18px;padding:12px;min-height:220px;">
        <div style="font-weight:900;color:#2f6168">AI Bayan:</div>
        <div style="margin:6px 0 12px;font-weight:800;color:#375f66">Hello! Ask me: ‚ÄúWhat‚Äôs your name?‚Äù or ‚ÄúHow old are you?‚Äù</div>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;">
        <input id="chatIn" class="input" style="flex:1;min-width:220px" placeholder="Type here..." />
        <button class="btn btnPrimary" style="min-width:140px" onclick="sendChat()">Send</button>
      </div>

      <div class="navRow">
        <button class="btn btnBlue" onclick="go('menu')">‚Üê Back</button>
        <button class="btn btnGhost" onclick="go('journal')">üè´ Teacher‚Äôs Journal</button>
      </div>
    </div>

    <div class="footerLine">Students: 3EL1‚Äì3EL15 | Student PIN 2844 | Teacher PIN 3244</div>
  `;
}

function sendChat(){
  const inp = document.getElementById("chatIn");
  const msg = (inp.value||"").trim();
  if(!msg) return;

  const box = document.getElementById("chatBox");
  box.innerHTML += `
    <div style="margin-top:10px">
      <div style="font-weight:900;color:#0a4a52">${escapeHtml(state.user?.login || "You")}:</div>
      <div style="font-weight:800;color:#375f66">${escapeHtml(msg)}</div>
    </div>
  `;

  // –ø—Ä–æ—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã (offline)
  const m = msg.toLowerCase();
  let reply = "Good! üòä";
  if(m.includes("name")) reply = "My name is AI Bayan.";
  else if(m.includes("how old")) reply = "I‚Äôm ten.";
  else if(m.includes("from")) reply = "I‚Äôm from Kazakhstan.";
  else if(m.includes("hello")) reply = "Hello!";

  box.innerHTML += `
    <div style="margin-top:10px">
      <div style="font-weight:900;color:#2f6168">AI Bayan:</div>
      <div style="font-weight:800;color:#375f66">${escapeHtml(reply)}</div>
    </div>
  `;
  box.scrollTop = box.scrollHeight;
  inp.value = "";
}

/* ===============================
   TEACHER JOURNAL
================================ */
function renderJournal(){
  // –¥–æ—Å—Ç—É–ø —É—á–∏—Ç–µ–ª—é –ø–æ–ª–Ω—ã–π; —É—á–µ–Ω–∏–∫—É ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
  const isTeacher = state.user?.type==="teacher";
  const rows = (state.teacherLog||[]).slice().reverse();

  app.innerHTML = `
    <div class="lessonHero">
      <div class="lessonBanner">
        <div>
          <div class="title">Teacher‚Äôs Journal</div>
          <div class="sub">${isTeacher ? "Full access" : "View only"}</div>
        </div>
        <div class="badge">‚≠ê Total: ${sumStars()}</div>
      </div>
    </div>

    <div class="lessonPanel">
      <div class="sectionTitle">üìí Logs</div>

      <div style="overflow:auto;border:2px solid rgba(12,106,115,.18);border-radius:18px;">
        <table style="width:100%;border-collapse:collapse;font-weight:800;color:#0a4a52">
          <thead>
            <tr style="background:#f0fbfc">
              <th style="padding:10px;border-bottom:2px solid rgba(0,0,0,.06);text-align:left">Time</th>
              <th style="padding:10px;border-bottom:2px solid rgba(0,0,0,.06);text-align:left">Login</th>
              <th style="padding:10px;border-bottom:2px solid rgba(0,0,0,.06);text-align:left">Action</th>
              <th style="padding:10px;border-bottom:2px solid rgba(0,0,0,.06);text-align:left">Lesson</th>
              <th style="padding:10px;border-bottom:2px solid rgba(0,0,0,.06);text-align:left">Stars</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>{
              if(!isTeacher && r.login !== state.user.login) return "";
              return `
                <tr>
                  <td style="padding:10px;border-bottom:1px solid rgba(0,0,0,.06);color:#365f66">${escapeHtml(r.ts||"")}</td>
                  <td style="padding:10px;border-bottom:1px solid rgba(0,0,0,.06)">${escapeHtml(r.login||"")}</td>
                  <td style="padding:10px;border-bottom:1px solid rgba(0,0,0,.06)">${escapeHtml(r.action||"")}</td>
                  <td style="padding:10px;border-bottom:1px solid rgba(0,0,0,.06)">${escapeHtml(r.lessonId||"")}</td>
                  <td style="padding:10px;border-bottom:1px solid rgba(0,0,0,.06)">${escapeHtml(String(r.stars ?? ""))}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>

      ${isTeacher ? `
        <div class="bottomRow">
          <div class="miniBtn" onclick="resetAll()">üßπ Reset all data</div>
        </div>
      ` : ``}

      <div class="navRow">
        <button class="btn btnBlue" onclick="go('menu')">‚Üê Back</button>
        <button class="btn btnGhost" onclick="go('chat')">üí¨ AI Bayan Chat</button>
      </div>
    </div>

    <div class="footerLine">Students: 3EL1‚Äì3EL15 | Student PIN 2844 | Teacher PIN 3244</div>
  `;
}

function resetAll(){
  if(!confirm("Reset all saved data?")) return;
  state.starsByLesson = {};
  state.teacherLog.push({ts: nowStr(), login:"TEACHER", action:"reset_all"});
  saveState();
  render();
}

/* ===============================
   UTIL
================================ */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function jsStr(s){
  return String(s).replace(/\\/g,"\\\\").replace(/'/g,"\\'");
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* ===============================
   START
================================ */
go(state.user ? "menu" : "auth");
</script>
</body>
</html>

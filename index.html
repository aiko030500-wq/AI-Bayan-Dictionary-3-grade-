<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ENGLISH WITH AI BAYAN ‚Äì Grade 3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ‚Äì –∑–µ–ª—ë–Ω–æ–µ */
      --menu-bg-dark:#1b5e20;
      --menu-bg:#2e7d32;
      --menu-soft:#a5d6a7;
      --accent-gold:#ffd54f;
      --text-main:#05313a;

      /* –¶–≤–µ—Ç–∞ —é–Ω–∏—Ç–æ–≤ (Variant B ‚Äì —è—Ä–∫–∏–µ) */
      --u1:#1565c0; /* Hello English! */
      --u2:#ef6c00; /* My school */
      --u3:#d81b60; /* People I love */
      --u4:#039be5; /* Weather */
      --u5:#8e24aa; /* My free time */
      --u6:#c62828; /* Health */
      --u7:#6d4c41; /* Buildings */
      --u8:#9e9d24; /* My holidays */
    }

    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#004d40;
      color:var(--text-main);
    }
    .app{
      max-width:900px;
      margin:0 auto;
      min-height:100vh;
      background:linear-gradient(180deg,var(--menu-bg-dark),var(--menu-bg));
      padding-bottom:2.5rem;
    }

    header.app-header{
      text-align:center;
      color:#e8f5e9;
      padding:1.1rem 0 0.7rem;
    }
    .logo-circle{
      width:140px;height:140px;border-radius:50%;
      border:6px solid var(--accent-gold);
      margin:0 auto 0.6rem;
      background:#fff;
      background-size:cover;
      background-position:center;
      background-image:url("img/ai-bayan-logo.png"); /* —Å—é–¥–∞ —Å–≤–æ—é –∫–∞—Ä—Ç–∏–Ω–∫—É */
    }
    header h1{
      font-size:1.4rem;
      font-weight:800;
      letter-spacing:.08em;
    }
    header h2{
      font-size:0.9rem;
      margin-top:0.15rem;
      opacity:.9;
    }

    .card{
      background:#ffffff;
      margin:.8rem 1rem;
      border-radius:18px;
      padding:1rem 1.1rem;
      border:3px solid var(--accent-gold);
      box-shadow:0 6px 14px rgba(0,0,0,.25);
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:.5rem 1.2rem;
      background:#00695c;
      color:#fff;
      font-weight:600;
      font-size:.95rem;
      cursor:pointer;
      box-shadow:0 4px 8px rgba(0,0,0,.3);
      transition:transform .08s, box-shadow .08s, opacity .12s;
      display:inline-flex;
      align-items:center;
      gap:.25rem;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 5px 12px rgba(0,0,0,.35);}
    .btn:active{transform:translateY(1px);box-shadow:0 2px 6px rgba(0,0,0,.25);opacity:.9;}
    .btn-secondary{background:#01579b;}
    .btn-danger{background:#c62828;}

    .input{
      width:100%;
      padding:.55rem .75rem;
      border-radius:10px;
      border:2px solid #b0bec5;
      font-size:1rem;
      margin-top:.25rem;
    }

    .center{text-align:center;}
    .hidden{display:none;}

    .menu-greeting{font-size:1.05rem;text-align:center;margin-bottom:.1rem;}
    .menu-stars{font-size:.95rem;text-align:center;font-weight:700;color:#fdd835;}

    .lesson-list{display:flex;flex-direction:column;gap:.6rem;margin-top:.7rem;}
    .lesson-btn{
      border-radius:18px;
      padding:.6rem .9rem;
      background:#e8f5e9;
      border:3px solid var(--accent-gold);
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
    }
    .lesson-btn-left{display:flex;align-items:center;gap:.45rem;}
    .lesson-icon{font-size:1.3rem;}
    .lesson-info small{font-size:.8rem;color:#004d40;}
    .lesson-stars-mini{font-size:.85rem;font-weight:700;color:#f57f17;}

    .tabs-row{
      margin:.4rem 0 .6rem;
      display:flex;
      flex-wrap:wrap;
      gap:.3rem;
    }
    .tab-btn{
      padding:.35rem .8rem;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.6);
      background:rgba(255,255,255,.18);
      color:#fff;
      font-size:.8rem;
      cursor:pointer;
      backdrop-filter:blur(4px);
    }
    .tab-btn.active{
      background:#ffffff;
      color:#000;
    }

    .lesson-header{
      margin-bottom:.45rem;
      color:#ffffff;
    }
    .lesson-title{font-size:1.2rem;font-weight:800;}
    .lesson-sub{font-size:.9rem;opacity:.9;}
    .lesson-stars{
      font-size:.9rem;
      font-weight:700;
      margin-top:.15rem;
    }

    .section-card{
      background:#ffffff;
      border-radius:16px;
      padding:.7rem .9rem;
      margin-top:.6rem;
      box-shadow:0 3px 10px rgba(0,0,0,.18);
    }
    .section-title{
      font-weight:800;
      font-size:.98rem;
      margin-bottom:.35rem;
      display:flex;
      align-items:center;
      gap:.4rem;
    }

    .vocab-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(130px,1fr));
      gap:.55rem;
    }
    .vocab-card{
      border-radius:14px;
      padding:.45rem .45rem .55rem;
      text-align:center;
      border:2px solid #bbdefb;
      background:#e3f2fd;
    }
    .vocab-img{
      width:70px;height:70px;
      border-radius:11px;
      background:#fff;
      margin:0 auto .25rem;
      display:flex;align-items:center;justify-content:center;
      font-size:2rem;
      background-size:cover;
      background-position:center;
      border:1px solid #cfd8dc;
    }
    .vocab-word{font-weight:700;}
    .vocab-ru{font-size:.8rem;color:#455a64;margin-top:.05rem;}
    .vocab-sound-btn{
      margin-top:.25rem;
      padding:.2rem .7rem;
      font-size:.8rem;
    }

    .grammar-rule{font-size:.9rem;line-height:1.4;}
    .grammar-formula{font-size:.85rem;margin-top:.3rem;font-style:italic;}
    .grammar-examples{margin-top:.35rem;font-size:.88rem;}
    .grammar-examples li{margin-left:1.1rem;}

    .phonics-items li{margin-left:1.1rem;font-size:.9rem;}

    textarea{
      width:100%;
      min-height:80px;
      padding:.55rem .7rem;
      border-radius:10px;
      border:1px solid #b0bec5;
      resize:vertical;
      font-size:.9rem;
    }

    .worksheet-block{
      border-radius:14px;
      border:1px dashed #b0bec5;
      padding:.6rem .6rem .8rem;
      margin-top:.45rem;
      font-size:.9rem;
      background:#fafafa;
    }
    .worksheet-block h4{font-size:.95rem;margin-bottom:.3rem;}
    .task-item{margin-bottom:.4rem;}
    .task-item input[type="text"],
    .task-item select{
      border-radius:8px;
      border:1px solid #90a4ae;
      padding:.25rem .4rem;
      min-width:120px;
      margin-top:.1rem;
      font-size:.9rem;
    }
    .check-row{
      margin-top:.4rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.6rem;
      flex-wrap:wrap;
    }
    .result-msg{font-size:.83rem;}

    .nav-row{
      display:flex;
      justify-content:space-between;
      gap:.4rem;
      margin-top:.8rem;
      flex-wrap:wrap;
    }

    .small-note{
      text-align:center;
      color:#e0f2f1;
      font-size:.78rem;
      margin:.4rem 0;
    }

    /* –ß–µ–∫-–∏–∫–æ–Ω–∫–∏ */
    .correct-icon{color:#2e7d32;font-weight:700;margin-left:.2rem;}
    .wrong-icon{color:#c62828;font-weight:700;margin-left:.2rem;}

    /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–≤–µ–∑–¥—ã */
    .star-burst{
      position:fixed;
      left:50%;
      bottom:12%;
      transform:translateX(-50%);
      font-size:2.4rem;
      animation:starBurst 1s ease-out forwards;
      pointer-events:none;
      z-index:9999;
    }
    @keyframes starBurst{
      0%{opacity:0;transform:translate(-50%,20px) scale(.5);}
      20%{opacity:1;transform:translate(-50%,0) scale(1);}
      80%{opacity:1;transform:translate(-50%,-40px) scale(1.2);}
      100%{opacity:0;transform:translate(-50%,-60px) scale(.4);}
    }

    @media(max-width:600px){
      .card{margin:.7rem .6rem;}
      header h1{font-size:1.15rem;}
      .logo-circle{width:120px;height:120px;}
    }

    /* –ü–µ—á–∞—Ç—å ‚Äì –ø–µ—á–∞—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π —é–Ω–∏—Ç */
    @media print{
      body{background:#fff;}
      .app-header,.small-note,#loginScreen,#menuScreen,#teacherScreen,#chatScreen{display:none!important;}
      .card{border:none;box-shadow:none;margin:0;padding:.5rem .5rem;}
      .nav-row,.tabs-row{display:none!important;}
    }
  </style>
</head>
<body>
<div class="app">
  <header class="app-header">
    <div class="logo-circle"></div>
    <h1>ENGLISH WITH AI BAYAN</h1>
    <h2>Grade 3 ‚Äì Family and Friends 3</h2>
  </header>

  <!-- LOGIN -->
  <section id="loginScreen" class="card">
    <h3 class="center" style="margin-bottom:.4rem;">English with AI Bayan</h3>
    <p class="center" style="font-size:.9rem;margin-bottom:.5rem;">
      Enter your name and PIN:
    </p>
    <label>Student name or Teacher:</label>
    <input id="loginName" class="input" placeholder="3E S1, 3E S2... or Teacher" />
    <label style="margin-top:.5rem;display:block;">PIN:</label>
    <input id="loginPin" type="password" class="input" placeholder="****" />
    <div class="center" style="margin-top:.7rem;">
      <button class="btn" onclick="handleLogin()">Enter</button>
    </div>
    <p class="center" style="font-size:.8rem;margin-top:.45rem;">
      Students PIN: <strong>2844</strong> ¬∑ Teacher PIN: <strong>3244</strong>
    </p>
  </section>

  <!-- MENU -->
  <section id="menuScreen" class="card hidden">
    <div id="menuGreeting" class="menu-greeting"></div>
    <div id="menuStars" class="menu-stars"></div>

    <div id="lessonList" class="lesson-list"></div>

    <div style="display:flex;justify-content:center;gap:.5rem;margin-top:.7rem;flex-wrap:wrap;">
      <button class="btn-secondary btn" onclick="openGlobalChat()">üí¨ AI Bayan Chat</button>
      <button class="btn-secondary btn" onclick="openTeacherJournal()">üè´ Teacher's Journal</button>
    </div>
  </section>

  <!-- LESSON -->
  <section id="lessonScreen" class="card hidden" style="padding:0;">
    <div id="lessonHeader" style="padding:.8rem .9rem;border-radius:15px 15px 0 0;background:var(--u1);">
      <div class="lesson-header">
        <div id="lessonTitle" class="lesson-title">Unit 1 ‚Äì Hello English!</div>
        <div id="lessonSubtitle" class="lesson-sub">Greetings, colours and numbers</div>
        <div id="lessonStars" class="lesson-stars">You have 0 ‚≠ê in this unit.</div>
      </div>
      <div class="tabs-row">
        <button class="tab-btn active" data-tab="vocab" onclick="switchTab('vocab')">Vocabulary</button>
        <button class="tab-btn" data-tab="grammar" onclick="switchTab('grammar')">Grammar</button>
        <button class="tab-btn" data-tab="phonics" onclick="switchTab('phonics')">Phonics</button>
        <button class="tab-btn" data-tab="lr" onclick="switchTab('lr')">Listen &amp; Read</button>
        <button class="tab-btn" data-tab="ls" onclick="switchTab('ls')">Listen &amp; Sing</button>
        <button class="tab-btn" data-tab="ws" onclick="switchTab('ws')">Worksheets</button>
      </div>
    </div>

    <div style="padding:.6rem .8rem 1rem;">

      <!-- VOCAB -->
      <div id="tab-vocab" class="section-card">
        <div class="section-title">üß† Vocabulary ‚Äì Colours and numbers</div>
        <p style="font-size:.85rem;margin-bottom:.35rem;">
          Tap the speaker to hear the word. (AI Bayan uses correct pronunciation.)
        </p>
        <div id="vocabGrid" class="vocab-grid"></div>
      </div>

      <!-- GRAMMAR -->
      <div id="tab-grammar" class="section-card hidden">
        <div class="section-title">üìò Grammar ‚Äì Questions about name, age and colours</div>
        <div id="grammarBox" class="grammar-rule"></div>
      </div>

      <!-- PHONICS -->
      <div id="tab-phonics" class="section-card hidden">
        <div class="section-title">üî§ Phonics ‚Äì The alphabet</div>
        <p style="font-size:.88rem;margin-bottom:.25rem;">
          Practise letters and sounds. Say them together with AI Bayan.
        </p>
        <ul id="phonicsList" class="phonics-items"></ul>
      </div>

      <!-- LISTEN & READ -->
      <div id="tab-lr" class="section-card hidden">
        <div class="section-title">üëÇüìñ Listen &amp; Read</div>
        <p style="font-size:.88rem;margin-bottom:.3rem;">
          Press <strong>Read text</strong> ‚Äì AI Bayan reads the text. Then answer questions.
        </p>
        <div id="lrText" style="font-size:.9rem;line-height:1.4;margin-bottom:.35rem;"></div>
        <button class="btn-secondary btn" onclick="readLRText()">üîä Read text</button>

        <div id="lrTasks" style="margin-top:.5rem;"></div>
      </div>

      <!-- LISTEN & SING -->
      <div id="tab-ls" class="section-card hidden">
        <div class="section-title">üéµ Listen &amp; Sing</div>
        <p style="font-size:.88rem;margin-bottom:.3rem;">
          –≠—Ç–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ø–µ—Å–µ–Ω–∫–∞ –ø–æ —Ç–µ–º–µ (–Ω–µ –∏–∑ –∫–Ω–∏–≥–∏). –ú–æ–∂–Ω–æ –ø—Ä–æ–∏–≥—Ä–∞—Ç—å —Å –ø–æ–º–æ—â—å—é TTS.
        </p>
        <div id="lsLyrics" style="font-size:.9rem;line-height:1.4;margin-bottom:.35rem;"></div>
        <button class="btn-secondary btn" onclick="readLSText()">üîä Sing with AI Bayan</button>
      </div>

      <!-- WORKSHEETS -->
      <div id="tab-ws" class="section-card hidden">
        <div class="section-title">üìÑ Worksheets ‚Äì Workbook style</div>

        <!-- WS1 -->
        <div class="worksheet-block" id="ws1Block">
          <h4>Worksheet 1 ‚Äì Vocabulary (colours &amp; numbers)</h4>
          <p style="font-size:.82rem;margin-bottom:.25rem;">
            Write the missing word.
          </p>
          <div id="ws1Tasks"></div>
          <div class="check-row">
            <button class="btn" onclick="checkWorksheet('ws1')">Check ‚úÖ</button>
            <div id="ws1Result" class="result-msg"></div>
          </div>
        </div>

        <!-- WS2 -->
        <div class="worksheet-block" id="ws2Block">
          <h4>Worksheet 2 ‚Äì Grammar (questions &amp; answers)</h4>
          <p style="font-size:.82rem;margin-bottom:.25rem;">
            Choose the correct answer.
          </p>
          <div id="ws2Tasks"></div>
          <div class="check-row">
            <button class="btn" onclick="checkWorksheet('ws2')">Check ‚úÖ</button>
            <div id="ws2Result" class="result-msg"></div>
          </div>
        </div>

        <!-- WS3 -->
        <div class="worksheet-block" id="ws3Block">
          <h4>Worksheet 3 ‚Äì Phonics (letters &amp; words)</h4>
          <p style="font-size:.82rem;margin-bottom:.25rem;">
            Write the first letter.
          </p>
          <div id="ws3Tasks"></div>
          <div class="check-row">
            <button class="btn" onclick="checkWorksheet('ws3')">Check ‚úÖ</button>
            <div id="ws3Result" class="result-msg"></div>
          </div>
        </div>

        <!-- WS4 -->
        <div class="worksheet-block" id="ws4Block">
          <h4>Worksheet 4 ‚Äì Reading check</h4>
          <p style="font-size:.82rem;margin-bottom:.25rem;">
            Choose the correct sentence.
          </p>
          <div id="ws4Tasks"></div>
          <div class="check-row">
            <button class="btn" onclick="checkWorksheet('ws4')">Check ‚úÖ</button>
            <div id="ws4Result" class="result-msg"></div>
          </div>
        </div>

      </div>

      <!-- –ß–∞—Ç –ø–æ —Ç–µ–º–µ (1 –≤–æ–ø—Ä–æ—Å) + –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
      <div class="section-card" style="margin-top:.7rem;">
        <div class="section-title">üí¨ AI Bayan Chat ‚Äì 1 question about this unit</div>
        <p style="font-size:.83rem;margin-bottom:.25rem;">
          –ù–∞–ø–∏—à–∏ <strong>–æ–¥–∏–Ω</strong> –≤–æ–ø—Ä–æ—Å –ø–æ —Ç–µ–º–µ —é–Ω–∏—Ç–∞. –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–Ω–æ–ø–∫–∞ –≤—ã–∫–ª—é—á–∏—Ç—Å—è.
          –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Ç–≤–æ–π Cloudflare Worker.
        </p>
        <textarea id="unitChatInput" placeholder="Ask AI Bayan about this unit..."></textarea>
        <div style="margin-top:.4rem;display:flex;justify-content:space-between;gap:.4rem;flex-wrap:wrap;">
          <button id="unitChatBtn" class="btn-secondary btn" onclick="sendUnitQuestion()">Send question</button>
          <button class="btn" onclick="window.print()">üñ® Print this unit</button>
        </div>
        <div id="unitChatInfo" style="font-size:.8rem;margin-top:.3rem;color:#455a64;"></div>
      </div>

      <div class="nav-row">
        <button class="btn-secondary btn" onclick="goBackToMenu()">‚¨Ö Back to menu</button>
        <button id="saveBtn" class="btn" onclick="saveLessonResult()">Save result ‚úî</button>
      </div>
    </div>
  </section>

  <!-- TEACHER -->
  <section id="teacherScreen" class="card hidden">
    <h3 class="center" style="margin-bottom:.4rem;">Teacher's Journal ‚Äì Grade 3</h3>
    <p style="font-size:.84rem;margin-bottom:.4rem;">
      Total stars saved on this device (for all students).
    </p>
    <div id="teacherTable" style="font-size:.86rem;"></div>
    <div class="center" style="margin-top:.6rem;">
      <button class="btn-secondary btn" onclick="goBackToMenu()">‚¨Ö Back</button>
      <button class="btn-danger btn" style="margin-left:.4rem;" onclick="clearAllData()">Clear all data</button>
    </div>
  </section>

  <!-- SIMPLE GLOBAL CHAT PLACEHOLDER -->
  <section id="chatScreen" class="card hidden">
    <h3 class="center" style="margin-bottom:.4rem;">AI Bayan Chat (global)</h3>
    <p style="font-size:.84rem;margin-bottom:.3rem;">
      –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å (–Ω–µ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —é–Ω–∏—Ç—É). –¢–æ–∂–µ –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ç–≤–æ–µ–≥–æ backend.
    </p>
    <textarea class="input" style="min-height:90px;"></textarea>
    <div class="center" style="margin-top:.6rem;">
      <button class="btn-secondary btn" onclick="goBackToMenu()">‚¨Ö Back</button>
    </div>
  </section>

  <p class="small-note">
    Students: 3E S1‚Äì3E S15 ¬∑ PIN 2844 ¬∑ Teacher PIN 3244 ¬∑ Main menu ‚Äì green, each unit has its own colour
  </p>
</div>

<script>
  const STUDENT_PIN = "2844";
  const TEACHER_PIN = "3244";
  const STORAGE_KEY = "ai_bayan_grade3_all";

  let currentUser = null;      // {name,isTeacher}
  let currentLessonId = "u1";  // –ø–æ–∫–∞ –æ–¥–∏–Ω —é–Ω–∏—Ç
  let lrText = "";
  let lsText = "";

  /* ---------- DATA ‚Äì Unit 1 HELLO ENGLISH! ---------- */
  const lessons = [
    {
      id:"u1",
      color:"var(--u1)",
      icon:"üëã",
      title:"Unit 1 ‚Äì Hello English!",
      subtitle:"Greetings, colours and numbers",
      vocab:[
        {word:"red", ru:"–∫—Ä–∞—Å–Ω—ã–π", emoji:"üü•", tts:"red"},
        {word:"blue", ru:"—Å–∏–Ω–∏–π", emoji:"üü¶", tts:"blue"},
        {word:"green", ru:"–∑–µ–ª—ë–Ω—ã–π", emoji:"üü©", tts:"green"},
        {word:"yellow", ru:"–∂—ë–ª—Ç—ã–π", emoji:"üü®", tts:"yellow"},
        {word:"black", ru:"—á—ë—Ä–Ω—ã–π", emoji:"‚¨õ", tts:"black"},
        {word:"white", ru:"–±–µ–ª—ã–π", emoji:"‚¨ú", tts:"white"},
        {word:"pink", ru:"—Ä–æ–∑–æ–≤—ã–π", emoji:"üå∏", tts:"pink"},
        {word:"orange", ru:"–æ—Ä–∞–Ω–∂–µ–≤—ã–π", emoji:"üüß", tts:"orange"},
        {word:"grey", ru:"—Å–µ—Ä—ã–π", emoji:"‚¨ú", tts:"grey"},
        {word:"brown", ru:"–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π", emoji:"üü´", tts:"brown"},
        {word:"one", ru:"–æ–¥–∏–Ω", emoji:"1Ô∏è‚É£", tts:"one"},
        {word:"two", ru:"–¥–≤–∞", emoji:"2Ô∏è‚É£", tts:"two"},
        {word:"three", ru:"—Ç—Ä–∏", emoji:"3Ô∏è‚É£", tts:"three"},
        {word:"four", ru:"—á–µ—Ç—ã—Ä–µ", emoji:"4Ô∏è‚É£", tts:"four"},
        {word:"five", ru:"–ø—è—Ç—å", emoji:"5Ô∏è‚É£", tts:"five"},
        {word:"six", ru:"—à–µ—Å—Ç—å", emoji:"6Ô∏è‚É£", tts:"six"},
        {word:"seven", ru:"—Å–µ–º—å", emoji:"7Ô∏è‚É£", tts:"seven"},
        {word:"eight", ru:"–≤–æ—Å–µ–º—å", emoji:"8Ô∏è‚É£", tts:"eight"},
        {word:"nine", ru:"–¥–µ–≤—è—Ç—å", emoji:"9Ô∏è‚É£", tts:"nine"},
        {word:"ten", ru:"–¥–µ—Å—è—Ç—å", emoji:"üîü", tts:"ten"}
      ],
      grammar:{
        rule:`We ask about <strong>name</strong>, <strong>age</strong> and <strong>country</strong>:`,
        formula:`What's your name? ‚Äì My name's Aidan.<br>
How old are you? ‚Äì I'm eight.<br>
Where are you from? ‚Äì I'm from Kazakhstan.<br><br>
Colours: <strong>That's</strong> (pink). <strong>Those are</strong> (red).`,
        examples:[
          "What's your name? ‚Äì My name's Alina.",
          "How old are you? ‚Äì I'm nine.",
          "Where are you from? ‚Äì I'm from Aktau.",
          "That's a blue bag. Those are green pens."
        ]
      },
      phonics:["A a ‚Äì apple","B b ‚Äì bag","C c ‚Äì cat","D d ‚Äì desk","E e ‚Äì egg","F f ‚Äì fish",
               "G g ‚Äì goat","H h ‚Äì hat","I i ‚Äì ink","J j ‚Äì jam","K k ‚Äì kite","L l ‚Äì lamp",
               "M m ‚Äì mum","N n ‚Äì nose","O o ‚Äì orange","P p ‚Äì pen","Q q ‚Äì queen","R r ‚Äì red",
               "S s ‚Äì sun","T t ‚Äì ten","U u ‚Äì umbrella","V v ‚Äì violin","W w ‚Äì window",
               "X x ‚Äì box","Y y ‚Äì yellow","Z z ‚Äì zebra"],
      listenRead:{
        text:`Hello! My name's Dana. I'm eight years old. I'm from Astana.
I have a red school bag and a blue pencil case. My favourite colour is green.
In my English class we say ‚ÄúHello!‚Äù and count from one to ten.`,
        questions:[
          {q:"Dana is __ years old.", options:["seven","eight","nine"], answer:"eight"},
          {q:"Her pencil case is __.", options:["blue","red","green"], answer:"blue"},
          {q:"Her favourite colour is __.", options:["green","pink","orange"], answer:"green"}
        ]
      },
      listenSing:{
        lyrics:`Hello, hello, hello, my friend,
Say your name and count to ten!
One, two, three, let's clap again,
Four, five, six, then seven, eight, nine, ten!`
      },
      // Worksheets "–ø–æ –º–æ—Ç–∏–≤–∞–º" workbook, –Ω–æ —Å–≤–æ–∏ —Ç–µ–∫—Å—Ç—ã
      worksheets:{
        ws1:[
          {prompt:"1) This colour is the sky: __________", answer:"blue"},
          {prompt:"2) 1, 2, 3, 4, 5 ‚Äì the number is: __________", answer:"five"},
          {prompt:"3) Grass is usually: __________", answer:"green"},
          {prompt:"4) Chocolate is: __________", answer:"brown"}
        ],
        ws2:[
          {
            sentence:"‚Äì __________ your name?  ‚Äì My name's Aidan.",
            options:["Where's","How's","What's"],
            answer:"What's"
          },
          {
            sentence:"‚Äì How old are you? ‚Äì __________ eight.",
            options:["I'm","It's","I"],
            answer:"I'm"
          },
          {
            sentence:"‚Äì Where are you from? ‚Äì I'm __________ Kazakhstan.",
            options:["on","at","from"],
            answer:"from"
          },
          {
            sentence:"__________ a red pen. __________ are blue pencils.",
            options:["That's / Those","Those / That's","This / That"],
            answer:"That's / Those"
          }
        ],
        ws3:[
          {prompt:"___ for red", answer:"R"},
          {prompt:"___ for bag", answer:"B"},
          {prompt:"___ for cat", answer:"C"},
          {prompt:"___ for ten", answer:"T"}
        ],
        ws4:[
          {
            sentence:"1) Dana is nine years old.",
            options:["True","False"],
            answer:"False"
          },
          {
            sentence:"2) Her school bag is red.",
            options:["True","False"],
            answer:"True"
          },
          {
            sentence:"3) Her favourite colour is green.",
            options:["True","False"],
            answer:"True"
          }
        ]
      }
    }

    // –°—é–¥–∞ –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–∏—à—å Unit 2‚Äì8 –ø–æ —Ç–æ–π –∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:
    // {id:"u2", color:"var(--u2)", icon:"üè´", title:"Unit 2 ‚Äì My school", ...}
  ];

  /* ---------- helpers ---------- */
  function $(id){return document.getElementById(id);}

  function speak(text){
    if(!("speechSynthesis" in window))return;
    const u=new SpeechSynthesisUtterance(text);
    u.lang="en-US";
    window.speechSynthesis.speak(u);
  }

  function loadData(){
    try{
      const raw=localStorage.getItem(STORAGE_KEY);
      return raw?JSON.parse(raw):{};
    }catch(e){return {};}
  }
  function saveData(data){
    localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
  }
  function getUserRecord(name){
    const data=loadData();
    if(!data[name]){
      data[name]={totalStars:0,lessons:{}}; // lessons[unitId]={stars,locked,chatUsed}
      saveData(data);
    }
    return data[name];
  }

  /* ---------- LOGIN ---------- */
  function handleLogin(){
    const name=$("loginName").value.trim();
    const pin=$("loginPin").value.trim();
    if(!name||!pin){alert("Please enter name and PIN.");return;}

    if(pin===TEACHER_PIN){
      currentUser={name:"Teacher",isTeacher:true};
      $("loginScreen").classList.add("hidden");
      buildTeacherJournal();
      $("teacherScreen").classList.remove("hidden");
      return;
    }
    if(pin!==STUDENT_PIN){alert("Wrong PIN.");return;}

    currentUser={name,isTeacher:false};
    $("loginScreen").classList.add("hidden");
    showMenu();
  }

  /* ---------- MENU ---------- */
  function showMenu(){
    if(!currentUser){return;}
    const rec=getUserRecord(currentUser.name);
    $("menuGreeting").textContent=`Hello, ${currentUser.name}!`;
    $("menuStars").textContent=`Total stars in all units: ${rec.totalStars} ‚≠ê`;

    const list=$("lessonList");
    list.innerHTML="";
    lessons.forEach(lesson=>{
      const lrec=rec.lessons[lesson.id]||{stars:0};
      const d=document.createElement("div");
      d.className="lesson-btn";
      d.onclick=()=>openLesson(lesson.id);
      d.innerHTML=`
        <div class="lesson-btn-left">
          <div class="lesson-icon">${lesson.icon}</div>
          <div class="lesson-info">
            <div>${lesson.title}</div>
            <small>${lesson.subtitle}</small>
          </div>
        </div>
        <div class="lesson-stars-mini">‚≠ê ${lrec.stars||0}</div>
      `;
      list.appendChild(d);
    });

    $("teacherScreen").classList.add("hidden");
    $("chatScreen").classList.add("hidden");
    $("lessonScreen").classList.add("hidden");
    $("menuScreen").classList.remove("hidden");
  }

  /* ---------- LESSON ---------- */
  function openLesson(id){
    currentLessonId=id;
    const lesson=lessons.find(l=>l.id===id);
    const header=$("lessonHeader");
    header.style.background=lesson.color;

    $("lessonTitle").textContent=lesson.title;
    $("lessonSubtitle").textContent=lesson.subtitle;

    const rec=getUserRecord(currentUser.name);
    const lrec=rec.lessons[id]||{stars:0,locked:false,chatUsed:false};
    $("lessonStars").textContent=`You have ${lrec.stars||0} ‚≠ê in this unit.`;
    $("saveBtn").disabled=!!lrec.locked;
    $("saveBtn").textContent=lrec.locked?"Result saved ‚úî":"Save result ‚úî";

    // tabs
    document.querySelectorAll(".tab-btn").forEach(btn=>{
      btn.classList.remove("active");
      if(btn.dataset.tab==="vocab")btn.classList.add("active");
    });
    ["vocab","grammar","phonics","lr","ls","ws"].forEach(tab=>{
      $("tab-"+tab).classList.toggle("hidden",tab!=="vocab");
    });

    // vocab
    const vg=$("vocabGrid");
    vg.innerHTML="";
    lesson.vocab.forEach(v=>{
      const card=document.createElement("div");
      card.className="vocab-card";
      card.innerHTML=`
        <div class="vocab-img">${v.emoji||"üìò"}</div>
        <div class="vocab-word">${v.word}</div>
        <div class="vocab-ru">${v.ru}</div>
        <button class="btn vocab-sound-btn"
          onclick="speak('${(v.tts||v.word).replace(/'/g,"\\'")}')">üîä Say it</button>
      `;
      vg.appendChild(card);
    });

    // grammar
    $("grammarBox").innerHTML=`
      ${lesson.grammar.rule}<br>
      <div class="grammar-formula">${lesson.grammar.formula}</div>
      <div class="grammar-examples">
        <strong>Examples:</strong>
        <ul>${lesson.grammar.examples.map(e=>`<li>${e}</li>`).join("")}</ul>
      </div>
    `;

    // phonics
    const pl=$("phonicsList");
    pl.innerHTML=lesson.phonics.map(p=>`<li>${p}</li>`).join("");

    // listen & read
    lrText=lesson.listenRead.text;
    $("lrText").innerHTML=lrText.replace(/\n/g,"<br>");
    const lrT=$("lrTasks");
    lrT.innerHTML="";
    lesson.listenRead.questions.forEach((t,i)=>{
      const div=document.createElement("div");
      div.className="task-item";
      div.innerHTML=`
        ${i+1}) ${t.q}<br>
        <select data-lr="${i}">
          <option value="">--choose--</option>
          ${t.options.map(o=>`<option value="${o}">${o}</option>`).join("")}
        </select>
      `;
      lrT.appendChild(div);
    });

    // listen & sing
    lsText=lesson.listenSing.lyrics;
    $("lsLyrics").innerHTML=lsText.replace(/\n/g,"<br>");

    // worksheets
    buildWorksheet("ws1");
    buildWorksheet("ws2");
    buildWorksheet("ws3");
    buildWorksheet("ws4");

    // unit chat limit
    $("unitChatInput").value="";
    $("unitChatInfo").textContent=lrec.chatUsed?"You already used your question for this unit.":"";
    $("unitChatBtn").disabled=!!lrec.chatUsed;

    $("menuScreen").classList.add("hidden");
    $("lessonScreen").classList.remove("hidden");
  }

  function switchTab(tab){
    document.querySelectorAll(".tab-btn").forEach(btn=>{
      btn.classList.toggle("active",btn.dataset.tab===tab);
    });
    ["vocab","grammar","phonics","lr","ls","ws"].forEach(t=>{
      $("tab-"+t).classList.toggle("hidden",t!==tab);
    });
  }

  function readLRText(){speak(lrText);}
  function readLSText(){speak(lsText);}

  function buildWorksheet(wsKey){
    const lesson=lessons.find(l=>l.id===currentLessonId);
    const tasks=lesson.worksheets[wsKey]||[];
    const container=$(wsKey+"Tasks");
    container.innerHTML="";

    tasks.forEach((t,i)=>{
      const div=document.createElement("div");
      div.className="task-item";
      if(wsKey==="ws1"||wsKey==="ws3"){
        div.innerHTML=`
          ${t.prompt}<br>
          <input type="text" data-ws="${wsKey}" data-idx="${i}">
        `;
      }else{
        div.innerHTML=`
          ${t.sentence}<br>
          <select data-ws="${wsKey}" data-idx="${i}">
            <option value="">--choose--</option>
            ${t.options.map(o=>`<option value="${o}">${o}</option>`).join("")}
          </select>
        `;
      }
      container.appendChild(div);
    });
    $(wsKey+"Result").textContent="";
  }

  function checkWorksheet(wsKey){
    const lesson=lessons.find(l=>l.id===currentLessonId);
    const tasks=lesson.worksheets[wsKey]||[];
    let correct=0;
    let total=tasks.length;

    // –∑–∞–ø—Ä–µ—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É ‚Äì 1 —à–∞–Ω—Å
    const alreadyLocked=$(wsKey+"Block").dataset.locked==="true";
    if(alreadyLocked){
      alert("You already checked this worksheet.");
      return;
    }

    tasks.forEach((t,i)=>{
      const el=document.querySelector(`[data-ws="${wsKey}"][data-idx="${i}"]`);
      if(!el)return;
      const value=el.value.trim();
      const ans=(t.answer||"").trim();
      let ok=false;
      if(wsKey==="ws1"||wsKey==="ws3"){
        ok=value.toLowerCase()===ans.toLowerCase();
      }else{
        ok=value===ans;
      }
      if(ok){
        correct++;
        el.style.borderColor="#2e7d32";
      }else{
        el.style.borderColor="#c62828";
      }
      el.disabled=true; // 1 –ø–æ–ø—ã—Ç–∫–∞
    });

    const res=$(wsKey+"Result");
    res.innerHTML=`Correct: ${correct}/${total} ${
      correct===total && total>0
        ? '<span class="correct-icon">‚úî +1‚≠ê</span>'
        : correct>0
          ? '<span class="correct-icon">‚úî</span>'
          : '<span class="wrong-icon">‚úñ</span>'
    }`;

    // –∞–Ω–∏–º–∞—Ü–∏—è –∑–≤–µ–∑–¥—ã, –µ—Å–ª–∏ –≤—Å—ë –≤–µ—Ä–Ω–æ
    if(correct===total&&total>0){
      showStar();
    }

    $(wsKey+"Block").dataset.locked="true";
  }

  function showStar(){
    const el=document.createElement("div");
    el.className="star-burst";
    el.textContent="‚≠ê";
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),1000);
  }

  function saveLessonResult(){
    if(!currentUser||currentUser.isTeacher){return;}
    const data=loadData();
    const rec=getUserRecord(currentUser.name);
    const lesson=lessons.find(l=>l.id===currentLessonId);
    const lrec=rec.lessons[currentLessonId]||{stars:0,locked:false};

    if(lrec.locked){
      alert("Result already saved.");
      return;
    }

    // —Å—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏—Ö –ª–∏—Å—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–µ—Ä–Ω–æ
    let gained=0;
    ["ws1","ws2","ws3","ws4"].forEach(wsKey=>{
      const tasks=lesson.worksheets[wsKey]||[];
      if(!tasks.length)return;
      let allCorrect=true;
      tasks.forEach((t,i)=>{
        const el=document.querySelector(`[data-ws="${wsKey}"][data-idx="${i}"]`);
        if(!el)return;
        const value=el.value.trim();
        const ans=(t.answer||"").trim();
        const ok=(wsKey==="ws1"||wsKey==="ws3")
          ? value.toLowerCase()===ans.toLowerCase()
          : value===ans;
        if(!ok)allCorrect=false;
      });
      if(allCorrect)gained++;
    });

    lrec.stars+=gained;
    lrec.locked=true;
    rec.totalStars+=gained;
    rec.lessons[currentLessonId]=lrec;
    data[currentUser.name]=rec;
    saveData(data);

    $("lessonStars").textContent=`You have ${lrec.stars} ‚≠ê in this unit.`;
    $("saveBtn").disabled=true;
    $("saveBtn").textContent="Result saved ‚úî";
    alert(`Saved! You earned ${gained} ‚≠ê in this unit.`);
  }

  function goBackToMenu(){
    showMenu();
  }

  /* ---------- Teacher ---------- */
  function buildTeacherJournal(){
    const data=loadData();
    const container=$("teacherTable");
    const names=Object.keys(data);
    if(!names.length){
      container.textContent="No data yet.";
      return;
    }
    let html=`<table style="width:100%;border-collapse:collapse;">
      <tr>
        <th style="border-bottom:1px solid #b0bec5;text-align:left;">Student</th>
        <th style="border-bottom:1px solid #b0bec5;">Total ‚≠ê</th>
        <th style="border-bottom:1px solid #b0bec5;font-size:.8rem;">By units</th>
      </tr>`;
    names.forEach(name=>{
      const r=data[name];
      const unitInfo=Object.entries(r.lessons||{})
        .map(([id,info])=>{
          const les=lessons.find(l=>l.id===id);
          const short=les?les.title.replace("Unit ","U"):"Unit";
          return `${short}: ${info.stars||0}‚≠ê`;
        }).join("<br>");
      html+=`<tr>
        <td style="border-bottom:1px solid #eceff1;padding:.25rem 0;">${name}</td>
        <td style="border-bottom:1px solid #eceff1;text-align:center;">${r.totalStars}</td>
        <td style="border-bottom:1px solid #eceff1;font-size:.78rem;">${unitInfo}</td>
      </tr>`;
    });
    html+="</table>";
    container.innerHTML=html;
  }

  function openTeacherJournal(){
    if(!currentUser||!currentUser.isTeacher){
      alert("Teacher PIN needed.");
      return;
    }
    $("menuScreen").classList.add("hidden");
    buildTeacherJournal();
    $("teacherScreen").classList.remove("hidden");
  }

  function clearAllData(){
    if(!confirm("Delete all saved stars on this device?"))return;
    localStorage.removeItem(STORAGE_KEY);
    buildTeacherJournal();
  }

  /* ---------- Chats ---------- */
  function openGlobalChat(){
    $("menuScreen").classList.add("hidden");
    $("chatScreen").classList.remove("hidden");
  }

  function sendUnitQuestion(){
    const q=$("unitChatInput").value.trim();
    if(!q){alert("Write your question first.");return;}

    const data=loadData();
    const rec=getUserRecord(currentUser.name);
    const lrec=rec.lessons[currentLessonId]||{stars:0,locked:false,chatUsed:false};

    if(lrec.chatUsed){
      alert("You already used your question for this unit.");
      return;
    }

    lrec.chatUsed=true;
    rec.lessons[currentLessonId]=lrec;
    data[currentUser.name]=rec;
    saveData(data);

    $("unitChatBtn").disabled=true;
    $("unitChatInfo").textContent="Your question is sent to AI Bayan (demo). Only one question per unit.";
    alert("Question sent (demo).");

    // –ó–¥–µ—Å—å –≤–º–µ—Å—Ç–æ alert –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å —Ç–≤–æ–π Cloudflare Worker
    // fetch('https://your-worker-url', {method:'POST', body:JSON.stringify({question:q,unit:currentLessonId})})
  }

</script>
</body>
</html>

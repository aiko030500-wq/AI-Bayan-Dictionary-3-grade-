<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AI Bayan Dictionary 3gr</title>
  <style>
    :root{
      --bg1:#e9fff6;
      --bg2:#dff8ef;
      --card:#ffffff;
      --ink:#10334a;
      --muted:#5c788d;

      --green:#1b7a45;
      --green2:#2fb36a;
      --gold:#ffd54f;

      --ok:#1e8f4c;
      --bad:#c62828;

      --shadow:0 14px 28px rgba(0,0,0,.10);
      --shadow2:0 10px 18px rgba(0,0,0,.08);

      --r1:22px;
      --r2:28px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--ink);
    }
    .wrap{max-width:820px;margin:0 auto;padding:16px}
    .topBadge{
      display:flex;align-items:center;gap:12px;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(0,0,0,.06);
      border-radius:18px;
      padding:10px 12px;
      box-shadow: var(--shadow2);
    }
    .logoMini{
      width:44px;height:44px;border-radius:50%;
      border:3px solid var(--gold);
      overflow:hidden;background:#fff;flex:0 0 auto;
      display:flex;align-items:center;justify-content:center;
    }
    .logoMini img{width:100%;height:100%;object-fit:cover}
    .topTitle{display:flex;flex-direction:column;gap:2px}
    .topTitle b{font-size:16px}
    .topTitle small{color:var(--muted);font-weight:800}
    .pill{
      margin-left:auto;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      box-shadow: var(--shadow2);
    }
    .pill.ok{color:var(--ok)}
    .pill.no{color:var(--bad)}
    .card{
      background:var(--card);
      border:1px solid rgba(0,0,0,.07);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      padding:14px;
      margin:14px 0;
    }
    h1,h2,h3{margin:0}
    .h2{font-size:22px;font-weight:1000}
    .muted{color:var(--muted);font-weight:800}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    .input{
      width:100%;
      border:1px solid rgba(0,0,0,.12);
      border-radius:16px;
      padding:12px 12px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    .btn{
      border:none;cursor:pointer;
      border-radius:18px;
      padding:12px 14px;
      font-weight:1000;
      box-shadow: var(--shadow2);
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      background:#fff;color:var(--ink);
      border:1px solid rgba(0,0,0,.10);
    }
    .btn:active{transform:scale(.99)}
    .btnGreen{
      background: linear-gradient(180deg,#4fe28f,var(--green2));
      color:#08321b;
      border:none;
    }
    .btnGold{
      background: linear-gradient(180deg,#fff3c3,var(--gold));
      color:#2a1e00;
      border:none;
    }
    .btnBlue{
      background: linear-gradient(180deg,#84c8ff,#3f8ee8);
      color:#062443;
      border:none;
    }
    .btnSmall{padding:10px 12px;border-radius:16px}

    .menuBtn{
      width:100%;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      padding:16px 14px;
      margin:12px 0;
      font-size:20px;
      font-weight:1000;
      display:flex;align-items:center;justify-content:space-between;
      cursor:pointer;
    }
    .menuBtn .left{display:flex;align-items:center;gap:10px}
    .tag{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:14px;
      padding:7px 10px;
      font-weight:1000;
      color:var(--muted);
      box-shadow: var(--shadow2);
      white-space:nowrap;
    }

    .screen{display:none}
    .screen.active{display:block}

    .headerBar{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      padding:14px;
      margin:14px 0;
    }
    .headerBar .top{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .headerBar h2{font-size:22px;font-weight:1000}
    .headerBar .meta{color:var(--muted);font-weight:900;margin-top:4px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

    /* Vocabulary cards (2 columns) */
    .grid2{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width:520px){ .grid2{grid-template-columns:1fr} }

    .vCard{
      background: linear-gradient(180deg,#eafff2,#f7fffb);
      border:1px solid rgba(0,0,0,.08);
      border-radius:20px;
      padding:12px;
      box-shadow: var(--shadow2);
      text-align:center;
    }
    .picBox{
      width:86px;height:86px;border-radius:18px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 8px 14px rgba(0,0,0,.08);
      margin:0 auto 8px;
      display:flex;align-items:center;justify-content:center;
      font-size:44px;
    }
    .vWord{font-size:22px;font-weight:1000;margin-top:2px}
    .vRu{font-size:16px;font-weight:900;color:var(--muted);margin-top:2px}
    .sayBtn{
      margin-top:10px;
      width:100%;
    }

    /* Sections */
    .secTitle{
      display:flex;align-items:center;gap:10px;
      font-size:18px;font-weight:1000;color:#0b3d6d;
      margin:0 0 10px 0;
    }
    .secBox{
      background:#f7fbff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:22px;
      padding:14px;
      box-shadow: var(--shadow2);
      margin-top:12px;
    }

    /* Grammar box */
    .gBox{
      background:#dff2ff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:18px;
      padding:14px;
      box-shadow: var(--shadow2);
    }
    .gRow{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:14px;
      padding:10px 12px;
      margin:10px 0;
    }
    .formula{
      background:#fff6cf;
      border:1px solid rgba(0,0,0,.10);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      color:#2a1e00;
      margin-top:10px;
    }
    ul{margin:8px 0 0 18px}
    li{margin:6px 0}

    /* Worksheets */
    .wBox{
      background:#fff;
      border:2px dashed rgba(0,0,0,.18);
      border-radius:20px;
      padding:12px;
      margin:12px 0;
    }
    .wHead{font-size:18px;font-weight:1000;margin:0 0 8px 0}
    .wNote{color:var(--muted);font-weight:900;margin:0 0 10px 0}
    .qRow{display:flex;gap:10px;align-items:center;margin:10px 0;flex-wrap:wrap}
    .qRow label{font-weight:1000}
    .short{max-width:320px}
    .select{
      border:1px solid rgba(0,0,0,.12);
      border-radius:14px;
      padding:10px 10px;
      font-size:16px;
      background:#fff;
      outline:none;
    }
    .mark{
      font-weight:1000;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      box-shadow: var(--shadow2);
    }
    .mark.ok{color:var(--ok)}
    .mark.bad{color:var(--bad)}
    .resultLine{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-top:10px;
      font-weight:1000;
    }

    /* Karaoke */
    .karaBox{
      background: linear-gradient(180deg,#fff,#f3fff8);
      border:1px solid rgba(0,0,0,.08);
      border-radius:22px;
      padding:12px;
      box-shadow: var(--shadow2);
    }
    .lyricLine{
      padding:10px 10px;
      border-radius:14px;
      margin:8px 0;
      font-weight:1000;
      border:1px solid rgba(0,0,0,.06);
      background:#fff;
    }
    .lyricLine.active{
      background: linear-gradient(180deg,#fff3c3,var(--gold));
      color:#2a1e00;
      border:none;
    }

    /* Teacher journal table */
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:0 8px}
    td{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      padding:10px 8px;
      border-radius:14px;
      font-weight:900;
    }
    .tSmall{color:var(--muted);font-weight:900;font-size:12px}

    /* Print */
    @media print{
      .noPrint{display:none!important}
      body{background:#fff}
      .wrap{max-width:100%;padding:0}
      .card,.headerBar,.secBox,.wBox,.karaBox,.gBox{box-shadow:none!important}
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- TOP badge -->
  <div class="topBadge noPrint">
    <div class="logoMini"><img src="logo.png" alt="AI Bayan"/></div>
    <div class="topTitle">
      <b>AI Bayan Dictionary 3gr</b>
      <small>8 units ‚Ä¢ stars saved</small>
    </div>
    <div id="loginPill" class="pill no">Not logged</div>
  </div>

  <!-- MAIN -->
  <section class="screen active" id="screenMain">

    <div class="card">
      <div class="h2">–í—Ö–æ–¥</div>
      <div class="muted" style="margin-top:6px">–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.</div>

      <div class="row" style="margin-top:12px">
        <div class="col">
          <input id="loginInput" class="input" placeholder="–õ–æ–≥–∏–Ω" autocomplete="off"/>
        </div>
        <div class="col">
          <input id="pinInput" class="input" placeholder="–ü–∞—Ä–æ–ª—å" type="password" autocomplete="off"/>
        </div>
      </div>

      <div class="row" style="margin-top:12px;align-items:center">
        <button class="btn btnGreen" onclick="doLogin()">–í–æ–π—Ç–∏</button>
        <button class="btn btnSmall" onclick="doLogout()">–í—ã–π—Ç–∏</button>
        <div class="muted" style="margin-left:auto;font-weight:1000">
          Total stars: <span id="totalStars">0</span> ‚≠ê
        </div>
      </div>

      <div style="margin-top:12px">
        <button class="btn btnGold" onclick="openTeacherGate()">üë©‚Äçüè´ –ñ—É—Ä–Ω–∞–ª —É—á–∏—Ç–µ–ª—è</button>
      </div>
    </div>

    <div class="card">
      <div class="h2">Units</div>
      <div class="muted" style="margin-top:6px">–û—Ç–∫—Ä–æ–π unit ‚Üí –≤–Ω—É—Ç—Ä–∏ 8 lessons.</div>

      <button class="menuBtn" onclick="goUnit(1)">
        <div class="left">üìó Unit 1</div>
        <div class="tag">‚≠ê <span id="u1s">0</span></div>
      </button>
      <button class="menuBtn" onclick="goUnit(2)"><div class="left">üéí Unit 2</div><div class="tag">‚≠ê <span id="u2s">0</span></div></button>
      <button class="menuBtn" onclick="goUnit(3)"><div class="left">üë®‚Äçüë©‚Äçüëß Unit 3</div><div class="tag">‚≠ê <span id="u3s">0</span></div></button>
      <button class="menuBtn" onclick="goUnit(4)"><div class="left">‚õÖ Unit 4</div><div class="tag">‚≠ê <span id="u4s">0</span></div></button>
      <button class="menuBtn" onclick="goUnit(5)"><div class="left">üéØ Unit 5</div><div class="tag">‚≠ê <span id="u5s">0</span></div></button>
      <button class="menuBtn" onclick="goUnit(6)"><div class="left">üçé Unit 6</div><div class="tag">‚≠ê <span id="u6s">0</span></div></button>
      <button class="menuBtn" onclick="goUnit(7)"><div class="left">üèôÔ∏è Unit 7</div><div class="tag">‚≠ê <span id="u7s">0</span></div></button>
      <button class="menuBtn" onclick="goUnit(8)"><div class="left">‚úàÔ∏è Unit 8</div><div class="tag">‚≠ê <span id="u8s">0</span></div></button>

      <!-- achievements + chat row (–≤–Ω–∏–∑ –≤–æ–∑–ª–µ —á–∞—Ç–∞) -->
      <div class="row" style="margin-top:14px">
        <button class="btn btnBlue" style="flex:1" onclick="openChat()">üí¨ AI Chat</button>
        <div class="card" style="flex:1;margin:0;padding:12px;border-radius:18px;box-shadow:var(--shadow2)">
          <div style="font-weight:1000">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
          <div class="tSmall" style="margin-top:4px">‚úÖ/‚ùå —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è ‚Ä¢ Print –∫–∞–∂–¥–æ–≥–æ lesson</div>
          <div style="margin-top:8px;font-weight:1000">
            ‚≠ê Stars: <span id="achStars">0</span>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- UNIT -->
  <section class="screen" id="screenUnit">
    <div class="headerBar noPrint">
      <div class="top">
        <div>
          <h2 id="unitTitle">Unit 1</h2>
          <div class="meta">Stars in this unit: <span id="unitStars">0</span> ‚≠ê</div>
        </div>
        <div class="tag">Student: <span id="who">‚Äî</span></div>
      </div>
      <div class="actions">
        <button class="btn btnSmall" onclick="goMain()">‚Üê Main</button>
        <button class="btn btnSmall" onclick="openChat()">üí¨ Chat</button>
        <button class="btn btnSmall" onclick="openTeacherGate()">üë©‚Äçüè´ Journal</button>
      </div>
    </div>

    <button class="menuBtn" onclick="openLesson(1)"><div class="left">Lesson 1</div><div class="tag">‚≠ê <span id="ls1">0</span></div></button>
    <button class="menuBtn" onclick="openLesson(2)"><div class="left">Lesson 2</div><div class="tag">‚≠ê <span id="ls2">0</span></div></button>
    <button class="menuBtn" onclick="openLesson(3)"><div class="left">Lesson 3</div><div class="tag">‚≠ê <span id="ls3">0</span></div></button>
    <button class="menuBtn" onclick="openLesson(4)"><div class="left">Lesson 4</div><div class="tag">‚≠ê <span id="ls4">0</span></div></button>
    <button class="menuBtn" onclick="openLesson(5)"><div class="left">Lesson 5</div><div class="tag">‚≠ê <span id="ls5">0</span></div></button>
    <button class="menuBtn" onclick="openLesson(6)"><div class="left">Lesson 6</div><div class="tag">‚≠ê <span id="ls6">0</span></div></button>
    <button class="menuBtn" onclick="openLesson(7)"><div class="left">Lesson 7</div><div class="tag">‚≠ê <span id="ls7">0</span></div></button>
    <button class="menuBtn" onclick="openLesson(8)"><div class="left">Lesson 8</div><div class="tag">‚≠ê <span id="ls8">0</span></div></button>
  </section>

  <!-- LESSON -->
  <section class="screen" id="screenLesson">
    <div class="headerBar">
      <div class="top">
        <div>
          <h2 id="lessonTitle">Unit 1 ‚Äî Lesson 1</h2>
          <div class="meta">You have <span id="lessonStars">0</span> ‚≠ê in this lesson.</div>
        </div>
        <div class="tag">Student: <span id="who2">‚Äî</span></div>
      </div>

      <div class="actions noPrint">
        <button class="btn btnBlue" onclick="backToUnit()">‚Üê Back</button>
        <button class="btn btnGold" onclick="printLesson()">üñ®Ô∏è Print</button>
        <button class="btn btnGreen" onclick="saveLessonStars()">Save Result ‚úÖ</button>
      </div>
    </div>

    <div id="lessonContent"></div>
  </section>

  <!-- TEACHER -->
  <section class="screen" id="screenTeacher">
    <div class="headerBar noPrint">
      <div class="top">
        <div>
          <h2>Teacher‚Äôs Journal</h2>
          <div class="meta">Students 3E L1 ‚Äî 3E L15</div>
        </div>
        <div class="tag">PIN required</div>
      </div>
      <div class="actions">
        <button class="btn btnSmall" onclick="goMain()">‚Üê Main</button>
      </div>
    </div>

    <div class="card noPrint" id="teacherGate">
      <div class="h2">Teacher PIN</div>
      <div class="row" style="margin-top:12px">
        <div class="col">
          <input id="teacherPinInput" class="input" placeholder="–ü–∞—Ä–æ–ª—å" type="password"/>
        </div>
        <div class="col" style="display:flex;align-items:center;gap:10px">
          <button class="btn btnGreen" onclick="enterTeacher()">Open</button>
          <button class="btn" onclick="clearAllData()">Reset data</button>
        </div>
      </div>
      <div class="tSmall" style="margin-top:10px">
        Reset –æ—á–∏—â–∞–µ—Ç –∑–≤—ë–∑–¥—ã/–≥–∞–ª–æ—á–∫–∏ (–ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ).
      </div>
    </div>

    <div class="card" id="teacherTableWrap" style="display:none">
      <div class="h2">Progress</div>
      <div class="muted" style="margin-top:6px">Stars + last login</div>

      <div style="overflow:auto;margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>Student</th>
              <th>Total ‚≠ê</th>
              <th>Last login</th>
              <th class="tSmall">Unit1 ‚≠ê</th>
            </tr>
          </thead>
          <tbody id="teacherRows"></tbody>
        </table>
      </div>
    </div>
  </section>

</div>

<script>
/* =========================
   DATA + STORAGE
========================= */
const STUDENTS = Array.from({length:15},(_,i)=>`3E L${i+1}`);
const STUDENT_PIN = "2844";
const TEACHER_PIN = "3244";

const LS = {
  session: "aib3_session",
  progress: "aib3_progress",  // per student
  chat: "aib3_chatlimit"
};

function todayKey(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function safeJSONParse(s, fallback){
  try{ return JSON.parse(s); }catch{ return fallback; }
}
function getSession(){
  return safeJSONParse(localStorage.getItem(LS.session), {logged:false, user:null, lastLogin:null});
}
function setSession(s){
  localStorage.setItem(LS.session, JSON.stringify(s));
}
function getAllProgress(){
  const p = safeJSONParse(localStorage.getItem(LS.progress), {});
  // ensure structure
  for(const st of STUDENTS){
    if(!p[st]) p[st] = { lastLogin:null, stars: makeStars(), marks:{} };
    if(!p[st].stars) p[st].stars = makeStars();
    if(!p[st].marks) p[st].marks = {};
  }
  localStorage.setItem(LS.progress, JSON.stringify(p));
  return p;
}
function setAllProgress(p){
  localStorage.setItem(LS.progress, JSON.stringify(p));
}
function makeStars(){
  // 8 units x 8 lessons
  const stars = {};
  for(let u=1;u<=8;u++){
    stars[u] = {};
    for(let l=1;l<=8;l++) stars[u][l]=0;
  }
  return stars;
}
function totalStarsForStudent(pStudent){
  let t=0;
  for(let u=1;u<=8;u++) for(let l=1;l<=8;l++) t += (pStudent.stars?.[u]?.[l]||0);
  return t;
}
function unitStarsForStudent(pStudent, u){
  let t=0;
  for(let l=1;l<=8;l++) t += (pStudent.stars?.[u]?.[l]||0);
  return t;
}

/* =========================
   UI NAV
========================= */
let state = {
  unit: 1,
  lesson: 1
};

function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  window.scrollTo({top:0,behavior:"instant"});
}

function goMain(){
  refreshAllBadges();
  show("screenMain");
}

function goUnit(u){
  const sess = getSession();
  if(!sess.logged){ alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ."); return; }
  state.unit = u;
  refreshUnitScreen();
  show("screenUnit");
}

function backToUnit(){
  refreshUnitScreen();
  show("screenUnit");
}

function openLesson(l){
  const sess = getSession();
  if(!sess.logged){ alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ."); return; }
  state.lesson = l;
  refreshLessonScreen();
  show("screenLesson");
}

function openTeacherGate(){
  show("screenTeacher");
  // gate shown by default
  document.getElementById("teacherGate").style.display = "block";
  document.getElementById("teacherTableWrap").style.display = "none";
  document.getElementById("teacherPinInput").value = "";
}

/* =========================
   LOGIN
========================= */
function doLogin(){
  const login = (document.getElementById("loginInput").value || "").trim();
  const pin = (document.getElementById("pinInput").value || "").trim();

  if(!STUDENTS.includes(login)){ alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω."); return; }
  if(pin !== STUDENT_PIN){ alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å."); return; }

  const p = getAllProgress();
  p[login].lastLogin = new Date().toISOString();
  setAllProgress(p);

  setSession({logged:true, user:login, lastLogin: p[login].lastLogin});
  refreshAllBadges();
  alert("–í—ã –≤–æ—à–ª–∏ ‚úÖ");
}

function doLogout(){
  setSession({logged:false, user:null, lastLogin:null});
  refreshAllBadges();
}

/* =========================
   CHAT 1 / DAY
========================= */
function openChat(){
  const sess = getSession();
  if(!sess.logged){ alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ."); return; }

  const key = `${sess.user}:${todayKey()}`;
  const chatState = safeJSONParse(localStorage.getItem(LS.chat), {});
  if(chatState[key]){ alert("–õ–∏–º–∏—Ç: 1 –≤–æ–ø—Ä–æ—Å –≤ –¥–µ–Ω—å ‚úÖ"); return; }

  const q = prompt("Ask AI Bayan (1 question/day):");
  if(!q) return;

  chatState[key] = { askedAt: new Date().toISOString(), q:q };
  localStorage.setItem(LS.chat, JSON.stringify(chatState));

  // simple helper reply (offline)
  alert("AI Bayan: Let‚Äôs practise! ‚úÖ\nTry to say it in English and repeat 3 times.");
}

/* =========================
   TEACHER
========================= */
function enterTeacher(){
  const pin = (document.getElementById("teacherPinInput").value||"").trim();
  if(pin !== TEACHER_PIN){ alert("–ù–µ–≤–µ—Ä–Ω—ã–π PIN."); return; }
  document.getElementById("teacherGate").style.display = "none";
  document.getElementById("teacherTableWrap").style.display = "block";
  renderTeacherTable();
}
function renderTeacherTable(){
  const p = getAllProgress();
  const tbody = document.getElementById("teacherRows");
  tbody.innerHTML = "";
  for(const st of STUDENTS){
    const ps = p[st];
    const tr = document.createElement("tr");
    const last = ps.lastLogin ? new Date(ps.lastLogin).toLocaleString() : "‚Äî";
    tr.innerHTML = `
      <td>${st}</td>
      <td>${totalStarsForStudent(ps)} ‚≠ê</td>
      <td>${last}</td>
      <td>${unitStarsForStudent(ps,1)} ‚≠ê</td>
    `;
    tbody.appendChild(tr);
  }
}
function clearAllData(){
  if(!confirm("Reset all local data?")) return;
  localStorage.removeItem(LS.progress);
  localStorage.removeItem(LS.chat);
  localStorage.removeItem(LS.session);
  alert("Done.");
  location.reload();
}

/* =========================
   STARS + MARKS per lesson
========================= */
function getStudentProgress(){
  const sess = getSession();
  if(!sess.logged) return null;
  const p = getAllProgress();
  return { all:p, me:p[sess.user], user:sess.user };
}

function setLessonStars(u,l,stars){
  const sp = getStudentProgress();
  if(!sp) return;
  sp.me.stars[u][l] = stars;
  sp.me.lastLogin = new Date().toISOString();
  sp.all[sp.user] = sp.me;
  setAllProgress(sp.all);
}

function getLessonStars(u,l){
  const sp = getStudentProgress();
  if(!sp) return 0;
  return sp.me.stars?.[u]?.[l] || 0;
}

function saveMarks(u,l,marksObj){
  const sp = getStudentProgress();
  if(!sp) return;
  const key = `U${u}L${l}`;
  sp.me.marks[key] = marksObj;
  sp.me.lastLogin = new Date().toISOString();
  sp.all[sp.user] = sp.me;
  setAllProgress(sp.all);
}
function loadMarks(u,l){
  const sp = getStudentProgress();
  if(!sp) return null;
  const key = `U${u}L${l}`;
  return sp.me.marks?.[key] || null;
}

/* =========================
   SPEECH (AI Bayan says)
========================= */
function speak(text){
  try{
    speechSynthesis.cancel();
    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = "en-US";
    ut.rate = 0.92;
    speechSynthesis.speak(ut);
  }catch(e){
    alert("Speech not supported on this device.");
  }
}

/* =========================
   LESSON CONTENT
========================= */
function lesson1HTML(){
  // Visual vocabulary (2 columns)
  const vocab = [
    {w:"hello", ru:"–ø—Ä–∏–≤–µ—Ç", pic:"üëã"},
    {w:"goodbye", ru:"–ø–æ–∫–∞", pic:"üëã"},
    {w:"name", ru:"–∏–º—è", pic:"üè∑Ô∏è"},
    {w:"thank you", ru:"—Å–ø–∞—Å–∏–±–æ", pic:"üôè"},
    {w:"I‚Äôm fine", ru:"—É –º–µ–Ω—è –≤—Å—ë —Ö–æ—Ä–æ—à–æ", pic:"üòä"},
    {w:"I‚Äôm from Kazakhstan", ru:"—è –∏–∑ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞", pic:"üá∞üáø"}
  ];

  return `
    <div class="card">
      <div class="secTitle">üß† Visual Vocabulary</div>
      <div class="muted" style="margin-bottom:10px">Tap ‚ÄúSay it‚Äù ‚Äî AI Bayan says the word.</div>

      <div class="grid2">
        ${vocab.map(v=>`
          <div class="vCard">
            <div class="picBox">${v.pic}</div>
            <div class="vWord">${v.w}</div>
            <div class="vRu">${v.ru}</div>
            <button class="btn btnGreen sayBtn" onclick="speak('${escapeQuotes(v.w)}')">üîä Say it</button>
          </div>
        `).join("")}
      </div>
    </div>

    <div class="card">
      <div class="secTitle">üìò Grammar Key</div>
      <div class="gBox">

        <div class="gRow">
          <b>1) What‚Äôs your name?</b><br/>
          EN: What‚Äôs your name? / What is your name?<br/>
          RU: –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?<br/>
          <div class="formula">Formula: What‚Äôs your name? ‚Üí My name‚Äôs + Name.</div>
          <ul>
            <li>My name‚Äôs Tim. ‚Äî –ú–µ–Ω—è –∑–æ–≤—É—Ç –¢–∏–º.</li>
            <li>My name‚Äôs Rosy. ‚Äî –ú–µ–Ω—è –∑–æ–≤—É—Ç –†–æ–∑–∏.</li>
          </ul>
        </div>

        <div class="gRow">
          <b>2) How old are you?</b><br/>
          EN: How old are you?<br/>
          RU: –°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç?<br/>
          <div class="formula">Formula: How old are you? ‚Üí I‚Äôm + number.</div>
          <ul>
            <li>I‚Äôm seven. ‚Äî –ú–Ω–µ 7.</li>
            <li>I‚Äôm eight. ‚Äî –ú–Ω–µ 8.</li>
          </ul>
        </div>

        <div class="gRow">
          <b>3) Where are you from?</b><br/>
          EN: Where are you from?<br/>
          RU: –û—Ç–∫—É–¥–∞ —Ç—ã?<br/>
          <div class="formula">Formula: Where are you from? ‚Üí I‚Äôm from + country/city.</div>
          <ul>
            <li>I‚Äôm from Kazakhstan. ‚Äî –Ø –∏–∑ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞.</li>
            <li>I‚Äôm from Aktau. ‚Äî –Ø –∏–∑ –ê–∫—Ç–∞—É.</li>
          </ul>
        </div>

        <div class="gRow">
          <b>4) This / That / These / Those</b><br/>
          EN: This is (pink). / That is (red). / These are (green). / Those are (blue).<br/>
          RU: –≠—Ç–æ (—Ä–æ–∑–æ–≤–æ–µ). / –¢–æ (–∫—Ä–∞—Å–Ω–æ–µ). / –≠—Ç–∏ (–∑–µ–ª—ë–Ω—ã–µ). / –¢–µ (—Å–∏–Ω–∏–µ).<br/>
          <div class="formula">Formula: This/That is + singular. &nbsp;|&nbsp; These/Those are + plural.</div>
          <ul>
            <li>This is a book. ‚Äî –≠—Ç–æ –∫–Ω–∏–≥–∞.</li>
            <li>These are pens. ‚Äî –≠—Ç–æ —Ä—É—á–∫–∏.</li>
          </ul>
        </div>

      </div>
    </div>

    <div class="card">
      <div class="secTitle">üßæ Worksheets (4 tasks)</div>

      <div class="wBox" id="w1">
        <div class="wHead">Worksheet 1 ‚Äî Missing letters</div>
        <div class="wNote">Write the missing letters.</div>

        <div class="qRow"><label>1) h__lo</label><input class="input short" id="w1a1" /></div>
        <div class="qRow"><label>2) g__dbye</label><input class="input short" id="w1a2" /></div>
        <div class="qRow"><label>3) th__k you</label><input class="input short" id="w1a3" /></div>
        <div class="qRow"><label>4) n__e</label><input class="input short" id="w1a4" /></div>

        <div class="resultLine">
          <button class="btn btnGreen" onclick="checkW1()">Check ‚úì</button>
          <div>Correct: <span id="w1score">0</span> / 4</div>
        </div>
      </div>

      <div class="wBox" id="w2">
        <div class="wHead">Worksheet 2 ‚Äî Matching picture and word</div>
        <div class="wNote">Choose the correct word for each picture.</div>

        <div class="qRow">
          <span class="picBox" style="width:52px;height:52px;border-radius:14px;font-size:26px">üëã</span>
          <select class="select" id="w2a1">
            <option value="">--choose--</option>
            <option>hello</option><option>name</option><option>thank you</option>
          </select>
        </div>

        <div class="qRow">
          <span class="picBox" style="width:52px;height:52px;border-radius:14px;font-size:26px">üôè</span>
          <select class="select" id="w2a2">
            <option value="">--choose--</option>
            <option>thank you</option><option>goodbye</option><option>I‚Äôm fine</option>
          </select>
        </div>

        <div class="qRow">
          <span class="picBox" style="width:52px;height:52px;border-radius:14px;font-size:26px">üè∑Ô∏è</span>
          <select class="select" id="w2a3">
            <option value="">--choose--</option>
            <option>name</option><option>hello</option><option>goodbye</option>
          </select>
        </div>

        <div class="resultLine">
          <button class="btn btnGreen" onclick="checkW2()">Check ‚úì</button>
          <div>Correct: <span id="w2score">0</span> / 3</div>
        </div>
      </div>

      <div class="wBox" id="w3">
        <div class="wHead">Worksheet 3 ‚Äî Choose the correct word (Grammar)</div>
        <div class="wNote">Choose the correct answer.</div>

        <div class="qRow">
          <label>1) ____ your name?</label>
          <select class="select" id="w3a1">
            <option value="">--choose--</option>
            <option>What‚Äôs</option>
            <option>Where</option>
            <option>How</option>
          </select>
        </div>

        <div class="qRow">
          <label>2) ____ old are you?</label>
          <select class="select" id="w3a2">
            <option value="">--choose--</option>
            <option>How</option>
            <option>Where</option>
            <option>What</option>
          </select>
        </div>

        <div class="qRow">
          <label>3) I‚Äôm ____ Kazakhstan.</label>
          <select class="select" id="w3a3">
            <option value="">--choose--</option>
            <option>from</option>
            <option>fine</option>
            <option>name</option>
          </select>
        </div>

        <div class="resultLine">
          <button class="btn btnGreen" onclick="checkW3()">Check ‚úì</button>
          <div>Correct: <span id="w3score">0</span> / 3</div>
        </div>
      </div>

      <div class="wBox" id="w4">
        <div class="wHead">Worksheet 4 ‚Äî Reading mini (True/False)</div>
        <div class="wNote">Read the mini dialogue. Answer True/False.</div>

        <div class="card" style="margin:0;border-radius:18px;box-shadow:var(--shadow2)">
          <div style="font-weight:1000">Mini dialogue</div>
          <div class="muted" style="margin-top:6px;line-height:1.4">
            Tim: Hello! What‚Äôs your name?<br/>
            Rosy: My name‚Äôs Rosy. How old are you?<br/>
            Tim: I‚Äôm seven. Where are you from?<br/>
            Rosy: I‚Äôm from Kazakhstan. Goodbye!<br/>
            Tim: Goodbye!
          </div>
        </div>

        <div class="qRow" style="margin-top:10px">
          <label>1) Rosy is from Kazakhstan.</label>
          <select class="select" id="w4a1">
            <option value="">--choose--</option>
            <option>True</option><option>False</option>
          </select>
        </div>
        <div class="qRow">
          <label>2) Tim is nine.</label>
          <select class="select" id="w4a2">
            <option value="">--choose--</option>
            <option>True</option><option>False</option>
          </select>
        </div>

        <div class="resultLine">
          <button class="btn btnGreen" onclick="checkW4()">Check ‚úì</button>
          <div>Correct: <span id="w4score">0</span> / 2</div>
        </div>
      </div>

      <div class="resultLine" style="margin-top:10px">
        <div style="font-weight:1000">Lesson stars now: <span id="liveStars">0</span> ‚≠ê</div>
        <div class="tSmall">Stars counted from correct answers.</div>
      </div>

    </div>

    <div class="card">
      <div class="secTitle">üéµ Song Karaoke</div>
      <div class="karaBox">
        <div class="muted">Start/Stop and follow the highlighted line.</div>
        <div id="karaokeLines" style="margin-top:10px"></div>

        <div class="row" style="margin-top:12px">
          <button class="btn btnGreen" onclick="karaokeStart()">‚ñ∂ Start</button>
          <button class="btn" onclick="karaokeStop()">‚èπ Stop</button>
        </div>
      </div>
    </div>
  `;
}

function emptyLessonHTML(){
  return `
    <div class="card">
      <div class="h2">Coming next</div>
      <div class="muted" style="margin-top:8px">
        –ó–¥–µ—Å—å –±—É–¥—É—Ç —Ç–∞–∫–∏–µ –∂–µ –±–ª–æ–∫–∏: Visual Vocabulary (2 rows) ‚Üí Grammar Key ‚Üí Worksheets 1‚Äì4 ‚Üí Karaoke.
      </div>
    </div>
  `;
}

/* =========================
   CHECKS + STARS (Lesson 1)
========================= */
let lessonLiveStars = 0;
let karaokeTimer = null;
let karaokeIndex = 0;
const karaoke = [
  {t:"Hello, hello!", ms:1200},
  {t:"What‚Äôs your name?", ms:1400},
  {t:"My name‚Äôs ‚Ä¶", ms:1200},
  {t:"Goodbye, goodbye!", ms:1400}
];

function initKaraokeUI(){
  const box = document.getElementById("karaokeLines");
  if(!box) return;
  box.innerHTML = karaoke.map((l,i)=>`<div class="lyricLine" id="line${i}">${l.t}</div>`).join("");
}
function karaokeHighlight(i){
  karaoke.forEach((_,idx)=>{
    const el = document.getElementById("line"+idx);
    if(el) el.classList.toggle("active", idx===i);
  });
}
function karaokeStart(){
  karaokeStop();
  karaokeIndex = 0;
  karaokeHighlight(0);
  speak(karaoke[0].t);

  karaokeTimer = setInterval(()=>{
    karaokeIndex++;
    if(karaokeIndex >= karaoke.length){
      karaokeStop();
      return;
    }
    karaokeHighlight(karaokeIndex);
    speak(karaoke[karaokeIndex].t);
  }, 1500);
}
function karaokeStop(){
  if(karaokeTimer){ clearInterval(karaokeTimer); karaokeTimer=null; }
  karaokeHighlight(-1);
  try{ speechSynthesis.cancel(); }catch{}
}

function normalize(s){ return (s||"").trim().toLowerCase(); }

function markScore(elId, ok){
  const el = document.getElementById(elId);
  if(!el) return;
  el.textContent = ok ? "‚úì" : "‚úó";
  el.className = "mark " + (ok ? "ok" : "bad");
}

function updateLiveStars(){
  const live = document.getElementById("liveStars");
  if(live) live.textContent = lessonLiveStars;
  document.getElementById("lessonStars").textContent = lessonLiveStars;
}

function restoreLesson1(){
  const marks = loadMarks(1,1);
  lessonLiveStars = getLessonStars(1,1) || 0;
  updateLiveStars();

  if(!marks) return;

  // restore inputs
  ["w1a1","w1a2","w1a3","w1a4","w2a1","w2a2","w2a3","w3a1","w3a2","w3a3","w4a1","w4a2"].forEach(id=>{
    const el = document.getElementById(id);
    if(el && marks[id] !== undefined) el.value = marks[id];
  });

  // restore scores
  if(marks._w1score!==undefined) document.getElementById("w1score").textContent = marks._w1score;
  if(marks._w2score!==undefined) document.getElementById("w2score").textContent = marks._w2score;
  if(marks._w3score!==undefined) document.getElementById("w3score").textContent = marks._w3score;
  if(marks._w4score!==undefined) document.getElementById("w4score").textContent = marks._w4score;
}

function collectMarksLesson1(){
  const obj = {};
  ["w1a1","w1a2","w1a3","w1a4","w2a1","w2a2","w2a3","w3a1","w3a2","w3a3","w4a1","w4a2"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) obj[id] = el.value;
  });
  obj._w1score = Number(document.getElementById("w1score")?.textContent||0);
  obj._w2score = Number(document.getElementById("w2score")?.textContent||0);
  obj._w3score = Number(document.getElementById("w3score")?.textContent||0);
  obj._w4score = Number(document.getElementById("w4score")?.textContent||0);
  return obj;
}

function checkW1(){
  const a1 = normalize(document.getElementById("w1a1").value) === "hello";
  const a2 = normalize(document.getElementById("w1a2").value) === "goodbye";
  const a3 = normalize(document.getElementById("w1a3").value) === "thank you";
  const a4 = normalize(document.getElementById("w1a4").value) === "name";
  const score = [a1,a2,a3,a4].filter(Boolean).length;
  document.getElementById("w1score").textContent = score;

  recalcStars();
  saveMarks(1,1, collectMarksLesson1());
}

function checkW2(){
  const a1 = document.getElementById("w2a1").value === "hello";
  const a2 = document.getElementById("w2a2").value === "thank you";
  const a3 = document.getElementById("w2a3").value === "name";
  const score = [a1,a2,a3].filter(Boolean).length;
  document.getElementById("w2score").textContent = score;

  recalcStars();
  saveMarks(1,1, collectMarksLesson1());
}

function checkW3(){
  const a1 = document.getElementById("w3a1").value === "What‚Äôs";
  const a2 = document.getElementById("w3a2").value === "How";
  const a3 = document.getElementById("w3a3").value === "from";
  const score = [a1,a2,a3].filter(Boolean).length;
  document.getElementById("w3score").textContent = score;

  recalcStars();
  saveMarks(1,1, collectMarksLesson1());
}

function checkW4(){
  const a1 = document.getElementById("w4a1").value === "True";
  const a2 = document.getElementById("w4a2").value === "False";
  const score = [a1,a2].filter(Boolean).length;
  document.getElementById("w4score").textContent = score;

  recalcStars();
  saveMarks(1,1, collectMarksLesson1());
}

function recalcStars(){
  const w1 = Number(document.getElementById("w1score").textContent||0);
  const w2 = Number(document.getElementById("w2score").textContent||0);
  const w3 = Number(document.getElementById("w3score").textContent||0);
  const w4 = Number(document.getElementById("w4score").textContent||0);

  // Stars = sum of correct (max 4+3+3+2=12)
  lessonLiveStars = w1+w2+w3+w4;
  updateLiveStars();
}

function saveLessonStars(){
  // save stars for current lesson
  setLessonStars(state.unit, state.lesson, lessonLiveStars);
  saveMarks(state.unit, state.lesson, collectMarksLesson1());
  refreshAllBadges();
  alert("Saved ‚úÖ");
}

/* =========================
   PRINT
========================= */
function printLesson(){ window.print(); }

/* =========================
   RENDER SCREENS
========================= */
function refreshAllBadges(){
  const sess = getSession();
  const pill = document.getElementById("loginPill");
  const p = getAllProgress();

  if(sess.logged && sess.user){
    pill.className = "pill ok";
    pill.textContent = "Logged";
  }else{
    pill.className = "pill no";
    pill.textContent = "Not logged";
  }

  let total = 0;
  if(sess.logged && sess.user){
    total = totalStarsForStudent(p[sess.user]);
  }
  document.getElementById("totalStars").textContent = total;
  document.getElementById("achStars").textContent = total;

  // unit stars on main
  for(let u=1;u<=8;u++){
    const el = document.getElementById(`u${u}s`);
    if(!el) continue;
    el.textContent = (sess.logged && sess.user) ? unitStarsForStudent(p[sess.user],u) : 0;
  }
}

function refreshUnitScreen(){
  const sess = getSession();
  const sp = getStudentProgress();
  document.getElementById("unitTitle").textContent = `Unit ${state.unit}`;
  document.getElementById("who").textContent = sess.logged ? sess.user : "‚Äî";
  document.getElementById("unitStars").textContent = sp ? unitStarsForStudent(sp.me, state.unit) : 0;

  for(let l=1;l<=8;l++){
    document.getElementById("ls"+l).textContent = sp ? (sp.me.stars[state.unit][l]||0) : 0;
  }
}

function refreshLessonScreen(){
  const sess = getSession();
  document.getElementById("lessonTitle").textContent = `Unit ${state.unit} ‚Äî Lesson ${state.lesson}`;
  document.getElementById("who2").textContent = sess.logged ? sess.user : "‚Äî";

  // content
  const wrap = document.getElementById("lessonContent");
  if(state.unit===1 && state.lesson===1){
    wrap.innerHTML = lesson1HTML();
    initKaraokeUI();
    // load saved stars + marks
    restoreLesson1();
  }else{
    wrap.innerHTML = emptyLessonHTML();
    lessonLiveStars = getLessonStars(state.unit,state.lesson) || 0;
    document.getElementById("lessonStars").textContent = lessonLiveStars;
  }
}

function escapeQuotes(s){
  return String(s).replace(/'/g,"\\'").replace(/"/g,'\\"');
}

/* =========================
   INIT
========================= */
refreshAllBadges();
const sess = getSession();
if(sess.logged){
  // show who in unit/lesson later
}
</script>
</body>
</html>

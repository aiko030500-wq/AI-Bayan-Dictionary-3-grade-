<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AI Bayan Dictionary 3gr</title>
  <style>
    :root{
      --bg:#e8f5e9;
      --card:#ffffff;
      --text:#143a1f;
      --muted:#4b6b54;
      --green:#2e7d32;
      --green2:#43a047;
      --border:#a5d6a7;
      --shadow:0 8px 18px rgba(0,0,0,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Arial;background:var(--bg);color:var(--text)}
    header{
      position:sticky;top:0;z-index:5;
      background:linear-gradient(90deg,#d9f7dc,#f1fff2);
      border-bottom:2px solid var(--border);
      padding:10px 12px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
    }
    .brand{font-weight:800;letter-spacing:.2px}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#fff;border:1px solid var(--border)}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card);border:2px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:12px;
    }
    .title{font-size:18px;font-weight:800;margin:0 0 6px}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input, textarea, select{
      width:100%;padding:12px 12px;border-radius:14px;border:2px solid var(--border);
      outline:none;background:#fff;
      font-size:16px;
    }
    textarea{min-height:88px;resize:vertical}
    button{
      border:none;border-radius:14px;padding:10px 12px;
      background:var(--green2);color:#fff;font-weight:800;cursor:pointer;
      box-shadow:0 6px 14px rgba(67,160,71,.22);
    }
    button.secondary{background:#fff;color:var(--text);border:2px solid var(--border);box-shadow:none}
    button.danger{background:#d32f2f}
    button.full{width:100%}
    .divider{height:1px;background:rgba(0,0,0,.08);margin:10px 0}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      padding:7px 10px;border-radius:999px;border:2px solid var(--border);
      background:#fff;cursor:pointer;font-weight:700;font-size:13px;
    }
    .chip.active{background:#c8f6cc}
    .units{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:720px){.units{grid-template-columns:1fr}}
    .unitBtn{
      text-align:left;background:#fff;color:var(--text);
      border:2px solid var(--border);border-radius:var(--radius);
      padding:12px;box-shadow:var(--shadow);cursor:pointer;
    }
    .unitBtn strong{display:block;font-size:16px}
    .lessonList{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:720px){.lessonList{grid-template-columns:1fr}}
    .lessonBtn{
      background:#fff;color:var(--text);border:2px solid var(--border);
      border-radius:var(--radius);padding:12px;cursor:pointer;box-shadow:var(--shadow);
      text-align:left;
    }
    .stars{font-size:18px}
    .ok{color:#1b5e20;font-weight:800}
    .hidden{display:none !important}
    .printOnly{display:none}
    @media print{
      header,.noPrint{display:none !important}
      body{background:#fff}
      .wrap{max-width:100%;padding:0}
      .card{box-shadow:none;border:0;border-radius:0}
      .printOnly{display:block}
    }
  </style>
</head>
<body>

<header class="noPrint">
  <div class="brand">AI Bayan Dictionary 3gr</div>
  <div class="row" style="gap:8px">
    <span class="pill" id="whoPill">–ì–æ—Å—Ç—å</span>
    <button class="secondary" id="homeBtn">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
    <button class="secondary" id="logoutBtn">–í—ã–π—Ç–∏</button>
  </div>
</header>

<div class="wrap">

  <!-- LOGIN -->
  <section id="screenLogin" class="card">
    <h1 class="title">–í—Ö–æ–¥</h1>
    <div class="grid">
      <div>
        <div class="muted">–õ–æ–≥–∏–Ω</div>
        <input id="loginInput" autocomplete="off" />
      </div>
      <div>
        <div class="muted">PIN</div>
        <input id="pinInput" type="password" inputmode="numeric" />
      </div>
    </div>
    <div class="divider"></div>
    <button class="full" id="loginBtn">–í–æ–π—Ç–∏</button>
    <div class="muted" style="margin-top:8px">* –ï—Å–ª–∏ PIN —É—á–∏—Ç–µ–ª—è ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∂—É—Ä–Ω–∞–ª.</div>
  </section>

  <!-- MAIN MENU -->
  <section id="screenMain" class="hidden">
    <div class="card">
      <h2 class="title">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
      <div class="muted">–í—ã–±–µ—Ä–∏ —é–Ω–∏—Ç –∏–ª–∏ –æ—Ç–∫—Ä–æ–π —á–∞—Ç.</div>

      <div class="divider"></div>

      <!-- AI CHAT ONLY HERE -->
      <div class="card" style="border-width:2px">
        <div class="row" style="justify-content:space-between">
          <strong>üí¨ –ß–∞—Ç —Å –ò–ò</strong>
          <span class="pill">—Ç–æ–ª—å–∫–æ –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é</span>
        </div>
        <div class="muted" style="margin:6px 0 10px">–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å (–¥–µ–º–æ-—á–∞—Ç –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞).</div>
        <textarea id="chatInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Explain 'What‚Äôs this? It‚Äôs a pencil.'"></textarea>
        <div class="row" style="margin-top:8px">
          <button id="chatSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          <button class="secondary" id="chatClear">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div class="divider"></div>
        <div id="chatLog" class="muted" style="white-space:pre-wrap"></div>
      </div>

      <div class="divider"></div>

      <div class="units" id="unitGrid"></div>
    </div>
  </section>

  <!-- UNIT -->
  <section id="screenUnit" class="hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 class="title" id="unitTitle">Unit</h2>
          <div class="muted">–í–Ω—É—Ç—Ä–∏ 8 —Ç–µ–º (lessons).</div>
        </div>
        <button class="secondary" id="backToMain">‚Üê –ù–∞–∑–∞–¥</button>
      </div>
      <div class="divider"></div>
      <div class="lessonList" id="lessonList"></div>
    </div>
  </section>

  <!-- LESSON -->
  <section id="screenLesson" class="hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 class="title" id="lessonTitle">Lesson</h2>
          <div class="muted" id="lessonSubtitle"></div>
        </div>
        <div class="row">
          <button class="secondary" id="backToUnit">‚Üê –ö —é–Ω–∏—Ç—É</button>
          <button id="printLesson">üñ® Print</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="printOnly">
        <h2 id="printHeader" style="margin:0 0 8px">AI Bayan Dictionary 3gr</h2>
      </div>

      <div id="lessonBody"></div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted">–ó–≤—ë–∑–¥—ã –∑–∞ lesson:</div>
          <div class="stars" id="starView">‚òÜ‚òÜ‚òÜ</div>
        </div>
        <div class="row">
          <button class="secondary" id="starMinus">-</button>
          <button id="starPlus">+</button>
        </div>
      </div>

    </div>
  </section>

  <!-- TEACHER JOURNAL -->
  <section id="screenTeacher" class="hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 class="title">–ñ—É—Ä–Ω–∞–ª —É—á–∏—Ç–µ–ª—è</h2>
          <div class="muted">–õ–æ–≥–∏–Ω—ã, –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥, –∑–≤—ë–∑–¥—ã.</div>
        </div>
        <button class="secondary" id="teacherBack">‚Üê –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
      </div>
      <div class="divider"></div>
      <div id="teacherTable"></div>
      <div class="divider"></div>
      <button class="danger" id="resetAll">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å (–≤—Å–µ)</button>
    </div>
  </section>

</div>

<script>
/* ====== AUTH RULES ====== */
const STUDENT_PIN = "2844";
const TEACHER_PIN = "3244";
const STUDENTS = Array.from({length:15}, (_,i)=>`3EL${i+1}`); // 3EL1..3EL15

/* ====== CONTENT SKELETON (8 units √ó 8 lessons) ====== */
const UNITS = [
  { id:1, title:"Unit 1 ‚Äì Hello English!" },
  { id:2, title:"Unit 2 ‚Äì My school" },
  { id:3, title:"Unit 3 ‚Äì People I love" },
  { id:4, title:"Unit 4 ‚Äì Weather" },
  { id:5, title:"Unit 5 ‚Äì My free time" },
  { id:6, title:"Unit 6 ‚Äì Health" },
  { id:7, title:"Unit 7 ‚Äì Buildings!" },
  { id:8, title:"Unit 8 ‚Äì My holidays" },
];

const LESSONS_8 = [
  { id:1, name:"Topic 1 ‚Äì Vocabulary", type:"vocab" },
  { id:2, name:"Topic 2 ‚Äì Grammar", type:"grammar" },
  { id:3, name:"Topic 3 ‚Äì Worksheet 1 (Quiz)", type:"quiz" },
  { id:4, name:"Topic 4 ‚Äì Reading mini (T/F)", type:"reading" },
  { id:5, name:"Topic 5 ‚Äì Matching (Picture‚ÄìWord)", type:"match" },
  { id:6, name:"Topic 6 ‚Äì Choose / Fill", type:"choose" },
  { id:7, name:"Topic 7 ‚Äì Spelling (Missing letters)", type:"spelling" },
  { id:8, name:"Topic 8 ‚Äì Review", type:"review" },
];

/* ====== STATE ====== */
let currentUser = null; // {role:'student'|'teacher', login:'3EL1'|...}
let currentUnitId = null;
let currentLessonId = null;

/* ====== STORAGE HELPERS ====== */
const LS_KEY = "AIB3_DICT_DATA_v1";
function loadDB(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {users:{}}; }
  catch{ return {users:{}}; }
}
function saveDB(db){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }

function ensureUser(db, login){
  if(!db.users[login]){
    db.users[login] = {
      lastLogin: null,
      stars: {}, // key: "u{unit}l{lesson}" -> number 0..3
    };
  }
  return db.users[login];
}
function keyUL(unitId, lessonId){ return `u${unitId}l${lessonId}`; }

/* ====== UI HELPERS ====== */
const $ = (id)=>document.getElementById(id);
function show(screenId){
  ["screenLogin","screenMain","screenUnit","screenLesson","screenTeacher"].forEach(s=>{
    $(s).classList.toggle("hidden", s!==screenId);
  });
}
function setWho(){
  if(!currentUser){ $("whoPill").textContent="–ì–æ—Å—Ç—å"; return; }
  $("whoPill").textContent = currentUser.role==="teacher" ? "–£—á–∏—Ç–µ–ª—å" : currentUser.login;
}

/* ====== RENDER MAIN ====== */
function renderUnits(){
  const grid = $("unitGrid");
  grid.innerHTML = "";
  UNITS.forEach(u=>{
    const b = document.createElement("button");
    b.className = "unitBtn";
    b.innerHTML = `<strong>${u.title}</strong><span class="muted">8 —Ç–µ–º –≤–Ω—É—Ç—Ä–∏</span>`;
    b.onclick = ()=>openUnit(u.id);
    grid.appendChild(b);
  });
}

/* ====== UNIT ====== */
function openUnit(unitId){
  currentUnitId = unitId;
  const u = UNITS.find(x=>x.id===unitId);
  $("unitTitle").textContent = u ? u.title : `Unit ${unitId}`;
  renderLessons(unitId);
  show("screenUnit");
}
function renderLessons(unitId){
  const list = $("lessonList");
  list.innerHTML = "";
  LESSONS_8.forEach(ls=>{
    const btn = document.createElement("button");
    btn.className = "lessonBtn";
    const stars = getStars(unitId, ls.id);
    btn.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <div>
          <div style="font-weight:900">${ls.name}</div>
          <div class="muted">–û—Ç–∫—Ä—ã—Ç—å</div>
        </div>
        <div class="stars">${"‚òÖ".repeat(stars)}${"‚òÜ".repeat(3-stars)}</div>
      </div>
    `;
    btn.onclick = ()=>openLesson(unitId, ls.id);
    list.appendChild(btn);
  });
}

/* ====== LESSON CONTENT (placeholders) ====== */
function lessonContent(unitId, lessonId){
  const unit = UNITS.find(u=>u.id===unitId)?.title || `Unit ${unitId}`;
  const lesson = LESSONS_8.find(l=>l.id===lessonId)?.name || `Lesson ${lessonId}`;

  // –¢—É—Ç –¥–∞–ª—å—à–µ –º—ã –ø—Ä–æ—Å—Ç–æ –±—É–¥–µ–º –∑–∞–º–µ–Ω—è—Ç—å –Ω–∞ —Ç–≤–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ –∫–Ω–∏–≥–µ (—Å–ª–æ–≤–∞/–ø—Ä–∞–≤–∏–ª–∞/—É–ø—Ä).
  if(lessonId===1){
    return `
      <div class="card">
        <div class="muted">Vocabulary (–ø—Ä–∏–º–µ—Ä-–∑–∞–≥–ª—É—à–∫–∞)</div>
        <div class="divider"></div>
        <div class="grid">
          ${["word 1","word 2","word 3","word 4"].map(w=>`
            <div class="card" style="border-width:2px">
              <div style="font-weight:900">${w}</div>
              <div class="muted">–ø–µ—Ä–µ–≤–æ–¥</div>
              <button onclick="speak('${w.replace(/'/g,"")}')">üîä</button>
            </div>
          `).join("")}
        </div>
      </div>
    `;
  }
  if(lessonId===2){
    return `
      <div class="card">
        <div class="muted">Grammar (–ø—Ä–∏–º–µ—Ä-–∑–∞–≥–ª—É—à–∫–∞)</div>
        <div class="divider"></div>
        <div><b>Rule (EN):</b> What‚Äôs this? It‚Äôs a ...</div>
        <div><b>–ü—Ä–∞–≤–∏–ª–æ (RU):</b> –ß—Ç–æ —ç—Ç–æ? –≠—Ç–æ ...</div>
        <div class="divider"></div>
        <div><b>Formula:</b> What‚Äôs this? ‚Üí It‚Äôs a/an + noun</div>
        <div class="divider"></div>
        <div><b>Examples:</b></div>
        <ul>
          <li>What‚Äôs this? It‚Äôs a pencil.</li>
          <li>What‚Äôs this? It‚Äôs an apple.</li>
        </ul>
      </div>
    `;
  }
  if(lessonId===4){
    return `
      <div class="card">
        <div class="muted">Reading mini (2 True/False)</div>
        <div class="divider"></div>
        <div style="font-weight:900">Mini text:</div>
        <p>Hello! I‚Äôm Tom. I have a bag and a book. I‚Äôm at school.</p>
        <div class="divider"></div>
        <div style="font-weight:900">True / False</div>
        <label class="row"><input type="checkbox" data-tf="1"> Tom has a bag.</label>
        <label class="row"><input type="checkbox" data-tf="2"> Tom is at home.</label>
        <div class="divider"></div>
        <button onclick="checkTF()">Check</button>
        <div id="tfResult" class="muted" style="margin-top:8px"></div>
      </div>
    `;
  }
  return `
    <div class="card">
      <div class="muted">${unit} ‚Ä¢ ${lesson}</div>
      <div class="divider"></div>
      <div>–ö–æ–Ω—Ç–µ–Ω—Ç —ç—Ç–æ–≥–æ –ª–µ—Å—Å–æ–Ω–∞ —è –∑–∞–ø–æ–ª–Ω—é –ø–æ –∫–Ω–∏–≥–µ (–≤–æ–∫–∞–±/—É–ø—Ä/—Ä–∏–¥–∏–Ω–≥) ‚Äî —Ç—É—Ç –ø–æ–∫–∞ —à–∞–±–ª–æ–Ω.</div>
    </div>
  `;
}

/* ====== OPEN LESSON ====== */
function openLesson(unitId, lessonId){
  currentUnitId = unitId;
  currentLessonId = lessonId;
  const u = UNITS.find(x=>x.id===unitId);
  const l = LESSONS_8.find(x=>x.id===lessonId);
  $("lessonTitle").textContent = `${u?.title || "Unit"} ‚Äî ${l?.name || "Lesson"}`;
  $("lessonSubtitle").textContent = `Unit ${unitId} ‚Ä¢ Lesson ${lessonId}`;
  $("printHeader").textContent = `AI Bayan Dictionary 3gr ‚Äî Unit ${unitId} ‚Ä¢ Lesson ${lessonId}`;
  $("lessonBody").innerHTML = lessonContent(unitId, lessonId);
  updateStarView();
  show("screenLesson");
}

/* ====== STARS ====== */
function getStars(unitId, lessonId){
  if(!currentUser || currentUser.role!=="student") return 0;
  const db = loadDB();
  const u = ensureUser(db, currentUser.login);
  return Math.max(0, Math.min(3, u.stars[keyUL(unitId,lessonId)] || 0));
}
function setStars(unitId, lessonId, val){
  if(!currentUser || currentUser.role!=="student") return;
  const db = loadDB();
  const u = ensureUser(db, currentUser.login);
  u.stars[keyUL(unitId,lessonId)] = Math.max(0, Math.min(3, val));
  saveDB(db);
}
function updateStarView(){
  const s = getStars(currentUnitId, currentLessonId);
  $("starView").textContent = "‚òÖ".repeat(s) + "‚òÜ".repeat(3-s);
}

/* ====== SPEAK ====== */
function speak(text){
  try{
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = "en-US";
    speechSynthesis.speak(msg);
  }catch(e){}
}

/* ====== TF CHECK (demo) ====== */
function checkTF(){
  // Correct: 1=true, 2=false
  const c1 = document.querySelector('input[data-tf="1"]')?.checked;
  const c2 = document.querySelector('input[data-tf="2"]')?.checked;
  const ok = (c1===true && c2===false);
  const out = $("tfResult");
  if(out) out.innerHTML = ok ? "<span class='ok'>Correct ‚úÖ</span>" : "Try again ‚ùå";
}

/* ====== TEACHER JOURNAL ====== */
function renderTeacher(){
  const db = loadDB();
  const box = $("teacherTable");
  const rows = STUDENTS.map(login=>{
    const u = db.users[login] || {lastLogin:null, stars:{}};
    // sum stars
    let sum = 0;
    for(const k in (u.stars||{})) sum += (u.stars[k]||0);
    const last = u.lastLogin ? new Date(u.lastLogin).toLocaleString() : "‚Äî";
    return `
      <div class="card" style="border-width:2px;margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div style="font-weight:900">${login}</div>
          <div class="pill">‚≠ê ${sum}</div>
        </div>
        <div class="muted">Last login: ${last}</div>
      </div>
    `;
  }).join("");
  box.innerHTML = rows || "<div class='muted'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>";
}

/* ====== LOGIN ====== */
function doLogin(){
  const login = $("loginInput").value.trim();
  const pin = $("pinInput").value.trim();

  // teacher
  if(pin === TEACHER_PIN){
    currentUser = {role:"teacher", login:"TEACHER"};
    setWho();
    renderUnits();
    show("screenMain");
    // teacher can open journal by button in main? We'll show via Home then Journal button? We'll open teacher screen directly:
    show("screenTeacher");
    renderTeacher();
    return;
  }

  // student
  if(pin === STUDENT_PIN && STUDENTS.includes(login)){
    currentUser = {role:"student", login};
    const db = loadDB();
    const u = ensureUser(db, login);
    u.lastLogin = new Date().toISOString();
    saveDB(db);
    setWho();
    renderUnits();
    show("screenMain");
    return;
  }

  alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ PIN");
}

/* ====== CHAT (demo local) ====== */
function chatAdd(role, text){
  const log = $("chatLog");
  const stamp = new Date().toLocaleTimeString();
  log.textContent += `[${stamp}] ${role}: ${text}\n`;
  log.scrollTop = log.scrollHeight;
}
function chatSend(){
  const t = $("chatInput").value.trim();
  if(!t) return;
  chatAdd(currentUser?.role==="student" ? currentUser.login : "User", t);
  $("chatInput").value = "";
  // demo reply:
  chatAdd("AI Bayan", "I can help! (demo) Write: 'Give me 5 words for Unit 1' or 'Explain this grammar.'");
}

/* ====== NAV ====== */
$("loginBtn").onclick = doLogin;
$("logoutBtn").onclick = ()=>{
  currentUser = null;
  currentUnitId = null; currentLessonId=null;
  $("loginInput").value=""; $("pinInput").value="";
  setWho();
  show("screenLogin");
};
$("homeBtn").onclick = ()=>{
  if(!currentUser){ show("screenLogin"); return; }
  if(currentUser.role==="teacher"){ show("screenTeacher"); renderTeacher(); return; }
  show("screenMain");
};
$("backToMain").onclick = ()=>show("screenMain");
$("backToUnit").onclick = ()=>openUnit(currentUnitId);
$("printLesson").onclick = ()=>window.print();
$("starPlus").onclick = ()=>{
  const s = getStars(currentUnitId, currentLessonId);
  setStars(currentUnitId, currentLessonId, s+1);
  updateStarView();
};
$("starMinus").onclick = ()=>{
  const s = getStars(currentUnitId, currentLessonId);
  setStars(currentUnitId, currentLessonId, s-1);
  updateStarView();
};
$("teacherBack").onclick = ()=>{
  // teacher view is journal only; go back to login? or main? we keep journal as home for teacher
  show("screenTeacher");
  renderTeacher();
};
$("resetAll").onclick = ()=>{
  if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?")) return;
  const db = loadDB();
  STUDENTS.forEach(s=>{
    if(db.users[s]) db.users[s].stars = {};
  });
  saveDB(db);
  renderTeacher();
};

$("chatSend").onclick = chatSend;
$("chatClear").onclick = ()=>{ $("chatLog").textContent=""; };

/* ====== INIT ====== */
setWho();
show("screenLogin");
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI BAYAN • Visual Vocabulary • Grade 3</title>

  <style>
    :root{
      /* динамическая тема (меняется из JS) */
      --bg1:#0b6f78;
      --bg2:#0a5f67;
      --accent:#0b6f78;
      --accent2:#0a5f67;

      --gold:#f3c84b;
      --ink:#0a3c42;
      --paper:#ffffff;
      --soft:#eaf6f8;
      --good:#1aa06c;
      --bad:#d62828;

      --radius:22px;
      --shadow:0 12px 26px rgba(0,0,0,.16);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      color:#fff;
      min-height:100vh;
    }
    .app{max-width:860px;margin:0 auto;min-height:100vh;padding:16px 12px 30px}

    .hero{ text-align:center; padding:18px 10px 8px; }
    .logoWrap{
      width:120px;height:120px;border-radius:999px;
      margin:0 auto 10px;
      border:5px solid rgba(243,200,75,.95);
      background:#fff;
      box-shadow:0 10px 22px rgba(0,0,0,.20);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
    }
    .logoWrap img{width:100%;height:100%;object-fit:cover}
    .brandTitle{
      font-weight:1000;
      letter-spacing:.6px;
      color:var(--gold);
      text-transform:uppercase;
      font-size:28px;
      text-shadow:0 4px 12px rgba(0,0,0,.25);
      margin:0;
    }
    .brandSub{margin:6px 0 0;font-weight:900;opacity:.95}

    .panel{
      background:var(--paper);
      color:var(--ink);
      border-radius:26px;
      padding:14px;
      margin:14px auto 0;
      border:3px solid rgba(243,200,75,.70);
      box-shadow:var(--shadow);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{margin:10px 0}
    .label{font-weight:1000;color:#0a4a52;margin-bottom:6px}
    .input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:2px solid rgba(12,106,115,.25);
      outline:none;
      font-size:16px;
    }

    .btn{
      border:none;
      border-radius:16px;
      padding:12px 14px;
      font-weight:1000;
      cursor:pointer;
      box-shadow:0 10px 18px rgba(0,0,0,.10);
      user-select:none;
    }
    .btnPrimary{
      background:linear-gradient(180deg,var(--accent),var(--accent2));
      color:#fff;
    }
    .btnGhost{
      background:#fff;
      border:3px solid rgba(12,106,115,.35);
      color:#0a4a52;
    }
    .btnDanger{
      background:linear-gradient(180deg,#e04b4b,#b21f1f);
      color:#fff;
    }
    .btn:active{transform:scale(.99)}

    .helloCard{
      background:linear-gradient(180deg,#ffffff,#f4fbfc);
      border-radius:18px;
      padding:12px;
      text-align:center;
      border:2px solid rgba(12,106,115,.20);
      margin-bottom:12px;
    }
    .helloCard .big{font-size:20px;font-weight:1000;color:#0b4f56}
    .helloCard .small{font-weight:900;color:#355e64;margin-top:4px}

    .menuGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .menuBtn{
      border-radius:18px;
      padding:14px 12px;
      background:#fff;
      border:3px solid rgba(12,106,115,.35);
      color:#0a4a52;
      font-weight:1000;
      text-align:center;
      box-shadow:0 10px 18px rgba(0,0,0,.08);
    }
    .menuBtn small{display:block;font-weight:900;color:#3a6a70;margin-top:4px}
    .menuBtn:active{transform:scale(.99)}

    .bottomRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
    .miniBtn{
      min-width:200px;
      border-radius:16px;
      padding:12px 12px;
      background:#fff;
      border:3px solid rgba(12,106,115,.35);
      color:#0a4a52;
      font-weight:1000;
      text-align:center;
      box-shadow:0 10px 18px rgba(0,0,0,.08);
    }

    .lessonBanner{
      border-radius:22px;
      padding:14px 14px;
      color:#fff;
      border:3px solid rgba(243,200,75,.70);
      box-shadow:0 12px 22px rgba(0,0,0,.12);
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:12px;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
    }
    .lessonBanner .title{font-weight:1000;font-size:18px}
    .lessonBanner .sub{font-weight:900;opacity:.95;font-size:13px;margin-top:4px}
    .badge{
      background:rgba(255,255,255,.18);
      border:2px solid rgba(255,255,255,.22);
      padding:8px 12px;
      border-radius:999px;
      font-weight:1000;
      white-space:nowrap;
    }

    .sectionTitle{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      color:#fff;
      border-radius:16px;
      font-weight:1000;
      font-size:14px;
      margin:12px 0 10px;
    }

    .vocabGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .vCard{
      background:var(--soft);
      border-radius:18px;
      padding:10px;
      border:2px solid rgba(12,106,115,.18);
      text-align:center;
      position:relative;
    }
    .vCard img{
      width:100%;
      height:130px;
      object-fit:cover;
      border-radius:14px;
      border:2px solid rgba(0,0,0,.06);
      background:#fff;
    }
    .vWord{margin-top:8px;font-weight:1000;color:#0a4a52;font-size:18px}
    .vRu{margin-top:2px;font-weight:900;color:#3d6167}

    .wsBox{
      background:#fff;
      border-radius:18px;
      border:2px dashed rgba(0,0,0,.25);
      padding:12px;
      margin:12px 0;
    }
    .wsBox h4{margin:0 0 6px;font-size:16px;color:#0a4a52}
    .wsBox p{margin:0 0 10px;color:#4b666c;font-weight:800}

    .qRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
    .qRow .q{font-weight:1000;color:#0a4a52}
    .qRow input[type="text"], .qRow select{
      flex:1;min-width:200px;
      padding:10px 10px;
      border-radius:12px;
      border:2px solid rgba(12,106,115,.22);
      outline:none;
      background:#fff;
      font-weight:900;
      font-size:15px;
    }

    .matchGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .matchCard{
      background:var(--soft);
      border-radius:18px;
      padding:10px;
      border:3px solid transparent;
      position:relative;
    }
    .matchCard img{
      width:100%;
      height:140px;
      object-fit:cover;
      border-radius:14px;
      border:2px solid rgba(0,0,0,.06);
      background:#fff;
    }
    .matchCard.correct{border-color:rgba(26,160,108,.65)}
    .matchCard.wrong{border-color:rgba(214,40,40,.65)}

    .mark{
      position:absolute;
      top:10px;right:12px;
      font-size:24px;
      font-weight:1000;
    }
    .spark{
      position:absolute;
      top:48%;left:50%;
      transform:translate(-50%,-50%) scale(0);
      font-size:44px;
      animation:pop .6s ease forwards;
      pointer-events:none;
    }
    @keyframes pop{
      0%{transform:translate(-50%,-50%) scale(0)}
      60%{transform:translate(-50%,-50%) scale(1.3)}
      100%{transform:translate(-50%,-50%) scale(1)}
    }

    .okBorder{border-color:rgba(26,160,108,.65)!important;background:#f1fff7}
    .badBorder{border-color:rgba(214,40,40,.65)!important;background:#fff3f3}

    .navRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .navRow .btn{flex:1;min-width:180px}

    .chatBox{
      background:#f6fbfc;
      border:2px solid rgba(12,106,115,.18);
      border-radius:18px;
      padding:12px;
      min-height:220px;
      max-height:360px;
      overflow:auto;
    }
    .msgMe{font-weight:1000;color:#0a4a52;margin-top:10px}
    .msgAi{font-weight:900;color:#2f6168;margin-top:10px}

    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid rgba(0,0,0,.15);padding:8px;font-weight:900;font-size:13px;color:#0a4a52}
    th{background:#f0fbfc}

    .footline{
      margin-top:12px;
      text-align:center;
      font-size:12px;
      font-weight:1000;
      color:rgba(255,255,255,.92);
      padding-bottom:6px;
    }

    @media (max-width:520px){
      .menuGrid{grid-template-columns:1fr}
      .vocabGrid{grid-template-columns:1fr 1fr}
      .matchGrid{grid-template-columns:1fr}
      .miniBtn{min-width:160px}
    }

    @media print{
      body{background:#fff;color:#000}
      .btn,.miniBtn,.menuBtn,.bottomRow,.navRow,.footline{display:none!important}
      .panel{border:none;box-shadow:none}
      body::after{
        content:"AI BAYAN • 3 grade • 2025";
        position:fixed;
        top:40%;
        left:8%;
        font-size:42px;
        opacity:.12;
        transform:rotate(-28deg);
        color:#000;
        white-space:nowrap;
      }
    }
  </style>
</head>

<body>
  <div class="app" id="app"></div>

<script>
/* ===================== CONFIG ===================== */
const STUDENT_PIN = "2844";
const TEACHER_PIN = "3244";
const CLASS_PREFIX = "3EL";
const MAX_STUDENTS = 15;
const STORAGE_KEY = "AIB_G3_V1_DB";

/* ===================== THEMES ===================== */
const unitThemes = {
  1:{name:"Green", shades:["#E8F5E9","#C8E6C9","#A5D6A7","#81C784","#66BB6A","#4CAF50","#43A047","#2E7D32"]},
  2:{name:"Blue",  shades:["#E3F2FD","#BBDEFB","#90CAF9","#64B5F6","#42A5F5","#2196F3","#1E88E5","#1565C0"]},
  3:{name:"Pink",  shades:["#FCE4EC","#F8BBD0","#F48FB1","#F06292","#EC407A","#E91E63","#D81B60","#AD1457"]},
  4:{name:"Orange",shades:["#FFF3E0","#FFE0B2","#FFCC80","#FFB74D","#FFA726","#FB8C00","#F57C00","#E65100"]},
  5:{name:"Purple",shades:["#F3E5F5","#E1BEE7","#CE93D8","#BA68C8","#AB47BC","#9C27B0","#8E24AA","#6A1B9A"]},
  6:{name:"Teal",  shades:["#E0F2F1","#B2DFDB","#80CBC4","#4DB6AC","#26A69A","#009688","#00897B","#00695C"]},
  7:{name:"Red",   shades:["#FFEBEE","#FFCDD2","#EF9A9A","#E57373","#EF5350","#F44336","#E53935","#B71C1C"]},
  8:{name:"Gold",  shades:["#FFFDE7","#FFF9C4","#FFF59D","#FFF176","#FFEE58","#FDD835","#FBC02D","#F9A825"]}
};

function applyTheme(unitNum=null, lessonIndex=null){
  // страницы без юнита (логин/меню) — базовый бирюзовый
  if(!unitNum){
    document.documentElement.style.setProperty("--bg1","#0b6f78");
    document.documentElement.style.setProperty("--bg2","#0a5f67");
    document.documentElement.style.setProperty("--accent","#0d7a83");
    document.documentElement.style.setProperty("--accent2","#0b6168");
    return;
  }

  const shades = unitThemes[unitNum]?.shades || ["#0b6f78","#0a5f67","#15909b","#0b6f78","#0a5f67","#15909b","#0b6f78","#0a5f67"];
  // фон для всего экрана (чтобы низ не был “другого цвета”)
  const bgTop = shades[6] || shades[5] || shades[4];
  const bgBottom = shades[7] || shades[6] || shades[5];

  // цвет текущего урока (разные оттенки)
  const lessonShade = (lessonIndex!=null) ? (shades[lessonIndex] || shades[4]) : shades[5];
  const lessonShade2 = (lessonIndex!=null) ? (shades[Math.min(7, lessonIndex+2)] || shades[6]) : shades[7];

  document.documentElement.style.setProperty("--bg1", bgTop);
  document.documentElement.style.setProperty("--bg2", bgBottom);
  document.documentElement.style.setProperty("--accent", lessonShade);
  document.documentElement.style.setProperty("--accent2", lessonShade2);
}

/* ===================== DATA ===================== */
const UNIT1 = [
  { id:"u1l1", unit:1, lessonIndex:0, title:"Lesson 1", subtitle:"Hello!", vocabTopic:"Greetings",
    vocab:[
      {en:"hello", ru:"привет"},
      {en:"goodbye", ru:"пока"},
      {en:"how are you?", ru:"как дела?"},
      {en:"fine", ru:"хорошо"},
    ],
    grammar:{
      title:"Hello / Goodbye",
      rule:"We say hello when we meet. We say goodbye when we leave.",
      formula:"Hello! | Goodbye!",
      mcq:[
        {q:"You meet your friend. You say:", options:["Goodbye","Hello","Fine"], ans:"Hello"},
        {q:"You leave the class. You say:", options:["Hello","Goodbye","How are you?"], ans:"Goodbye"},
      ]
    },
    reading:{
      text:["Hello!","My name is Tom.","How are you?","I’m fine.","Goodbye!"],
      tf:[
        {q:"Tom says “Hello”.", ans:true},
        {q:"Tom says “Good morning”.", ans:false},
      ]
    },
    song:null
  },
  { id:"u1l2", unit:1, lessonIndex:1, title:"Lesson 2", subtitle:"My name is…", vocabTopic:"Names",
    vocab:[
      {en:"my name is…", ru:"меня зовут…"},
      {en:"what’s your name?", ru:"как тебя зовут?"},
      {en:"I’m…", ru:"я…"},
      {en:"this is…", ru:"это…"},
    ],
    grammar:{
      title:"What’s your name?",
      rule:'We ask: "What’s your name?" We answer: "My name is… / I’m…".',
      formula:"What’s your name? → I’m… / My name is…",
      mcq:[
        {q:"You ask a name:", options:["Goodbye","What’s your name?","I’m fine"], ans:"What’s your name?"},
        {q:"You answer:", options:["I’m Anna","What’s your name?","Hello"], ans:"I’m Anna"},
      ]
    },
    reading:{ text:["Hello!","My name is Anna.","This is Tom."], tf:[{q:"Her name is Anna.", ans:true},{q:"Tom is her teacher.", ans:false}] },
    song:null
  },
  { id:"u1l3", unit:1, lessonIndex:2, title:"Lesson 3", subtitle:"The alphabet", vocabTopic:"Alphabet A–D",
    vocab:[ {en:"A", ru:"эй"}, {en:"B", ru:"би"}, {en:"C", ru:"си"}, {en:"D", ru:"ди"} ],
    grammar:{
      title:"Spell with letters",
      rule:"We can spell words with letters.",
      formula:"A - B - C - D",
      mcq:[
        {q:"Apple starts with:", options:["B","A","D"], ans:"A"},
        {q:"Dog starts with:", options:["C","D","A"], ans:"D"},
      ]
    },
    reading:{ text:["A is for apple.","B is for ball.","C is for cat.","D is for dog."], tf:[{q:"B is for ball.", ans:true},{q:"C is for dog.", ans:false}] },
    song:null
  },
  { id:"u1l4", unit:1, lessonIndex:3, title:"Lesson 4", subtitle:"Numbers 1–10", vocabTopic:"Numbers",
    vocab:[ {en:"one", ru:"один"}, {en:"two", ru:"два"}, {en:"three", ru:"три"}, {en:"ten", ru:"десять"} ],
    grammar:{
      title:"I’m … (age)",
      rule:'We ask: "How old are you?" We answer: "I’m …".',
      formula:"How old are you? → I’m (ten).",
      mcq:[
        {q:"How old are you? — I’m ___", options:["blue","ten","hello"], ans:"ten"},
        {q:"Choose a number:", options:["goodbye","two","fine"], ans:"two"},
      ]
    },
    reading:{ text:["I am Ben.","I am nine."], tf:[{q:"Ben is nine.", ans:true},{q:"Ben is ten.", ans:false}] },
    song:null
  },
  { id:"u1l5", unit:1, lessonIndex:4, title:"Lesson 5", subtitle:"Numbers 11–20", vocabTopic:"Numbers 11–20",
    vocab:[ {en:"eleven", ru:"11"}, {en:"twelve", ru:"12"}, {en:"fifteen", ru:"15"}, {en:"twenty", ru:"20"} ],
    grammar:{
      title:"I’m … (age)",
      rule:"Use numbers to say your age.",
      formula:"I’m + number.",
      mcq:[ {q:"15 is:", options:["twelve","fifteen","twenty"], ans:"fifteen"}, {q:"20 is:", options:["twenty","eleven","three"], ans:"twenty"} ]
    },
    reading:{ text:["My name is Ann.","I’m twelve."], tf:[{q:"Ann is twelve.", ans:true},{q:"Ann is eleven.", ans:false}] },
    song:null
  },
  { id:"u1l6", unit:1, lessonIndex:5, title:"Lesson 6", subtitle:"Colours", vocabTopic:"Colours",
    vocab:[ {en:"red", ru:"красный"}, {en:"blue", ru:"синий"}, {en:"green", ru:"зелёный"}, {en:"yellow", ru:"жёлтый"} ],
    grammar:{
      title:"It is … (colour)",
      rule:'We say: "It is red." / "It is blue."',
      formula:"It is + colour.",
      mcq:[ {q:"The sky is ___", options:["blue","ten","hello"], ans:"blue"}, {q:"A banana is ___", options:["yellow","green","goodbye"], ans:"yellow"} ]
    },
    reading:{ text:["The ball is red."], tf:[{q:"The ball is red.", ans:true},{q:"The ball is blue.", ans:false}] },
    song:null
  },
  { id:"u1l7", unit:1, lessonIndex:6, title:"Lesson 7", subtitle:"Where are you from?", vocabTopic:"Countries",
    vocab:[ {en:"Kazakhstan", ru:"Казахстан"}, {en:"the UK", ru:"Великобритания"}, {en:"the USA", ru:"США"}, {en:"Russia", ru:"Россия"} ],
    grammar:{
      title:"Where are you from?",
      rule:'We ask: "Where are you from?" We answer: "I’m from …".',
      formula:"Where are you from? → I’m from …",
      mcq:[ {q:"I’m from ___", options:["Kazakhstan","blue","hello"], ans:"Kazakhstan"}, {q:"A country:", options:["the UK","fine","goodbye"], ans:"the UK"} ]
    },
    reading:{ text:["I’m Tom.","I’m from the UK."], tf:[{q:"Tom is from the UK.", ans:true},{q:"Tom is from Russia.", ans:false}] },
    song:null
  },
  { id:"u1l8", unit:1, lessonIndex:7, title:"Lesson 8", subtitle:"Project", vocabTopic:"About me",
    vocab:[ {en:"name", ru:"имя"}, {en:"age", ru:"возраст"}, {en:"country", ru:"страна"}, {en:"favourite colour", ru:"любимый цвет"} ],
    grammar:{
      title:"My poster",
      rule:"We can write simple sentences about us.",
      formula:"My name is… I’m… I’m from… My favourite colour is…",
      mcq:[ {q:"My favourite colour is ___", options:["blue","Kazakhstan","hello"], ans:"blue"}, {q:"My ___ is Tom.", options:["name","yellow","goodbye"], ans:"name"} ]
    },
    reading:{ text:["My name is Ali.","I’m nine.","I’m from Kazakhstan."], tf:[{q:"Ali is nine.", ans:true},{q:"Ali is from the UK.", ans:false}] },
    song:null
  }
];

  /* ===================== UNITS 2–8 (8 lessons each) ===================== */

const UNIT2 = [
  {
    id:"u2l1", unit:2, lessonIndex:0, title:"Lesson 1", subtitle:"School things", vocabTopic:"School",
    vocab:[{en:"book",ru:"книга"},{en:"pen",ru:"ручка"},{en:"pencil",ru:"карандаш"},{en:"bag",ru:"рюкзак"}],
    grammar:{title:"This is…",rule:'We say: "This is my book."',formula:"This is + noun.",mcq:[
      {q:"Choose the word: книга",options:["book","pen","pencil","bag"],ans:"book"},
      {q:"Choose the word: ручка",options:["book","pen","pencil","bag"],ans:"pen"},
    ]},
    reading:{text:["This is my bag.","It is blue."],tf:[
      {q:"The bag is blue.",ans:true},{q:"The bag is red.",ans:false}
    ]},
    song:null
  },
  {
    id:"u2l2", unit:2, lessonIndex:1, title:"Lesson 2", subtitle:"In the classroom", vocabTopic:"Classroom",
    vocab:[{en:"desk",ru:"парта"},{en:"chair",ru:"стул"},{en:"board",ru:"доска"},{en:"window",ru:"окно"}],
    grammar:{title:"There is…",rule:'We say: "There is a desk."',formula:"There is + a/an + noun.",mcq:[
      {q:"Choose the word: парта",options:["desk","chair","board","window"],ans:"desk"},
      {q:"Choose the word: стул",options:["desk","chair","board","window"],ans:"chair"},
    ]},
    reading:{text:["There is a desk.","There is a chair."],tf:[
      {q:"There is a desk.",ans:true},{q:"There is a bed.",ans:false}
    ]},
    song:null
  },
  {
    id:"u2l3", unit:2, lessonIndex:2, title:"Lesson 3", subtitle:"School people", vocabTopic:"People",
    vocab:[{en:"teacher",ru:"учитель"},{en:"student",ru:"ученик"},{en:"friend",ru:"друг"},{en:"class",ru:"класс"}],
    grammar:{title:"He/She is…",rule:'We say: "She is a teacher."',formula:"She/He is + a/an + noun.",mcq:[
      {q:"Choose the word: учитель",options:["teacher","student","friend","class"],ans:"teacher"},
      {q:"Choose the word: ученик",options:["teacher","student","friend","class"],ans:"student"},
    ]},
    reading:{text:["She is a teacher.","He is a student."],tf:[
      {q:"She is a teacher.",ans:true},{q:"He is a doctor.",ans:false}
    ]},
    song:null
  },
  {
    id:"u2l4", unit:2, lessonIndex:3, title:"Lesson 4", subtitle:"My timetable", vocabTopic:"Time",
    vocab:[{en:"Monday",ru:"понедельник"},{en:"Tuesday",ru:"вторник"},{en:"English",ru:"английский"},{en:"Maths",ru:"математика"}],
    grammar:{title:"I have…",rule:'We say: "I have English on Monday."',formula:"I have + subject.",mcq:[
      {q:"Choose the word: понедельник",options:["Monday","Tuesday","English","Maths"],ans:"Monday"},
      {q:"Choose the word: английский",options:["Monday","Tuesday","English","Maths"],ans:"English"},
    ]},
    reading:{text:["I have English.","I have Maths."],tf:[
      {q:"The text has English.",ans:true},{q:"The text has Sunday.",ans:false}
    ]},
    song:null
  },
  {
    id:"u2l5", unit:2, lessonIndex:4, title:"Lesson 5", subtitle:"School rules", vocabTopic:"Rules",
    vocab:[{en:"listen",ru:"слушать"},{en:"sit",ru:"сидеть"},{en:"stand",ru:"вставать"},{en:"write",ru:"писать"}],
    grammar:{title:"Let’s…",rule:'We say: "Let’s listen!"',formula:"Let’s + verb.",mcq:[
      {q:"Choose the word: слушать",options:["listen","sit","stand","write"],ans:"listen"},
      {q:"Choose the word: писать",options:["listen","sit","stand","write"],ans:"write"},
    ]},
    reading:{text:["Let’s listen.","Let’s write."],tf:[
      {q:"The text says “listen”.",ans:true},{q:"The text says “run”.",ans:false}
    ]},
    song:null
  },
  {
    id:"u2l6", unit:2, lessonIndex:5, title:"Lesson 6", subtitle:"My classroom", vocabTopic:"Classroom",
    vocab:[{en:"big",ru:"большой"},{en:"small",ru:"маленький"},{en:"clean",ru:"чистый"},{en:"new",ru:"новый"}],
    grammar:{title:"It is…",rule:'We say: "It is big."',formula:"It is + adjective.",mcq:[
      {q:"Choose the word: большой",options:["big","small","clean","new"],ans:"big"},
      {q:"Choose the word: чистый",options:["big","small","clean","new"],ans:"clean"},
    ]},
    reading:{text:["My classroom is big.","It is clean."],tf:[
      {q:"The classroom is big.",ans:true},{q:"The classroom is dirty.",ans:false}
    ]},
    song:null
  },
  {
    id:"u2l7", unit:2, lessonIndex:6, title:"Lesson 7", subtitle:"At break time", vocabTopic:"Break",
    vocab:[{en:"play",ru:"играть"},{en:"run",ru:"бегать"},{en:"jump",ru:"прыгать"},{en:"talk",ru:"говорить"}],
    grammar:{title:"I can…",rule:'We say: "I can run."',formula:"I can + verb.",mcq:[
      {q:"Choose the word: бегать",options:["play","run","jump","talk"],ans:"run"},
      {q:"Choose the word: говорить",options:["play","run","jump","talk"],ans:"talk"},
    ]},
    reading:{text:["I can play.","I can jump."],tf:[
      {q:"The text says “jump”.",ans:true},{q:"The text says “sleep”.",ans:false}
    ]},
    song:null
  },
  {
    id:"u2l8", unit:2, lessonIndex:7, title:"Lesson 8", subtitle:"School project", vocabTopic:"Project",
    vocab:[{en:"my school",ru:"моя школа"},{en:"my class",ru:"мой класс"},{en:"my teacher",ru:"мой учитель"},{en:"my friend",ru:"мой друг"}],
    grammar:{title:"My…",rule:'We say: "My school is nice."',formula:"My + noun + is + adjective.",mcq:[
      {q:"Choose the word: моя школа",options:["my school","my class","my teacher","my friend"],ans:"my school"},
      {q:"Choose the word: мой друг",options:["my school","my class","my teacher","my friend"],ans:"my friend"},
    ]},
    reading:{text:["My school is nice.","My class is big."],tf:[
      {q:"The school is nice.",ans:true},{q:"The class is small.",ans:false}
    ]},
    song:null
  },
];

const UNIT3 = [
  {
    id:"u3l1", unit:3, lessonIndex:0, title:"Lesson 1", subtitle:"My family", vocabTopic:"Family",
    vocab:[{en:"mother",ru:"мама"},{en:"father",ru:"папа"},{en:"sister",ru:"сестра"},{en:"brother",ru:"брат"}],
    grammar:{title:"This is…",rule:'We say: "This is my mother."',formula:"This is my + family word.",mcq:[
      {q:"Choose the word: мама",options:["mother","father","sister","brother"],ans:"mother"},
      {q:"Choose the word: папа",options:["mother","father","sister","brother"],ans:"father"},
    ]},
    reading:{text:["This is my mother.","This is my father."],tf:[
      {q:"The text has mother.",ans:true},{q:"The text has teacher.",ans:false}
    ]},
    song:null
  },
  {
    id:"u3l2", unit:3, lessonIndex:1, title:"Lesson 2", subtitle:"Grandparents", vocabTopic:"Family",
    vocab:[{en:"grandma",ru:"бабушка"},{en:"grandpa",ru:"дедушка"},{en:"family",ru:"семья"},{en:"love",ru:"любить"}],
    grammar:{title:"I love…",rule:'We say: "I love my grandma."',formula:"I love + noun.",mcq:[
      {q:"Choose the word: бабушка",options:["grandma","grandpa","family","love"],ans:"grandma"},
      {q:"Choose the word: семья",options:["grandma","grandpa","family","love"],ans:"family"},
    ]},
    reading:{text:["I love my family.","I love my grandma."],tf:[
      {q:"The text has family.",ans:true},{q:"The text has bus.",ans:false}
    ]},
    song:null
  },
  {
    id:"u3l3", unit:3, lessonIndex:2, title:"Lesson 3", subtitle:"Friends", vocabTopic:"Friends",
    vocab:[{en:"friend",ru:"друг"},{en:"happy",ru:"счастливый"},{en:"kind",ru:"добрый"},{en:"funny",ru:"весёлый"}],
    grammar:{title:"He/She is…",rule:'We say: "She is kind."',formula:"He/She is + adjective.",mcq:[
      {q:"Choose the word: друг",options:["friend","happy","kind","funny"],ans:"friend"},
      {q:"Choose the word: добрый",options:["friend","happy","kind","funny"],ans:"kind"},
    ]},
    reading:{text:["My friend is funny.","She is kind."],tf:[
      {q:"The friend is funny.",ans:true},{q:"The friend is sad.",ans:false}
    ]},
    song:null
  },
  {
    id:"u3l4", unit:3, lessonIndex:3, title:"Lesson 4", subtitle:"Pets", vocabTopic:"Pets",
    vocab:[{en:"cat",ru:"кот"},{en:"dog",ru:"собака"},{en:"fish",ru:"рыбка"},{en:"bird",ru:"птица"}],
    grammar:{title:"I have…",rule:'We say: "I have a cat."',formula:"I have a/an + pet.",mcq:[
      {q:"Choose the word: кот",options:["cat","dog","fish","bird"],ans:"cat"},
      {q:"Choose the word: собака",options:["cat","dog","fish","bird"],ans:"dog"},
    ]},
    reading:{text:["I have a dog.","I have a cat."],tf:[
      {q:"The text has dog.",ans:true},{q:"The text has tiger.",ans:false}
    ]},
    song:null
  },
  {
    id:"u3l5", unit:3, lessonIndex:4, title:"Lesson 5", subtitle:"Feelings", vocabTopic:"Feelings",
    vocab:[{en:"happy",ru:"счастливый"},{en:"sad",ru:"грустный"},{en:"tired",ru:"уставший"},{en:"fine",ru:"хорошо"}],
    grammar:{title:"How are you?",rule:'We answer: "I’m happy / I’m fine."',formula:"How are you? → I’m …",mcq:[
      {q:"Choose the word: грустный",options:["happy","sad","tired","fine"],ans:"sad"},
      {q:"Choose the word: уставший",options:["happy","sad","tired","fine"],ans:"tired"},
    ]},
    reading:{text:["How are you?","I’m fine."],tf:[
      {q:"The answer is fine.",ans:true},{q:"The answer is ten.",ans:false}
    ]},
    song:null
  },
  {
    id:"u3l6", unit:3, lessonIndex:5, title:"Lesson 6", subtitle:"My best friend", vocabTopic:"Friends",
    vocab:[{en:"name",ru:"имя"},{en:"age",ru:"возраст"},{en:"from",ru:"из"},{en:"like",ru:"любить"}],
    grammar:{title:"He/She likes…",rule:'We say: "She likes apples."',formula:"He/She likes + noun.",mcq:[
      {q:"Choose the word: имя",options:["name","age","from","like"],ans:"name"},
      {q:"Choose the word: любить",options:["name","age","from","like"],ans:"like"},
    ]},
    reading:{text:["My friend is Ali.","He likes games."],tf:[
      {q:"He likes games.",ans:true},{q:"He likes milk.",ans:false}
    ]},
    song:null
  },
  {
    id:"u3l7", unit:3, lessonIndex:6, title:"Lesson 7", subtitle:"Family activities", vocabTopic:"Activities",
    vocab:[{en:"eat",ru:"есть"},{en:"play",ru:"играть"},{en:"walk",ru:"гулять"},{en:"watch",ru:"смотреть"}],
    grammar:{title:"We…",rule:'We say: "We play."',formula:"We + verb.",mcq:[
      {q:"Choose the word: гулять",options:["eat","play","walk","watch"],ans:"walk"},
      {q:"Choose the word: смотреть",options:["eat","play","walk","watch"],ans:"watch"},
    ]},
    reading:{text:["We play.","We walk."],tf:[
      {q:"We walk.",ans:true},{q:"We fly.",ans:false}
    ]},
    song:null
  },
  {
    id:"u3l8", unit:3, lessonIndex:7, title:"Lesson 8", subtitle:"Project", vocabTopic:"Project",
    vocab:[{en:"my family",ru:"моя семья"},{en:"my pet",ru:"мой питомец"},{en:"my friend",ru:"мой друг"},{en:"I love…",ru:"я люблю…"}],
    grammar:{title:"Simple sentences",rule:"We can write about people we love.",formula:"I love… / This is…",mcq:[
      {q:"Choose the word: моя семья",options:["my family","my pet","my friend","I love…"],ans:"my family"},
      {q:"Choose the word: мой питомец",options:["my family","my pet","my friend","I love…"],ans:"my pet"},
    ]},
    reading:{text:["I love my family.","This is my pet."],tf:[
      {q:"The text has family.",ans:true},{q:"The text has hospital.",ans:false}
    ]},
    song:null
  },
];

const UNIT4 = [
  {
    id:"u4l1", unit:4, lessonIndex:0, title:"Lesson 1", subtitle:"Sunny day", vocabTopic:"Weather",
    vocab:[{en:"sunny",ru:"солнечно"},{en:"sun",ru:"солнце"},{en:"hot",ru:"жарко"},{en:"summer",ru:"лето"}],
    grammar:{title:"It is…",rule:'We say: "It is sunny."',formula:"It is + weather.",mcq:[
      {q:"Choose the word: солнечно",options:["sunny","sun","hot","summer"],ans:"sunny"},
      {q:"Choose the word: жарко",options:["sunny","sun","hot","summer"],ans:"hot"},
    ]},
    reading:{text:["It is sunny.","It is hot."],tf:[
      {q:"It is sunny.",ans:true},{q:"It is snowy.",ans:false}
    ]},
    song:null
  },
  {
    id:"u4l2", unit:4, lessonIndex:1, title:"Lesson 2", subtitle:"Rainy day", vocabTopic:"Weather",
    vocab:[{en:"rainy",ru:"дождливо"},{en:"rain",ru:"дождь"},{en:"wet",ru:"мокро"},{en:"umbrella",ru:"зонт"}],
    grammar:{title:"I have…",rule:'We say: "I have an umbrella."',formula:"I have a/an + noun.",mcq:[
      {q:"Choose the word: дождь",options:["rainy","rain","wet","umbrella"],ans:"rain"},
      {q:"Choose the word: зонт",options:["rainy","rain","wet","umbrella"],ans:"umbrella"},
    ]},
    reading:{text:["It is rainy.","I have an umbrella."],tf:[
      {q:"The text has umbrella.",ans:true},{q:"The text has pencil.",ans:false}
    ]},
    song:null
  },
  {
    id:"u4l3", unit:4, lessonIndex:2, title:"Lesson 3", subtitle:"Cloudy day", vocabTopic:"Weather",
    vocab:[{en:"cloudy",ru:"облачно"},{en:"cloud",ru:"облако"},{en:"cool",ru:"прохладно"},{en:"jacket",ru:"куртка"}],
    grammar:{title:"Wear…",rule:'We say: "Wear a jacket."',formula:"Wear + noun.",mcq:[
      {q:"Choose the word: облако",options:["cloudy","cloud","cool","jacket"],ans:"cloud"},
      {q:"Choose the word: куртка",options:["cloudy","cloud","cool","jacket"],ans:"jacket"},
    ]},
    reading:{text:["It is cloudy.","Wear a jacket."],tf:[
      {q:"It is cloudy.",ans:true},{q:"It is sunny.",ans:false}
    ]},
    song:null
  },
  {
    id:"u4l4", unit:4, lessonIndex:3, title:"Lesson 4", subtitle:"Windy day", vocabTopic:"Weather",
    vocab:[{en:"windy",ru:"ветрено"},{en:"wind",ru:"ветер"},{en:"kite",ru:"воздушный змей"},{en:"cold",ru:"холодно"}],
    grammar:{title:"I can…",rule:'We say: "I can fly a kite."',formula:"I can + verb.",mcq:[
      {q:"Choose the word: ветер",options:["windy","wind","kite","cold"],ans:"wind"},
      {q:"Choose the word: змей",options:["windy","wind","kite","cold"],ans:"kite"},
    ]},
    reading:{text:["It is windy.","I can fly a kite."],tf:[
      {q:"The text has kite.",ans:true},{q:"The text has fish.",ans:false}
    ]},
    song:null
  },
  {
    id:"u4l5", unit:4, lessonIndex:4, title:"Lesson 5", subtitle:"Snowy day", vocabTopic:"Weather",
    vocab:[{en:"snowy",ru:"снежно"},{en:"snow",ru:"снег"},{en:"winter",ru:"зима"},{en:"hat",ru:"шапка"}],
    grammar:{title:"Put on…",rule:'We say: "Put on a hat."',formula:"Put on + noun.",mcq:[
      {q:"Choose the word: снег",options:["snowy","snow","winter","hat"],ans:"snow"},
      {q:"Choose the word: шапка",options:["snowy","snow","winter","hat"],ans:"hat"},
    ]},
    reading:{text:["It is snowy.","Put on a hat."],tf:[
      {q:"It is snowy.",ans:true},{q:"It is hot.",ans:false}
    ]},
    song:null
  },
  {
    id:"u4l6", unit:4, lessonIndex:5, title:"Lesson 6", subtitle:"Seasons", vocabTopic:"Seasons",
    vocab:[{en:"spring",ru:"весна"},{en:"summer",ru:"лето"},{en:"autumn",ru:"осень"},{en:"winter",ru:"зима"}],
    grammar:{title:"My favourite…",rule:'We say: "My favourite season is summer."',formula:"My favourite season is …",mcq:[
      {q:"Choose the word: осень",options:["spring","summer","autumn","winter"],ans:"autumn"},
      {q:"Choose the word: зима",options:["spring","summer","autumn","winter"],ans:"winter"},
    ]},
    reading:{text:["My favourite season is summer."],tf:[
      {q:"Favourite season is summer.",ans:true},{q:"Favourite season is Monday.",ans:false}
    ]},
    song:null
  },
  {
    id:"u4l7", unit:4, lessonIndex:6, title:"Lesson 7", subtitle:"Clothes", vocabTopic:"Clothes",
    vocab:[{en:"coat",ru:"пальто"},{en:"boots",ru:"сапоги"},{en:"dress",ru:"платье"},{en:"T-shirt",ru:"футболка"}],
    grammar:{title:"I wear…",rule:'We say: "I wear boots."',formula:"I wear + clothes.",mcq:[
      {q:"Choose the word: сапоги",options:["coat","boots","dress","T-shirt"],ans:"boots"},
      {q:"Choose the word: футболка",options:["coat","boots","dress","T-shirt"],ans:"T-shirt"},
    ]},
    reading:{text:["I wear a coat.","I wear boots."],tf:[
      {q:"The text has boots.",ans:true},{q:"The text has chair.",ans:false}
    ]},
    song:null
  },
  {
    id:"u4l8", unit:4, lessonIndex:7, title:"Lesson 8", subtitle:"Weather project", vocabTopic:"Project",
    vocab:[{en:"today",ru:"сегодня"},{en:"weather",ru:"погода"},{en:"sunny",ru:"солнечно"},{en:"rainy",ru:"дождливо"}],
    grammar:{title:"Today is…",rule:'We say: "Today is sunny."',formula:"Today is + weather.",mcq:[
      {q:"Choose the word: сегодня",options:["today","weather","sunny","rainy"],ans:"today"},
      {q:"Choose the word: погода",options:["today","weather","sunny","rainy"],ans:"weather"},
    ]},
    reading:{text:["Today is sunny.","It is warm."],tf:[
      {q:"Today is sunny.",ans:true},{q:"Today is snowy.",ans:false}
    ]},
    song:null
  },
];

const UNIT5 = [
  {
    id:"u5l1", unit:5, lessonIndex:0, title:"Lesson 1", subtitle:"Hobbies", vocabTopic:"Hobbies",
    vocab:[{en:"play",ru:"играть"},{en:"draw",ru:"рисовать"},{en:"read",ru:"читать"},{en:"sing",ru:"петь"}],
    grammar:{title:"I like…",rule:'We say: "I like to read."',formula:"I like to + verb.",mcq:[
      {q:"Choose the word: читать",options:["play","draw","read","sing"],ans:"read"},
      {q:"Choose the word: петь",options:["play","draw","read","sing"],ans:"sing"},
    ]},
    reading:{text:["I like to read.","I like to draw."],tf:[
      {q:"The text has read.",ans:true},{q:"The text has fly.",ans:false}
    ]},
    song:null
  },
  {
    id:"u5l2", unit:5, lessonIndex:1, title:"Lesson 2", subtitle:"Sports", vocabTopic:"Sports",
    vocab:[{en:"football",ru:"футбол"},{en:"run",ru:"бегать"},{en:"jump",ru:"прыгать"},{en:"swim",ru:"плавать"}],
    grammar:{title:"I can…",rule:'We say: "I can swim."',formula:"I can + verb.",mcq:[
      {q:"Choose the word: плавать",options:["football","run","jump","swim"],ans:"swim"},
      {q:"Choose the word: бегать",options:["football","run","jump","swim"],ans:"run"},
    ]},
    reading:{text:["I can run.","I can swim."],tf:[
      {q:"The text has swim.",ans:true},{q:"The text has sleep.",ans:false}
    ]},
    song:null
  },
  {
    id:"u5l3", unit:5, lessonIndex:2, title:"Lesson 3", subtitle:"Toys", vocabTopic:"Toys",
    vocab:[{en:"ball",ru:"мяч"},{en:"doll",ru:"кукла"},{en:"car",ru:"машинка"},{en:"kite",ru:"змей"}],
    grammar:{title:"This is…",rule:'We say: "This is a ball."',formula:"This is a/an + toy.",mcq:[
      {q:"Choose the word: мяч",options:["ball","doll","car","kite"],ans:"ball"},
      {q:"Choose the word: кукла",options:["ball","doll","car","kite"],ans:"doll"},
    ]},
    reading:{text:["This is a ball.","This is a doll."],tf:[
      {q:"The text has ball.",ans:true},{q:"The text has umbrella.",ans:false}
    ]},
    song:null
  },
  {
    id:"u5l4", unit:5, lessonIndex:3, title:"Lesson 4", subtitle:"Music", vocabTopic:"Music",
    vocab:[{en:"music",ru:"музыка"},{en:"song",ru:"песня"},{en:"dance",ru:"танцевать"},{en:"happy",ru:"счастливый"}],
    grammar:{title:"Let’s…",rule:'We say: "Let’s dance!"',formula:"Let’s + verb.",mcq:[
      {q:"Choose the word: танцевать",options:["music","song","dance","happy"],ans:"dance"},
      {q:"Choose the word: песня",options:["music","song","dance","happy"],ans:"song"},
    ]},
    reading:{text:["Let’s dance!","It is a song."],tf:[
      {q:"The text says dance.",ans:true},{q:"The text says winter.",ans:false}
    ]},
    song:null
  },
  {
    id:"u5l5", unit:5, lessonIndex:4, title:"Lesson 5", subtitle:"At the park", vocabTopic:"Park",
    vocab:[{en:"park",ru:"парк"},{en:"tree",ru:"дерево"},{en:"bench",ru:"скамейка"},{en:"playground",ru:"площадка"}],
    grammar:{title:"There is…",rule:'We say: "There is a tree."',formula:"There is a/an + noun.",mcq:[
      {q:"Choose the word: дерево",options:["park","tree","bench","playground"],ans:"tree"},
      {q:"Choose the word: парк",options:["park","tree","bench","playground"],ans:"park"},
    ]},
    reading:{text:["There is a tree.","There is a bench."],tf:[
      {q:"There is a tree.",ans:true},{q:"There is a train.",ans:false}
    ]},
    song:null
  },
  {
    id:"u5l6", unit:5, lessonIndex:5, title:"Lesson 6", subtitle:"Weekend", vocabTopic:"Weekend",
    vocab:[{en:"Saturday",ru:"суббота"},{en:"Sunday",ru:"воскресенье"},{en:"fun",ru:"весело"},{en:"rest",ru:"отдых"}],
    grammar:{title:"On Saturday…",rule:'We say: "On Saturday I play."',formula:"On + day + I + verb.",mcq:[
      {q:"Choose the word: воскресенье",options:["Saturday","Sunday","fun","rest"],ans:"Sunday"},
      {q:"Choose the word: отдых",options:["Saturday","Sunday","fun","rest"],ans:"rest"},
    ]},
    reading:{text:["On Sunday I rest."],tf:[
      {q:"The text has Sunday.",ans:true},{q:"The text has Tuesday.",ans:false}
    ]},
    song:null
  },
  {
    id:"u5l7", unit:5, lessonIndex:6, title:"Lesson 7", subtitle:"My favourite", vocabTopic:"Favourite",
    vocab:[{en:"favourite",ru:"любимый"},{en:"game",ru:"игра"},{en:"book",ru:"книга"},{en:"sport",ru:"спорт"}],
    grammar:{title:"My favourite…",rule:'We say: "My favourite game is football."',formula:"My favourite + noun + is …",mcq:[
      {q:"Choose the word: любимый",options:["favourite","game","book","sport"],ans:"favourite"},
      {q:"Choose the word: спорт",options:["favourite","game","book","sport"],ans:"sport"},
    ]},
    reading:{text:["My favourite book is a comic."],tf:[
      {q:"The text has favourite.",ans:true},{q:"The text has hospital.",ans:false}
    ]},
    song:null
  },
  {
    id:"u5l8", unit:5, lessonIndex:7, title:"Lesson 8", subtitle:"Project", vocabTopic:"Project",
    vocab:[{en:"I like…",ru:"мне нравится…"}, {en:"I can…",ru:"я умею…"}, {en:"play",ru:"играть"}, {en:"read",ru:"читать"}],
    grammar:{title:"About me",rule:"We can write about free time.",formula:"I like… / I can…",mcq:[
      {q:"Choose the word: мне нравится…",options:["I like…","I can…","play","read"],ans:"I like…"},
      {q:"Choose the word: я умею…",options:["I like…","I can…","play","read"],ans:"I can…"},
    ]},
    reading:{text:["I like to read.","I can play football."],tf:[
      {q:"The text has read.",ans:true},{q:"The text has snow.",ans:false}
    ]},
    song:null
  },
];

const UNIT6 = [
  {
    id:"u6l1", unit:6, lessonIndex:0, title:"Lesson 1", subtitle:"Body", vocabTopic:"Body",
    vocab:[{en:"head",ru:"голова"},{en:"hand",ru:"рука"},{en:"leg",ru:"нога"},{en:"eye",ru:"глаз"}],
    grammar:{title:"My…",rule:'We say: "My head hurts."',formula:"My + body part + hurts.",mcq:[
      {q:"Choose the word: голова",options:["head","hand","leg","eye"],ans:"head"},
      {q:"Choose the word: нога",options:["head","hand","leg","eye"],ans:"leg"},
    ]},
    reading:{text:["My leg hurts."],tf:[
      {q:"The text has leg.",ans:true},{q:"The text has desk.",ans:false}
    ]},
    song:null
  },
  {
    id:"u6l2", unit:6, lessonIndex:1, title:"Lesson 2", subtitle:"Healthy food", vocabTopic:"Food",
    vocab:[{en:"apple",ru:"яблоко"},{en:"milk",ru:"молоко"},{en:"water",ru:"вода"},{en:"bread",ru:"хлеб"}],
    grammar:{title:"I eat/drink",rule:'We say: "I drink water."',formula:"I eat… / I drink…",mcq:[
      {q:"Choose the word: вода",options:["apple","milk","water","bread"],ans:"water"},
      {q:"Choose the word: молоко",options:["apple","milk","water","bread"],ans:"milk"},
    ]},
    reading:{text:["I drink water.","I eat an apple."],tf:[
      {q:"The text has water.",ans:true},{q:"The text has umbrella.",ans:false}
    ]},
    song:null
  },
  {
    id:"u6l3", unit:6, lessonIndex:2, title:"Lesson 3", subtitle:"Doctor", vocabTopic:"Health",
    vocab:[{en:"doctor",ru:"врач"},{en:"hospital",ru:"больница"},{en:"medicine",ru:"лекарство"},{en:"help",ru:"помощь"}],
    grammar:{title:"Go to…",rule:'We say: "Go to the doctor."',formula:"Go to + person/place.",mcq:[
      {q:"Choose the word: врач",options:["doctor","hospital","medicine","help"],ans:"doctor"},
      {q:"Choose the word: больница",options:["doctor","hospital","medicine","help"],ans:"hospital"},
    ]},
    reading:{text:["Go to the doctor.","He can help."],tf:[
      {q:"The text has doctor.",ans:true},{q:"The text has kite.",ans:false}
    ]},
    song:null
  },
  {
    id:"u6l4", unit:6, lessonIndex:3, title:"Lesson 4", subtitle:"Feelings", vocabTopic:"Feelings",
    vocab:[{en:"tired",ru:"уставший"},{en:"sad",ru:"грустный"},{en:"happy",ru:"счастливый"},{en:"fine",ru:"хорошо"}],
    grammar:{title:"I’m …",rule:'We say: "I’m tired."',formula:"I’m + adjective.",mcq:[
      {q:"Choose the word: уставший",options:["tired","sad","happy","fine"],ans:"tired"},
      {q:"Choose the word: хорошо",options:["tired","sad","happy","fine"],ans:"fine"},
    ]},
    reading:{text:["I’m fine.","I’m happy."],tf:[
      {q:"The text has fine.",ans:true},{q:"The text has ten.",ans:false}
    ]},
    song:null
  },
  {
    id:"u6l5", unit:6, lessonIndex:4, title:"Lesson 5", subtitle:"Sports & health", vocabTopic:"Sports",
    vocab:[{en:"run",ru:"бегать"},{en:"swim",ru:"плавать"},{en:"jump",ru:"прыгать"},{en:"strong",ru:"сильный"}],
    grammar:{title:"Healthy",rule:"Sport is good for health.",formula:"I run / I swim.",mcq:[
      {q:"Choose the word: плавать",options:["run","swim","jump","strong"],ans:"swim"},
      {q:"Choose the word: сильный",options:["run","swim","jump","strong"],ans:"strong"},
    ]},
    reading:{text:["I run.","I am strong."],tf:[
      {q:"The text has run.",ans:true},{q:"The text has winter.",ans:false}
    ]},
    song:null
  },
  {
    id:"u6l6", unit:6, lessonIndex:5, title:"Lesson 6", subtitle:"Clean", vocabTopic:"Hygiene",
    vocab:[{en:"wash",ru:"мыть"},{en:"soap",ru:"мыло"},{en:"teeth",ru:"зубы"},{en:"clean",ru:"чистый"}],
    grammar:{title:"I wash…",rule:'We say: "I wash my hands."',formula:"I wash my …",mcq:[
      {q:"Choose the word: мыть",options:["wash","soap","teeth","clean"],ans:"wash"},
      {q:"Choose the word: мыло",options:["wash","soap","teeth","clean"],ans:"soap"},
    ]},
    reading:{text:["I wash my hands.","I clean my teeth."],tf:[
      {q:"The text has wash.",ans:true},{q:"The text has bus.",ans:false}
    ]},
    song:null
  },
  {
    id:"u6l7", unit:6, lessonIndex:6, title:"Lesson 7", subtitle:"Clothes", vocabTopic:"Clothes",
    vocab:[{en:"hat",ru:"шапка"},{en:"coat",ru:"пальто"},{en:"boots",ru:"сапоги"},{en:"T-shirt",ru:"футболка"}],
    grammar:{title:"Put on…",rule:'We say: "Put on a coat."',formula:"Put on + clothes.",mcq:[
      {q:"Choose the word: пальто",options:["hat","coat","boots","T-shirt"],ans:"coat"},
      {q:"Choose the word: сапоги",options:["hat","coat","boots","T-shirt"],ans:"boots"},
    ]},
    reading:{text:["Put on a coat.","It is cold."],tf:[
      {q:"The text has coat.",ans:true},{q:"The text has sunny.",ans:false}
    ]},
    song:null
  },
  {
    id:"u6l8", unit:6, lessonIndex:7, title:"Lesson 8", subtitle:"Project", vocabTopic:"Project",
    vocab:[{en:"healthy",ru:"здоровый"},{en:"water",ru:"вода"},{en:"sport",ru:"спорт"},{en:"doctor",ru:"врач"}],
    grammar:{title:"Healthy day",rule:"We can write about health.",formula:"I drink… I play…",mcq:[
      {q:"Choose the word: вода",options:["healthy","water","sport","doctor"],ans:"water"},
      {q:"Choose the word: врач",options:["healthy","water","sport","doctor"],ans:"doctor"},
    ]},
    reading:{text:["I drink water.","I play sport."],tf:[
      {q:"The text has water.",ans:true},{q:"The text has chair.",ans:false}
    ]},
    song:null
  },
];

const UNIT7 = [
  {
    id:"u7l1", unit:7, lessonIndex:0, title:"Lesson 1", subtitle:"My house", vocabTopic:"Home",
    vocab:[{en:"house",ru:"дом"},{en:"room",ru:"комната"},{en:"bed",ru:"кровать"},{en:"door",ru:"дверь"}],
    grammar:{title:"This is…",rule:'We say: "This is my house."',formula:"This is my + noun.",mcq:[
      {q:"Choose the word: дом",options:["house","room","bed","door"],ans:"house"},
      {q:"Choose the word: дверь",options:["house","room","bed","door"],ans:"door"},
    ]},
    reading:{text:["This is my room.","This is my bed."],tf:[
      {q:"The text has room.",ans:true},{q:"The text has plane.",ans:false}
    ]},
    song:null
  },
  {
    id:"u7l2", unit:7, lessonIndex:1, title:"Lesson 2", subtitle:"My city", vocabTopic:"City",
    vocab:[{en:"city",ru:"город"},{en:"street",ru:"улица"},{en:"road",ru:"дорога"},{en:"bridge",ru:"мост"}],
    grammar:{title:"On the…",rule:'We say: "On the street…"',formula:"On the + noun…",mcq:[
      {q:"Choose the word: улица",options:["city","street","road","bridge"],ans:"street"},
      {q:"Choose the word: мост",options:["city","street","road","bridge"],ans:"bridge"},
    ]},
    reading:{text:["On the street there is a shop."],tf:[
      {q:"The text has street.",ans:true},{q:"The text has snow.",ans:false}
    ]},
    song:null
  },
  {
    id:"u7l3", unit:7, lessonIndex:2, title:"Lesson 3", subtitle:"Places", vocabTopic:"Places",
    vocab:[{en:"school",ru:"школа"},{en:"shop",ru:"магазин"},{en:"park",ru:"парк"},{en:"hospital",ru:"больница"}],
    grammar:{title:"There is…",rule:'We say: "There is a park."',formula:"There is a/an + place.",mcq:[
      {q:"Choose the word: парк",options:["school","shop","park","hospital"],ans:"park"},
      {q:"Choose the word: магазин",options:["school","shop","park","hospital"],ans:"shop"},
    ]},
    reading:{text:["There is a school.","There is a park."],tf:[
      {q:"There is a park.",ans:true},{q:"There is a zoo.",ans:false}
    ]},
    song:null
  },
  {
    id:"u7l4", unit:7, lessonIndex:3, title:"Lesson 4", subtitle:"In the shop", vocabTopic:"Shop",
    vocab:[{en:"buy",ru:"покупать"},{en:"money",ru:"деньги"},{en:"food",ru:"еда"},{en:"toy",ru:"игрушка"}],
    grammar:{title:"I want…",rule:'We say: "I want a toy."',formula:"I want + noun.",mcq:[
      {q:"Choose the word: игрушка",options:["buy","money","food","toy"],ans:"toy"},
      {q:"Choose the word: деньги",options:["buy","money","food","toy"],ans:"money"},
    ]},
    reading:{text:["I want food.","I want a toy."],tf:[
      {q:"The text has toy.",ans:true},{q:"The text has winter.",ans:false}
    ]},
    song:null
  },
  {
    id:"u7l5", unit:7, lessonIndex:4, title:"Lesson 5", subtitle:"Transport", vocabTopic:"Transport",
    vocab:[{en:"bus",ru:"автобус"},{en:"car",ru:"машина"},{en:"train",ru:"поезд"},{en:"plane",ru:"самолёт"}],
    grammar:{title:"I go by…",rule:'We say: "I go by bus."',formula:"I go by + transport.",mcq:[
      {q:"Choose the word: поезд",options:["bus","car","train","plane"],ans:"train"},
      {q:"Choose the word: самолёт",options:["bus","car","train","plane"],ans:"plane"},
    ]},
    reading:{text:["I go by bus.","I go by car."],tf:[
      {q:"The text has bus.",ans:true},{q:"The text has fish.",ans:false}
    ]},
    song:null
  },
  {
    id:"u7l6", unit:7, lessonIndex:5, title:"Lesson 6", subtitle:"My room", vocabTopic:"Home",
    vocab:[{en:"table",ru:"стол"},{en:"chair",ru:"стул"},{en:"window",ru:"окно"},{en:"lamp",ru:"лампа"}],
    grammar:{title:"There is…",rule:'We say: "There is a table."',formula:"There is a/an + thing.",mcq:[
      {q:"Choose the word: лампа",options:["table","chair","window","lamp"],ans:"lamp"},
      {q:"Choose the word: стул",options:["table","chair","window","lamp"],ans:"chair"},
    ]},
    reading:{text:["There is a chair.","There is a lamp."],tf:[
      {q:"There is a lamp.",ans:true},{q:"There is a kite.",ans:false}
    ]},
    song:null
  },
  {
    id:"u7l7", unit:7, lessonIndex:6, title:"Lesson 7", subtitle:"Big or small", vocabTopic:"Adjectives",
    vocab:[{en:"big",ru:"большой"},{en:"small",ru:"маленький"},{en:"tall",ru:"высокий"},{en:"new",ru:"новый"}],
    grammar:{title:"It is…",rule:'We say: "It is big."',formula:"It is + adjective.",mcq:[
      {q:"Choose the word: высокий",options:["big","small","tall","new"],ans:"tall"},
      {q:"Choose the word: новый",options:["big","small","tall","new"],ans:"new"},
    ]},
    reading:{text:["The building is tall.","The house is new."],tf:[
      {q:"The building is tall.",ans:true},{q:"The house is old.",ans:false}
    ]},
    song:null
  },
  {
    id:"u7l8", unit:7, lessonIndex:7, title:"Lesson 8", subtitle:"Building project", vocabTopic:"Project",
    vocab:[{en:"my street",ru:"моя улица"},{en:"my house",ru:"мой дом"},{en:"my school",ru:"моя школа"},{en:"my city",ru:"мой город"}],
    grammar:{title:"My…",rule:"We can write about places.",formula:"My … is …",mcq:[
      {q:"Choose the word: моя улица",options:["my street","my house","my school","my city"],ans:"my street"},
      {q:"Choose the word: мой город",options:["my street","my house","my school","my city"],ans:"my city"},
    ]},
    reading:{text:["My city is big.","My school is nice."],tf:[
      {q:"My city is big.",ans:true},{q:"My school is small.",ans:false}
    ]},
    song:null
  },
];

const UNIT8 = [
  {
    id:"u8l1", unit:8, lessonIndex:0, title:"Lesson 1", subtitle:"Holiday time", vocabTopic:"Holidays",
    vocab:[{en:"holiday",ru:"каникулы"},{en:"travel",ru:"путешествовать"},{en:"fun",ru:"весело"},{en:"photo",ru:"фото"}],
    grammar:{title:"I like…",rule:'We say: "I like my holidays."',formula:"I like + noun.",mcq:[
      {q:"Choose the word: каникулы",options:["holiday","travel","fun","photo"],ans:"holiday"},
      {q:"Choose the word: фото",options:["holiday","travel","fun","photo"],ans:"photo"},
    ]},
    reading:{text:["I like my holiday.","It is fun!"],tf:[
      {q:"Holiday is fun.",ans:true},{q:"Holiday is rainy.",ans:false}
    ]},
    song:null
  },
  {
    id:"u8l2", unit:8, lessonIndex:1, title:"Lesson 2", subtitle:"At the beach", vocabTopic:"Beach",
    vocab:[{en:"beach",ru:"пляж"},{en:"sea",ru:"море"},{en:"sand",ru:"песок"},{en:"swim",ru:"плавать"}],
    grammar:{title:"I can…",rule:'We say: "I can swim."',formula:"I can + verb.",mcq:[
      {q:"Choose the word: море",options:["beach","sea","sand","swim"],ans:"sea"},
      {q:"Choose the word: песок",options:["beach","sea","sand","swim"],ans:"sand"},
    ]},
    reading:{text:["I swim in the sea.","The sand is hot."],tf:[
      {q:"The text has sea.",ans:true},{q:"The text has snow.",ans:false}
    ]},
    song:null
  },
  {
    id:"u8l3", unit:8, lessonIndex:2, title:"Lesson 3", subtitle:"In the mountains", vocabTopic:"Mountains",
    vocab:[{en:"mountain",ru:"горы"},{en:"lake",ru:"озеро"},{en:"tree",ru:"дерево"},{en:"hike",ru:"поход"}],
    grammar:{title:"Let’s…",rule:'We say: "Let’s hike!"',formula:"Let’s + verb.",mcq:[
      {q:"Choose the word: озеро",options:["mountain","lake","tree","hike"],ans:"lake"},
      {q:"Choose the word: поход",options:["mountain","lake","tree","hike"],ans:"hike"},
    ]},
    reading:{text:["Let’s hike!","We see a lake."],tf:[
      {q:"The text has lake.",ans:true},{q:"The text has bus.",ans:false}
    ]},
    song:null
  },
  {
    id:"u8l4", unit:8, lessonIndex:3, title:"Lesson 4", subtitle:"Travel", vocabTopic:"Travel",
    vocab:[{en:"ticket",ru:"билет"},{en:"bag",ru:"сумка"},{en:"train",ru:"поезд"},{en:"hotel",ru:"отель"}],
    grammar:{title:"I have…",rule:'We say: "I have a ticket."',formula:"I have a/an + noun.",mcq:[
      {q:"Choose the word: билет",options:["ticket","bag","train","hotel"],ans:"ticket"},
      {q:"Choose the word: поезд",options:["ticket","bag","train","hotel"],ans:"train"},
    ]},
    reading:{text:["I have a ticket.","I go by train."],tf:[
      {q:"The text has ticket.",ans:true},{q:"The text has umbrella.",ans:false}
    ]},
    song:null
  },
  {
    id:"u8l5", unit:8, lessonIndex:4, title:"Lesson 5", subtitle:"Food on holiday", vocabTopic:"Food",
    vocab:[{en:"ice cream",ru:"мороженое"},{en:"juice",ru:"сок"},{en:"cake",ru:"торт"},{en:"water",ru:"вода"}],
    grammar:{title:"I eat/drink",rule:'We say: "I eat ice cream."',formula:"I eat… / I drink…",mcq:[
      {q:"Choose the word: сок",options:["ice cream","juice","cake","water"],ans:"juice"},
      {q:"Choose the word: вода",options:["ice cream","juice","cake","water"],ans:"water"},
    ]},
    reading:{text:["I eat ice cream.","I drink juice."],tf:[
      {q:"The text has ice cream.",ans:true},{q:"The text has doctor.",ans:false}
    ]},
    song:null
  },
  {
    id:"u8l6", unit:8, lessonIndex:5, title:"Lesson 6", subtitle:"Souvenirs", vocabTopic:"Souvenirs",
    vocab:[{en:"gift",ru:"подарок"},{en:"toy",ru:"игрушка"},{en:"magnet",ru:"магнит"},{en:"shop",ru:"магазин"}],
    grammar:{title:"I buy…",rule:'We say: "I buy a gift."',formula:"I buy + noun.",mcq:[
      {q:"Choose the word: подарок",options:["gift","toy","magnet","shop"],ans:"gift"},
      {q:"Choose the word: магнит",options:["gift","toy","magnet","shop"],ans:"magnet"},
    ]},
    reading:{text:["I buy a gift.","I buy a magnet."],tf:[
      {q:"The text has gift.",ans:true},{q:"The text has winter.",ans:false}
    ]},
    song:null
  },
  {
    id:"u8l7", unit:8, lessonIndex:6, title:"Lesson 7", subtitle:"Family trip", vocabTopic:"Family",
    vocab:[{en:"family",ru:"семья"},{en:"car",ru:"машина"},{en:"map",ru:"карта"},{en:"happy",ru:"счастливый"}],
    grammar:{title:"We…",rule:'We say: "We travel."',formula:"We + verb.",mcq:[
      {q:"Choose the word: семья",options:["family","car","map","happy"],ans:"family"},
      {q:"Choose the word: карта",options:["family","car","map","happy"],ans:"map"},
    ]},
    reading:{text:["We travel by car.","We are happy."],tf:[
      {q:"They travel by car.",ans:true},{q:"They travel by plane.",ans:false}
    ]},
    song:null
  },
  {
    id:"u8l8", unit:8, lessonIndex:7, title:"Lesson 8", subtitle:"Holiday project", vocabTopic:"Project",
    vocab:[{en:"my holiday",ru:"мои каникулы"},{en:"place",ru:"место"},{en:"I went…",ru:"я ездил…"},{en:"I liked…",ru:"мне понравилось…"}],
    grammar:{title:"Past simple (easy)",rule:"We can say: I went to … / I liked …",formula:"I went to … / I liked …",mcq:[
      {q:"Choose the word: место",options:["my holiday","place","I went…","I liked…"],ans:"place"},
      {q:"Choose the word: мне понравилось…",options:["my holiday","place","I went…","I liked…"],ans:"I liked…"},
    ]},
    reading:{text:["I went to the beach.","I liked the sea."],tf:[
      {q:"I went to the beach.",ans:true},{q:"I went to the hospital.",ans:false}
    ]},
    song:null
  },
];

/* ===================== FINAL UNITS LIST ===================== */
/* ВАЖНО: UNIT1 должен быть выше (у тебя уже есть). Тут добавляем 2–8. */
const UNITS = [
  {unit:1, title:"Unit 1 — Hello English!", lessons: UNIT1},
  {unit:2, title:"Unit 2 — My school", lessons: UNIT2},
  {unit:3, title:"Unit 3 — People I love", lessons: UNIT3},
  {unit:4, title:"Unit 4 — Weather", lessons: UNIT4},
  {unit:5, title:"Unit 5 — My free time", lessons: UNIT5},
  {unit:6, title:"Unit 6 — Health", lessons: UNIT6},
  {unit:7, title:"Unit 7 — Buildings", lessons: UNIT7},
  {unit:8, title:"Unit 8 — My holidays", lessons: UNIT8},
];

/* ===================== DB ===================== */
function loadDB(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) return JSON.parse(raw);
  }catch(e){}
  return { user:null, stars:{}, done:{}, chatLast:{}, logs:[] };
}
let db = loadDB();
function saveDB(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

function nowStr(){ return new Date().toLocaleString(); }
function todayKey(){ return new Date().toDateString(); }

function totalStarsFor(login){
  const m = db.stars[login] || {};
  return Object.values(m).reduce((a,b)=>a+(+b||0),0);
}
function lessonStars(login, lessonId){
  return (db.stars[login] && db.stars[login][lessonId]) ? db.stars[login][lessonId] : 0;
}
function isDone(login, lessonId){
  return !!(db.done[login] && db.done[login][lessonId]);
}
function setDone(login, lessonId){
  db.done[login] = db.done[login] || {};
  db.done[login][lessonId] = true;
}
function addStars(login, lessonId, delta){
  db.stars[login] = db.stars[login] || {};
  db.stars[login][lessonId] = (db.stars[login][lessonId] || 0) + delta;
}

/* ===================== CARTOON IMAGES (OFFLINE SVG) ===================== */
function escapeXml(s){ return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

function pickIconType(word){
  const w = (word||"").toLowerCase();

  if(w.includes("sun")) return "sun";
  if(w.includes("rain")) return "rain";
  if(w.includes("cloud")) return "cloud";
  if(w.includes("wind")) return "wind";
  if(w.includes("snow")) return "snow";

  if(w.includes("school")) return "school";
  if(w.includes("teacher")) return "teacher";
  if(w.includes("book")) return "book";
  if(w.includes("pen")) return "pen";
  if(w.includes("pencil")) return "pencil";
  if(w.includes("bag")) return "bag";

  if(w.includes("house") || w.includes("home")) return "house";
  if(w.includes("park")) return "park";
  if(w.includes("library")) return "library";

  if(w.includes("doctor")) return "doctor";
  if(w.includes("hospital")) return "hospital";
  if(w.includes("medicine")) return "medicine";

  if(w.includes("plane")) return "plane";
  if(w.includes("train")) return "train";
  if(w.includes("bus")) return "bus";
  if(w.includes("car")) return "car";

  if(w.includes("football")) return "football";
  if(w.includes("music")) return "music";

  if(w==="red") return "color_red";
  if(w==="blue") return "color_blue";
  if(w==="green") return "color_green";
  if(w==="yellow") return "color_yellow";
  if(w==="pink") return "color_pink";
  if(w==="purple") return "color_purple";
  if(w==="orange") return "color_orange";
  if(w==="black") return "color_black";
  if(w==="white") return "color_white";

  const numMap = {one:"1",two:"2",three:"3",four:"4",five:"5",six:"6",seven:"7",eight:"8",nine:"9",ten:"10",
    eleven:"11",twelve:"12",thirteen:"13",fourteen:"14",fifteen:"15",sixteen:"16",seventeen:"17",eighteen:"18",nineteen:"19",twenty:"20"};
  if(numMap[w]) return "num_"+numMap[w];

  if(w.length===1 && /[a-z]/i.test(w)) return "letter_"+w.toUpperCase();

  if(w.includes("kazakhstan")) return "flag_kz";
  if(w.includes("uk")) return "flag_uk";
  if(w.includes("usa")) return "flag_usa";
  if(w.includes("russia")) return "flag_ru";

  return "generic";
}

function svgCartoonDataUri({title, accent="#2E7D32", soft="#E8F5E9", type="generic"}){
  const safe = String(title||"").replace("?","").slice(0,22);
  const A = accent, S = soft;

  const cloud = `
    <path d="M95 185c-5-48 64-70 90-30 30-26 78-4 72 33 34 6 38 54 0 60H115c-22-2-30-30-20-63z"
          fill="#FFFFFF" stroke="${A}" stroke-width="8" stroke-linejoin="round"/>`;

  const artMap = {
    sun: `
      <circle cx="150" cy="140" r="52" fill="#FFD54F" stroke="${A}" stroke-width="8"/>
      ${Array.from({length:10}).map((_,i)=>{
        const ang = (i*36)*Math.PI/180;
        const x1 = 150 + Math.cos(ang)*70, y1 = 140 + Math.sin(ang)*70;
        const x2 = 150 + Math.cos(ang)*92, y2 = 140 + Math.sin(ang)*92;
        return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${A}" stroke-width="8" stroke-linecap="round"/>`;
      }).join("")}
    `,
    cloud,
    rain: cloud + `${[130,165,200,235].map(x=>`
      <path d="M${x} 255c0 22-18 40-18 40s-18-18-18-40 18-40 18-40 18 18 18 40z"
        fill="#4FC3F7" stroke="${A}" stroke-width="6" />`).join("")}`,
    wind: `
      <path d="M90 160c60 0 60-40 20-40" fill="none" stroke="${A}" stroke-width="10" stroke-linecap="round"/>
      <path d="M90 200c90 0 90-52 32-52" fill="none" stroke="${A}" stroke-width="10" stroke-linecap="round"/>
      <path d="M90 240c70 0 70-36 26-36" fill="none" stroke="${A}" stroke-width="10" stroke-linecap="round"/>`,
    snow: cloud + `${[140,180,220].map(x=>`
      <g transform="translate(${x},270)">
        <line x1="-18" y1="0" x2="18" y2="0" stroke="#90CAF9" stroke-width="8" stroke-linecap="round"/>
        <line x1="0" y1="-18" x2="0" y2="18" stroke="#90CAF9" stroke-width="8" stroke-linecap="round"/>
        <line x1="-12" y1="-12" x2="12" y2="12" stroke="#90CAF9" stroke-width="8" stroke-linecap="round"/>
        <line x1="-12" y1="12" x2="12" y2="-12" stroke="#90CAF9" stroke-width="8" stroke-linecap="round"/>
      </g>`).join("")}`,
    book: `
      <rect x="95" y="105" rx="20" ry="20" width="190" height="190" fill="#FFFFFF" stroke="${A}" stroke-width="10"/>
      <rect x="115" y="125" rx="16" ry="16" width="70" height="150" fill="${S}" stroke="${A}" stroke-width="8"/>
      <rect x="195" y="125" rx="16" ry="16" width="70" height="150" fill="${S}" stroke="${A}" stroke-width="8"/>
      <line x1="190" y1="125" x2="190" y2="275" stroke="${A}" stroke-width="8"/>`,
    pen: `
      <rect x="150" y="90" width="70" height="230" rx="30" fill="#BBDEFB" stroke="${A}" stroke-width="10"/>
      <polygon points="150,290 220,290 185,340" fill="#90CAF9" stroke="${A}" stroke-width="10"/>
      <circle cx="185" cy="125" r="10" fill="${A}"/>`,
    pencil: `
      <path d="M120 250 L250 120 L290 160 L160 290 Z" fill="#FFCC80" stroke="${A}" stroke-width="10" />
      <path d="M250 120 L270 100 L310 140 L290 160 Z" fill="#FFE0B2" stroke="${A}" stroke-width="10"/>
      <path d="M120 250 L105 305 L160 290 Z" fill="#D7CCC8" stroke="${A}" stroke-width="10"/>`,
    bag: `
      <rect x="110" y="140" width="200" height="190" rx="30" fill="#FFE082" stroke="${A}" stroke-width="10"/>
      <path d="M155 145c0-55 110-55 110 0" fill="none" stroke="${A}" stroke-width="10" stroke-linecap="round"/>
      <rect x="145" y="200" width="130" height="90" rx="18" fill="#FFF3E0" stroke="${A}" stroke-width="8"/>`,
    house: `
      <polygon points="100,200 210,110 320,200" fill="#FFCCBC" stroke="${A}" stroke-width="10" />
      <rect x="125" y="200" width="170" height="140" rx="18" fill="#FFF" stroke="${A}" stroke-width="10"/>
      <rect x="195" y="250" width="40" height="90" rx="10" fill="${S}" stroke="${A}" stroke-width="8"/>
      <rect x="145" y="240" width="40" height="40" rx="10" fill="${S}" stroke="${A}" stroke-width="8"/>`,
    school: `
      <rect x="120" y="150" width="220" height="170" rx="20" fill="#FFFFFF" stroke="${A}" stroke-width="10"/>
      <polygon points="110,150 230,85 350,150" fill="#BBDEFB" stroke="${A}" stroke-width="10"/>
      <rect x="215" y="235" width="50" height="85" rx="12" fill="${S}" stroke="${A}" stroke-width="8"/>
      <rect x="150" y="190" width="45" height="45" rx="10" fill="${S}" stroke="${A}" stroke-width="8"/>
      <rect x="285" y="190" width="45" height="45" rx="10" fill="${S}" stroke="${A}" stroke-width="8"/>`,
    football: `
      <circle cx="205" cy="215" r="95" fill="#FFFFFF" stroke="${A}" stroke-width="10"/>
      <polygon points="205,165 175,190 187,225 223,225 235,190" fill="#263238" />`,
    music: `
      <path d="M250 120v150c0 35-70 45-85 10-10-25 10-55 45-55 15 0 28 3 40 8V140l-110 25v125c0 35-70 45-85 10-10-25 10-55 45-55 15 0 28 3 40 8V145c0-10 7-18 16-20l134-30c12-3 20 6 20 25z"
            fill="#E1BEE7" stroke="${A}" stroke-width="10" stroke-linejoin="round"/>`,
    doctor: `
      <circle cx="200" cy="155" r="55" fill="#FFE0B2" stroke="${A}" stroke-width="10"/>
      <rect x="125" y="210" width="150" height="140" rx="30" fill="#FFFFFF" stroke="${A}" stroke-width="10"/>
      <rect x="165" y="110" width="70" height="26" rx="13" fill="#FFCDD2" stroke="${A}" stroke-width="8"/>`,
    hospital: `
      <rect x="120" y="130" width="220" height="210" rx="24" fill="#FFFFFF" stroke="${A}" stroke-width="10"/>
      <rect x="210" y="160" width="40" height="140" rx="12" fill="#FFCDD2" stroke="${A}" stroke-width="10"/>
      <rect x="160" y="210" width="140" height="40" rx="12" fill="#FFCDD2" stroke="${A}" stroke-width="10"/>`,
    medicine: `
      <rect x="140" y="120" width="130" height="220" rx="50" fill="#FFFFFF" stroke="${A}" stroke-width="10"/>
      <path d="M140 230h130v60c0 28-22 50-50 50h-30c-28 0-50-22-50-50z" fill="#C5E1A5" stroke="${A}" stroke-width="10"/>
      <line x1="140" y1="230" x2="270" y2="230" stroke="${A}" stroke-width="10"/>`,
    plane: `
      <path d="M90 220l120-30 40-90 30 0-15 100 85 40 0 25-85-10 15 85-30 0-40-80-120-20z"
            fill="#BBDEFB" stroke="${A}" stroke-width="10" stroke-linejoin="round"/>`,
    train: `
      <rect x="120" y="120" width="220" height="190" rx="30" fill="#CFD8DC" stroke="${A}" stroke-width="10"/>
      <rect x="145" y="150" width="170" height="70" rx="16" fill="#E3F2FD" stroke="${A}" stroke-width="8"/>`,
    bus: `
      <rect x="110" y="140" width="240" height="160" rx="30" fill="#FFE082" stroke="${A}" stroke-width="10"/>
      <rect x="135" y="165" width="190" height="70" rx="16" fill="#E3F2FD" stroke="${A}" stroke-width="8"/>`,
    car: `
      <path d="M120 260l35-75c8-18 22-28 42-28h82c20 0 34 10 42 28l35 75v40H120z"
            fill="#FFCCBC" stroke="${A}" stroke-width="10" stroke-linejoin="round"/>`,
    park: `
      <rect x="110" y="290" width="240" height="60" rx="20" fill="#C8E6C9" stroke="${A}" stroke-width="10"/>
      <circle cx="185" cy="185" r="60" fill="#A5D6A7" stroke="${A}" stroke-width="10"/>`,
    library: `
      <rect x="120" y="120" width="220" height="220" rx="26" fill="#FFFFFF" stroke="${A}" stroke-width="10"/>
      <rect x="150" y="150" width="24" height="170" rx="10" fill="#BBDEFB" stroke="${A}" stroke-width="6"/>
      <rect x="190" y="150" width="24" height="170" rx="10" fill="#FFE082" stroke="${A}" stroke-width="6"/>
      <rect x="230" y="150" width="24" height="170" rx="10" fill="#E1BEE7" stroke="${A}" stroke-width="6"/>
      <rect x="270" y="150" width="24" height="170" rx="10" fill="#C8E6C9" stroke="${A}" stroke-width="6"/>`
  };

  const colorBlock = (col)=>`
    <rect x="125" y="125" width="210" height="210" rx="40" fill="${col}" stroke="${A}" stroke-width="10"/>
    <circle cx="205" cy="200" r="55" fill="#ffffff55"/>`;

  const letterBlock = (ch)=>`
    <rect x="125" y="125" width="210" height="210" rx="40" fill="${S}" stroke="${A}" stroke-width="10"/>
    <text x="230" y="260" text-anchor="middle" font-size="140" font-weight="1000"
          font-family="system-ui,Segoe UI,Arial" fill="${A}">${escapeXml(ch)}</text>`;

  const numBlock = (n)=>`
    <rect x="125" y="125" width="210" height="210" rx="40" fill="#FFF3E0" stroke="${A}" stroke-width="10"/>
    <text x="230" y="260" text-anchor="middle" font-size="120" font-weight="1000"
          font-family="system-ui,Segoe UI,Arial" fill="${A}">${escapeXml(n)}</text>`;

  const flag = (c1,c2,c3)=>`
    <rect x="125" y="145" width="210" height="170" rx="26" fill="#fff" stroke="${A}" stroke-width="10"/>
    <rect x="135" y="155" width="190" height="50" rx="16" fill="${c1}"/>
    <rect x="135" y="210" width="190" height="50" rx="16" fill="${c2}"/>
    <rect x="135" y="265" width="190" height="40" rx="16" fill="${c3}"/>`;

  let art = artMap[type] || artMap.generic || `
    <circle cx="230" cy="170" r="72" fill="${S}" stroke="${A}" stroke-width="10"/>
    <text x="230" y="195" text-anchor="middle" font-size="62" font-weight="900"
          font-family="system-ui,Segoe UI,Arial" fill="${A}">${escapeXml(safe[0] ? safe[0].toUpperCase() : "A")}</text>`;

  if(type==="color_red") art = colorBlock("#F44336");
  if(type==="color_blue") art = colorBlock("#2196F3");
  if(type==="color_green") art = colorBlock("#4CAF50");
  if(type==="color_yellow") art = colorBlock("#FDD835");
  if(type==="color_pink") art = colorBlock("#EC407A");
  if(type==="color_purple") art = colorBlock("#8E24AA");
  if(type==="color_orange") art = colorBlock("#FB8C00");
  if(type==="color_black") art = colorBlock("#263238");
  if(type==="color_white") art = colorBlock("#FFFFFF");

  if(type.startsWith("letter_")) art = letterBlock(type.split("_")[1]);
  if(type.startsWith("num_")) art = numBlock(type.split("_")[1]);

  if(type==="flag_kz") art = flag("#00A3DD","#00A3DD","#FFD54F");
  if(type==="flag_uk") art = flag("#1E88E5","#FFFFFF","#E53935");
  if(type==="flag_usa") art = flag("#E53935","#FFFFFF","#1E88E5");
  if(type==="flag_ru") art = flag("#FFFFFF","#1E88E5","#E53935");

  const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="900" height="600">
  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#ffffff"/>
      <stop offset="1" stop-color="${S}"/>
    </linearGradient>
  </defs>
  <rect width="100%" height="100%" rx="44" fill="url(#bg)"/>
  <circle cx="760" cy="90" r="70" fill="${A}22"/>
  <circle cx="820" cy="160" r="90" fill="${A}18"/>
  <g>${art}</g>
  <rect x="60" y="430" width="780" height="120" rx="28" fill="#ffffffcc" stroke="${A}55" stroke-width="10"/>
  <text x="450" y="510" text-anchor="middle" font-size="64" font-weight="1000"
        font-family="system-ui,Segoe UI,Arial" fill="${A}">${escapeXml(safe)}</text>
</svg>`;
  return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg);
}

function cartoonImageByWord(en, unitNum, lessonIndex){
  const shades = unitThemes[unitNum]?.shades || ["#2E7D32"];
  const accent = shades[lessonIndex] || shades[6] || "#2E7D32";
  const soft = shades[0] || "#E8F5E9";
  const type = pickIconType(en);
  return svgCartoonDataUri({title: en, accent, soft, type});
}

/* ===================== ROUTER ===================== */
const app = document.getElementById("app");
let route = {page:"auth"};

function go(page, params={}){
  route = {page, ...params};
  render();
}

function render(){
  if(route.page==="auth") return renderAuth();
  if(!db.user) return renderAuth();
  if(route.page==="menu") return renderMenu();
  if(route.page==="unit") return renderUnit(route.unit);
  if(route.page==="lesson") return renderLesson(route.unit, route.lessonId);
  if(route.page==="chat") return renderChat();
  if(route.page==="journal") return renderJournal();
  renderMenu();
}

/* ===================== AUTH ===================== */
function validStudentLogin(login){
  const s = (login||"").trim().toUpperCase();
  return /^3EL([1-9]|1[0-5])$/.test(s);
}

function renderAuth(){
  applyTheme(null,null); // бирюзовый
  app.innerHTML = `
    <div class="hero">
      <div class="logoWrap">
        <img src="logo.png" alt="logo" onerror="this.style.display='none'; this.parentElement.innerHTML='👧'; this.parentElement.style.fontSize='64px'; this.parentElement.style.color='#0b6f78'">
      </div>
      <h1 class="brandTitle">AI BAYAN</h1>
      <div class="brandSub">Visual Vocabulary • Grade 3</div>
    </div>

    <div class="panel" style="max-width:520px">
      <div class="field">
        <div class="label">Login</div>
        <input class="input" id="login" placeholder="">
      </div>
      <div class="field">
        <div class="label">PIN</div>
        <input class="input" id="pin" type="password" placeholder="">
      </div>

      <div class="row">
        <button class="btn btnPrimary" style="flex:1;min-width:180px" onclick="handleLogin()">Enter</button>
        <button class="btn btnGhost" style="flex:1;min-width:180px" onclick="clearAuth()">Clear</button>
      </div>
    </div>

    <div class="footline">AI BAYAN • Grade 3 • 2025</div>
  `;
}

function clearAuth(){
  document.getElementById("login").value = "";
  document.getElementById("pin").value = "";
}

function handleLogin(){
  const login = (document.getElementById("login").value || "").trim().toUpperCase();
  const pin = (document.getElementById("pin").value || "").trim();

  if(pin === TEACHER_PIN){
    db.user = {type:"teacher", login:"TEACHER"};
    db.logs.push({ts: nowStr(), login:"TEACHER", action:"teacher_login"});
    saveDB();
    go("menu");
    return;
  }

  if(pin === STUDENT_PIN && validStudentLogin(login)){
    db.user = {type:"student", login};
    db.logs.push({ts: nowStr(), login, action:"student_login"});
    saveDB();
    go("menu");
    return;
  }

  alert("Wrong login or PIN.");
}

/* ===================== MENU ===================== */
function logout(){
  db.logs.push({ts: nowStr(), login: db.user?.login || "-", action:"logout"});
  db.user = null;
  saveDB();
  go("auth");
}

function renderMenu(){
  applyTheme(null,null); // бирюзовый
  const who = db.user.type==="teacher" ? "Teacher" : db.user.login;

  app.innerHTML = `
    <div class="hero">
      <div class="logoWrap">
        <img src="logo.png" alt="logo" onerror="this.style.display='none'; this.parentElement.innerHTML='👧'; this.parentElement.style.fontSize='64px'; this.parentElement.style.color='#0b6f78'">
      </div>
      <h1 class="brandTitle">ENGLISH WITH AI BAYAN</h1>
      <div class="brandSub">AI Bayan Visual Dictionary — Grade 3</div>
    </div>

    <div class="panel">
      <div class="helloCard">
        <div class="big">Hello, ${escapeHtml(who)}!</div>
        <div class="small">Total stars: ${db.user.type==="student" ? totalStarsFor(db.user.login) : "—"} ⭐</div>
      </div>

      <div class="menuGrid">
        ${UNITS.map(u=>`
          <div class="menuBtn" onclick="go('unit',{unit:${u.unit}})">
            📘 ${escapeHtml(u.title)}
            <small>Open Unit ${u.unit}</small>
          </div>
        `).join("")}
      </div>

      <div class="bottomRow">
        ${db.user.type==="student" ? `<div class="miniBtn" onclick="go('chat')">💬 AI Bayan Chat</div>` : ``}
        <div class="miniBtn" onclick="go('journal')">🏫 Teacher’s Journal</div>
        <div class="miniBtn" onclick="logout()">🚪 Exit</div>
      </div>
    </div>

    <div class="footline">AI BAYAN • Grade 3 • 2025</div>
  `;
}

/* ===================== UNIT ===================== */
function renderUnit(unitNum){
  const u = UNITS.find(x=>x.unit===unitNum);
  if(!u) return go("menu");

  // фон = цвет юнита (исправляет “низ другого цвета”)
  applyTheme(unitNum, null);

  const total = (db.user.type==="student") ? totalStarsFor(db.user.login) : 0;

  if(!u.lessons || u.lessons.length===0){
    app.innerHTML = `
      <div class="panel">
        <div class="lessonBanner">
          <div>
            <div class="title">${escapeHtml(u.title)}</div>
            <div class="sub">Lessons will be added</div>
          </div>
          <div class="badge">⭐ Total: ${db.user.type==="student"?total:"—"}</div>
        </div>

        <div class="sectionTitle">ℹ️ Unit is empty now</div>
        <div style="font-weight:900;color:#3d6167">
          Unit ${unitNum} is ready as a template. We will fill it by book (vocabulary, grammar, reading, songs).
        </div>

        <div class="navRow">
          <button class="btn btnPrimary" onclick="go('menu')">← Back</button>
          ${db.user.type==="student" ? `<button class="btn btnGhost" onclick="go('chat')">💬 Chat</button>` : ``}
        </div>
      </div>

      <div class="footline">AI BAYAN • Grade 3 • 2025</div>
    `;
    return;
  }

  app.innerHTML = `
    <div class="panel">
      <div class="lessonBanner">
        <div>
          <div class="title">${escapeHtml(u.title)}</div>
          <div class="sub">Choose a lesson</div>
        </div>
        <div class="badge">⭐ Total: ${db.user.type==="student"?total:"—"}</div>
      </div>

      <div class="menuGrid">
        ${u.lessons.map((L,idx)=>`
          <div class="menuBtn" onclick="go('lesson',{unit:${unitNum}, lessonId:'${L.id}'})">
            📗 Lesson ${idx+1} — ${escapeHtml(L.subtitle)}
            <small>${escapeHtml(L.vocabTopic)} ${db.user.type==="student" ? (isDone(db.user.login, L.id) ? "• ✅ done" : "") : ""}</small>
          </div>
        `).join("")}
      </div>

      <div class="bottomRow">
        <div class="miniBtn" onclick="go('menu')">← Main menu</div>
        ${db.user.type==="student" ? `<div class="miniBtn" onclick="go('chat')">💬 AI Bayan Chat</div>` : ``}
        <div class="miniBtn" onclick="go('journal')">🏫 Teacher’s Journal</div>
      </div>
    </div>

    <div class="footline">AI BAYAN • Grade 3 • 2025</div>
  `;
}

/* ===================== LESSON ===================== */
function renderLesson(unitNum, lessonId){
  const u = UNITS.find(x=>x.unit===unitNum);
  if(!u) return go("menu");
  const L = (u.lessons||[]).find(x=>x.id===lessonId);
  if(!L) return go("unit",{unit:unitNum});

  // тема урока = оттенок lessonIndex (и фон тоже!)
  applyTheme(unitNum, L.lessonIndex);

  const login = db.user.login;
  const studentMode = (db.user.type==="student");
  const locked = studentMode ? isDone(login, lessonId) : false;
  const curStars = studentMode ? lessonStars(login, lessonId) : 0;

  app.innerHTML = `
    <div class="panel">
      <div class="lessonBanner">
        <div>
          <div class="title">${escapeHtml(u.title)} — ${escapeHtml(L.subtitle)}</div>
          <div class="sub">${escapeHtml(L.vocabTopic)}</div>
        </div>
        <div class="badge">${studentMode ? `⭐ Stars: ${curStars}` : `Teacher view`}</div>
      </div>

      ${locked ? `<div style="font-weight:1000;color:#b21f1f;margin:6px 2px 10px">✅ This lesson is already completed. (1 attempt)</div>` : ``}

      <div class="sectionTitle">🧠 VOCABULARY — Visual Dictionary</div>
      <div class="vocabGrid">
        ${L.vocab.map(w=>{
          const src = cartoonImageByWord(w.en, unitNum, L.lessonIndex);
          return `
            <div class="vCard">
              <img src="${src}" alt="${escapeHtml(w.en)}">
              <div class="vWord">${escapeHtml(w.en)}</div>
              <div class="vRu">${escapeHtml(w.ru)}</div>
            </div>
          `;
        }).join("")}
      </div>

      <div class="sectionTitle">📘 GRAMMAR — Key Rule</div>
      <div class="wsBox">
        <h4>${escapeHtml(L.grammar.title)}</h4>
        <p style="font-weight:900">${escapeHtml(L.grammar.rule)}</p>
        <p><b>Formula:</b> ${escapeHtml(L.grammar.formula)}</p>
      </div>

      <div class="sectionTitle">📝 WORKSHEETS (4 tasks)</div>

      ${renderWS1(L, studentMode, locked)}
      ${renderWS2(L, studentMode, locked, unitNum)}
      ${renderWS3(L, studentMode, locked)}
      ${renderWS4(L, studentMode, locked)}

      <div class="navRow">
        <button class="btn btnGhost" onclick="go('unit',{unit:${unitNum}})">← Back</button>
        ${studentMode ? `<button class="btn btnPrimary" onclick="finishLesson('${lessonId}')">Finish lesson ✓</button>` : ``}
        <button class="btn btnGhost" onclick="window.print()">🖨 Print</button>
      </div>
    </div>

    <div class="footline">AI BAYAN • Grade 3 • 2025</div>
  `;
}

function renderWS1(L, studentMode, locked){
  const items = L.vocab.map(v=>{
    const raw = v.en.replace(/\?$/,"").trim();
    const idx = Math.max(1, Math.floor(raw.length/2));
    const shown = raw.slice(0,idx) + "_" + raw.slice(idx+1);
    return {shown, ans: raw};
  });

  return `
    <div class="wsBox" id="ws1">
      <h4>Worksheet 1 — Missing letters</h4>
      <p>Write the full word.</p>
      ${items.map((it,i)=>`
        <div class="qRow">
          <div class="q">${i+1}) ${escapeHtml(it.shown)} →</div>
          <input type="text" ${(!studentMode || locked) ? "disabled" : ""} data-ans="${escapeHtml(it.ans)}"
                 onblur="checkText(this)" placeholder="">
        </div>
      `).join("")}
    </div>
  `;
}

function renderWS2(L, studentMode, locked, unitNum){
  const opts = shuffle(L.vocab.map(v=>v.en));
  const lessonIndex = L.lessonIndex;

  return `
    <div class="wsBox" id="ws2">
      <h4>Worksheet 2 — Matching (picture → word)</h4>
      <p>Choose the correct word for each picture. (One try for each.)</p>

      <div class="matchGrid">
        ${L.vocab.map((w,i)=>{
          const src = cartoonImageByWord(w.en, unitNum, lessonIndex);
          return `
            <div class="matchCard" id="m${i}">
              <img src="${src}" alt="${escapeHtml(w.en)}">
              <div class="qRow" style="margin:10px 0 0">
                <select ${(!studentMode || locked) ? "disabled" : ""} data-ans="${escapeHtml(w.en)}"
                        onchange="checkSelect(this,'m${i}')">
                  <option value="">-- choose --</option>
                  ${opts.map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("")}
                </select>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    </div>
  `;
}

function renderWS3(L, studentMode, locked){
  return `
    <div class="wsBox" id="ws3">
      <h4>Worksheet 3 — Grammar (choose)</h4>
      <p>Choose the correct answer.</p>
      ${L.grammar.mcq.map((q,i)=>`
        <div class="qRow">
          <div class="q">${i+1}) ${escapeHtml(q.q)}</div>
          <select ${(!studentMode || locked) ? "disabled" : ""} data-ans="${escapeHtml(q.ans)}"
                  onchange="checkSelect(this,'g${i}')">
            <option value="">-- choose --</option>
            ${shuffle(q.options).map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("")}
          </select>
          <span id="g${i}" style="font-weight:1000"></span>
        </div>
      `).join("")}
    </div>
  `;
}

function renderWS4(L, studentMode, locked){
  const textHtml = L.reading.text.map(s=>`<div style="font-weight:900;color:#2f6168;margin:4px 0">${escapeHtml(s)}</div>`).join("");
  return `
    <div class="wsBox" id="ws4">
      <h4>Worksheet 4 — Mini reading + True/False</h4>
      <p>Read and choose True or False.</p>

      <div style="background:#f6fbfc;border:2px solid rgba(12,106,115,.18);border-radius:14px;padding:10px">
        ${textHtml}
      </div>

      ${L.reading.tf.map((t,i)=>`
        <div class="qRow">
          <div class="q">${i+1}) ${escapeHtml(t.q)}</div>
          <select ${(!studentMode || locked) ? "disabled" : ""} data-ans="${t.ans ? "True" : "False"}"
                  onchange="checkSelect(this,'t${i}')">
            <option value="">-- choose --</option>
            <option value="True">True</option>
            <option value="False">False</option>
          </select>
          <span id="t${i}" style="font-weight:1000"></span>
        </div>
      `).join("")}
    </div>
  `;
}

/* ===================== CHECKERS ===================== */
function sparkle(el){
  const s = document.createElement("div");
  s.className = "spark";
  s.textContent = "⭐";
  el.appendChild(s);
  setTimeout(()=>{ try{s.remove()}catch(e){} }, 700);
}
function lockControl(ctrl){ ctrl.disabled = true; }

function checkText(inp){
  if(inp.disabled) return;
  const ans = (inp.dataset.ans||"").trim().toLowerCase();
  const v = (inp.value||"").trim().toLowerCase();
  const ok = v && v===ans;

  inp.classList.remove("okBorder","badBorder");
  inp.classList.add(ok ? "okBorder" : "badBorder");

  const box = inp.closest(".wsBox");
  if(ok){ sparkle(box); addLessonStar(1); }

  lockControl(inp);
}

function checkSelect(sel, markId){
  if(sel.disabled) return;
  const ans = (sel.dataset.ans||"").trim().toLowerCase();
  const v = (sel.value||"").trim().toLowerCase();
  const ok = v && v===ans;

  sel.classList.remove("okBorder","badBorder");
  sel.classList.add(ok ? "okBorder" : "badBorder");

  const markTarget = document.getElementById(markId);
  if(markTarget && markTarget.classList && markTarget.classList.contains("matchCard")){
    // no-op
  }

  const parentCard = document.getElementById(markId);
  if(parentCard && parentCard.classList){
    parentCard.classList.toggle("correct", ok);
    parentCard.classList.toggle("wrong", !ok);
    const m = document.createElement("div");
    m.className = "mark";
    m.textContent = ok ? "✅" : "❌";
    parentCard.appendChild(m);
    if(ok) sparkle(parentCard);
  }

  if(ok) addLessonStar(1);
  lockControl(sel);
}

function addLessonStar(delta){
  if(db.user?.type!=="student") return;
  const lessonId = route.lessonId;
  addStars(db.user.login, lessonId, delta);
  saveDB();
  try{
    const badge = document.querySelector(".badge");
    if(badge) badge.textContent = `⭐ Stars: ${lessonStars(db.user.login, lessonId)}`;
  }catch(e){}
}

/* ===================== FINISH ===================== */
function finishLesson(lessonId){
  if(db.user?.type!=="student") return;
  if(isDone(db.user.login, lessonId)){
    alert("Already completed.");
    return;
  }
  setDone(db.user.login, lessonId);
  db.logs.push({ ts: nowStr(), login: db.user.login, action: "finish_lesson", lessonId, stars: lessonStars(db.user.login, lessonId) });
  saveDB();
  alert("Saved! Lesson completed ✅ (1 attempt)");
  go("unit",{unit: route.unit});
}

/* ===================== CHAT ===================== */
function renderChat(){
  applyTheme(null,null);
  const login = db.user.login;
  const last = db.chatLast[login] || null;
  const today = todayKey();
  const blocked = (last === today);

  app.innerHTML = `
    <div class="panel">
      <div class="lessonBanner">
        <div>
          <div class="title">AI Bayan Chat</div>
          <div class="sub">Limit: 1 question per day</div>
        </div>
        <div class="badge">⭐ Total: ${totalStarsFor(login)}</div>
      </div>

      <div class="sectionTitle">💬 Chat</div>
      <div class="chatBox" id="chatBox">
        <div class="msgAi">AI Bayan: Hello! Ask me a simple question 😊</div>
      </div>

      <div style="margin-top:12px">
        ${blocked ? `
          <div style="font-weight:1000;color:#b21f1f">❌ You already asked today.</div>
        ` : `
          <div class="row">
            <input class="input" id="chatIn" placeholder="Type your question..." style="flex:1;min-width:240px">
            <button class="btn btnPrimary" style="min-width:150px" onclick="sendChat()">Send</button>
          </div>
        `}
      </div>

      <div class="navRow">
        <button class="btn btnGhost" onclick="go('menu')">← Back</button>
      </div>
    </div>

    <div class="footline">AI BAYAN • Grade 3 • 2025</div>
  `;
}

function sendChat(){
  const login = db.user.login;
  const today = todayKey();
  if(db.chatLast[login] === today){ alert("Only 1 question per day."); return; }

  const inp = document.getElementById("chatIn");
  const msg = (inp.value||"").trim();
  if(!msg) return;

  const box = document.getElementById("chatBox");
  box.innerHTML += `<div class="msgMe">${escapeHtml(login)}: ${escapeHtml(msg)}</div>`;

  const m = msg.toLowerCase();
  let reply = "Good! 😊";
  if(m.includes("name")) reply = "My name is AI Bayan.";
  else if(m.includes("old")) reply = "I’m ten.";
  else if(m.includes("from")) reply = "I’m from Kazakhstan.";
  else if(m.includes("hello")) reply = "Hello!";
  else if(m.includes("how are you")) reply = "I’m fine. Thank you!";

  box.innerHTML += `<div class="msgAi">AI Bayan: ${escapeHtml(reply)}</div>`;
  box.scrollTop = box.scrollHeight;

  db.chatLast[login] = today;
  db.logs.push({ts: nowStr(), login, action:"chat_question"});
  saveDB();

  inp.value = "";
  setTimeout(()=>go("menu"), 900);
}

/* ===================== JOURNAL ===================== */
function renderJournal(){
  applyTheme(null,null);
  const isTeacher = db.user?.type==="teacher";

  const students = [];
  for(let i=1;i<=MAX_STUDENTS;i++){
    const login = `${CLASS_PREFIX}${i}`;
    const total = totalStarsFor(login);
    const doneCount = db.done[login] ? Object.keys(db.done[login]).length : 0;
    students.push({login,total,doneCount});
  }
  const logs = (db.logs||[]).slice().reverse().slice(0,120);

  app.innerHTML = `
    <div class="panel">
      <div class="lessonBanner">
        <div>
          <div class="title">Teacher’s Journal</div>
          <div class="sub">${isTeacher ? "Full access" : "View only"}</div>
        </div>
        <div class="badge">Logs: ${db.logs.length}</div>
      </div>

      <div class="sectionTitle">👩‍🏫 Students summary</div>
      <div style="overflow:auto;border:2px solid rgba(12,106,115,.18);border-radius:16px">
        <table>
          <thead><tr><th>Student</th><th>Total ⭐</th><th>Done lessons</th></tr></thead>
          <tbody>
            ${students.map(s=>`<tr><td>${escapeHtml(s.login)}</td><td>${escapeHtml(String(s.total))}</td><td>${escapeHtml(String(s.doneCount))}</td></tr>`).join("")}
          </tbody>
        </table>
      </div>

      <div class="sectionTitle">📒 Activity log (latest)</div>
      <div style="overflow:auto;border:2px solid rgba(12,106,115,.18);border-radius:16px">
        <table>
          <thead><tr><th>Time</th><th>Login</th><th>Action</th><th>Lesson</th><th>Stars</th></tr></thead>
          <tbody>
            ${logs.map(r=>`<tr><td>${escapeHtml(r.ts||"")}</td><td>${escapeHtml(r.login||"")}</td><td>${escapeHtml(r.action||"")}</td><td>${escapeHtml(r.lessonId||"")}</td><td>${escapeHtml(String(r.stars ?? ""))}</td></tr>`).join("")}
          </tbody>
        </table>
      </div>

      <div class="bottomRow">
        ${isTeacher ? `<div class="miniBtn" onclick="resetAll()">🧹 Reset ALL data</div>` : ``}
        <div class="miniBtn" onclick="go('menu')">← Back</div>
      </div>
    </div>

    <div class="footline">AI BAYAN • Grade 3 • 2025</div>
  `;
}

function resetAll(){
  if(!confirm("Reset all saved data?")) return;
  db = { user: db.user, stars:{}, done:{}, chatLast:{}, logs:[{ts: nowStr(), login:"TEACHER", action:"reset_all"}] };
  saveDB();
  alert("All data reset.");
  renderJournal();
}

/* ===================== UTILS ===================== */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* ===================== START ===================== */
go(db.user ? "menu" : "auth");
</script>
</body>
</html>
